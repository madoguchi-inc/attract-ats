<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Attract ATS - æ¡ç”¨ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—</title>
<script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script crossorigin src="https://unpkg.com/prop-types@15/prop-types.min.js"></script>
<script crossorigin src="https://unpkg.com/recharts@2.5.0/umd/Recharts.js"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Kaku Gothic ProN', sans-serif; }
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useMemo, useEffect, useCallback, useRef } = React;
const { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, PieChart, Pie, Cell, LineChart, Line, RadarChart, Radar, PolarGrid, PolarAngleAxis, PolarRadiusAxis, Legend } = Recharts;

// ============================================================
// SUPABASE è¨­å®š (CDNä¸è¦ãƒ»fetch APIç›´æ¥å‘¼ã³å‡ºã—)
// ============================================================
const SUPABASE_URL = 'https://enzgjnelimfrosilsokn.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVuemdqbmVsaW1mcm9zaWxzb2tuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxNjU0MzQsImV4cCI6MjA4Nzc0MTQzNH0.lGp7juqG5IPjSiXa7E8dWtyl7q1CH34ntodzCetFN3U';
const SUPABASE_READY = SUPABASE_URL !== 'YOUR_SUPABASE_URL';

// ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†
const tokenStore = {
  get accessToken() { return localStorage.getItem('sb_access_token'); },
  get refreshToken() { return localStorage.getItem('sb_refresh_token'); },
  save(session) {
    localStorage.setItem('sb_access_token', session.access_token);
    localStorage.setItem('sb_refresh_token', session.refresh_token);
  },
  clear() {
    localStorage.removeItem('sb_access_token');
    localStorage.removeItem('sb_refresh_token');
  }
};

// Supabase REST API ãƒ˜ãƒ«ãƒ‘ãƒ¼
const sbApi = {
  _headers(withAuth = true) {
    const h = { 'apikey': SUPABASE_ANON_KEY, 'Content-Type': 'application/json' };
    if (withAuth && tokenStore.accessToken) h['Authorization'] = 'Bearer ' + tokenStore.accessToken;
    return h;
  },
  // èªè¨¼: ãƒ­ã‚°ã‚¤ãƒ³
  async signIn(email, password) {
    const res = await fetch(SUPABASE_URL + '/auth/v1/token?grant_type=password', {
      method: 'POST', headers: this._headers(false),
      body: JSON.stringify({ email, password })
    });
    const data = await res.json();
    if (!res.ok) return { user: null, error: data };
    tokenStore.save(data);
    return { user: data.user, error: null };
  },
  // èªè¨¼: ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—
  async getUser() {
    if (!tokenStore.accessToken) return null;
    const res = await fetch(SUPABASE_URL + '/auth/v1/user', { headers: this._headers() });
    if (!res.ok) { tokenStore.clear(); return null; }
    return await res.json();
  },
  // èªè¨¼: ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
  async signOut() {
    await fetch(SUPABASE_URL + '/auth/v1/logout', { method: 'POST', headers: this._headers() }).catch(() => {});
    tokenStore.clear();
  },
  // DB: SELECT
  async select(table, params = '') {
    const res = await fetch(SUPABASE_URL + '/rest/v1/' + table + '?select=*' + (params ? '&' + params : ''), { headers: this._headers() });
    if (!res.ok) return { data: null, error: await res.json() };
    return { data: await res.json(), error: null };
  },
  // DB: INSERT
  async insert(table, row) {
    const res = await fetch(SUPABASE_URL + '/rest/v1/' + table, {
      method: 'POST', headers: { ...this._headers(), 'Prefer': 'return=representation' },
      body: JSON.stringify(row)
    });
    if (!res.ok) return { data: null, error: await res.json() };
    const data = await res.json();
    return { data: data[0] || data, error: null };
  },
  // èªè¨¼: ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆæ‹›å¾…ç”¨ï¼‰
  async signUp(email, password, metadata = {}) {
    const res = await fetch(SUPABASE_URL + '/auth/v1/signup', {
      method: 'POST', headers: this._headers(false),
      body: JSON.stringify({ email, password, data: metadata })
    });
    const data = await res.json();
    if (!res.ok) return { user: null, error: data };
    return { user: data.user || data, error: null };
  },
  // DB: DELETE
  async remove(table, filter) {
    const res = await fetch(SUPABASE_URL + '/rest/v1/' + table + '?' + filter, {
      method: 'DELETE', headers: this._headers()
    });
    if (!res.ok) return { error: await res.json() };
    return { error: null };
  },
  // DB: UPDATE
  async update(table, filter, row) {
    const res = await fetch(SUPABASE_URL + '/rest/v1/' + table + '?' + filter, {
      method: 'PATCH', headers: { ...this._headers(), 'Prefer': 'return=representation' },
      body: JSON.stringify(row)
    });
    if (!res.ok) return { error: await res.json() };
    return { error: null };
  }
};

console.log('[Attract ATS] SUPABASE_READY:', SUPABASE_READY);

// ============================================================
// ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³: 549ä»¶ã‚’æ–°8ã‚¹ãƒ†ãƒ¼ã‚¸ã«å†é…åˆ†
// ============================================================
async function runDataMigration(onProgress) {
  if (!SUPABASE_READY) { alert('Supabaseæœªæ¥ç¶šã®ãŸã‚å®Ÿè¡Œã§ãã¾ã›ã‚“'); return false; }
  onProgress && onProgress('å€™è£œè€…ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...');

  // 1) å…¨å€™è£œè€…IDå–å¾—
  const { data: allCandidates, error } = await sbApi.select('candidates', 'select=id&order=id.asc&limit=1000');
  if (error || !allCandidates) { alert('ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼'); return false; }
  const total = allCandidates.length;
  onProgress && onProgress('å–å¾—å®Œäº†: ' + total + 'ä»¶ã€‚ã‚¹ãƒ†ãƒ¼ã‚¸å†é…åˆ†ä¸­...');

  // 2) ãƒªã‚¢ãƒ«ãªé¸è€ƒãƒ•ã‚¡ãƒãƒ«åˆ†å¸ƒã‚’è¨­è¨ˆ
  //    ã‚¨ãƒ³ãƒˆãƒªãƒ¼(100%) â†’ èª¬æ˜ä¼š(75%) â†’ ä¸€æ¬¡(55%) â†’ é©æ€§(40%) â†’ äºŒæ¬¡(28%) â†’ æœ€çµ‚(18%) â†’ å†…å®š(10%) â†’ æ‰¿è«¾(7%)
  //    å„ã‚¹ãƒ†ãƒ¼ã‚¸ã§ä¸€éƒ¨ãŒé›¢è„±ï¼ˆè¾é€€ãƒ»ä¸åˆæ ¼ãƒ»ä¿ç•™ï¼‰
  const distribution = [
    { stage: 'ã‚¨ãƒ³ãƒˆãƒªãƒ¼', pct: 0.12, subs: [
      { sub: 'å—ä»˜æ¸ˆ', w: 2 }, { sub: 'æ›¸é¡ç¢ºèªä¸­', w: 3 }, { sub: 'æ›¸é¡é€šé', w: 5 },
      { sub: 'è¾é€€', w: 2 }, { sub: 'ä¸åˆæ ¼', w: 3 }
    ]},
    { stage: 'èª¬æ˜ä¼š', pct: 0.14, subs: [
      { sub: 'æ¡ˆå†…æ¸ˆ', w: 1 }, { sub: 'äºˆç´„æ¸ˆ', w: 2 }, { sub: 'å‚åŠ æ¸ˆ', w: 5 }, { sub: 'æ¬ å¸­', w: 2 },
      { sub: 'è¾é€€', w: 2 }, { sub: 'ä¸åˆæ ¼', w: 1 }
    ]},
    { stage: 'ä¸€æ¬¡é¢æ¥', pct: 0.16, subs: [
      { sub: 'æ—¥ç¨‹èª¿æ•´ä¸­', w: 2 }, { sub: 'äºˆç´„æ¸ˆ', w: 2 }, { sub: 'å®Ÿæ–½æ¸ˆ', w: 4 }, { sub: 'åˆæ ¼', w: 5 },
      { sub: 'è¾é€€', w: 2 }, { sub: 'ä¸åˆæ ¼', w: 4 }
    ]},
    { stage: 'é©æ€§ãƒ†ã‚¹ãƒˆ', pct: 0.12, subs: [
      { sub: 'æ¡ˆå†…æ¸ˆ', w: 2 }, { sub: 'å—é¨“æ¸ˆ', w: 4 }, { sub: 'åˆæ ¼', w: 5 },
      { sub: 'è¾é€€', w: 1 }, { sub: 'ä¸åˆæ ¼', w: 3 }
    ]},
    { stage: 'äºŒæ¬¡é¢æ¥', pct: 0.14, subs: [
      { sub: 'æ—¥ç¨‹èª¿æ•´ä¸­', w: 2 }, { sub: 'äºˆç´„æ¸ˆ', w: 2 }, { sub: 'å®Ÿæ–½æ¸ˆ', w: 3 }, { sub: 'åˆæ ¼', w: 4 },
      { sub: 'è¾é€€', w: 3 }, { sub: 'ä¸åˆæ ¼', w: 4 }, { sub: 'ä¿ç•™', w: 1 }
    ]},
    { stage: 'æœ€çµ‚é¢æ¥', pct: 0.12, subs: [
      { sub: 'æ—¥ç¨‹èª¿æ•´ä¸­', w: 2 }, { sub: 'äºˆç´„æ¸ˆ', w: 2 }, { sub: 'å®Ÿæ–½æ¸ˆ', w: 3 }, { sub: 'åˆæ ¼', w: 4 },
      { sub: 'è¾é€€', w: 2 }, { sub: 'ä¸åˆæ ¼', w: 3 }, { sub: 'ä¿ç•™', w: 1 }
    ]},
    { stage: 'å†…å®š', pct: 0.10, subs: [
      { sub: 'å†…å®šé€šçŸ¥', w: 2 }, { sub: 'é¢è«‡èª¿æ•´ä¸­', w: 3 }, { sub: 'é¢è«‡å®Ÿæ–½æ¸ˆ', w: 4 },
      { sub: 'è¾é€€', w: 3 }, { sub: 'ä¿ç•™', w: 1 }
    ]},
    { stage: 'å†…å®šæ‰¿è«¾', pct: 0.10, subs: [
      { sub: 'æ‰¿è«¾æ¸ˆ', w: 5 }, { sub: 'å…¥ç¤¾æº–å‚™ä¸­', w: 3 }, { sub: 'å…¥ç¤¾æ¸ˆ', w: 2 },
      { sub: 'æ‰¿è«¾å¾Œè¾é€€', w: 1 }
    ]},
  ];

  // é‡ã¿ä»˜ããƒ©ãƒ³ãƒ€ãƒ é¸æŠ
  function weightedRandom(items) {
    const totalW = items.reduce((s, i) => s + i.w, 0);
    let r = Math.random() * totalW;
    for (const item of items) {
      r -= item.w;
      if (r <= 0) return item.sub;
    }
    return items[items.length - 1].sub;
  }

  // 3) å„å€™è£œè€…ã«ã‚¹ãƒ†ãƒ¼ã‚¸ï¼†ã‚µãƒ–ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å‰²ã‚Šå½“ã¦
  const assignments = [];
  let idx = 0;
  // ã¾ãšå„ã‚¹ãƒ†ãƒ¼ã‚¸ã«äººæ•°ã‚’å‰²ã‚Šå½“ã¦
  const stageCounts = distribution.map(d => Math.round(total * d.pct));
  // ç«¯æ•°èª¿æ•´
  const diff = total - stageCounts.reduce((s, c) => s + c, 0);
  stageCounts[0] += diff; // ã‚¨ãƒ³ãƒˆãƒªãƒ¼ã§èª¿æ•´

  for (let si = 0; si < distribution.length; si++) {
    const stg = distribution[si];
    const count = stageCounts[si];
    for (let j = 0; j < count && idx < total; j++, idx++) {
      const sub = weightedRandom(stg.subs);
      assignments.push({ id: allCandidates[idx].id, stage: stg.stage, substatus: sub });
    }
  }

  // 4) ãƒãƒƒãƒæ›´æ–° (20ä»¶ãšã¤)
  const batchSize = 20;
  let done = 0;
  for (let i = 0; i < assignments.length; i += batchSize) {
    const batch = assignments.slice(i, i + batchSize);
    const promises = batch.map(a =>
      sbApi.update('candidates', 'id=eq.' + a.id, { stage: a.stage, substatus: a.substatus })
    );
    await Promise.all(promises);
    done += batch.length;
    onProgress && onProgress('æ›´æ–°ä¸­... ' + done + '/' + total + 'ä»¶');
  }

  onProgress && onProgress('å®Œäº†ï¼ ' + total + 'ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
  return true;
}

// Simple Icon component (replaces lucide-react)
function Icon({ name, size = 16, color = "currentColor", style: extraStyle }) {
  const icons = {
    home: "M3 12l9-9 9 9M5 10v10h4v-6h6v6h4V10",
    users: "M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2M9 7a4 4 0 100-8 4 4 0 000 8M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75",
    "git-branch": "M6 3v12M18 9a3 3 0 100-6 3 3 0 000 6zM6 21a3 3 0 100-6 3 3 0 000 6zM18 9a9 9 0 01-9 9",
    calendar: "M19 4H5a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2V6a2 2 0 00-2-2zM16 2v4M8 2v4M3 10h18",
    "message-square": "M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z",
    zap: "M13 2L3 14h9l-1 8 10-12h-9l1-8z",
    building: "M6 22V4a2 2 0 012-2h8a2 2 0 012 2v18zM6 12H4a2 2 0 00-2 2v6a2 2 0 002 2h2M18 9h2a2 2 0 012 2v9a2 2 0 01-2 2h-2M10 6h4M10 10h4M10 14h4M10 18h4",
    "bar-chart": "M12 20V10M18 20V4M6 20v-4",
    "check-square": "M9 11l3 3L22 4M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11",
    settings: "M12 15a3 3 0 100-6 3 3 0 000 6z",
    bell: "M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9M13.73 21a2 2 0 01-3.46 0",
    search: "M11 17.25a6.25 6.25 0 110-12.5 6.25 6.25 0 010 12.5zM16.65 16.65L21 21",
    "chevron-right": "M9 18l6-6-6-6",
    "arrow-left": "M19 12H5M12 19l-7-7 7-7",
    mic: "M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3zM19 10v2a7 7 0 01-14 0v-2M12 19v4M8 23h8",
    "mic-off": "M1 1l22 22M9 9v3a3 3 0 005.12 2.12M15 9.34V4a3 3 0 00-5.94-.6M17 16.95A7 7 0 015 12v-2m14 0v2c0 .76-.12 1.5-.34 2.18M12 19v4M8 23h8",
    mail: "M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2zM22 6l-10 7L2 6",
    phone: "M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72",
    "graduation-cap": "M22 10l-10-6L2 10l10 6 10-6zM6 12v5c3 3 9 3 12 0v-5",
    briefcase: "M20 7H4a2 2 0 00-2 2v10a2 2 0 002 2h16a2 2 0 002-2V9a2 2 0 00-2-2zM16 21V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v16",
    star: "M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z",
    plus: "M12 5v14M5 12h14",
    "trending-up": "M23 6l-9.5 9.5-5-5L1 18",
    "trending-down": "M23 18l-9.5-9.5-5 5L1 6",
    "alert-circle": "M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10zM12 8v4M12 16h.01",
    "check-circle": "M22 11.08V12a10 10 0 11-5.93-9.14M22 4L12 14.01l-3-3",
    "file-text": "M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8zM14 2v6h6M16 13H8M16 17H8M10 9H8",
    volume: "M11 5L6 9H2v6h4l5 4V5zM19.07 4.93a10 10 0 010 14.14M15.54 8.46a5 5 0 010 7.07",
    user: "M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2M12 7a4 4 0 100-8 4 4 0 000 8",
    filter: "M22 3H2l8 9.46V19l4 2v-8.54L22 3",
  };
  const path = icons[name] || icons["user"];
  return (
    <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" style={{ display: "inline-block", verticalAlign: "middle", flexShrink: 0, ...extraStyle }}>
      {path.split("M").filter(Boolean).map((d, i) => <path key={i} d={"M" + d} />)}
    </svg>
  );
}

// ============================================================
// MOCK DATA - æ–°å’ + ä¸­é€”
// ============================================================
// ============================================================
// é¸è€ƒã‚¹ãƒ†ãƒ¼ã‚¸å®šç¾© (8æ®µéš + å…±é€šé›¢è„±ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹)
// ============================================================
const STAGE_DEFINITIONS = [
  { id: "entry",       order: 1, name: "ã‚¨ãƒ³ãƒˆãƒªãƒ¼", color: "#6366f1", icon: "users",
    substatuses: ["å—ä»˜æ¸ˆ", "æ›¸é¡ç¢ºèªä¸­", "æ›¸é¡é€šé"],
    exitStatuses: ["è¾é€€", "ä¸åˆæ ¼", "ä¿ç•™"] },
  { id: "briefing",    order: 2, name: "èª¬æ˜ä¼š",     color: "#8b5cf6", icon: "volume",
    substatuses: ["æ¡ˆå†…æ¸ˆ", "äºˆç´„æ¸ˆ", "å‚åŠ æ¸ˆ", "æ¬ å¸­"],
    exitStatuses: ["è¾é€€", "ä¸åˆæ ¼", "ä¿ç•™"] },
  { id: "interview1",  order: 3, name: "ä¸€æ¬¡é¢æ¥",   color: "#a855f7", icon: "user",
    substatuses: ["æ—¥ç¨‹èª¿æ•´ä¸­", "äºˆç´„æ¸ˆ", "å®Ÿæ–½æ¸ˆ", "åˆæ ¼"],
    exitStatuses: ["è¾é€€", "ä¸åˆæ ¼", "ä¿ç•™"] },
  { id: "aptitude",    order: 4, name: "é©æ€§ãƒ†ã‚¹ãƒˆ", color: "#c084fc", icon: "check-square",
    substatuses: ["æ¡ˆå†…æ¸ˆ", "å—é¨“æ¸ˆ", "åˆæ ¼"],
    exitStatuses: ["è¾é€€", "ä¸åˆæ ¼", "ä¿ç•™"] },
  { id: "interview2",  order: 5, name: "äºŒæ¬¡é¢æ¥",   color: "#d946ef", icon: "user",
    substatuses: ["æ—¥ç¨‹èª¿æ•´ä¸­", "äºˆç´„æ¸ˆ", "å®Ÿæ–½æ¸ˆ", "åˆæ ¼"],
    exitStatuses: ["è¾é€€", "ä¸åˆæ ¼", "ä¿ç•™"] },
  { id: "final",       order: 6, name: "æœ€çµ‚é¢æ¥",   color: "#ec4899", icon: "star",
    substatuses: ["æ—¥ç¨‹èª¿æ•´ä¸­", "äºˆç´„æ¸ˆ", "å®Ÿæ–½æ¸ˆ", "åˆæ ¼"],
    exitStatuses: ["è¾é€€", "ä¸åˆæ ¼", "ä¿ç•™"] },
  { id: "offer",       order: 7, name: "å†…å®š",       color: "#f59e0b", icon: "check-circle",
    substatuses: ["å†…å®šé€šçŸ¥", "é¢è«‡èª¿æ•´ä¸­", "é¢è«‡å®Ÿæ–½æ¸ˆ"],
    exitStatuses: ["è¾é€€", "ä¸åˆæ ¼", "ä¿ç•™"] },
  { id: "accepted",    order: 8, name: "å†…å®šæ‰¿è«¾",   color: "#10b981", icon: "check-circle",
    substatuses: ["æ‰¿è«¾æ¸ˆ", "å…¥ç¤¾æº–å‚™ä¸­", "å…¥ç¤¾æ¸ˆ"],
    exitStatuses: ["æ‰¿è«¾å¾Œè¾é€€"] },
];

// ã‚¹ãƒ†ãƒ¼ã‚¸åã‹ã‚‰ã‚¹ãƒ†ãƒ¼ã‚¸å®šç¾©ã‚’å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
const getStageDefByName = (name) => STAGE_DEFINITIONS.find(s => s.name === name);
const getStageDefById = (id) => STAGE_DEFINITIONS.find(s => s.id === id);
const STAGE_NAMES = STAGE_DEFINITIONS.map(s => s.name);

// ============================================================
// ãƒ­ãƒ¼ãƒ«å®šç¾© & æ¨©é™ãƒ˜ãƒ«ãƒ‘ãƒ¼
// ============================================================
const ROLES = [
  { id: "admin",       label: "ç®¡ç†è€…",    color: "#dc2626", icon: "ğŸ”‘", description: "å…¨æ©Ÿèƒ½ã«ãƒ•ãƒ«ã‚¢ã‚¯ã‚»ã‚¹" },
  { id: "recruiter",   label: "æ¡ç”¨æ‹…å½“",  color: "#6366f1", icon: "ğŸ‘¤", description: "å€™è£œè€…ç®¡ç†ãƒ»ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ»ã‚¤ãƒ³ãƒãƒ¼ãƒˆ" },
  { id: "interviewer", label: "é¢æ¥å®˜",    color: "#f59e0b", icon: "ğŸ¤", description: "æ‹…å½“å€™è£œè€…ã®é–²è¦§ãƒ»FBå…¥åŠ›" },
  { id: "viewer",      label: "é–²è¦§è€…",    color: "#6b7280", icon: "ğŸ‘ï¸", description: "ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ»ä¸€è¦§ã®é–²è¦§ã®ã¿" },
];
const PERMISSIONS = {
  admin:       { viewDashboard: true, viewCandidates: true, editCandidates: true, changeStage: true, inputFB: true, csvImport: true, sendMessage: true, manageAccounts: true, editSettings: true },
  recruiter:   { viewDashboard: true, viewCandidates: true, editCandidates: true, changeStage: true, inputFB: true, csvImport: true, sendMessage: true, manageAccounts: false, editSettings: false },
  interviewer: { viewDashboard: true, viewCandidates: true, editCandidates: false, changeStage: false, inputFB: true, csvImport: false, sendMessage: false, manageAccounts: false, editSettings: false },
  viewer:      { viewDashboard: true, viewCandidates: true, editCandidates: false, changeStage: false, inputFB: false, csvImport: false, sendMessage: false, manageAccounts: false, editSettings: false },
};
const hasPermission = (role, permission) => PERMISSIONS[role]?.[permission] ?? false;
const getRoleDef = (roleId) => ROLES.find(r => r.id === roleId) || ROLES[3];
const PERMISSION_LABELS = {
  viewDashboard: "ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰é–²è¦§", viewCandidates: "å€™è£œè€…ä¸€è¦§é–²è¦§", editCandidates: "å€™è£œè€…ç·¨é›†ãƒ»ç™»éŒ²",
  changeStage: "ã‚¹ãƒ†ãƒ¼ã‚¸å¤‰æ›´", inputFB: "é¢æ¥FBå…¥åŠ›", csvImport: "CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ",
  sendMessage: "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡", manageAccounts: "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†", editSettings: "è¨­å®šå¤‰æ›´",
};

// ============================================================
// ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
// ============================================================
const DEFAULT_EMAIL_TEMPLATES = [
  // --- ã‚¨ãƒ³ãƒˆãƒªãƒ¼ ---
  { id: "t01", category: "ã‚¨ãƒ³ãƒˆãƒªãƒ¼", label: "ã‚¨ãƒ³ãƒˆãƒªãƒ¼å—é ˜ã®å¾¡ç¤¼", subject: "ã€{{company}}ã€‘ã‚¨ãƒ³ãƒˆãƒªãƒ¼å—é ˜ã®ã”é€£çµ¡", body: "{{name}} æ§˜\n\nãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚\n{{company}}ã®æ¡ç”¨æ‹…å½“ã§ã”ã–ã„ã¾ã™ã€‚\n\nã“ã®åº¦ã¯å¼Šç¤¾ã«ã‚¨ãƒ³ãƒˆãƒªãƒ¼ã„ãŸã ãã€èª ã«ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚\nã„ãŸã ã„ãŸå†…å®¹ã‚’ç¢ºèªã®ã†ãˆã€ä»Šå¾Œã®é¸è€ƒã«ã¤ã„ã¦ã”é€£çµ¡ã„ãŸã—ã¾ã™ã€‚\n\nä»Šã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã¾ã›ã€‚\n\nä½•å’ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚" },
  { id: "t02", category: "ã‚¨ãƒ³ãƒˆãƒªãƒ¼", label: "å¿œå‹Ÿæ›¸é¡æå‡ºã®ãŠé¡˜ã„", subject: "ã€{{company}}ã€‘å¿œå‹Ÿæ›¸é¡ã”æå‡ºã®ãŠé¡˜ã„", body: "{{name}} æ§˜\n\nãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚\n{{company}}ã®æ¡ç”¨æ‹…å½“ã§ã”ã–ã„ã¾ã™ã€‚\n\nã‚¨ãƒ³ãƒˆãƒªãƒ¼ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚\né¸è€ƒã‚’é€²ã‚ã‚‹ã«ã‚ãŸã‚Šã€ä¸‹è¨˜ã®æ›¸é¡ã‚’ã”æå‡ºã„ãŸã ã‘ã¾ã™ã§ã—ã‚‡ã†ã‹ã€‚\n\nã€æå‡ºæ›¸é¡ã€‘\nãƒ»å±¥æ­´æ›¸\nãƒ»è·å‹™çµŒæ­´æ›¸ï¼ˆä¸­é€”ã®å ´åˆï¼‰\n\nã€æå‡ºæ–¹æ³•ã€‘ãƒ¡ãƒ¼ãƒ«æ·»ä»˜ or æŒ‡å®šãƒ•ã‚©ãƒ¼ãƒ \nã€æå‡ºæœŸé™ã€‘â—‹æœˆâ—‹æ—¥ï¼ˆâ—‹ï¼‰ã¾ã§\n\nã”ä¸æ˜ãªç‚¹ãŒã”ã–ã„ã¾ã—ãŸã‚‰ãŠæ°—è»½ã«ã”é€£çµ¡ãã ã•ã„ã€‚\n\nä½•å’ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚" },
  // --- èª¬æ˜ä¼š ---
  { id: "t03", category: "èª¬æ˜ä¼š", label: "èª¬æ˜ä¼šã®ã”æ¡ˆå†…", subject: "ã€{{company}}ã€‘ä¼šç¤¾èª¬æ˜ä¼šã®ã”æ¡ˆå†…", body: "{{name}} æ§˜\n\nãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚\n{{company}}ã®æ¡ç”¨æ‹…å½“ã§ã”ã–ã„ã¾ã™ã€‚\n\nä¸‹è¨˜ã®æ—¥ç¨‹ã§ä¼šç¤¾èª¬æ˜ä¼šã‚’é–‹å‚¬ã„ãŸã—ã¾ã™ã€‚\nãœã²ã”å‚åŠ ã„ãŸã ã‘ã¾ã™ã¨å¹¸ã„ã§ã™ã€‚\n\nã€æ—¥æ™‚ã€‘â—‹æœˆâ—‹æ—¥ï¼ˆâ—‹ï¼‰â—‹:â—‹â—‹ã€œâ—‹:â—‹â—‹\nã€å ´æ‰€ã€‘â—‹â—‹ï¼ˆã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã®å ´åˆã¯URLï¼‰\nã€å†…å®¹ã€‘ä¼šç¤¾æ¦‚è¦ãƒ»äº‹æ¥­ç´¹ä»‹ãƒ»è³ªç–‘å¿œç­”\nã€æŒã¡ç‰©ã€‘ç‰¹ã«ãªã—\n\nã”å‚åŠ ã®å¯å¦ã‚’â—‹æœˆâ—‹æ—¥ã¾ã§ã«ã”è¿”ä¿¡ãã ã•ã„ã€‚\n\nä½•å’ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚" },
  { id: "t04", category: "èª¬æ˜ä¼š", label: "èª¬æ˜ä¼šå‚åŠ å¾¡ç¤¼", subject: "ã€{{company}}ã€‘èª¬æ˜ä¼šã”å‚åŠ ã®å¾¡ç¤¼", body: "{{name}} æ§˜\n\nãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚\n{{company}}ã®æ¡ç”¨æ‹…å½“ã§ã”ã–ã„ã¾ã™ã€‚\n\nå…ˆæ—¥ã¯ä¼šç¤¾èª¬æ˜ä¼šã«ã”å‚åŠ ã„ãŸã ãã€èª ã«ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚\nå¼Šç¤¾ã®äº‹æ¥­å†…å®¹ã‚„é›°å›²æ°—ã«ã¤ã„ã¦ã€å°‘ã—ã§ã‚‚ãŠä¼ãˆã§ãã¦ã„ã‚Œã°å¹¸ã„ã§ã™ã€‚\n\nä»Šå¾Œã®é¸è€ƒã«ãŠé€²ã¿ã„ãŸã ã‘ã‚‹å ´åˆã¯ã€\nè¿½ã£ã¦è©³ç´°ã‚’ã”æ¡ˆå†…ã„ãŸã—ã¾ã™ã®ã§ã€ä»Šã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚\n\nã”è³ªå•ç­‰ã”ã–ã„ã¾ã—ãŸã‚‰ã€ãŠæ°—è»½ã«ã”é€£çµ¡ãã ã•ã„ã€‚\n\nä½•å’ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚" },
  // --- ä¸€æ¬¡é¢æ¥ ---
  { id: "t05", category: "ä¸€æ¬¡é¢æ¥", label: "ä¸€æ¬¡é¢æ¥æ—¥ç¨‹ã®ã”æ¡ˆå†…", subject: "ã€{{company}}ã€‘ä¸€æ¬¡é¢æ¥æ—¥ç¨‹ã®ã”æ¡ˆå†…", body: "{{name}} æ§˜\n\nãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚\n{{company}}ã®æ¡ç”¨æ‹…å½“ã§ã”ã–ã„ã¾ã™ã€‚\n\næ›¸é¡é¸è€ƒã®çµæœã€ãœã²ä¸€æ¬¡é¢æ¥ã«ãŠé€²ã¿ã„ãŸã ããŸãã”é€£çµ¡ã„ãŸã—ã¾ã—ãŸã€‚\nä¸‹è¨˜ã®æ—¥ç¨‹ã‹ã‚‰ã”éƒ½åˆã®è‰¯ã„æ—¥æ™‚ã‚’ãŠçŸ¥ã‚‰ã›ãã ã•ã„ã€‚\n\nã€å€™è£œæ—¥æ™‚ã€‘\nâ‘  â—‹æœˆâ—‹æ—¥ï¼ˆâ—‹ï¼‰â—‹:â—‹â—‹ã€œ\nâ‘¡ â—‹æœˆâ—‹æ—¥ï¼ˆâ—‹ï¼‰â—‹:â—‹â—‹ã€œ\nâ‘¢ â—‹æœˆâ—‹æ—¥ï¼ˆâ—‹ï¼‰â—‹:â—‹â—‹ã€œ\n\nã€å ´æ‰€ã€‘â—‹â—‹ï¼ˆã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã®å ´åˆã¯URLï¼‰\nã€æ‰€è¦æ™‚é–“ã€‘ç´„60åˆ†\nã€é¢æ¥å®˜ã€‘â—‹â—‹éƒ¨ â—‹â—‹\n\nã”éƒ½åˆãŒåˆã‚ãªã„å ´åˆã¯ã€åˆ¥æ—¥ç¨‹ã‚‚èª¿æ•´å¯èƒ½ã§ã™ã€‚\n\nä½•å’ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚" },
  { id: "t06", category: "ä¸€æ¬¡é¢æ¥", label: "ä¸€æ¬¡é¢æ¥ãƒªãƒã‚¤ãƒ³ãƒ‰", subject: "ã€{{company}}ã€‘ä¸€æ¬¡é¢æ¥ã®ãƒªãƒã‚¤ãƒ³ãƒ‰", body: "{{name}} æ§˜\n\nãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚\n{{company}}ã®æ¡ç”¨æ‹…å½“ã§ã”ã–ã„ã¾ã™ã€‚\n\næ˜æ—¥ã®é¢æ¥ã«ã¤ã„ã¦ã€æ”¹ã‚ã¦ã”æ¡ˆå†…ã„ãŸã—ã¾ã™ã€‚\n\nã€æ—¥æ™‚ã€‘â—‹æœˆâ—‹æ—¥ï¼ˆâ—‹ï¼‰â—‹:â—‹â—‹ã€œ\nã€å ´æ‰€ã€‘â—‹â—‹\nã€é¢æ¥å®˜ã€‘â—‹â—‹\n\nå½“æ—¥ã¯ã©ã†ããƒªãƒ©ãƒƒã‚¯ã‚¹ã—ã¦ãŠè¶Šã—ãã ã•ã„ã€‚\nãŠä¼šã„ã§ãã‚‹ã“ã¨ã‚’æ¥½ã—ã¿ã«ã—ã¦ãŠã‚Šã¾ã™ã€‚\n\nä½•å’ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚" },
  // --- é©æ€§ãƒ†ã‚¹ãƒˆ ---
  { id: "t07", category: "é©æ€§ãƒ†ã‚¹ãƒˆ", label: "é©æ€§ãƒ†ã‚¹ãƒˆå—æ¤œã®ã”æ¡ˆå†…", subject: "ã€{{company}}ã€‘é©æ€§ãƒ†ã‚¹ãƒˆå—æ¤œã®ã”æ¡ˆå†…", body: "{{name}} æ§˜\n\nãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚\n{{company}}ã®æ¡ç”¨æ‹…å½“ã§ã”ã–ã„ã¾ã™ã€‚\n\né¸è€ƒã®ä¸€ç’°ã¨ã—ã¦ã€é©æ€§ãƒ†ã‚¹ãƒˆã®å—æ¤œã‚’ãŠé¡˜ã„ã—ã¦ãŠã‚Šã¾ã™ã€‚\nä¸‹è¨˜ã®è¦é ˜ã§ã”å—æ¤œãã ã•ã„ã€‚\n\nã€ãƒ†ã‚¹ãƒˆç¨®åˆ¥ã€‘â—‹â—‹\nã€å—æ¤œURLã€‘â—‹â—‹\nã€å—æ¤œæœŸé™ã€‘â—‹æœˆâ—‹æ—¥ï¼ˆâ—‹ï¼‰ã¾ã§\nã€æ‰€è¦æ™‚é–“ã€‘ç´„â—‹â—‹åˆ†\nã€å‚™è€ƒã€‘é™ã‹ãªç’°å¢ƒã§PCãƒ»ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã‹ã‚‰ã”å—æ¤œãã ã•ã„\n\nã”ä¸æ˜ãªç‚¹ãŒã”ã–ã„ã¾ã—ãŸã‚‰ãŠæ°—è»½ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚\n\nä½•å’ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚" },
  // --- äºŒæ¬¡é¢æ¥ ---
  { id: "t08", category: "äºŒæ¬¡é¢æ¥", label: "äºŒæ¬¡é¢æ¥æ—¥ç¨‹ã®ã”æ¡ˆå†…", subject: "ã€{{company}}ã€‘äºŒæ¬¡é¢æ¥æ—¥ç¨‹ã®ã”æ¡ˆå†…", body: "{{name}} æ§˜\n\nãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚\n{{company}}ã®æ¡ç”¨æ‹…å½“ã§ã”ã–ã„ã¾ã™ã€‚\n\nä¸€æ¬¡é¢æ¥ã®çµæœã€ãœã²äºŒæ¬¡é¢æ¥ã«ãŠé€²ã¿ã„ãŸã ããŸãã”é€£çµ¡ã„ãŸã—ã¾ã—ãŸã€‚\n\nã€å€™è£œæ—¥æ™‚ã€‘\nâ‘  â—‹æœˆâ—‹æ—¥ï¼ˆâ—‹ï¼‰â—‹:â—‹â—‹ã€œ\nâ‘¡ â—‹æœˆâ—‹æ—¥ï¼ˆâ—‹ï¼‰â—‹:â—‹â—‹ã€œ\nâ‘¢ â—‹æœˆâ—‹æ—¥ï¼ˆâ—‹ï¼‰â—‹:â—‹â—‹ã€œ\n\nã€å ´æ‰€ã€‘â—‹â—‹\nã€æ‰€è¦æ™‚é–“ã€‘ç´„60åˆ†\nã€é¢æ¥å®˜ã€‘â—‹â—‹éƒ¨ éƒ¨é•· â—‹â—‹\n\nã”éƒ½åˆã‚’ãŠçŸ¥ã‚‰ã›ã„ãŸã ã‘ã¾ã™ã¨å¹¸ã„ã§ã™ã€‚\n\nä½•å’ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚" },
  // --- æœ€çµ‚é¢æ¥ ---
  { id: "t09", category: "æœ€çµ‚é¢æ¥", label: "æœ€çµ‚é¢æ¥æ—¥ç¨‹ã®ã”æ¡ˆå†…", subject: "ã€{{company}}ã€‘æœ€çµ‚é¢æ¥æ—¥ç¨‹ã®ã”æ¡ˆå†…", body: "{{name}} æ§˜\n\nãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚\n{{company}}ã®æ¡ç”¨æ‹…å½“ã§ã”ã–ã„ã¾ã™ã€‚\n\näºŒæ¬¡é¢æ¥ã®çµæœã‚’è¸ã¾ãˆã€ãœã²æœ€çµ‚é¢æ¥ã«ãŠé€²ã¿ã„ãŸã ããŸãã”é€£çµ¡ã„ãŸã—ã¾ã—ãŸã€‚\n\nã€å€™è£œæ—¥æ™‚ã€‘\nâ‘  â—‹æœˆâ—‹æ—¥ï¼ˆâ—‹ï¼‰â—‹:â—‹â—‹ã€œ\nâ‘¡ â—‹æœˆâ—‹æ—¥ï¼ˆâ—‹ï¼‰â—‹:â—‹â—‹ã€œ\n\nã€å ´æ‰€ã€‘â—‹â—‹ï¼ˆæœ¬ç¤¾ï¼‰\nã€æ‰€è¦æ™‚é–“ã€‘ç´„45åˆ†\nã€é¢æ¥å®˜ã€‘ä»£è¡¨å–ç· å½¹ â—‹â—‹\n\nãŠå¿™ã—ã„ã¨ã“ã‚æã‚Œå…¥ã‚Šã¾ã™ãŒã€ã”éƒ½åˆã‚’ãŠçŸ¥ã‚‰ã›ãã ã•ã„ã€‚\n\nä½•å’ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚" },
  // --- å†…å®š ---
  { id: "t10", category: "å†…å®š", label: "å†…å®šé€šçŸ¥", subject: "ã€{{company}}ã€‘å†…å®šã®ã”é€£çµ¡", body: "{{name}} æ§˜\n\nãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚\n{{company}}ã®æ¡ç”¨æ‹…å½“ã§ã”ã–ã„ã¾ã™ã€‚\n\næ…é‡ã«é¸è€ƒã‚’é‡ã­ã¾ã—ãŸçµæœã€{{name}}æ§˜ã«å†…å®šã‚’ãŠå‡ºã—ã•ã›ã¦ã„ãŸã ãé‹ã³ã¨ãªã‚Šã¾ã—ãŸã€‚\nå¿ƒã‚ˆã‚ŠãŠç¥ã„ç”³ã—ä¸Šã’ã¾ã™ã€‚\n\nå…¥ç¤¾æ¡ä»¶ç­‰ã®è©³ç´°ã«ã¤ãã¾ã—ã¦ã¯ã€\nåˆ¥é€”ã€Œå†…å®šé€šçŸ¥æ›¸ã€ã‚’ãŠé€ã‚Šã„ãŸã—ã¾ã™ã®ã§ã”ç¢ºèªãã ã•ã„ã€‚\n\nã€å›ç­”æœŸé™ã€‘â—‹æœˆâ—‹æ—¥ï¼ˆâ—‹ï¼‰ã¾ã§\n\nã”ä¸æ˜ãªç‚¹ã‚„ã”ç›¸è«‡ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€\nã„ã¤ã§ã‚‚ãŠæ°—è»½ã«ã”é€£çµ¡ãã ã•ã„ã€‚\n\n{{name}}æ§˜ã¨ä¸€ç·’ã«åƒã‘ã‚‹ã“ã¨ã‚’æ¥½ã—ã¿ã«ã—ã¦ãŠã‚Šã¾ã™ã€‚\n\nä½•å’ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚" },
  { id: "t11", category: "å†…å®š", label: "å†…å®šå¾Œãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—", subject: "ã€{{company}}ã€‘å…¥ç¤¾ã«å‘ã‘ãŸã”æ¡ˆå†…", body: "{{name}} æ§˜\n\nãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚\n{{company}}ã®æ¡ç”¨æ‹…å½“ã§ã”ã–ã„ã¾ã™ã€‚\n\nå†…å®šã®ã”æ‰¿è«¾ã‚’ã„ãŸã ãã€èª ã«ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚\nå…¥ç¤¾ã«å‘ã‘ã¦ã€ã„ãã¤ã‹ã”æ¡ˆå†…ãŒã”ã–ã„ã¾ã™ã€‚\n\nã€å…¥ç¤¾æ—¥ã€‘â—‹æœˆâ—‹æ—¥ï¼ˆâ—‹ï¼‰\nã€å…¥ç¤¾æ™‚ã®æŒã¡ç‰©ã€‘\nãƒ»èº«åˆ†è¨¼æ˜æ›¸\nãƒ»å°é‘‘\nãƒ»â—‹â—‹\n\nã€äº‹å‰æå‡ºæ›¸é¡ã€‘\nãƒ»â—‹â—‹\n\nå…¥ç¤¾ã¾ã§ã®é–“ã«ã”ä¸å®‰ãªç‚¹ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€\nã„ã¤ã§ã‚‚ã”é€£çµ¡ãã ã•ã„ã€‚\n\nãŠä¼šã„ã§ãã‚‹æ—¥ã‚’æ¥½ã—ã¿ã«ã—ã¦ãŠã‚Šã¾ã™ã€‚\n\nä½•å’ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚" },
  // --- å†…å®šæ‰¿è«¾ ---
  { id: "t12", category: "å†…å®šæ‰¿è«¾", label: "å…¥ç¤¾æ‰‹ç¶šãã®ã”æ¡ˆå†…", subject: "ã€{{company}}ã€‘å…¥ç¤¾æ‰‹ç¶šãã«ã¤ã„ã¦ã®ã”æ¡ˆå†…", body: "{{name}} æ§˜\n\nãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚\n{{company}}ã®æ¡ç”¨æ‹…å½“ã§ã”ã–ã„ã¾ã™ã€‚\n\nå†…å®šæ‰¿è«¾ã®ã”é€£çµ¡ã‚’ã„ãŸã ãã€èª ã«ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚\nå…¥ç¤¾ã«å‘ã‘ã¦ã€ä¸‹è¨˜ã®æ‰‹ç¶šãã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚\n\nã€æå‡ºæ›¸é¡ã€‘\n1. å…¥ç¤¾èª“ç´„æ›¸ï¼ˆåŒå°ï¼‰\n2. èº«å…ƒä¿è¨¼æ›¸\n3. çµ¦ä¸æŒ¯è¾¼å£åº§å±Š\n4. å¹´é‡‘æ‰‹å¸³ã®ã‚³ãƒ”ãƒ¼\n5. æºæ³‰å¾´åç¥¨ï¼ˆå‰è·ãŒã‚ã‚‹å ´åˆï¼‰\n\nã€æå‡ºæœŸé™ã€‘â—‹æœˆâ—‹æ—¥ï¼ˆâ—‹ï¼‰ã¾ã§\nã€æå‡ºæ–¹æ³•ã€‘éƒµé€ or ãƒ¡ãƒ¼ãƒ«æ·»ä»˜\n\nãã®ä»–ã”ä¸æ˜ãªç‚¹ãŒã”ã–ã„ã¾ã—ãŸã‚‰\nãŠæ°—è»½ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚\n\nä½•å’ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚" },
  // --- å…±é€šï¼ˆä¸åˆæ ¼ãƒ»è¾é€€ï¼‰ ---
  { id: "t13", category: "å…±é€š", label: "é¸è€ƒçµæœï¼ˆä¸åˆæ ¼ï¼‰ã®ã”é€£çµ¡", subject: "ã€{{company}}ã€‘é¸è€ƒçµæœã®ã”é€£çµ¡", body: "{{name}} æ§˜\n\nãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚\n{{company}}ã®æ¡ç”¨æ‹…å½“ã§ã”ã–ã„ã¾ã™ã€‚\n\nã“ã®åº¦ã¯å¼Šç¤¾ã®é¸è€ƒã«ã”å‚åŠ ã„ãŸã ãã€\nèª ã«ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚\n\næ…é‡ã«æ¤œè¨ã„ãŸã—ã¾ã—ãŸçµæœã€\nèª ã«æ®‹å¿µã§ã¯ã”ã–ã„ã¾ã™ãŒã€ä»Šå›ã¯ã”æœŸå¾…ã«æ²¿ãˆãªã„çµæœã¨ãªã‚Šã¾ã—ãŸã€‚\n\n{{name}}æ§˜ã®ä»Šå¾Œã®ã”æ´»èºã‚’å¿ƒã‚ˆã‚ŠãŠç¥ˆã‚Šç”³ã—ä¸Šã’ã¾ã™ã€‚\n\nä½•å’ã”äº†æ‰¿ã„ãŸã ã‘ã¾ã™ã‚ˆã†ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚" },
  { id: "t14", category: "å…±é€š", label: "é¸è€ƒè¾é€€ã®å—ç†", subject: "ã€{{company}}ã€‘é¸è€ƒè¾é€€ã®å—ç†ã«ã¤ã„ã¦", body: "{{name}} æ§˜\n\nãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚\n{{company}}ã®æ¡ç”¨æ‹…å½“ã§ã”ã–ã„ã¾ã™ã€‚\n\né¸è€ƒè¾é€€ã®ã”é€£çµ¡ã‚’æ‰¿ã‚Šã¾ã—ãŸã€‚\nãŠå¿™ã—ã„ä¸­ã”é€£çµ¡ã„ãŸã ãã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚\n\nã¾ãŸã”ç¸ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€ãœã²ãŠæ°—è»½ã«ã”å¿œå‹Ÿãã ã•ã„ã€‚\n{{name}}æ§˜ã®ä»Šå¾Œã®ã”æ´»èºã‚’å¿ƒã‚ˆã‚ŠãŠç¥ˆã‚Šç”³ã—ä¸Šã’ã¾ã™ã€‚\n\nä½•å’ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚" },
  { id: "t15", category: "å…±é€š", label: "é¸è€ƒã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å¤‰æ›´ã®ãŠé¡˜ã„", subject: "ã€{{company}}ã€‘é¸è€ƒã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å¤‰æ›´ã®ãŠé¡˜ã„", body: "{{name}} æ§˜\n\nãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚\n{{company}}ã®æ¡ç”¨æ‹…å½“ã§ã”ã–ã„ã¾ã™ã€‚\n\nå¤§å¤‰ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ãŒã€\nè«¸äº‹æƒ…ã«ã‚ˆã‚Šé¸è€ƒã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å¤‰æ›´ã•ã›ã¦ã„ãŸã ããŸãã”é€£çµ¡ã„ãŸã—ã¾ã—ãŸã€‚\n\nã€å¤‰æ›´å†…å®¹ã€‘\nï¼ˆæ—§ï¼‰â—‹æœˆâ—‹æ—¥ï¼ˆâ—‹ï¼‰â—‹:â—‹â—‹\nï¼ˆæ–°ï¼‰â—‹æœˆâ—‹æ—¥ï¼ˆâ—‹ï¼‰â—‹:â—‹â—‹\n\nã”è¿·æƒ‘ã‚’ãŠã‹ã‘ã—èª ã«æç¸®ã§ã™ãŒã€\nã”äº†æ‰¿ã„ãŸã ã‘ã¾ã™ã¨å¹¸ã„ã§ã™ã€‚\n\nä½•å’ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚" },
  { id: "t16", category: "å…±é€š", label: "é¸è€ƒé€šéã®ã”é€£çµ¡ï¼ˆæ±ç”¨ï¼‰", subject: "ã€{{company}}ã€‘é¸è€ƒçµæœã®ã”é€£çµ¡", body: "{{name}} æ§˜\n\nãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚\n{{company}}ã®æ¡ç”¨æ‹…å½“ã§ã”ã–ã„ã¾ã™ã€‚\n\nå…ˆæ—¥ã®é¸è€ƒçµæœã«ã¤ã„ã¦ã”é€£çµ¡ã„ãŸã—ã¾ã™ã€‚\næ…é‡ã«æ¤œè¨ã„ãŸã—ã¾ã—ãŸçµæœã€\nãœã²æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã«ãŠé€²ã¿ã„ãŸã ããŸãå­˜ã˜ã¾ã™ã€‚\n\næ¬¡å›ã®é¸è€ƒã«ã¤ã„ã¦ã¯ã€æ”¹ã‚ã¦ã”æ¡ˆå†…ã„ãŸã—ã¾ã™ã€‚\n\nä½•å’ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚" },
];

// å…±é€šã®é›¢è„±ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¤å®š
const EXIT_STATUSES = ["è¾é€€", "ä¸åˆæ ¼", "ä¿ç•™", "æ‰¿è«¾å¾Œè¾é€€"];
const isExitStatus = (sub) => EXIT_STATUSES.includes(sub);

// å€™è£œè€…ã®stageã‹ã‚‰ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚¹ãƒ†ãƒ¼ã‚¸IDã¸ã®ãƒãƒƒãƒ”ãƒ³ã‚°
function candidateToStageId(stage) {
  if (!stage) return "entry";
  for (const def of STAGE_DEFINITIONS) {
    if (stage === def.name) return def.id;
    if (stage.startsWith(def.name)) return def.id;
  }
  // ãƒ¬ã‚¬ã‚·ãƒ¼ãƒãƒƒãƒ”ãƒ³ã‚°
  if (stage.includes("ã‚¨ãƒ³ãƒˆãƒªãƒ¼")) return "entry";
  if (stage.includes("èª¬æ˜ä¼š")) return "briefing";
  if (stage.includes("1æ¬¡") || stage.includes("ä¸€æ¬¡")) return "interview1";
  if (stage.includes("é©æ€§")) return "aptitude";
  if (stage.includes("2æ¬¡") || stage.includes("äºŒæ¬¡")) return "interview2";
  if (stage.includes("æœ€çµ‚")) return "final";
  if (stage.includes("å†…å®šæ‰¿è«¾") || stage.includes("æ‰¿è«¾")) return "accepted";
  if (stage.includes("å†…å®š")) return "offer";
  return "entry";
}

// ãƒ¬ã‚¬ã‚·ãƒ¼äº’æ›ãƒãƒƒãƒ”ãƒ³ã‚°
const PIPELINE_STAGE_MAP = {};
STAGE_DEFINITIONS.forEach(s => { PIPELINE_STAGE_MAP[s.name] = s.name; });
const CANDIDATE_TO_PIPELINE = {};
Object.entries(PIPELINE_STAGE_MAP).forEach(([k, v]) => { CANDIDATE_TO_PIPELINE[v] = k; });

const CANDIDATES = [
  // æ–°å’  â€» format: é¢æ¥ãƒ»é¸è€ƒã®å®Ÿæ–½å½¢æ…‹ï¼ˆ"WEB" / "å¯¾é¢" / nullï¼‰  â€» substatus: ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å†…ã‚µãƒ–ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  { id: 1, recruitType: "æ–°å’", lastName: "å±±ç”°", firstName: "èŠ±å­", university: "æ±äº¬å¤§å­¦", faculty: "çµŒæ¸ˆå­¦éƒ¨", gradYear: 2027, majorType: "æ–‡ç³»", company: null, position: null, experience: null, stage: "äºŒæ¬¡é¢æ¥", substatus: "äºˆç´„æ¸ˆ", status: "äºˆå®š", format: "å¯¾é¢", email: "hanako@example.com", phone: "090-1234-5678", route: "ãƒªã‚¯ãƒŠãƒ“", aspiration: 4, agent: "â—‹â—‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ", gender: "å¥³æ€§", score: 4.2, createdAt: "2026/01/15" },
  { id: 2, recruitType: "æ–°å’", lastName: "ä½è—¤", firstName: "å¤ªéƒ", university: "æ…¶æ‡‰ç¾©å¡¾å¤§å­¦", faculty: "æ³•å­¦éƒ¨", gradYear: 2027, majorType: "æ–‡ç³»", company: null, position: null, experience: null, stage: "ä¸€æ¬¡é¢æ¥", substatus: "åˆæ ¼", status: "é€šé", format: "WEB", email: "taro@example.com", phone: "090-2345-6789", route: "ãƒã‚¤ãƒŠãƒ“", aspiration: 5, agent: null, gender: "ç”·æ€§", score: 3.8, createdAt: "2026/01/18" },
  { id: 3, recruitType: "æ–°å’", lastName: "éˆ´æœ¨", firstName: "ç¾å’²", university: "æ—©ç¨²ç”°å¤§å­¦", faculty: "å•†å­¦éƒ¨", gradYear: 2027, majorType: "æ–‡ç³»", company: null, position: null, experience: null, stage: "èª¬æ˜ä¼š", substatus: "æ¡ˆå†…æ¸ˆ", status: "æ¡ˆå†…æ¸ˆ", format: null, email: "misaki@example.com", phone: "090-3456-7890", route: "ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ", aspiration: 3, agent: "â–³â–³äººæ", gender: "å¥³æ€§", score: null, createdAt: "2026/02/01" },
  { id: 4, recruitType: "æ–°å’", lastName: "ç”°ä¸­", firstName: "å¥ä¸€", university: "äº¬éƒ½å¤§å­¦", faculty: "å·¥å­¦éƒ¨", gradYear: 2027, majorType: "ç†ç³»", company: null, position: null, experience: null, stage: "æœ€çµ‚é¢æ¥", substatus: "äºˆç´„æ¸ˆ", status: "äºˆå®š", format: "å¯¾é¢", email: "kenichi@example.com", phone: "090-4567-8901", route: "ãƒªã‚¯ãƒŠãƒ“", aspiration: 5, agent: null, gender: "ç”·æ€§", score: 4.5, createdAt: "2026/01/10" },
  { id: 5, recruitType: "æ–°å’", lastName: "é«˜æ©‹", firstName: "ã•ãã‚‰", university: "ä¸Šæ™ºå¤§å­¦", faculty: "æ–‡å­¦éƒ¨", gradYear: 2027, majorType: "æ–‡ç³»", company: null, position: null, experience: null, stage: "å†…å®š", substatus: "æ‰¿è«¾", status: "æ‰¿è«¾å¾…ã¡", format: null, email: "sakura@example.com", phone: "090-5678-9012", route: "ãƒã‚¤ãƒŠãƒ“", aspiration: 5, agent: null, gender: "å¥³æ€§", score: 4.7, createdAt: "2025/12/20" },
  { id: 6, recruitType: "æ–°å’", lastName: "ä¼Šè—¤", firstName: "å¤§è¼", university: "æ±åŒ—å¤§å­¦", faculty: "ç†å­¦éƒ¨", gradYear: 2027, majorType: "ç†ç³»", company: null, position: null, experience: null, stage: "ã‚¨ãƒ³ãƒˆãƒªãƒ¼", substatus: "å—ä»˜æ¸ˆ", status: "æ–°è¦", format: null, email: "daiki@example.com", phone: "090-6789-0123", route: "ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ", aspiration: 2, agent: "â–¡â–¡ã‚­ãƒ£ãƒªã‚¢", gender: "ç”·æ€§", score: null, createdAt: "2026/02/24" },
  { id: 7, recruitType: "æ–°å’", lastName: "æ¸¡è¾º", firstName: "æ„›", university: "ä¸€æ©‹å¤§å­¦", faculty: "ç¤¾ä¼šå­¦éƒ¨", gradYear: 2027, majorType: "æ–‡ç³»", company: null, position: null, experience: null, stage: "ä¸€æ¬¡é¢æ¥", substatus: "æ¬ å¸­", status: "ä¸åˆæ ¼", format: "WEB", email: "ai@example.com", phone: "090-7890-1234", route: "ãƒªã‚¯ãƒŠãƒ“", aspiration: 3, agent: null, gender: "å¥³æ€§", score: 2.8, createdAt: "2026/01/22" },
  { id: 8, recruitType: "æ–°å’", lastName: "ä¸­æ‘", firstName: "ç¿”", university: "å¤§é˜ªå¤§å­¦", faculty: "çµŒæ¸ˆå­¦éƒ¨", gradYear: 2027, majorType: "æ–‡ç³»", company: null, position: null, experience: null, stage: "äºŒæ¬¡é¢æ¥", substatus: "åˆæ ¼", status: "é€šé", format: "WEB", email: "sho@example.com", phone: "090-8901-2345", route: "ãƒã‚¤ãƒŠãƒ“", aspiration: 4, agent: null, gender: "ç”·æ€§", score: 4.0, createdAt: "2026/01/12" },
  // æ–°å’è¿½åŠ ï¼ˆèª¬æ˜ä¼šãƒ•ãƒ­ãƒ¼ï¼‰
  { id: 15, recruitType: "æ–°å’", lastName: "è—¤ç”°", firstName: "å„ªèŠ±", university: "æ˜æ²»å¤§å­¦", faculty: "æ”¿æ²»çµŒæ¸ˆå­¦éƒ¨", gradYear: 2027, majorType: "æ–‡ç³»", company: null, position: null, experience: null, stage: "èª¬æ˜ä¼š", substatus: "æ¡ˆå†…æ¸ˆ", status: "æ¡ˆå†…æ¸ˆ", format: null, email: "yuka@example.com", phone: "090-1122-3344", route: "ãƒªã‚¯ãƒŠãƒ“", aspiration: 3, agent: null, gender: "å¥³æ€§", score: null, createdAt: "2026/02/20" },
  { id: 16, recruitType: "æ–°å’", lastName: "å±±å£", firstName: "æ‹“æµ·", university: "ç«‹å‘½é¤¨å¤§å­¦", faculty: "ç†å·¥å­¦éƒ¨", gradYear: 2027, majorType: "ç†ç³»", company: null, position: null, experience: null, stage: "èª¬æ˜ä¼š", substatus: "äºˆç´„æ¸ˆ", status: "äºˆç´„æ¸ˆ", format: "WEB", email: "takumi@example.com", phone: "090-2233-4455", route: "ãƒã‚¤ãƒŠãƒ“", aspiration: 4, agent: null, gender: "ç”·æ€§", score: null, createdAt: "2026/02/18" },
  { id: 17, recruitType: "æ–°å’", lastName: "çŸ³äº•", firstName: "ä¸ƒæµ·", university: "é’å±±å­¦é™¢å¤§å­¦", faculty: "çµŒå–¶å­¦éƒ¨", gradYear: 2027, majorType: "æ–‡ç³»", company: null, position: null, experience: null, stage: "èª¬æ˜ä¼š", substatus: "å‚åŠ ", status: "å‚åŠ æ¸ˆ", format: "WEB", email: "nanami@example.com", phone: "090-3344-5566", route: "ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ", aspiration: 4, agent: "â—‹â—‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ", gender: "å¥³æ€§", score: null, createdAt: "2026/02/10" },
  { id: 18, recruitType: "æ–°å’", lastName: "å‰ç”°", firstName: "é™¸", university: "ä¸­å¤®å¤§å­¦", faculty: "æ³•å­¦éƒ¨", gradYear: 2027, majorType: "æ–‡ç³»", company: null, position: null, experience: null, stage: "èª¬æ˜ä¼š", substatus: "æ¡ˆå†…æ¸ˆ", status: "æ¡ˆå†…æ¸ˆ", format: null, email: "riku@example.com", phone: "090-4455-6677", route: "ãƒªã‚¯ãƒŠãƒ“", aspiration: 2, agent: null, gender: "ç”·æ€§", score: null, createdAt: "2026/02/22" },
  { id: 19, recruitType: "æ–°å’", lastName: "å²¡ç”°", firstName: "ã‚ãŠã„", university: "æ³•æ”¿å¤§å­¦", faculty: "ç¤¾ä¼šå­¦éƒ¨", gradYear: 2027, majorType: "æ–‡ç³»", company: null, position: null, experience: null, stage: "èª¬æ˜ä¼š", substatus: "äºˆç´„æ¸ˆ", status: "äºˆç´„æ¸ˆ", format: "å¯¾é¢", email: "aoi@example.com", phone: "090-5566-7788", route: "ãƒã‚¤ãƒŠãƒ“", aspiration: 3, agent: null, gender: "å¥³æ€§", score: null, createdAt: "2026/02/19" },
  { id: 20, recruitType: "æ–°å’", lastName: "æ£®", firstName: "æ‚ æ–—", university: "ç­‘æ³¢å¤§å­¦", faculty: "æƒ…å ±å­¦ç¾¤", gradYear: 2027, majorType: "ç†ç³»", company: null, position: null, experience: null, stage: "ä¸€æ¬¡é¢æ¥", substatus: "æ¡ˆå†…æ¸ˆ", status: "æ¡ˆå†…æ¸ˆ", format: null, email: "yuto@example.com", phone: "090-6677-8899", route: "ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ", aspiration: 4, agent: "â–³â–³äººæ", gender: "ç”·æ€§", score: null, createdAt: "2026/02/15" },
  { id: 21, recruitType: "æ–°å’", lastName: "æ± ç”°", firstName: "çµè¡£", university: "ç¥æˆ¸å¤§å­¦", faculty: "çµŒæ¸ˆå­¦éƒ¨", gradYear: 2027, majorType: "æ–‡ç³»", company: null, position: null, experience: null, stage: "äºŒæ¬¡é¢æ¥", substatus: "æ¡ˆå†…æ¸ˆ", status: "æ¡ˆå†…æ¸ˆ", format: null, email: "yui@example.com", phone: "090-7788-9900", route: "ãƒªã‚¯ãƒŠãƒ“", aspiration: 5, agent: null, gender: "å¥³æ€§", score: null, createdAt: "2026/02/12" },
  { id: 22, recruitType: "æ–°å’", lastName: "åŸ", firstName: "è“®", university: "ä¹å·å¤§å­¦", faculty: "å·¥å­¦éƒ¨", gradYear: 2027, majorType: "ç†ç³»", company: null, position: null, experience: null, stage: "å†…å®š", substatus: "å†…å®šé€šçŸ¥", status: "å†…å®šé€šçŸ¥", format: null, email: "ren@example.com", phone: "090-8899-0011", route: "ãƒã‚¤ãƒŠãƒ“", aspiration: 4, agent: null, gender: "ç”·æ€§", score: 4.3, createdAt: "2026/01/08" },
  // ä¸­é€”
  { id: 9, recruitType: "ä¸­é€”", lastName: "æ¾æœ¬", firstName: "å¤§ä»‹", university: null, faculty: null, gradYear: null, majorType: null, company: "æ ªå¼ä¼šç¤¾ãƒªã‚¯ãƒ«ãƒ¼ãƒˆ", position: "å–¶æ¥­ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼", experience: 8, stage: "äºŒæ¬¡é¢æ¥", substatus: "äºˆç´„æ¸ˆ", status: "äºˆå®š", format: "å¯¾é¢", email: "daisuke@example.com", phone: "090-1111-2222", route: "ãƒ“ã‚ºãƒªãƒ¼ãƒ", aspiration: 4, agent: "â—â—ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ", gender: "ç”·æ€§", score: 4.3, createdAt: "2026/02/10" },
  { id: 10, recruitType: "ä¸­é€”", lastName: "å°æ—", firstName: "ç”±ç¾", university: null, faculty: null, gradYear: null, majorType: null, company: "ã‚¢ã‚¯ã‚»ãƒ³ãƒãƒ¥ã‚¢æ ªå¼ä¼šç¤¾", position: "ã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆ", experience: 5, stage: "ä¸€æ¬¡é¢æ¥", substatus: "åˆæ ¼", status: "é€šé", format: "WEB", email: "yumi@example.com", phone: "090-2222-3333", route: "ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ", aspiration: 5, agent: "â˜…â˜…ã‚­ãƒ£ãƒªã‚¢", gender: "å¥³æ€§", score: 4.1, createdAt: "2026/02/05" },
  { id: 11, recruitType: "ä¸­é€”", lastName: "åŠ è—¤", firstName: "ç¿”å¤ª", university: null, faculty: null, gradYear: null, majorType: null, company: "ã‚µã‚¤ãƒãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ", position: "Webã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢", experience: 3, stage: "èª¬æ˜ä¼š", substatus: "å‚åŠ ", status: "å‚åŠ æ¸ˆ", format: "WEB", email: "shota@example.com", phone: "090-3333-4444", route: "Green", aspiration: 3, agent: null, gender: "ç”·æ€§", score: null, createdAt: "2026/02/15" },
  { id: 12, recruitType: "ä¸­é€”", lastName: "æœ¨æ‘", firstName: "éº»è¡£", university: null, faculty: null, gradYear: null, majorType: null, company: "ãƒ‡ãƒ­ã‚¤ãƒˆãƒˆãƒ¼ãƒãƒ„", position: "ã‚·ãƒ‹ã‚¢ã‚¢ãƒŠãƒªã‚¹ãƒˆ", experience: 6, stage: "æœ€çµ‚é¢æ¥", substatus: "äºˆç´„æ¸ˆ", status: "äºˆå®š", format: "å¯¾é¢", email: "mai@example.com", phone: "090-4444-5555", route: "ãƒ“ã‚ºãƒªãƒ¼ãƒ", aspiration: 5, agent: null, gender: "å¥³æ€§", score: 4.6, createdAt: "2026/01/28" },
  { id: 13, recruitType: "ä¸­é€”", lastName: "å‰ç”°", firstName: "å¥å¤ª", university: null, faculty: null, gradYear: null, majorType: null, company: "æ¥½å¤©ã‚°ãƒ«ãƒ¼ãƒ—", position: "ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼", experience: 10, stage: "ã‚¨ãƒ³ãƒˆãƒªãƒ¼", substatus: "å—ä»˜æ¸ˆ", status: "æ–°è¦", format: null, email: "kenta@example.com", phone: "090-5555-6666", route: "ãƒªãƒ•ã‚¡ãƒ©ãƒ«", aspiration: 4, agent: null, gender: "ç”·æ€§", score: null, createdAt: "2026/02/22" },
  { id: 14, recruitType: "ä¸­é€”", lastName: "æ–‰è—¤", firstName: "ã‚ã‹ã‚Š", university: null, faculty: null, gradYear: null, majorType: null, company: "ãƒ‘ãƒ¼ã‚½ãƒ«ã‚­ãƒ£ãƒªã‚¢", position: "äººäº‹", experience: 4, stage: "å†…å®š", substatus: "æ‰¿è«¾", status: "æ‰¿è«¾å¾…ã¡", format: null, email: "akari@example.com", phone: "090-6666-7777", route: "ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ", aspiration: 5, agent: "â—â—ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ", gender: "å¥³æ€§", score: 4.4, createdAt: "2026/01/05" },
  { id: 23, recruitType: "ä¸­é€”", lastName: "è¥¿æ‘", firstName: "å¥", university: null, faculty: null, gradYear: null, majorType: null, company: "ãƒãƒƒã‚­ãƒ³ã‚¼ãƒ¼", position: "ã‚¢ã‚½ã‚·ã‚¨ã‚¤ãƒˆ", experience: 4, stage: "èª¬æ˜ä¼š", substatus: "æ¡ˆå†…æ¸ˆ", status: "æ¡ˆå†…æ¸ˆ", format: null, email: "ken@example.com", phone: "090-9900-1122", route: "ãƒ“ã‚ºãƒªãƒ¼ãƒ", aspiration: 3, agent: null, gender: "ç”·æ€§", score: null, createdAt: "2026/02/21" },
];

const PIPELINE_STAGES = STAGE_DEFINITIONS.map(s => ({ name: s.name, count: 0, active: 0, color: s.color }));

const FUNNEL_DATA = STAGE_DEFINITIONS.map(s => ({ stage: s.name, value: 0 }));

const MONTHLY_TREND = [
  { month: "10æœˆ", entries: 45, passes: 30, offers: 0 },
  { month: "11æœˆ", entries: 82, passes: 55, offers: 0 },
  { month: "12æœˆ", entries: 120, passes: 78, offers: 1 },
  { month: "1æœˆ", entries: 210, passes: 145, offers: 3 },
  { month: "2æœˆ", entries: 180, passes: 120, offers: 5 },
  { month: "3æœˆ", entries: 114, passes: 0, offers: 3 },
];

const EVALUATOR_BIAS = [
  { name: "å®‰å²¡", avg: 3.8, passRate: 72, tendency: "å¹³å‡", variance: 0.8, count: 45 },
  { name: "éˆ´æœ¨", avg: 4.2, passRate: 85, tendency: "ç”˜ã‚", variance: 0.5, count: 38 },
  { name: "ç”°ä¸­éƒ¨é•·", avg: 3.2, passRate: 55, tendency: "è¾›ã‚", variance: 1.2, count: 22 },
  { name: "ä½è—¤", avg: 3.9, passRate: 70, tendency: "å¹³å‡", variance: 0.6, count: 30 },
];

const RADAR_DATA = [
  { subject: "ã‚³ãƒŸãƒ¥åŠ›", a: 3.8, b: 4.5, c: 3.2 },
  { subject: "è«–ç†åŠ›", a: 4.0, b: 3.5, c: 4.3 },
  { subject: "å¿—æœ›åº¦", a: 3.5, b: 4.3, c: 2.8 },
  { subject: "é©æ€§", a: 3.8, b: 4.0, c: 3.5 },
  { subject: "ã‚¹ã‚­ãƒ«", a: 4.0, b: 4.2, c: 3.0 },
];

const AUTOMATION_TRIGGERS = [
  { id: 1, name: "ã‚¨ãƒ³ãƒˆãƒªãƒ¼å®Œäº† â†’ ã‚µãƒ³ã‚¯ã‚¹ãƒ¡ãƒ¼ãƒ«", trigger: "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒã€Œã‚¨ãƒ³ãƒˆãƒªãƒ¼ã€ã«å¤‰æ›´", target: "å€™è£œè€…", delay: "å³æ™‚", channels: ["ãƒ¡ãƒ¼ãƒ«", "LINE"], active: true },
  { id: 2, name: "æ›¸é¡é¸è€ƒé€šé â†’ ä¸€æ¬¡é¢æ¥æ¡ˆå†…", trigger: "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒã€Œæ›¸é¡é¸è€ƒé€šéã€ã«å¤‰æ›´", target: "å€™è£œè€…", delay: "30åˆ†å¾Œ", channels: ["ãƒ¡ãƒ¼ãƒ«", "LINE"], active: true },
  { id: 3, name: "é¢æ¥å‰æ—¥ãƒªãƒã‚¤ãƒ³ãƒ‰", trigger: "é¢æ¥äºˆå®šæ—¥ã®24æ™‚é–“å‰", target: "å€™è£œè€… + é¢æ¥å®˜", delay: "è‡ªå‹•", channels: ["ãƒ¡ãƒ¼ãƒ«", "LINE"], active: true },
  { id: 4, name: "é¢æ¥ç›´å‰ãƒªãƒã‚¤ãƒ³ãƒ‰", trigger: "é¢æ¥äºˆå®šæ—¥ã®1æ™‚é–“å‰", target: "å€™è£œè€… + é¢æ¥å®˜", delay: "è‡ªå‹•", channels: ["LINE"], active: true },
  { id: 5, name: "ä¸åˆæ ¼é€šçŸ¥", trigger: "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒã€Œä¸åˆæ ¼ã€ã«å¤‰æ›´", target: "å€™è£œè€…", delay: "1æ™‚é–“å¾Œ", channels: ["ãƒ¡ãƒ¼ãƒ«"], active: true },
  { id: 6, name: "FBæœªå…¥åŠ›ãƒªãƒã‚¤ãƒ³ãƒ‰", trigger: "é¢æ¥å®Œäº†å¾Œ24æ™‚é–“ã€FBãŒæœªå…¥åŠ›", target: "é¢æ¥å®˜", delay: "24æ™‚é–“ã”ã¨", channels: ["ãƒ¡ãƒ¼ãƒ«"], active: true },
  { id: 7, name: "å†…å®šé€šçŸ¥", trigger: "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒã€Œå†…å®šã€ã«å¤‰æ›´", target: "å€™è£œè€…", delay: "å³æ™‚", channels: ["ãƒ¡ãƒ¼ãƒ«", "LINE"], active: false },
];

const COLORS = ["#6366f1", "#8b5cf6", "#a855f7", "#d946ef", "#ec4899", "#f43f5e", "#10b981"];

// ============================================================
// ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸
// ============================================================
function LoginPage({ onLogin }) {
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [error, setError] = useState(null);
  const [loading, setLoading] = useState(false);

  const handleSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);
    setError(null);
    if (SUPABASE_READY) {
      const { user, error: authError } = await sbApi.signIn(email, password);
      if (authError) {
        setError("ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: " + (authError.error_description || authError.msg || JSON.stringify(authError)));
        setLoading(false);
        return;
      }
      onLogin(user);
    } else {
      // ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ï¼ˆSupabaseæœªè¨­å®šæ™‚ï¼‰
      if (email && password) {
        onLogin({ email, id: "demo" });
      } else {
        setError("ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      }
      setLoading(false);
    }
  };

  return (
    <div style={{ minHeight: "100vh", display: "flex", alignItems: "center", justifyContent: "center", background: "linear-gradient(135deg, #0d2eb5 0%, #1d4aff 50%, #3562f6 100%)" }}>
      <div style={{ background: "white", borderRadius: 20, padding: "48px 40px", width: 400, boxShadow: "0 20px 60px rgba(0,0,0,0.3)" }}>
        <div style={{ textAlign: "center", marginBottom: 32 }}>
          <img src="logo.svg" alt="Attract" style={{ width: 200, marginBottom: 4, filter: "brightness(0) saturate(100%) invert(22%) sepia(93%) saturate(4000%) hue-rotate(228deg) brightness(100%) contrast(102%)" }} />
          <div style={{ fontSize: 13, color: "#6b7280" }}>æ¡ç”¨ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </div>
        </div>
        <form onSubmit={handleSubmit}>
          <div style={{ marginBottom: 16 }}>
            <label style={{ display: "block", fontSize: 12, fontWeight: 600, color: "#374151", marginBottom: 6 }}>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
            <input type="email" value={email} onChange={e => setEmail(e.target.value)} placeholder="you@example.com"
              style={{ width: "100%", padding: "10px 14px", border: "1px solid #d1d5db", borderRadius: 10, fontSize: 14, outline: "none", boxSizing: "border-box" }} />
          </div>
          <div style={{ marginBottom: 24 }}>
            <label style={{ display: "block", fontSize: 12, fontWeight: 600, color: "#374151", marginBottom: 6 }}>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
            <input type="password" value={password} onChange={e => setPassword(e.target.value)} placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›"
              style={{ width: "100%", padding: "10px 14px", border: "1px solid #d1d5db", borderRadius: 10, fontSize: 14, outline: "none", boxSizing: "border-box" }} />
          </div>
          {error && (
            <div style={{ padding: "10px 14px", background: "#fef2f2", border: "1px solid #fecaca", borderRadius: 8, color: "#dc2626", fontSize: 12, marginBottom: 16 }}>{error}</div>
          )}
          <button type="submit" disabled={loading}
            style={{ width: "100%", padding: "12px", background: loading ? "#a5b4fc" : "#4338ca", color: "white", border: "none", borderRadius: 10, fontSize: 14, fontWeight: 600, cursor: loading ? "default" : "pointer" }}>
            {loading ? "ãƒ­ã‚°ã‚¤ãƒ³ä¸­..." : "ãƒ­ã‚°ã‚¤ãƒ³"}
          </button>
        </form>
        {!SUPABASE_READY && (
          <div style={{ marginTop: 20, padding: "12px 14px", background: "#fefce8", border: "1px solid #fde68a", borderRadius: 8, fontSize: 11, color: "#92400e" }}>
            <strong>ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰:</strong> Supabaseæœªæ¥ç¶šã®ãŸã‚ã€ä»»æ„ã®ãƒ¡ãƒ¼ãƒ«ãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã§ãã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ã¯ãƒ–ãƒ©ã‚¦ã‚¶å†…ã®ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã§ã™ã€‚
          </div>
        )}
      </div>
    </div>
  );
}

// ============================================================
// ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ•ãƒƒã‚¯
// ============================================================
function useSupabaseCandidates(recruitFilter) {
  const [candidates, setCandidates] = useState(CANDIDATES);
  const [loading, setLoading] = useState(false);

  const fetchCandidates = useCallback(async () => {
    if (!SUPABASE_READY) { setCandidates(CANDIDATES); return; }
    setLoading(true);
    let params = 'order=created_at.desc';
    if (recruitFilter !== 'all') params += '&recruit_type=eq.' + encodeURIComponent(recruitFilter);
    const { data, error } = await sbApi.select('candidates', params);
    if (!error && data) {
      // DB ã®ã‚«ãƒ©ãƒ å â†’ ãƒ•ãƒ­ãƒ³ãƒˆã®ã‚­ãƒ¼åã«ãƒãƒƒãƒ”ãƒ³ã‚°
      setCandidates(data.map(r => ({
        id: r.id,
        recruitType: r.recruit_type,
        lastName: r.last_name,
        firstName: r.first_name,
        university: r.university,
        faculty: r.faculty,
        gradYear: r.grad_year,
        majorType: r.major_type,
        company: r.company,
        position: r.position,
        experience: r.experience,
        stage: r.stage,
        substatus: r.substatus,
        status: r.status,
        format: r.format,
        email: r.email,
        phone: r.phone,
        route: r.route,
        aspiration: r.aspiration,
        agent: r.agent,
        gender: r.gender,
        score: r.score ? parseFloat(r.score) : null,
        createdAt: new Date(r.created_at).toLocaleDateString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/-/g, '/'),
        entryDate: r.entry_date || null,
        birthDate: r.birth_date || null,
        graduationPeriod: r.graduation_period || null,
        department: r.department || null,
        lastNameKana: r.last_name_kana || null,
        firstNameKana: r.first_name_kana || null,
        notes: r.notes || null,
        stageDate: r.stage_date || null,
        originalStage: r.original_stage || null,
      })));
    }
    setLoading(false);
  }, [recruitFilter]);

  useEffect(() => { fetchCandidates(); }, [fetchCandidates]);

  const addCandidate = async (newCandidate) => {
    if (!SUPABASE_READY) {
      const maxId = Math.max(...candidates.map(c => c.id));
      const withId = { ...newCandidate, id: maxId + 1, createdAt: new Date().toLocaleDateString('ja-JP').replace(/-/g, '/') };
      setCandidates(prev => [withId, ...prev]);
      return withId;
    }
    const { data, error } = await sbApi.insert('candidates', {
      recruit_type: newCandidate.recruitType,
      last_name: newCandidate.lastName,
      first_name: newCandidate.firstName,
      last_name_kana: newCandidate.lastNameKana || null,
      first_name_kana: newCandidate.firstNameKana || null,
      university: newCandidate.university || null,
      faculty: newCandidate.faculty || null,
      department: newCandidate.department || null,
      grad_year: newCandidate.gradYear || null,
      major_type: newCandidate.majorType || null,
      graduation_period: newCandidate.graduationPeriod || null,
      company: newCandidate.company || null,
      position: newCandidate.position || null,
      experience: newCandidate.experience || null,
      stage: newCandidate.stage || 'ã‚¨ãƒ³ãƒˆãƒªãƒ¼',
      substatus: newCandidate.substatus || 'å—ä»˜æ¸ˆ',
      status: newCandidate.status || 'æ–°è¦',
      format: newCandidate.format || null,
      email: newCandidate.email || null,
      phone: newCandidate.phone || null,
      route: newCandidate.route || null,
      aspiration: newCandidate.aspiration || 3,
      agent: newCandidate.agent || null,
      gender: newCandidate.gender || null,
      birth_date: newCandidate.birthDate || null,
      entry_date: newCandidate.entryDate || null,
      notes: newCandidate.notes || null,
    });
    if (!error) await fetchCandidates();
    return data;
  };

  const updateCandidate = async (id, updates) => {
    if (!SUPABASE_READY) {
      setCandidates(prev => prev.map(c => c.id === id ? { ...c, ...updates } : c));
      return;
    }
    // camelCase â†’ snake_case
    const dbUpdates = {};
    if (updates.stage !== undefined) dbUpdates.stage = updates.stage;
    if (updates.substatus !== undefined) dbUpdates.substatus = updates.substatus;
    if (updates.status !== undefined) dbUpdates.status = updates.status;
    if (updates.format !== undefined) dbUpdates.format = updates.format;
    if (updates.score !== undefined) dbUpdates.score = updates.score;
    if (updates.aspiration !== undefined) dbUpdates.aspiration = updates.aspiration;
    await sbApi.update('candidates', 'id=eq.' + id, dbUpdates);
    await fetchCandidates();
  };

  const bulkUpdateStatus = async (ids, newStatus) => {
    if (!SUPABASE_READY) {
      setCandidates(prev => prev.map(c => ids.has(c.id) ? { ...c, status: newStatus } : c));
      return;
    }
    const idList = Array.from(ids).join(',');
    await sbApi.update('candidates', 'id=in.(' + idList + ')', { status: newStatus });
    await fetchCandidates();
  };

  return { candidates, loading, addCandidate, updateCandidate, bulkUpdateStatus, refresh: fetchCandidates };
}

// ============================================================
// æ¡ç”¨åŒºåˆ†ã‚¿ãƒ–ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼‰
// ============================================================
function RecruitTypeSelector({ value, onChange }) {
  const types = [
    { id: "all", label: "å…¨ä½“", icon: "users" },
    { id: "æ–°å’", label: "æ–°å’", icon: "graduation-cap" },
    { id: "ä¸­é€”", label: "ä¸­é€”", icon: "briefcase" },
  ];
  return (
    <div style={{ display: "flex", gap: 2, background: "#eef2ff", borderRadius: 8, padding: 3 }}>
      {types.map(t => (
        <button key={t.id} onClick={() => onChange(t.id)}
          style={{ display: "flex", alignItems: "center", gap: 5, padding: "5px 14px", border: "none", borderRadius: 6, fontSize: 12, cursor: "pointer",
            background: value === t.id ? "#4338ca" : "transparent",
            color: value === t.id ? "white" : "#6366f1",
            fontWeight: value === t.id ? 600 : 400, transition: "all 0.15s" }}>
          <Icon name={t.icon} size={13} color={value === t.id ? "white" : "#6366f1"} />
          {t.label}
        </button>
      ))}
    </div>
  );
}

// ============================================================
// COMPONENTS
// ============================================================
function Sidebar({ currentPage, onNavigate, userRole = "admin", userProfile, onEditProfile }) {
  const items = [
    { id: "dashboard", icon: "home", label: "ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰" },
    { id: "candidates", icon: "users", label: "å€™è£œè€…ç®¡ç†" },
    { id: "pipeline", icon: "git-branch", label: "é¸è€ƒãƒ•ãƒ­ãƒ¼" },
    { id: "schedule", icon: "calendar", label: "ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«" },
    { id: "messages", icon: "message-square", label: "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸", requiredPermission: "sendMessage" },
    { id: "automation", icon: "zap", label: "è‡ªå‹•åŒ–è¨­å®š", requiredPermission: "editSettings" },
    { id: "agents", icon: "building", label: "ç´¹ä»‹ä¼šç¤¾" },
    { id: "analytics", icon: "bar-chart", label: "åˆ†æ" },
    { id: "tasks", icon: "check-square", label: "ã‚¿ã‚¹ã‚¯" },
    { id: "accounts", icon: "shield", label: "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†", requiredPermission: "manageAccounts" },
    { id: "settings", icon: "settings", label: "è¨­å®š", requiredPermission: "editSettings" },
  ].filter(item => !item.requiredPermission || hasPermission(userRole, item.requiredPermission));
  return (
    <div style={{ width: 220, background: "#0a1632", color: "white", display: "flex", flexDirection: "column", minHeight: "100vh", flexShrink: 0 }}>
      <div style={{ padding: "18px 14px 14px", borderBottom: "1px solid rgba(255,255,255,0.08)" }}>
        <img src="logo.svg" alt="Attract" style={{ width: "100%", maxWidth: 170, display: "block" }} />
      </div>
      <nav style={{ flex: 1, padding: "8px 0" }}>
        {items.map(item => (
          <button key={item.id} onClick={() => onNavigate(item.id)}
            style={{ width: "100%", display: "flex", alignItems: "center", gap: 10, padding: "10px 16px", border: "none", background: currentPage === item.id ? "#1d4aff" : "transparent", color: currentPage === item.id ? "white" : "rgba(255,255,255,0.6)", cursor: "pointer", fontSize: 13, textAlign: "left", transition: "all 0.15s", borderRadius: currentPage === item.id ? 0 : 0 }}>
            <Icon name={item.icon} size={18} color={currentPage === item.id ? "white" : "rgba(255,255,255,0.6)"} />
            <span>{item.label}</span>
          </button>
        ))}
      </nav>
      <div onClick={onEditProfile} style={{ padding: "12px 16px", borderTop: "1px solid rgba(255,255,255,0.08)", display: "flex", alignItems: "center", gap: 8, cursor: "pointer", transition: "background 0.15s" }} onMouseEnter={e => e.currentTarget.style.background = "rgba(255,255,255,0.06)"} onMouseLeave={e => e.currentTarget.style.background = "transparent"}>
        <div style={{ width: 32, height: 32, borderRadius: "50%", background: getRoleDef(userRole).color, display: "flex", alignItems: "center", justifyContent: "center", fontSize: 12, fontWeight: 600 }}>
          {(userProfile?.display_name || "U").charAt(0)}
        </div>
        <div style={{ flex: 1, minWidth: 0 }}>
          <div style={{ fontSize: 12, fontWeight: 500, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>{userProfile?.display_name || "ãƒ¦ãƒ¼ã‚¶ãƒ¼"}</div>
          <div style={{ fontSize: 10, color: "rgba(255,255,255,0.4)" }}>{getRoleDef(userRole).label}</div>
        </div>
        <Icon name="edit" size={12} color="rgba(255,255,255,0.3)" />
      </div>
    </div>
  );
}

function KpiCard({ label, value, change, changeType, iconName, color }) {
  return (
    <div style={{ background: "white", borderRadius: 12, padding: "18px 20px", boxShadow: "0 1px 3px rgba(0,0,0,0.08)", flex: 1, minWidth: 160 }}>
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start" }}>
        <div>
          <div style={{ fontSize: 12, color: "#6b7280", marginBottom: 4 }}>{label}</div>
          <div style={{ fontSize: 28, fontWeight: 700, color: "#111827" }}>{value}</div>
        </div>
        <div style={{ width: 40, height: 40, borderRadius: 10, background: color + "18", display: "flex", alignItems: "center", justifyContent: "center" }}>
          <Icon name={iconName} size={20} color={color} />
        </div>
      </div>
      {change !== undefined && (
        <div style={{ fontSize: 11, marginTop: 8, display: "flex", alignItems: "center", gap: 4, color: changeType === "up" ? "#10b981" : changeType === "down" ? "#ef4444" : "#6b7280" }}>
          {changeType === "up" ? <Icon name="trending-up" size={12} /> : changeType === "down" ? <Icon name="trending-down" size={12} /> : null}
          {change} ä»Šé€±
        </div>
      )}
    </div>
  );
}

// æ¡ç”¨åŒºåˆ†ãƒãƒƒã‚¸
function RecruitTypeBadge({ type }) {
  const isNew = type === "æ–°å’";
  return (
    <span style={{ fontSize: 10, fontWeight: 600, padding: "2px 8px", borderRadius: 10,
      background: isNew ? "#dbeafe" : "#fef3c7",
      color: isNew ? "#1d4ed8" : "#92400e" }}>
      {type}
    </span>
  );
}

// WEB/å¯¾é¢ãƒãƒƒã‚¸
function FormatBadge({ format }) {
  if (!format) return null;
  const isWeb = format === "WEB";
  return (
    <span style={{ fontSize: 10, fontWeight: 600, padding: "2px 8px", borderRadius: 10,
      background: isWeb ? "#ecfdf5" : "#fdf2f8",
      color: isWeb ? "#065f46" : "#9d174d",
      display: "inline-flex", alignItems: "center", gap: 3 }}>
      {isWeb ? "ğŸ’»" : "ğŸ¢"} {format}
    </span>
  );
}

// ============================================================
// PAGES
// ============================================================

function DashboardPage({ onNavigate, recruitFilter, tasks = [] }) {
  const filteredCandidates = recruitFilter === "all" ? CANDIDATES : CANDIDATES.filter(c => c.recruitType === recruitFilter);
  const newCount = CANDIDATES.filter(c => c.recruitType === "æ–°å’").length;
  const midCount = CANDIDATES.filter(c => c.recruitType === "ä¸­é€”").length;
  const today = new Date().toISOString().split("T")[0];
  const overdueTaskCount = tasks.filter(t => !t.done && t.dueAt < today).length;
  const todayTaskCount = tasks.filter(t => !t.done && t.dueAt === today).length;
  const pendingHighCount = tasks.filter(t => !t.done && t.priority === "high").length;
  const pendingTaskCount = tasks.filter(t => !t.done).length;
  const upcomingTasks = tasks.filter(t => !t.done).sort((a, b) => (a.dueAt || "9999") < (b.dueAt || "9999") ? -1 : 1).slice(0, 5);
  return (
    <div style={{ padding: 24, maxWidth: 1200 }}>
      <h1 style={{ fontSize: 22, fontWeight: 700, color: "#111827", marginBottom: 20 }}>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
      <div style={{ display: "flex", gap: 16, marginBottom: 24, flexWrap: "wrap" }}>
        <KpiCard label="ã‚¨ãƒ³ãƒˆãƒªãƒ¼ç·è¨ˆ" value="751" change="+12" changeType="up" iconName="users" color="#6366f1" />
        <KpiCard label="é¸è€ƒä¸­" value="540" change="-3" changeType="down" iconName="git-branch" color="#8b5cf6" />
        <KpiCard label="å†…å®š" value="6" change="+1" changeType="up" iconName="check-circle" color="#10b981" />
        <KpiCard label="å†…å®šæ‰¿è«¾" value="5" change="Â±0" changeType="neutral" iconName="star" color="#f59e0b" />
      </div>

      {/* æ¡ç”¨åŒºåˆ†åˆ¥ã‚µãƒãƒªãƒ¼ */}
      <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 16, marginBottom: 24 }}>
        <div style={{ background: "white", borderRadius: 12, padding: 20, boxShadow: "0 1px 3px rgba(0,0,0,0.08)" }}>
          <h3 style={{ fontSize: 14, fontWeight: 600, marginBottom: 16, display: "flex", alignItems: "center", gap: 6 }}>
            <Icon name="check-square" size={16} color="#f59e0b" /> ã‚¿ã‚¹ã‚¯çŠ¶æ³
          </h3>
          <div style={{ display: "flex", gap: 8, marginBottom: 14 }}>
            {overdueTaskCount > 0 && <span style={{ fontSize: 11, padding: "3px 10px", borderRadius: 8, background: "#fee2e2", color: "#dc2626", fontWeight: 600 }}>ğŸ”´ æœŸé™è¶…é {overdueTaskCount}ä»¶</span>}
            {todayTaskCount > 0 && <span style={{ fontSize: 11, padding: "3px 10px", borderRadius: 8, background: "#fef3c7", color: "#92400e", fontWeight: 600 }}>ğŸŸ¡ ä»Šæ—¥ãŒæœŸé™ {todayTaskCount}ä»¶</span>}
            {pendingHighCount > 0 && <span style={{ fontSize: 11, padding: "3px 10px", borderRadius: 8, background: "#eef2ff", color: "#4338ca", fontWeight: 600 }}>ğŸ”µ é«˜å„ªå…ˆåº¦ {pendingHighCount}ä»¶</span>}
            {pendingTaskCount === 0 && <span style={{ fontSize: 11, padding: "3px 10px", borderRadius: 8, background: "#dcfce7", color: "#15803d", fontWeight: 600 }}>âœ… æœªå®Œäº†ã‚¿ã‚¹ã‚¯ãªã—</span>}
          </div>
          {upcomingTasks.length > 0 ? upcomingTasks.map((task, i) => {
            const isOverdue = task.dueAt < today;
            const isToday = task.dueAt === today;
            const dt = task.dueAt ? new Date(task.dueAt + "T00:00:00") : null;
            const dateStr = dt ? (dt.getMonth()+1) + "/" + dt.getDate() : "";
            return (
              <div key={task.id} style={{ display: "flex", alignItems: "center", justifyContent: "space-between", padding: "10px 0", borderBottom: i < upcomingTasks.length - 1 ? "1px solid #f3f4f6" : "none" }}>
                <div style={{ display: "flex", alignItems: "center", gap: 8, flex: 1, minWidth: 0 }}>
                  <span>{isOverdue ? "ğŸ”´" : isToday ? "ğŸŸ¡" : "âšª"}</span>
                  <div style={{ minWidth: 0 }}>
                    <div style={{ fontSize: 13, color: "#374151", overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>{task.label}</div>
                    <div style={{ fontSize: 10, color: "#9ca3af" }}>{task.candidateName} {dateStr && "ãƒ»" + dateStr}</div>
                  </div>
                </div>
                <button onClick={() => onNavigate("tasks")} style={{ fontSize: 11, color: "#6366f1", background: "#eef2ff", border: "none", borderRadius: 6, padding: "4px 10px", cursor: "pointer", flexShrink: 0 }}>ã‚¿ã‚¹ã‚¯ã¸</button>
              </div>
            );
          }) : (
            <div style={{ padding: "16px 0", textAlign: "center", fontSize: 13, color: "#9ca3af" }}>
              {pendingTaskCount === 0 ? "ã‚¿ã‚¹ã‚¯ã¯ã™ã¹ã¦å®Œäº†ã—ã¦ã„ã¾ã™ ğŸ‰" : "ç›´è¿‘ã®ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“"}
            </div>
          )}
          {pendingTaskCount > 5 && <div style={{ textAlign: "right", marginTop: 8 }}><button onClick={() => onNavigate("tasks")} style={{ fontSize: 11, color: "#6366f1", background: "none", border: "none", cursor: "pointer" }}>ã™ã¹ã¦ã®ã‚¿ã‚¹ã‚¯ã‚’è¡¨ç¤º â†’</button></div>}
        </div>
        <div style={{ background: "white", borderRadius: 12, padding: 20, boxShadow: "0 1px 3px rgba(0,0,0,0.08)" }}>
          <h3 style={{ fontSize: 14, fontWeight: 600, marginBottom: 16, display: "flex", alignItems: "center", gap: 6 }}>
            <Icon name="bar-chart" size={16} color="#6366f1" /> é¸è€ƒãƒ•ã‚¡ãƒãƒ«
          </h3>
          <ResponsiveContainer width="100%" height={200}>
            <BarChart data={FUNNEL_DATA} layout="vertical" margin={{ left: 60 }}>
              <XAxis type="number" hide />
              <YAxis type="category" dataKey="stage" tick={{ fontSize: 11 }} width={60} />
              <Tooltip />
              <Bar dataKey="value" radius={[0, 6, 6, 0]}>
                {FUNNEL_DATA.map((_, i) => <Cell key={i} fill={COLORS[i]} />)}
              </Bar>
            </BarChart>
          </ResponsiveContainer>
        </div>
      </div>

      {/* æ¡ç”¨åŒºåˆ†åˆ¥ã®å€™è£œè€…æ•° */}
      <div style={{ background: "white", borderRadius: 12, padding: 20, boxShadow: "0 1px 3px rgba(0,0,0,0.08)", marginBottom: 24 }}>
        <h3 style={{ fontSize: 14, fontWeight: 600, marginBottom: 16 }}>æ¡ç”¨åŒºåˆ†åˆ¥ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h3>
        <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 16 }}>
          <div style={{ padding: 16, background: "#eef2ff", borderRadius: 10, border: "1px solid #c7d2fe" }}>
            <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 12 }}>
              <Icon name="graduation-cap" size={18} color="#4338ca" />
              <span style={{ fontSize: 14, fontWeight: 600, color: "#4338ca" }}>æ–°å’æ¡ç”¨</span>
              <span style={{ fontSize: 22, fontWeight: 700, color: "#4338ca", marginLeft: "auto" }}>{newCount}å</span>
            </div>
            <div style={{ display: "flex", gap: 8, fontSize: 11 }}>
              <span style={{ padding: "2px 8px", borderRadius: 8, background: "#dbeafe", color: "#1d4ed8" }}>é¸è€ƒä¸­ 6</span>
              <span style={{ padding: "2px 8px", borderRadius: 8, background: "#dcfce7", color: "#15803d" }}>å†…å®š 1</span>
              <span style={{ padding: "2px 8px", borderRadius: 8, background: "#fee2e2", color: "#dc2626" }}>ä¸åˆæ ¼ 1</span>
            </div>
          </div>
          <div style={{ padding: 16, background: "#fffbeb", borderRadius: 10, border: "1px solid #fde68a" }}>
            <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 12 }}>
              <Icon name="briefcase" size={18} color="#92400e" />
              <span style={{ fontSize: 14, fontWeight: 600, color: "#92400e" }}>ä¸­é€”æ¡ç”¨</span>
              <span style={{ fontSize: 22, fontWeight: 700, color: "#92400e", marginLeft: "auto" }}>{midCount}å</span>
            </div>
            <div style={{ display: "flex", gap: 8, fontSize: 11 }}>
              <span style={{ padding: "2px 8px", borderRadius: 8, background: "#fef3c7", color: "#92400e" }}>é¸è€ƒä¸­ 4</span>
              <span style={{ padding: "2px 8px", borderRadius: 8, background: "#dcfce7", color: "#15803d" }}>å†…å®š 1</span>
              <span style={{ padding: "2px 8px", borderRadius: 8, background: "#f3f4f6", color: "#6b7280" }}>æ–°è¦ 1</span>
            </div>
          </div>
        </div>
      </div>

      <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 16 }}>
        <div style={{ background: "white", borderRadius: 12, padding: 20, boxShadow: "0 1px 3px rgba(0,0,0,0.08)" }}>
          <h3 style={{ fontSize: 14, fontWeight: 600, marginBottom: 16, display: "flex", alignItems: "center", gap: 6 }}>
            <Icon name="calendar" size={16} color="#6366f1" /> ç›´è¿‘ã®é¢æ¥äºˆå®š
          </h3>
          {[
            { time: "14:00", name: "å±±ç”° èŠ±å­", stage: "äºŒæ¬¡é¢æ¥", interviewer: "å®‰å²¡", type: "æ–°å’", format: "å¯¾é¢" },
            { time: "15:30", name: "æ¾æœ¬ å¤§ä»‹", stage: "äºŒæ¬¡é¢æ¥", interviewer: "éˆ´æœ¨", type: "ä¸­é€”", format: "å¯¾é¢" },
            { time: "16:00", name: "ç”°ä¸­ å¥ä¸€", stage: "æœ€çµ‚é¢æ¥", interviewer: "ç”°ä¸­éƒ¨é•·", type: "æ–°å’", format: "å¯¾é¢" },
          ].map((item, i) => (
            <div key={i} style={{ display: "flex", alignItems: "center", gap: 12, padding: "12px 0", borderBottom: i < 2 ? "1px solid #f3f4f6" : "none" }}>
              <div style={{ width: 44, height: 44, borderRadius: 10, background: "#eef2ff", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 12, fontWeight: 600, color: "#4338ca" }}>{item.time}</div>
              <div style={{ flex: 1 }}>
                <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
                  <span style={{ fontSize: 13, fontWeight: 600, color: "#111827" }}>{item.name}</span>
                  <RecruitTypeBadge type={item.type} />
                  <FormatBadge format={item.format} />
                </div>
                <div style={{ fontSize: 11, color: "#6b7280" }}>{item.stage} ãƒ» é¢æ¥å®˜: {item.interviewer}</div>
              </div>
              <button onClick={() => onNavigate("interview-fb")} style={{ fontSize: 11, color: "white", background: "#6366f1", border: "none", borderRadius: 6, padding: "6px 12px", cursor: "pointer" }}>FBå…¥åŠ›</button>
            </div>
          ))}
        </div>
        <div style={{ background: "white", borderRadius: 12, padding: 20, boxShadow: "0 1px 3px rgba(0,0,0,0.08)" }}>
          <h3 style={{ fontSize: 14, fontWeight: 600, marginBottom: 16, display: "flex", alignItems: "center", gap: 6 }}>
            <Icon name="bell" size={16} color="#6366f1" /> æœ€æ–°ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£
          </h3>
          {[
            { text: "ç”°ä¸­å¥ä¸€ãŒä¸€æ¬¡é¢æ¥é€šé", time: "15åˆ†å‰", type: "pass", recruit: "æ–°å’" },
            { text: "å°æ—ç”±ç¾ãŒä¸€æ¬¡é¢æ¥é€šé", time: "30åˆ†å‰", type: "pass", recruit: "ä¸­é€”" },
            { text: "â—‹â—‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒ3åç™»éŒ²", time: "3æ™‚é–“å‰", type: "entry", recruit: null },
            { text: "æœ¨æ‘éº»è¡£ã®æœ€çµ‚é¢æ¥ã‚’äºˆç´„", time: "5æ™‚é–“å‰", type: "schedule", recruit: "ä¸­é€”" },
          ].map((item, i) => (
            <div key={i} style={{ display: "flex", alignItems: "flex-start", gap: 10, padding: "10px 0", borderBottom: i < 3 ? "1px solid #f3f4f6" : "none" }}>
              <div style={{ width: 6, height: 6, borderRadius: "50%", background: item.type === "pass" ? "#10b981" : item.type === "fb" ? "#6366f1" : item.type === "entry" ? "#f59e0b" : "#8b5cf6", marginTop: 5, flexShrink: 0 }} />
              <div style={{ flex: 1 }}>
                <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
                  <span style={{ fontSize: 13, color: "#374151" }}>{item.text}</span>
                  {item.recruit && <RecruitTypeBadge type={item.recruit} />}
                </div>
                <div style={{ fontSize: 11, color: "#9ca3af" }}>{item.time}</div>
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
}

// Candidates List - æ–°å’/ä¸­é€”å¯¾å¿œ
function CandidatesPage({ onNavigate, recruitFilter, pipelineFilter, onClearPipelineFilter, candidates: propCandidates, onUpdateCandidate, onBulkUpdateStatus, onShowAddModal, can = () => true, emailTemplates = [] }) {
  // propCandidatesãŒæ¸¡ã•ã‚Œã‚Œã°ãã‚Œã‚’ä½¿ç”¨ã€ãªã‘ã‚Œã°ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
  const CANDS = propCandidates || CANDIDATES;
  const [searchTerm, setSearchTerm] = useState("");
  const [stageFilter, setStageFilter] = useState("all");
  const [checkedSubstatuses, setCheckedSubstatuses] = useState(new Set()); // ãƒã‚§ãƒƒã‚¯ã•ã‚ŒãŸã‚µãƒ–ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆç©º = å…¨ã¦ï¼‰
  const [selectedIds, setSelectedIds] = useState(new Set());
  const [showBulkStatus, setShowBulkStatus] = useState(false);
  const [bulkToast, setBulkToast] = useState(null);
  // ãƒ¡ãƒ¼ãƒ«ä¸€æ‹¬é€ä¿¡ãƒ¢ãƒ¼ãƒ€ãƒ«
  const [bulkEmailOpen, setBulkEmailOpen] = useState(false);
  const [bulkEmailData, setBulkEmailData] = useState({ subject: "", body: "", cc: "" });
  const [bulkEmailSending, setBulkEmailSending] = useState(false);
  const [bulkEmailStep, setBulkEmailStep] = useState("compose"); // compose | preview | done
  // LINEä¸€æ‹¬é€ä¿¡ãƒ¢ãƒ¼ãƒ€ãƒ«
  const [bulkLineOpen, setBulkLineOpen] = useState(false);
  const [bulkLineData, setBulkLineData] = useState({ message: "" });
  const [bulkLineSending, setBulkLineSending] = useState(false);
  const [bulkLineStep, setBulkLineStep] = useState("compose");

  // ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚¹ãƒ†ãƒ¼ã‚¸åã§ãƒ•ã‚£ãƒ«ã‚¿ã«ä½¿ãˆã‚‹ã‚¹ãƒ†ãƒ¼ã‚¸ä¸€è¦§
  const stages = ["all", ...STAGE_NAMES];

  // æœ‰åŠ¹ãªã‚¹ãƒ†ãƒ¼ã‚¸ã‚’åˆ¤å®š
  const effectiveStageFilter = pipelineFilter ? pipelineFilter.stageName : stageFilter;

  // ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã«å¯¾å¿œã™ã‚‹ã‚µãƒ–ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ä¸€è¦§ï¼ˆä»¶æ•°ä»˜ãï¼‰
  const substatusOptions = useMemo(() => {
    const activeStage = pipelineFilter ? pipelineFilter.stageName : (stageFilter !== "all" ? stageFilter : null);
    if (!activeStage) return [];
    const dynPipeline = buildPipelineFromCandidates(CANDS);
    const pipelineEntry = dynPipeline.find(s => s.name === activeStage);
    if (!pipelineEntry) return [];
    return pipelineEntry.substages.map(s => {
      return { status: s.status, count: s.staying, isAlert: s.isAlert };
    });
  }, [effectiveStageFilter, recruitFilter]);

  // pipelineFilteråˆ°ç€æ™‚ã®ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ï¼ˆè©²å½“ã‚µãƒ–ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã ã‘ONï¼‰
  const effectiveChecked = pipelineFilter
    ? new Set([pipelineFilter.substatus])
    : checkedSubstatuses;

  const filtered = CANDS.filter(c => {
    const matchRecruit = recruitFilter === "all" || c.recruitType === recruitFilter;
    const searchTarget = recruitFilter === "ä¸­é€”" || c.recruitType === "ä¸­é€”"
      ? `${c.lastName}${c.firstName}${c.company || ""}${c.position || ""}`
      : `${c.lastName}${c.firstName}${c.university || ""}`;
    const matchSearch = searchTarget.includes(searchTerm);
    // ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ•ã‚£ãƒ«ã‚¿
    let matchStage = true;
    if (effectiveStageFilter !== "all") {
      const mappedStage = PIPELINE_STAGE_MAP[effectiveStageFilter] || effectiveStageFilter;
      matchStage = c.stage === effectiveStageFilter || c.stage === mappedStage;
    }
    // ã‚µãƒ–ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ï¼‰ï¼šä½•ã‚‚ãƒã‚§ãƒƒã‚¯ã•ã‚Œã¦ã„ãªã‘ã‚Œã°å…¨è¡¨ç¤º
    let matchSubstatus = true;
    if (effectiveChecked.size > 0) {
      matchSubstatus = effectiveChecked.has(c.substatus);
    }
    return matchRecruit && matchSearch && matchStage && matchSubstatus;
  });

  const toggleSubstatusCheck = (status) => {
    if (pipelineFilter) onClearPipelineFilter();
    setCheckedSubstatuses(prev => {
      const next = new Set(prev);
      next.has(status) ? next.delete(status) : next.add(status);
      return next;
    });
  };
  const clearSubstatusChecks = () => {
    if (pipelineFilter) onClearPipelineFilter();
    setCheckedSubstatuses(new Set());
  };

  // ===== CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ =====
  const [csvModalOpen, setCsvModalOpen] = useState(false);
  const [csvStep, setCsvStep] = useState("upload"); // upload | preview | importing | done
  const [csvRawData, setCsvRawData] = useState([]);
  const [csvHeaders, setCsvHeaders] = useState([]);
  const [csvMapping, setCsvMapping] = useState({});
  const [csvImportResult, setCsvImportResult] = useState(null);
  const csvFileRef = useRef(null);

  const CSV_TEMPLATE_COLS = [
    { key: "lastName", label: "å§“", required: true, example: "å±±ç”°" },
    { key: "firstName", label: "å", required: true, example: "å¤ªéƒ" },
    { key: "email", label: "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹", required: false, example: "taro@example.com" },
    { key: "phone", label: "é›»è©±ç•ªå·", required: false, example: "090-1234-5678" },
    { key: "recruitType", label: "åŒºåˆ†", required: true, example: "æ–°å’" },
    { key: "university", label: "å¤§å­¦", required: false, example: "æ±äº¬å¤§å­¦" },
    { key: "faculty", label: "å­¦éƒ¨", required: false, example: "çµŒæ¸ˆå­¦éƒ¨" },
    { key: "gradYear", label: "å’æ¥­å¹´", required: false, example: "2027" },
    { key: "majorType", label: "æ–‡ç†", required: false, example: "æ–‡ç³»" },
    { key: "company", label: "ç¾è·ä¼æ¥­", required: false, example: "ã€‡ã€‡æ ªå¼ä¼šç¤¾" },
    { key: "position", label: "è·ç¨®", required: false, example: "å–¶æ¥­" },
    { key: "experience", label: "çµŒé¨“å¹´æ•°", required: false, example: "5" },
    { key: "stage", label: "é¸è€ƒã‚¹ãƒ†ãƒ¼ã‚¸", required: false, example: "ã‚¨ãƒ³ãƒˆãƒªãƒ¼" },
    { key: "substatus", label: "ã‚µãƒ–ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹", required: false, example: "å—ä»˜æ¸ˆ" },
    { key: "route", label: "æµå…¥çµŒè·¯", required: false, example: "ãƒªã‚¯ãƒŠãƒ“" },
    { key: "agent", label: "ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ", required: false, example: "ã€‡ã€‡ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ" },
    { key: "aspiration", label: "å¿—æœ›åº¦(1-5)", required: false, example: "4" },
    { key: "gender", label: "æ€§åˆ¥", required: false, example: "ç”·æ€§" },
    { key: "format", label: "é¸è€ƒå½¢æ…‹", required: false, example: "WEB" },
  ];

  const downloadCsvTemplate = () => {
    const bom = "\uFEFF";
    const header = CSV_TEMPLATE_COLS.map(c => c.label).join(",");
    const example = CSV_TEMPLATE_COLS.map(c => c.example).join(",");
    const blob = new Blob([bom + header + "\n" + example + "\n"], { type: "text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a"); a.href = url; a.download = "å€™è£œè€…ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ.csv"; a.click();
    URL.revokeObjectURL(url);
  };

  const parseCSV = (text) => {
    const lines = text.split(/\r?\n/).filter(l => l.trim());
    if (lines.length < 2) return { headers: [], rows: [] };
    const parseLine = (line) => {
      const result = []; let current = ""; let inQuote = false;
      for (let i = 0; i < line.length; i++) {
        if (line[i] === '"') { inQuote = !inQuote; }
        else if (line[i] === ',' && !inQuote) { result.push(current.trim()); current = ""; }
        else { current += line[i]; }
      }
      result.push(current.trim());
      return result;
    };
    const headers = parseLine(lines[0]);
    const rows = lines.slice(1).map(l => parseLine(l)).filter(r => r.some(c => c));
    return { headers, rows };
  };

  const handleCsvFile = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
      const { headers, rows } = parseCSV(ev.target.result);
      setCsvHeaders(headers);
      setCsvRawData(rows);
      // è‡ªå‹•ãƒãƒƒãƒ”ãƒ³ã‚°
      const mapping = {};
      CSV_TEMPLATE_COLS.forEach(col => {
        const idx = headers.findIndex(h => h === col.label || h.toLowerCase() === col.key.toLowerCase() || h === col.key);
        if (idx >= 0) mapping[col.key] = idx;
      });
      setCsvMapping(mapping);
      setCsvStep("preview");
    };
    reader.readAsText(file, "UTF-8");
  };

  const executeCsvImport = async () => {
    setCsvStep("importing");
    let success = 0; let failed = 0; const errors = [];
    for (let i = 0; i < csvRawData.length; i++) {
      const row = csvRawData[i];
      try {
        const record = {};
        CSV_TEMPLATE_COLS.forEach(col => {
          if (csvMapping[col.key] !== undefined) {
            let val = row[csvMapping[col.key]] || "";
            if (col.key === "gradYear" || col.key === "experience" || col.key === "aspiration") val = val ? parseInt(val, 10) || null : null;
            record[col.key] = val || null;
          }
        });
        // å¿…é ˆãƒã‚§ãƒƒã‚¯
        if (!record.lastName && !record.firstName) { failed++; errors.push(`è¡Œ${i+1}: æ°åãŒç©º`); continue; }
        if (!record.recruitType) record.recruitType = "æ–°å’";
        if (!record.stage) record.stage = "ã‚¨ãƒ³ãƒˆãƒªãƒ¼";
        if (!record.substatus) record.substatus = "å—ä»˜æ¸ˆ";
        // Supabase insert
        if (SUPABASE_READY) {
          const snakeRecord = {
            last_name: record.lastName, first_name: record.firstName, email: record.email, phone: record.phone,
            recruit_type: record.recruitType, university: record.university, faculty: record.faculty,
            grad_year: record.gradYear, major_type: record.majorType, company: record.company, position: record.position,
            experience: record.experience, stage: record.stage, substatus: record.substatus, status: record.substatus || "å—ä»˜æ¸ˆ",
            route: record.route, agent: record.agent, aspiration: record.aspiration, gender: record.gender, format: record.format,
          };
          const { error } = await sbApi.insert('candidates', snakeRecord);
          if (error) { failed++; errors.push(`è¡Œ${i+1}: ${error.message || "DBç™»éŒ²ã‚¨ãƒ©ãƒ¼"}`); continue; }
        }
        success++;
      } catch (err) { failed++; errors.push(`è¡Œ${i+1}: ${err.message}`); }
    }
    setCsvImportResult({ success, failed, errors, total: csvRawData.length });
    setCsvStep("done");
  };

  const resetCsvModal = () => {
    setCsvModalOpen(false); setCsvStep("upload"); setCsvRawData([]); setCsvHeaders([]); setCsvMapping({}); setCsvImportResult(null);
    if (csvFileRef.current) csvFileRef.current.value = "";
  };

  const getStatusColor = (status) => {
    if (["é€šé", "æ‰¿è«¾å¾…ã¡", "åˆæ ¼", "å‚åŠ æ¸ˆ", "æ‰¿è«¾æ¸ˆ", "å…¥ç¤¾æ¸ˆ", "å…¥ç¤¾æº–å‚™ä¸­", "å—é¨“æ¸ˆ", "å®Ÿæ–½æ¸ˆ", "æ›¸é¡é€šé"].includes(status)) return { bg: "#dcfce7", text: "#15803d" };
    if (["äºˆå®š", "æ–°è¦", "æ¡ˆå†…æ¸ˆ", "äºˆç´„æ¸ˆ", "å†…å®šé€šçŸ¥", "æ—¥ç¨‹èª¿æ•´ä¸­", "æ›¸é¡ç¢ºèªä¸­", "é¢è«‡èª¿æ•´ä¸­", "é¢è«‡å®Ÿæ–½æ¸ˆ", "å—ä»˜æ¸ˆ"].includes(status)) return { bg: "#dbeafe", text: "#1d4ed8" };
    if (["ä¸åˆæ ¼", "æ¬ å¸­"].includes(status)) return { bg: "#fee2e2", text: "#dc2626" };
    if (["è¾é€€", "æ‰¿è«¾å¾Œè¾é€€"].includes(status)) return { bg: "#fef3c7", text: "#92400e" };
    if (status === "ä¿ç•™") return { bg: "#f3f4f6", text: "#6b7280" };
    return { bg: "#f3f4f6", text: "#6b7280" };
  };

  const showBothTypes = recruitFilter === "all";
  const searchPlaceholder = recruitFilter === "ä¸­é€”" ? "åå‰ãƒ»ä¼æ¥­åãƒ»è·ç¨®ã§æ¤œç´¢..." : recruitFilter === "æ–°å’" ? "åå‰ãƒ»å¤§å­¦ã§æ¤œç´¢..." : "åå‰ãƒ»å¤§å­¦ãƒ»ä¼æ¥­åã§æ¤œç´¢...";

  const toggleSelect = (id) => {
    setSelectedIds(prev => {
      const next = new Set(prev);
      next.has(id) ? next.delete(id) : next.add(id);
      return next;
    });
  };
  const toggleSelectAll = () => {
    if (selectedIds.size === filtered.length) {
      setSelectedIds(new Set());
    } else {
      setSelectedIds(new Set(filtered.map(c => c.id)));
    }
  };
  const allSelected = filtered.length > 0 && selectedIds.size === filtered.length;

  // é¸æŠä¸­ã®å€™è£œè€…ãƒªã‚¹ãƒˆ
  const selectedCandidates = useMemo(() => {
    const CANDS_ALL = propCandidates || [];
    return CANDS_ALL.filter(c => selectedIds.has(c.id));
  }, [selectedIds, propCandidates]);

  const handleBulkAction = (action) => {
    if (action === "email") {
      setBulkEmailData({ subject: "", body: "", cc: "" });
      setBulkEmailStep("compose");
      setBulkEmailOpen(true);
      return;
    }
    if (action === "line") {
      setBulkLineData({ message: "" });
      setBulkLineStep("compose");
      setBulkLineOpen(true);
      return;
    }
    if (action === "status") { setShowBulkStatus(true); return; }
  };

  const handleBulkEmailSend = async () => {
    setBulkEmailSending(true);
    // ãƒ‡ãƒ¢: å®Ÿéš›ã«ã¯APIå‘¼ã³å‡ºã—
    await new Promise(r => setTimeout(r, 1200));
    setBulkEmailSending(false);
    setBulkEmailStep("done");
  };

  const handleBulkLineSend = async () => {
    setBulkLineSending(true);
    await new Promise(r => setTimeout(r, 1000));
    setBulkLineSending(false);
    setBulkLineStep("done");
  };

  const closeBulkEmail = () => {
    setBulkEmailOpen(false);
    if (bulkEmailStep === "done") {
      setBulkToast(`${selectedIds.size}åã«ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸ`);
      setSelectedIds(new Set());
      setTimeout(() => setBulkToast(null), 3000);
    }
  };

  const closeBulkLine = () => {
    setBulkLineOpen(false);
    if (bulkLineStep === "done") {
      setBulkToast(`${selectedIds.size}åã«LINEã‚’é€ä¿¡ã—ã¾ã—ãŸ`);
      setSelectedIds(new Set());
      setTimeout(() => setBulkToast(null), 3000);
    }
  };

  const handleBulkStatusChange = async (newStatus) => {
    const count = selectedIds.size;
    if (onBulkUpdateStatus) await onBulkUpdateStatus(selectedIds, newStatus);
    setBulkToast(`${count}åã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã€Œ${newStatus}ã€ã«å¤‰æ›´ã—ã¾ã—ãŸ`);
    setShowBulkStatus(false);
    setSelectedIds(new Set());
    setTimeout(() => setBulkToast(null), 3000);
  };

  const applyEmailTemplate = (tpl) => {
    setBulkEmailData({ ...bulkEmailData, subject: tpl.subject, body: tpl.body });
  };

  // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ã‚«ãƒ†ã‚´ãƒªã§ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°
  const templatesByCategory = useMemo(() => {
    const map = {};
    (emailTemplates || []).forEach(t => {
      if (!map[t.category]) map[t.category] = [];
      map[t.category].push(t);
    });
    return map;
  }, [emailTemplates]);

  return (
    <div style={{ padding: 24, maxWidth: 1200 }}>
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 20 }}>
        <h1 style={{ fontSize: 22, fontWeight: 700, color: "#111827" }}>å€™è£œè€…ç®¡ç†</h1>
        <div style={{ display: "flex", gap: 8 }}>
          {can("csvImport") && <button onClick={() => setCsvModalOpen(true)} style={{ display: "flex", alignItems: "center", gap: 6, background: "white", color: "#6366f1", border: "1px solid #6366f1", borderRadius: 8, padding: "8px 16px", fontSize: 13, fontWeight: 500, cursor: "pointer" }}>
            <Icon name="upload" size={16} /> CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ
          </button>}
          {can("editCandidates") && <button onClick={onShowAddModal} style={{ display: "flex", alignItems: "center", gap: 6, background: "#6366f1", color: "white", border: "none", borderRadius: 8, padding: "8px 16px", fontSize: 13, fontWeight: 500, cursor: "pointer" }}>
            <Icon name="plus" size={16} /> æ–°è¦ç™»éŒ²
          </button>}
        </div>
      </div>

      {/* æ¤œç´¢ + ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ•ã‚£ãƒ«ã‚¿ */}
      <div style={{ display: "flex", gap: 12, marginBottom: 10, alignItems: "center", flexWrap: "wrap" }}>
        <div style={{ position: "relative", flex: 1, maxWidth: 360 }}>
          <Icon name="search" size={16} style={{ position: "absolute", left: 10, top: 10 }} color="#9ca3af" />
          <input value={searchTerm} onChange={e => setSearchTerm(e.target.value)} placeholder={searchPlaceholder} style={{ width: "100%", padding: "8px 8px 8px 32px", border: "1px solid #d1d5db", borderRadius: 8, fontSize: 13, outline: "none", boxSizing: "border-box" }} />
        </div>
        <div style={{ display: "flex", gap: 4, background: "#f3f4f6", borderRadius: 8, padding: 3 }}>
          {stages.map(s => {
            const isActive = effectiveStageFilter === s || (s === "all" && effectiveStageFilter === "all");
            return (
              <button key={s} onClick={() => { if (pipelineFilter) onClearPipelineFilter(); setStageFilter(s); setCheckedSubstatuses(new Set()); }}
                style={{ padding: "6px 12px", border: "none", borderRadius: 6, fontSize: 11, cursor: "pointer", background: isActive ? "white" : "transparent", color: isActive ? "#4338ca" : "#6b7280", fontWeight: isActive ? 600 : 400, boxShadow: isActive ? "0 1px 2px rgba(0,0,0,0.1)" : "none" }}>
                {s === "all" ? "å…¨ã¦" : s}
              </button>
            );
          })}
        </div>
      </div>

      {/* ã‚µãƒ–ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ */}
      {substatusOptions.length > 0 && (
        <div style={{ marginBottom: 14, padding: "12px 16px", background: "#f9fafb", borderRadius: 10, border: "1px solid #e5e7eb" }}>
          <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 8 }}>
            <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
              <Icon name="filter" size={13} color="#6366f1" />
              <span style={{ fontSize: 12, fontWeight: 600, color: "#374151" }}>
                {effectiveStageFilter} ã®ã‚µãƒ–ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§çµã‚Šè¾¼ã¿
              </span>
              {effectiveChecked.size > 0 && (
                <span style={{ fontSize: 11, color: "#6366f1", background: "#eef2ff", padding: "2px 8px", borderRadius: 8, fontWeight: 600 }}>
                  {filtered.length}å è¡¨ç¤ºä¸­
                </span>
              )}
            </div>
            {effectiveChecked.size > 0 && (
              <button onClick={clearSubstatusChecks}
                style={{ background: "none", border: "none", color: "#6366f1", fontSize: 11, cursor: "pointer", fontWeight: 500, textDecoration: "underline" }}>
                ã™ã¹ã¦è§£é™¤
              </button>
            )}
          </div>
          <div style={{ display: "flex", gap: 8, flexWrap: "wrap" }}>
            {substatusOptions.map(opt => {
              const isChecked = effectiveChecked.has(opt.status);
              const alertStyle = opt.isAlert ? { borderColor: "#fecaca", background: isChecked ? "#fef2f2" : "white" } : {};
              return (
                <label key={opt.status}
                  style={{
                    display: "flex", alignItems: "center", gap: 6,
                    padding: "6px 12px", borderRadius: 8, cursor: "pointer",
                    border: isChecked ? "1.5px solid #818cf8" : "1px solid #d1d5db",
                    background: isChecked ? "#eef2ff" : "white",
                    transition: "all 0.15s",
                    ...alertStyle,
                    ...(isChecked && opt.isAlert ? { borderColor: "#f87171" } : {}),
                  }}
                  onMouseOver={e => { if (!isChecked) e.currentTarget.style.borderColor = "#a5b4fc"; }}
                  onMouseOut={e => { if (!isChecked) e.currentTarget.style.borderColor = "#d1d5db"; }}>
                  <input type="checkbox" checked={isChecked} onChange={() => toggleSubstatusCheck(opt.status)}
                    style={{ width: 15, height: 15, accentColor: opt.isAlert ? "#ef4444" : "#6366f1", cursor: "pointer" }} />
                  <span style={{ fontSize: 12, fontWeight: isChecked ? 600 : 400, color: opt.isAlert ? "#dc2626" : "#374151" }}>
                    {opt.status}
                  </span>
                  <span style={{ fontSize: 10, color: "#9ca3af", fontWeight: 500 }}>
                    ({opt.count})
                  </span>
                </label>
              );
            })}
          </div>
        </div>
      )}

      {/* ä¸€æ‹¬æ“ä½œãƒãƒ¼ */}
      {selectedIds.size > 0 && (
        <div style={{
          display: "flex", alignItems: "center", gap: 12, marginBottom: 12, padding: "10px 16px",
          background: "linear-gradient(90deg, #312e81, #4338ca)", borderRadius: 10,
          boxShadow: "0 4px 12px rgba(99,102,241,0.3)",
        }}>
          <span style={{ fontSize: 13, color: "white", fontWeight: 600 }}>
            {selectedIds.size}åé¸æŠä¸­
          </span>
          <div style={{ flex: 1 }} />
          {can("sendMessage") && <button onClick={() => handleBulkAction("email")}
            style={{ display: "flex", alignItems: "center", gap: 5, background: "rgba(255,255,255,0.15)", color: "white", border: "1px solid rgba(255,255,255,0.3)", borderRadius: 7, padding: "6px 14px", fontSize: 12, cursor: "pointer", fontWeight: 500 }}>
            <Icon name="mail" size={13} color="white" /> ãƒ¡ãƒ¼ãƒ«ä¸€æ‹¬é€ä¿¡
          </button>}
          {can("sendMessage") && <button onClick={() => handleBulkAction("line")}
            style={{ display: "flex", alignItems: "center", gap: 5, background: "#06c755", color: "white", border: "1px solid rgba(255,255,255,0.3)", borderRadius: 7, padding: "6px 14px", fontSize: 12, cursor: "pointer", fontWeight: 500 }}>
            <Icon name="message-square" size={13} color="white" /> LINEä¸€æ‹¬é€ä¿¡
          </button>}
          {can("changeStage") && <div style={{ position: "relative" }}>
            <button onClick={() => handleBulkAction("status")}
              style={{ display: "flex", alignItems: "center", gap: 5, background: "rgba(255,255,255,0.15)", color: "white", border: "1px solid rgba(255,255,255,0.3)", borderRadius: 7, padding: "6px 14px", fontSize: 12, cursor: "pointer", fontWeight: 500 }}>
              <Icon name="check-square" size={13} color="white" /> ã‚¹ãƒ†ãƒ¼ã‚¸ä¸€æ‹¬å¤‰æ›´
            </button>
            {showBulkStatus && (
              <div style={{ position: "absolute", right: 0, top: "110%", background: "white", borderRadius: 10, boxShadow: "0 8px 24px rgba(0,0,0,0.15)", padding: 6, zIndex: 100, minWidth: 180 }}>
                <div style={{ fontSize: 10, fontWeight: 600, color: "#9ca3af", padding: "4px 14px" }}>ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’é¸æŠ</div>
                {STAGE_NAMES.map(s => (
                  <button key={s} onClick={() => handleBulkStatusChange(s)}
                    style={{ display: "block", width: "100%", textAlign: "left", padding: "7px 14px", border: "none", background: "none", fontSize: 12, cursor: "pointer", borderRadius: 6, color: "#111827" }}
                    onMouseOver={e => e.target.style.background = "#f3f4f6"} onMouseOut={e => e.target.style.background = "none"}>
                    {s}
                  </button>
                ))}
                <div style={{ borderTop: "1px solid #e5e7eb", margin: "4px 0" }} />
                <button onClick={() => setShowBulkStatus(false)}
                  style={{ display: "block", width: "100%", textAlign: "center", padding: "6px 14px", border: "none", background: "none", fontSize: 11, cursor: "pointer", color: "#9ca3af" }}>
                  ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
              </div>
            )}
          </div>}
          <button onClick={() => setSelectedIds(new Set())}
            style={{ background: "none", color: "rgba(255,255,255,0.7)", border: "none", fontSize: 18, cursor: "pointer", padding: "0 4px", lineHeight: 1 }}>
            Ã—
          </button>
        </div>
      )}

      <div style={{ background: "white", borderRadius: 12, boxShadow: "0 1px 3px rgba(0,0,0,0.08)", overflow: "auto" }}>
        <table style={{ width: "100%", borderCollapse: "collapse", minWidth: 1100 }}>
          <thead>
            <tr style={{ background: "#f9fafb" }}>
              <th style={{ padding: "12px 8px 12px 16px", width: 36, borderBottom: "1px solid #e5e7eb" }}>
                <input type="checkbox" checked={allSelected} onChange={toggleSelectAll}
                  style={{ width: 16, height: 16, cursor: "pointer", accentColor: "#6366f1" }} />
              </th>
              {[
                "æ°å",
                showBothTypes ? "åŒºåˆ†" : null,
                recruitFilter === "ä¸­é€”" ? "ç¾è·ä¼æ¥­ãƒ»è·ç¨®" : recruitFilter === "æ–°å’" ? "å¤§å­¦ãƒ»å­¦éƒ¨" : "æ‰€å±",
                recruitFilter === "ä¸­é€”" ? "çµŒé¨“å¹´æ•°" : recruitFilter === "æ–°å’" ? "å’å¹´" : "å’å¹´/çµŒé¨“",
                "ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ—¥",
                "é¸è€ƒã‚¹ãƒ†ãƒ¼ã‚¸", "å½¢æ…‹", "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹", "å¿—æœ›åº¦", "è©•ä¾¡", "ç™»éŒ²æ—¥", ""
              ].filter(Boolean).map((h, i) => (
                <th key={i} style={{ padding: "12px 12px", fontSize: 11, fontWeight: 600, color: "#6b7280", textAlign: "left", borderBottom: "1px solid #e5e7eb", whiteSpace: "nowrap" }}>{h}</th>
              ))}
            </tr>
          </thead>
          <tbody>
            {filtered.map(c => {
              const sc = getStatusColor(c.status);
              const isNewGrad = c.recruitType === "æ–°å’";
              const isSelected = selectedIds.has(c.id);
              return (
                <tr key={c.id} style={{ cursor: "pointer", borderBottom: "1px solid #f3f4f6", background: isSelected ? "#eef2ff" : "white" }}
                  onMouseOver={e => { if (!isSelected) e.currentTarget.style.background = "#f9fafb"; }} onMouseOut={e => { if (!isSelected) e.currentTarget.style.background = "white"; }}>
                  <td style={{ padding: "12px 8px 12px 16px" }} onClick={e => e.stopPropagation()}>
                    <input type="checkbox" checked={isSelected} onChange={() => toggleSelect(c.id)}
                      style={{ width: 16, height: 16, cursor: "pointer", accentColor: "#6366f1" }} />
                  </td>
                  <td style={{ padding: "12px 16px" }} onClick={() => onNavigate("candidate-detail", c.id)}>
                    <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
                      <div style={{ width: 34, height: 34, borderRadius: "50%", background: isNewGrad ? "#eef2ff" : "#fffbeb", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 12, fontWeight: 600, color: isNewGrad ? "#4338ca" : "#92400e" }}>{c.lastName[0]}</div>
                      <div>
                        <div style={{ fontSize: 13, fontWeight: 600, color: "#111827" }}>{c.lastName} {c.firstName}</div>
                        {(c.lastNameKana || c.firstNameKana) && <div style={{ fontSize: 10, color: "#b0b5bf", marginTop: 1 }}>{c.lastNameKana || ""} {c.firstNameKana || ""}</div>}
                        <div style={{ fontSize: 11, color: "#9ca3af" }}>{c.route}{c.agent ? ` / ${c.agent}` : ""}</div>
                      </div>
                    </div>
                  </td>
                  {showBothTypes && <td style={{ padding: "12px 10px", whiteSpace: "nowrap" }}><RecruitTypeBadge type={c.recruitType} /></td>}
                  <td style={{ padding: "12px 10px", fontSize: 13, color: "#374151" }} onClick={() => onNavigate("candidate-detail", c.id)}>
                    {isNewGrad
                      ? <>{c.university}<br /><span style={{ fontSize: 11, color: "#9ca3af" }}>{c.faculty}{c.department ? ` / ${c.department}` : ""}</span></>
                      : <>{c.company}<br /><span style={{ fontSize: 11, color: "#9ca3af" }}>{c.position}</span></>
                    }
                  </td>
                  <td style={{ padding: "12px 10px", fontSize: 13, color: "#374151", whiteSpace: "nowrap" }}>
                    {isNewGrad ? c.gradYear : c.experience ? `${c.experience}å¹´` : "â€”"}
                  </td>
                  <td style={{ padding: "12px 10px", fontSize: 12, color: "#6b7280", whiteSpace: "nowrap" }}>{c.entryDate || "â€”"}</td>
                  <td style={{ padding: "12px 10px", whiteSpace: "nowrap" }}><span style={{ fontSize: 11, fontWeight: 500, padding: "3px 8px", borderRadius: 12, background: "#eef2ff", color: "#4338ca", whiteSpace: "nowrap" }}>{c.stage}</span></td>
                  <td style={{ padding: "12px 10px", whiteSpace: "nowrap" }}><FormatBadge format={c.format} /></td>
                  <td style={{ padding: "12px 10px", whiteSpace: "nowrap" }}><span style={{ fontSize: 11, fontWeight: 500, padding: "3px 8px", borderRadius: 12, background: sc.bg, color: sc.text, whiteSpace: "nowrap" }}>{c.status}</span></td>
                  <td style={{ padding: "12px 10px", whiteSpace: "nowrap" }}>{[...Array(5)].map((_, i) => <span key={i} style={{ color: i < c.aspiration ? "#f59e0b" : "#e5e7eb", fontSize: 12 }}>â˜…</span>)}</td>
                  <td style={{ padding: "12px 10px", fontSize: 13, fontWeight: 600, whiteSpace: "nowrap", color: c.score ? (c.score >= 4 ? "#10b981" : c.score >= 3 ? "#f59e0b" : "#ef4444") : "#d1d5db" }}>{c.score ? `${c.score}/5.0` : "â€”"}</td>
                  <td style={{ padding: "12px 10px", fontSize: 12, color: "#9ca3af", whiteSpace: "nowrap" }}>{c.createdAt}</td>
                  <td style={{ padding: "12px 8px" }} onClick={() => onNavigate("candidate-detail", c.id)}><Icon name="chevron-right" size={16} color="#d1d5db" /></td>
                </tr>
              );
            })}
          </tbody>
        </table>
        {filtered.length === 0 && (
          <div style={{ padding: 40, textAlign: "center", color: "#9ca3af", fontSize: 13 }}>è©²å½“ã™ã‚‹å€™è£œè€…ãŒã„ã¾ã›ã‚“</div>
        )}
      </div>

      {/* ===== ãƒ¡ãƒ¼ãƒ«ä¸€æ‹¬é€ä¿¡ãƒ¢ãƒ¼ãƒ€ãƒ« ===== */}
      {bulkEmailOpen && (
        <div style={{ position: "fixed", top: 0, left: 0, right: 0, bottom: 0, background: "rgba(0,0,0,0.5)", zIndex: 9999, display: "flex", alignItems: "center", justifyContent: "center", padding: 20 }}
          onClick={e => { if (e.target === e.currentTarget && bulkEmailStep !== "done") closeBulkEmail(); }}>
          <div style={{ background: "white", borderRadius: 16, boxShadow: "0 20px 60px rgba(0,0,0,0.3)", width: "100%", maxWidth: 720, maxHeight: "90vh", display: "flex", flexDirection: "column", overflow: "hidden" }}>
            {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
            <div style={{ padding: "20px 24px 16px", borderBottom: "1px solid #e5e7eb", display: "flex", justifyContent: "space-between", alignItems: "center" }}>
              <div>
                <h3 style={{ fontSize: 17, fontWeight: 700, color: "#111827", margin: 0 }}>âœ‰ï¸ ãƒ¡ãƒ¼ãƒ«ä¸€æ‹¬é€ä¿¡</h3>
                <div style={{ fontSize: 12, color: "#6b7280", marginTop: 4 }}>é€ä¿¡å…ˆ: {selectedCandidates.length}å</div>
              </div>
              <button onClick={closeBulkEmail} style={{ background: "none", border: "none", fontSize: 20, color: "#9ca3af", cursor: "pointer", lineHeight: 1 }}>Ã—</button>
            </div>

            <div style={{ flex: 1, overflowY: "auto", padding: "20px 24px" }}>
              {bulkEmailStep === "compose" && (<>
                {/* å®›å…ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */}
                <div style={{ marginBottom: 16 }}>
                  <label style={{ fontSize: 11, fontWeight: 600, color: "#6b7280", display: "block", marginBottom: 6 }}>å®›å…ˆ</label>
                  <div style={{ display: "flex", gap: 4, flexWrap: "wrap", padding: "8px 12px", background: "#f9fafb", borderRadius: 8, border: "1px solid #e5e7eb", maxHeight: 80, overflowY: "auto" }}>
                    {selectedCandidates.map(c => (
                      <span key={c.id} style={{ display: "inline-flex", alignItems: "center", gap: 4, padding: "2px 8px", background: "#eef2ff", color: "#4338ca", borderRadius: 4, fontSize: 11, fontWeight: 500 }}>
                        {c.lastName || ""}{c.firstName || ""} {c.email ? `<${c.email}>` : "(ãƒ¡ãƒ¼ãƒ«æœªç™»éŒ²)"}
                      </span>
                    ))}
                  </div>
                </div>

                {/* ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ */}
                <div style={{ marginBottom: 16 }}>
                  <label style={{ fontSize: 11, fontWeight: 600, color: "#6b7280", display: "block", marginBottom: 6 }}>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰é¸æŠ</label>
                  <div style={{ maxHeight: 140, overflowY: "auto", border: "1px solid #e5e7eb", borderRadius: 8, padding: 8 }}>
                    {Object.entries(templatesByCategory).map(([cat, tpls]) => (
                      <div key={cat} style={{ marginBottom: 6 }}>
                        <div style={{ fontSize: 10, fontWeight: 700, color: "#9ca3af", padding: "2px 4px", textTransform: "uppercase" }}>{cat}</div>
                        <div style={{ display: "flex", gap: 4, flexWrap: "wrap" }}>
                          {tpls.map(tpl => (
                            <button key={tpl.id} onClick={() => applyEmailTemplate(tpl)}
                              style={{ padding: "3px 10px", border: "1px solid #d1d5db", borderRadius: 5, background: "white", fontSize: 11, cursor: "pointer", color: "#374151" }}
                              onMouseOver={e => { e.currentTarget.style.background = "#eef2ff"; e.currentTarget.style.borderColor = "#6366f1"; }}
                              onMouseOut={e => { e.currentTarget.style.background = "white"; e.currentTarget.style.borderColor = "#d1d5db"; }}>
                              {tpl.label}
                            </button>
                          ))}
                        </div>
                      </div>
                    ))}
                    {Object.keys(templatesByCategory).length === 0 && <div style={{ fontSize: 11, color: "#9ca3af", padding: 8 }}>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆè¨­å®šç”»é¢ã‹ã‚‰ä½œæˆã§ãã¾ã™ï¼‰</div>}
                  </div>
                </div>

                {/* CC */}
                <div style={{ marginBottom: 12 }}>
                  <label style={{ fontSize: 11, fontWeight: 600, color: "#6b7280", display: "block", marginBottom: 4 }}>CCï¼ˆä»»æ„ï¼‰</label>
                  <input value={bulkEmailData.cc} onChange={e => setBulkEmailData({...bulkEmailData, cc: e.target.value})}
                    placeholder="cc@example.com" style={{ width: "100%", padding: "8px 12px", border: "1px solid #d1d5db", borderRadius: 8, fontSize: 13, outline: "none", boxSizing: "border-box" }} />
                </div>

                {/* ä»¶å */}
                <div style={{ marginBottom: 12 }}>
                  <label style={{ fontSize: 11, fontWeight: 600, color: "#6b7280", display: "block", marginBottom: 4 }}>ä»¶å *</label>
                  <input value={bulkEmailData.subject} onChange={e => setBulkEmailData({...bulkEmailData, subject: e.target.value})}
                    placeholder="ãƒ¡ãƒ¼ãƒ«ã®ä»¶åã‚’å…¥åŠ›" style={{ width: "100%", padding: "8px 12px", border: "1px solid #d1d5db", borderRadius: 8, fontSize: 13, outline: "none", boxSizing: "border-box" }} />
                </div>

                {/* æœ¬æ–‡ */}
                <div style={{ marginBottom: 12 }}>
                  <label style={{ fontSize: 11, fontWeight: 600, color: "#6b7280", display: "block", marginBottom: 4 }}>æœ¬æ–‡ *</label>
                  <div style={{ fontSize: 10, color: "#9ca3af", marginBottom: 4 }}>{"{{name}}"} = å€™è£œè€…æ°å / {"{{company}}"} = è‡ªç¤¾å ãŒè‡ªå‹•ç½®æ›ã•ã‚Œã¾ã™</div>
                  <textarea value={bulkEmailData.body} onChange={e => setBulkEmailData({...bulkEmailData, body: e.target.value})}
                    rows={10} placeholder="ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ã‚’å…¥åŠ›..." style={{ width: "100%", padding: "10px 12px", border: "1px solid #d1d5db", borderRadius: 8, fontSize: 13, outline: "none", resize: "vertical", boxSizing: "border-box", fontFamily: "inherit", lineHeight: 1.6 }} />
                </div>
              </>)}

              {bulkEmailStep === "preview" && (<>
                <div style={{ marginBottom: 12 }}>
                  <div style={{ fontSize: 12, fontWeight: 600, color: "#6b7280", marginBottom: 8 }}>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆ1äººç›®: {selectedCandidates[0] ? `${selectedCandidates[0].lastName || ""}${selectedCandidates[0].firstName || ""}` : "â€”"}ï¼‰</div>
                  <div style={{ background: "#f9fafb", borderRadius: 10, padding: 16, border: "1px solid #e5e7eb" }}>
                    <div style={{ fontSize: 11, color: "#6b7280", marginBottom: 4 }}>ä»¶å:</div>
                    <div style={{ fontSize: 14, fontWeight: 600, color: "#111827", marginBottom: 12 }}>
                      {bulkEmailData.subject.replace(/\{\{name\}\}/g, `${selectedCandidates[0]?.lastName || ""}${selectedCandidates[0]?.firstName || ""}`).replace(/\{\{company\}\}/g, "æ ªå¼ä¼šç¤¾madoguchi")}
                    </div>
                    <div style={{ fontSize: 11, color: "#6b7280", marginBottom: 4 }}>æœ¬æ–‡:</div>
                    <div style={{ fontSize: 13, color: "#374151", whiteSpace: "pre-wrap", lineHeight: 1.7, background: "white", padding: 14, borderRadius: 8, border: "1px solid #e5e7eb" }}>
                      {bulkEmailData.body.replace(/\{\{name\}\}/g, `${selectedCandidates[0]?.lastName || ""}${selectedCandidates[0]?.firstName || ""}`).replace(/\{\{company\}\}/g, "æ ªå¼ä¼šç¤¾madoguchi")}
                    </div>
                  </div>
                </div>
                <div style={{ padding: "10px 14px", background: "#fef3c7", borderRadius: 8, fontSize: 12, color: "#92400e" }}>
                  âš ï¸ {selectedCandidates.length}åã«åŒã˜å†…å®¹ã®ãƒ¡ãƒ¼ãƒ«ãŒé€ä¿¡ã•ã‚Œã¾ã™ã€‚å€™è£œè€…åã¯è‡ªå‹•ã§å·®ã—æ›¿ã‚ã‚Šã¾ã™ã€‚
                </div>
              </>)}

              {bulkEmailStep === "done" && (
                <div style={{ textAlign: "center", padding: 40 }}>
                  <div style={{ fontSize: 48, marginBottom: 12 }}>âœ…</div>
                  <div style={{ fontSize: 18, fontWeight: 700, color: "#111827", marginBottom: 4 }}>é€ä¿¡å®Œäº†</div>
                  <div style={{ fontSize: 13, color: "#6b7280" }}>{selectedCandidates.length}åã«ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸ</div>
                </div>
              )}
            </div>

            {/* ãƒ•ãƒƒã‚¿ãƒ¼ãƒœã‚¿ãƒ³ */}
            <div style={{ padding: "16px 24px", borderTop: "1px solid #e5e7eb", display: "flex", justifyContent: "space-between", alignItems: "center" }}>
              {bulkEmailStep === "compose" && (<>
                <button onClick={closeBulkEmail} style={{ padding: "8px 20px", border: "1px solid #d1d5db", borderRadius: 8, background: "white", color: "#374151", fontSize: 13, cursor: "pointer" }}>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button onClick={() => { if (!bulkEmailData.subject || !bulkEmailData.body) { alert("ä»¶åã¨æœ¬æ–‡ã¯å¿…é ˆã§ã™"); return; } setBulkEmailStep("preview"); }}
                  style={{ padding: "8px 20px", border: "none", borderRadius: 8, background: "#6366f1", color: "white", fontSize: 13, fontWeight: 500, cursor: "pointer" }}>
                  ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ â†’
                </button>
              </>)}
              {bulkEmailStep === "preview" && (<>
                <button onClick={() => setBulkEmailStep("compose")} style={{ padding: "8px 20px", border: "1px solid #d1d5db", borderRadius: 8, background: "white", color: "#374151", fontSize: 13, cursor: "pointer" }}>â† ç·¨é›†ã«æˆ»ã‚‹</button>
                <button onClick={handleBulkEmailSend} disabled={bulkEmailSending}
                  style={{ padding: "8px 24px", border: "none", borderRadius: 8, background: "#dc2626", color: "white", fontSize: 13, fontWeight: 600, cursor: "pointer", opacity: bulkEmailSending ? 0.6 : 1 }}>
                  {bulkEmailSending ? "é€ä¿¡ä¸­..." : `${selectedCandidates.length}åã«é€ä¿¡ã™ã‚‹`}
                </button>
              </>)}
              {bulkEmailStep === "done" && (
                <button onClick={closeBulkEmail} style={{ marginLeft: "auto", padding: "8px 24px", border: "none", borderRadius: 8, background: "#6366f1", color: "white", fontSize: 13, fontWeight: 500, cursor: "pointer" }}>é–‰ã˜ã‚‹</button>
              )}
            </div>
          </div>
        </div>
      )}

      {/* ===== LINEä¸€æ‹¬é€ä¿¡ãƒ¢ãƒ¼ãƒ€ãƒ« ===== */}
      {bulkLineOpen && (
        <div style={{ position: "fixed", top: 0, left: 0, right: 0, bottom: 0, background: "rgba(0,0,0,0.5)", zIndex: 9999, display: "flex", alignItems: "center", justifyContent: "center", padding: 20 }}
          onClick={e => { if (e.target === e.currentTarget) closeBulkLine(); }}>
          <div style={{ background: "white", borderRadius: 16, boxShadow: "0 20px 60px rgba(0,0,0,0.3)", width: "100%", maxWidth: 520, maxHeight: "90vh", display: "flex", flexDirection: "column", overflow: "hidden" }}>
            <div style={{ padding: "20px 24px 16px", borderBottom: "1px solid #e5e7eb", display: "flex", justifyContent: "space-between", alignItems: "center" }}>
              <div>
                <h3 style={{ fontSize: 17, fontWeight: 700, color: "#111827", margin: 0 }}>ğŸ’¬ LINEä¸€æ‹¬é€ä¿¡</h3>
                <div style={{ fontSize: 12, color: "#6b7280", marginTop: 4 }}>é€ä¿¡å…ˆ: {selectedCandidates.length}å</div>
              </div>
              <button onClick={closeBulkLine} style={{ background: "none", border: "none", fontSize: 20, color: "#9ca3af", cursor: "pointer", lineHeight: 1 }}>Ã—</button>
            </div>

            <div style={{ flex: 1, overflowY: "auto", padding: "20px 24px" }}>
              {bulkLineStep === "compose" && (<>
                <div style={{ marginBottom: 16 }}>
                  <label style={{ fontSize: 11, fontWeight: 600, color: "#6b7280", display: "block", marginBottom: 6 }}>å®›å…ˆ</label>
                  <div style={{ display: "flex", gap: 4, flexWrap: "wrap", padding: "8px 12px", background: "#f0fdf4", borderRadius: 8, border: "1px solid #bbf7d0", maxHeight: 60, overflowY: "auto" }}>
                    {selectedCandidates.map(c => (
                      <span key={c.id} style={{ display: "inline-flex", padding: "2px 8px", background: "#dcfce7", color: "#15803d", borderRadius: 4, fontSize: 11, fontWeight: 500 }}>
                        {c.lastName || ""}{c.firstName || ""}
                      </span>
                    ))}
                  </div>
                </div>
                <div style={{ marginBottom: 12 }}>
                  <label style={{ fontSize: 11, fontWeight: 600, color: "#6b7280", display: "block", marginBottom: 4 }}>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ *</label>
                  <div style={{ fontSize: 10, color: "#9ca3af", marginBottom: 4 }}>{"{{name}}"} = å€™è£œè€…æ°å</div>
                  <textarea value={bulkLineData.message} onChange={e => setBulkLineData({...bulkLineData, message: e.target.value})}
                    rows={6} placeholder="LINEãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." style={{ width: "100%", padding: "10px 12px", border: "1px solid #d1d5db", borderRadius: 8, fontSize: 13, outline: "none", resize: "vertical", boxSizing: "border-box", fontFamily: "inherit", lineHeight: 1.6 }} />
                </div>
              </>)}
              {bulkLineStep === "preview" && (<>
                <div style={{ background: "#f0fdf4", borderRadius: 10, padding: 16, border: "1px solid #bbf7d0" }}>
                  <div style={{ fontSize: 12, fontWeight: 600, color: "#15803d", marginBottom: 8 }}>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
                  <div style={{ background: "white", borderRadius: 12, padding: 14, fontSize: 13, color: "#374151", whiteSpace: "pre-wrap", lineHeight: 1.7, border: "1px solid #e5e7eb", borderBottomLeftRadius: 4 }}>
                    {bulkLineData.message.replace(/\{\{name\}\}/g, `${selectedCandidates[0]?.lastName || ""}${selectedCandidates[0]?.firstName || ""}`)}
                  </div>
                </div>
                <div style={{ marginTop: 12, padding: "10px 14px", background: "#fef3c7", borderRadius: 8, fontSize: 12, color: "#92400e" }}>
                  âš ï¸ {selectedCandidates.length}åã«åŒã˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé€ä¿¡ã•ã‚Œã¾ã™ã€‚
                </div>
              </>)}
              {bulkLineStep === "done" && (
                <div style={{ textAlign: "center", padding: 40 }}>
                  <div style={{ fontSize: 48, marginBottom: 12 }}>âœ…</div>
                  <div style={{ fontSize: 18, fontWeight: 700, color: "#111827", marginBottom: 4 }}>é€ä¿¡å®Œäº†</div>
                  <div style={{ fontSize: 13, color: "#6b7280" }}>{selectedCandidates.length}åã«LINEã‚’é€ä¿¡ã—ã¾ã—ãŸ</div>
                </div>
              )}
            </div>

            <div style={{ padding: "16px 24px", borderTop: "1px solid #e5e7eb", display: "flex", justifyContent: "space-between" }}>
              {bulkLineStep === "compose" && (<>
                <button onClick={closeBulkLine} style={{ padding: "8px 20px", border: "1px solid #d1d5db", borderRadius: 8, background: "white", color: "#374151", fontSize: 13, cursor: "pointer" }}>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button onClick={() => { if (!bulkLineData.message) { alert("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; } setBulkLineStep("preview"); }}
                  style={{ padding: "8px 20px", border: "none", borderRadius: 8, background: "#06c755", color: "white", fontSize: 13, fontWeight: 500, cursor: "pointer" }}>
                  ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ â†’
                </button>
              </>)}
              {bulkLineStep === "preview" && (<>
                <button onClick={() => setBulkLineStep("compose")} style={{ padding: "8px 20px", border: "1px solid #d1d5db", borderRadius: 8, background: "white", color: "#374151", fontSize: 13, cursor: "pointer" }}>â† ç·¨é›†ã«æˆ»ã‚‹</button>
                <button onClick={handleBulkLineSend} disabled={bulkLineSending}
                  style={{ padding: "8px 24px", border: "none", borderRadius: 8, background: "#06c755", color: "white", fontSize: 13, fontWeight: 600, cursor: "pointer", opacity: bulkLineSending ? 0.6 : 1 }}>
                  {bulkLineSending ? "é€ä¿¡ä¸­..." : `${selectedCandidates.length}åã«é€ä¿¡`}
                </button>
              </>)}
              {bulkLineStep === "done" && (
                <button onClick={closeBulkLine} style={{ marginLeft: "auto", padding: "8px 24px", border: "none", borderRadius: 8, background: "#06c755", color: "white", fontSize: 13, fontWeight: 500, cursor: "pointer" }}>é–‰ã˜ã‚‹</button>
              )}
            </div>
          </div>
        </div>
      )}

      {/* ===== CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« ===== */}
      {csvModalOpen && (
        <div style={{ position: "fixed", top: 0, left: 0, right: 0, bottom: 0, background: "rgba(0,0,0,0.5)", zIndex: 9999, display: "flex", alignItems: "center", justifyContent: "center", padding: 20 }}
          onClick={e => { if (e.target === e.currentTarget && csvStep !== "importing") resetCsvModal(); }}>
          <div style={{ background: "white", borderRadius: 16, padding: 28, boxShadow: "0 20px 60px rgba(0,0,0,0.3)", width: "100%", maxWidth: 720, maxHeight: "90vh", overflowY: "auto" }}>
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 20 }}>
              <h3 style={{ fontSize: 17, fontWeight: 700, color: "#111827" }}>ğŸ“‚ CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h3>
              {csvStep !== "importing" && <button onClick={resetCsvModal} style={{ background: "none", border: "none", fontSize: 20, cursor: "pointer", color: "#9ca3af" }}>âœ•</button>}
            </div>

            {/* ã‚¹ãƒ†ãƒƒãƒ—1: ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ */}
            {csvStep === "upload" && (
              <>
                <div style={{ padding: 32, border: "2px dashed #d1d5db", borderRadius: 12, textAlign: "center", marginBottom: 20, background: "#f9fafb" }}>
                  <Icon name="upload" size={40} color="#9ca3af" />
                  <div style={{ fontSize: 14, color: "#6b7280", marginTop: 12, marginBottom: 16 }}>CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã“ã“ã«ãƒ‰ãƒ­ãƒƒãƒ—ã€ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</div>
                  <input ref={csvFileRef} type="file" accept=".csv,.tsv,.txt" onChange={handleCsvFile}
                    style={{ display: "none" }} />
                  <button onClick={() => csvFileRef.current?.click()}
                    style={{ padding: "10px 24px", background: "#6366f1", color: "white", border: "none", borderRadius: 8, fontSize: 13, fontWeight: 600, cursor: "pointer" }}>
                    ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                  </button>
                </div>
                <div style={{ display: "flex", alignItems: "center", gap: 12, padding: 16, background: "#eef2ff", borderRadius: 10 }}>
                  <Icon name="download" size={20} color="#6366f1" />
                  <div style={{ flex: 1 }}>
                    <div style={{ fontSize: 13, fontWeight: 600, color: "#4338ca" }}>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆCSV</div>
                    <div style={{ fontSize: 11, color: "#6b7280" }}>ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«åˆã‚ã›ãŸCSVãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™</div>
                  </div>
                  <button onClick={downloadCsvTemplate}
                    style={{ padding: "8px 16px", background: "white", color: "#6366f1", border: "1px solid #6366f1", borderRadius: 8, fontSize: 12, fontWeight: 500, cursor: "pointer" }}>
                    ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                  </button>
                </div>
                <div style={{ marginTop: 16, fontSize: 12, color: "#9ca3af" }}>
                  â€» æ–‡å­—ã‚³ãƒ¼ãƒ‰: UTF-8ï¼ˆBOMä»˜ãæ¨å¥¨ï¼‰ã€åŒºåˆ‡ã‚Š: ã‚«ãƒ³ãƒ<br/>
                  â€» å¿…é ˆé …ç›®: å§“ã€åã€åŒºåˆ†ï¼ˆæ–°å’/ä¸­é€”ï¼‰
                </div>
              </>
            )}

            {/* ã‚¹ãƒ†ãƒƒãƒ—2: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */}
            {csvStep === "preview" && (
              <>
                <div style={{ marginBottom: 16, padding: 12, background: "#f0fdf4", borderRadius: 8, border: "1px solid #bbf7d0", fontSize: 13, color: "#15803d" }}>
                  âœ… {csvRawData.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œå‡ºã—ã¾ã—ãŸ
                </div>

                {/* ãƒãƒƒãƒ”ãƒ³ã‚°è¨­å®š */}
                <div style={{ marginBottom: 16 }}>
                  <div style={{ fontSize: 13, fontWeight: 600, color: "#374151", marginBottom: 8 }}>ã‚«ãƒ©ãƒ ãƒãƒƒãƒ”ãƒ³ã‚°</div>
                  <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: 8, maxHeight: 200, overflowY: "auto" }}>
                    {CSV_TEMPLATE_COLS.map(col => (
                      <div key={col.key} style={{ display: "flex", alignItems: "center", gap: 6, padding: "6px 10px", background: "#f9fafb", borderRadius: 8, fontSize: 12 }}>
                        <span style={{ color: col.required ? "#dc2626" : "#9ca3af", fontSize: 10 }}>{col.required ? "â—" : "â—‹"}</span>
                        <span style={{ color: "#374151", fontWeight: 500, minWidth: 70 }}>{col.label}</span>
                        <select value={csvMapping[col.key] ?? ""} onChange={e => setCsvMapping({...csvMapping, [col.key]: e.target.value === "" ? undefined : parseInt(e.target.value)})}
                          style={{ flex: 1, padding: "3px 4px", border: "1px solid #e5e7eb", borderRadius: 4, fontSize: 11, minWidth: 0 }}>
                          <option value="">-- æœªè¨­å®š --</option>
                          {csvHeaders.map((h, i) => <option key={i} value={i}>{h}</option>)}
                        </select>
                      </div>
                    ))}
                  </div>
                </div>

                {/* ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */}
                <div style={{ fontSize: 13, fontWeight: 600, color: "#374151", marginBottom: 8 }}>ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆå…ˆé ­5ä»¶ï¼‰</div>
                <div style={{ overflowX: "auto", marginBottom: 20 }}>
                  <table style={{ width: "100%", borderCollapse: "collapse", fontSize: 11 }}>
                    <thead>
                      <tr style={{ background: "#f9fafb" }}>
                        <th style={{ padding: "6px 8px", borderBottom: "1px solid #e5e7eb", textAlign: "left", color: "#6b7280" }}>#</th>
                        {CSV_TEMPLATE_COLS.filter(c => csvMapping[c.key] !== undefined).map(col => (
                          <th key={col.key} style={{ padding: "6px 8px", borderBottom: "1px solid #e5e7eb", textAlign: "left", color: "#6b7280", whiteSpace: "nowrap" }}>{col.label}</th>
                        ))}
                      </tr>
                    </thead>
                    <tbody>
                      {csvRawData.slice(0, 5).map((row, i) => (
                        <tr key={i} style={{ borderBottom: "1px solid #f3f4f6" }}>
                          <td style={{ padding: "6px 8px", color: "#9ca3af" }}>{i + 1}</td>
                          {CSV_TEMPLATE_COLS.filter(c => csvMapping[c.key] !== undefined).map(col => (
                            <td key={col.key} style={{ padding: "6px 8px", color: "#374151", maxWidth: 120, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>
                              {row[csvMapping[col.key]] || <span style={{ color: "#d1d5db" }}>â€”</span>}
                            </td>
                          ))}
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>

                <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                  <button onClick={() => { setCsvStep("upload"); setCsvRawData([]); setCsvHeaders([]); }}
                    style={{ padding: "10px 20px", border: "1px solid #e5e7eb", borderRadius: 8, background: "white", color: "#6b7280", fontSize: 13, cursor: "pointer" }}>
                    â† æˆ»ã‚‹
                  </button>
                  <button onClick={executeCsvImport}
                    style={{ padding: "10px 28px", border: "none", borderRadius: 8, background: "#6366f1", color: "white", fontSize: 13, fontWeight: 600, cursor: "pointer" }}>
                    {csvRawData.length}ä»¶ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                  </button>
                </div>
              </>
            )}

            {/* ã‚¹ãƒ†ãƒƒãƒ—3: ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­ */}
            {csvStep === "importing" && (
              <div style={{ padding: 40, textAlign: "center" }}>
                <div style={{ fontSize: 40, marginBottom: 16 }}>â³</div>
                <div style={{ fontSize: 15, fontWeight: 600, color: "#374151", marginBottom: 8 }}>ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­...</div>
                <div style={{ fontSize: 13, color: "#9ca3af" }}>ãƒ‡ãƒ¼ã‚¿ã‚’Supabaseã«ç™»éŒ²ã—ã¦ã„ã¾ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚</div>
              </div>
            )}

            {/* ã‚¹ãƒ†ãƒƒãƒ—4: å®Œäº† */}
            {csvStep === "done" && csvImportResult && (
              <div style={{ textAlign: "center" }}>
                <div style={{ fontSize: 48, marginBottom: 12 }}>{csvImportResult.failed === 0 ? "ğŸ‰" : "âš ï¸"}</div>
                <div style={{ fontSize: 17, fontWeight: 700, color: "#111827", marginBottom: 8 }}>ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†</div>
                <div style={{ display: "flex", justifyContent: "center", gap: 24, marginBottom: 20 }}>
                  <div style={{ textAlign: "center" }}>
                    <div style={{ fontSize: 28, fontWeight: 700, color: "#10b981" }}>{csvImportResult.success}</div>
                    <div style={{ fontSize: 12, color: "#6b7280" }}>æˆåŠŸ</div>
                  </div>
                  {csvImportResult.failed > 0 && (
                    <div style={{ textAlign: "center" }}>
                      <div style={{ fontSize: 28, fontWeight: 700, color: "#ef4444" }}>{csvImportResult.failed}</div>
                      <div style={{ fontSize: 12, color: "#6b7280" }}>å¤±æ•—</div>
                    </div>
                  )}
                  <div style={{ textAlign: "center" }}>
                    <div style={{ fontSize: 28, fontWeight: 700, color: "#6b7280" }}>{csvImportResult.total}</div>
                    <div style={{ fontSize: 12, color: "#6b7280" }}>åˆè¨ˆ</div>
                  </div>
                </div>
                {csvImportResult.errors.length > 0 && (
                  <div style={{ textAlign: "left", marginBottom: 16, padding: 12, background: "#fef2f2", borderRadius: 8, border: "1px solid #fecaca", maxHeight: 120, overflowY: "auto" }}>
                    <div style={{ fontSize: 12, fontWeight: 600, color: "#dc2626", marginBottom: 6 }}>ã‚¨ãƒ©ãƒ¼è©³ç´°:</div>
                    {csvImportResult.errors.map((e, i) => <div key={i} style={{ fontSize: 11, color: "#991b1b", marginBottom: 2 }}>ãƒ»{e}</div>)}
                  </div>
                )}
                <button onClick={() => { resetCsvModal(); window.location.reload(); }}
                  style={{ padding: "10px 28px", border: "none", borderRadius: 8, background: "#6366f1", color: "white", fontSize: 13, fontWeight: 600, cursor: "pointer" }}>
                  é–‰ã˜ã‚‹
                </button>
              </div>
            )}
          </div>
        </div>
      )}

      {/* ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ */}
      {bulkToast && (
        <div style={{
          position: "fixed", bottom: 24, left: "50%", transform: "translateX(-50%)",
          background: "#10b981", color: "white", padding: "12px 24px", borderRadius: 10,
          fontSize: 13, fontWeight: 600, boxShadow: "0 4px 16px rgba(16,185,129,0.3)", zIndex: 999,
          display: "flex", alignItems: "center", gap: 8,
        }}>
          <Icon name="check-circle" size={16} color="white" /> {bulkToast}
        </div>
      )}
    </div>
  );
}

// Candidate Detail - æ–°å’/ä¸­é€”å¯¾å¿œ
function CandidateDetailPage({ candidateId, onNavigate, candidates: propCandidates, onUpdateCandidate, can = () => true }) {
  const CANDS = propCandidates || CANDIDATES;
  const c = CANDS.find(c => c.id === candidateId) || CANDS[0];
  const isNewGrad = c.recruitType === "æ–°å’";
  const [activeTab, setActiveTab] = useState("timeline");
  const [memoText, setMemoText] = useState(c.notes || "");

  // ã‚¹ãƒ†ãƒ¼ã‚¸å¤‰æ›´ç”¨ state
  const [editingStage, setEditingStage] = useState(false);
  const [selectedStage, setSelectedStage] = useState(c.stage);
  const [selectedSub, setSelectedSub] = useState(c.substatus || "");
  const [savingStage, setSavingStage] = useState(false);

  // é¸æŠä¸­ã‚¹ãƒ†ãƒ¼ã‚¸ã®å®šç¾©ã‚’å–å¾—
  const currentStageDef = getStageDefByName(selectedStage);
  const availableSubs = currentStageDef
    ? [...currentStageDef.substatuses, ...currentStageDef.exitStatuses]
    : [];

  // ã‚¹ãƒ†ãƒ¼ã‚¸ãŒå¤‰ã‚ã£ãŸã‚‰ã‚µãƒ–ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
  const handleStageChange = (newStage) => {
    setSelectedStage(newStage);
    const def = getStageDefByName(newStage);
    if (def) setSelectedSub(def.substatuses[0] || "");
  };

  // ä¿å­˜
  const handleSaveStage = async () => {
    if (!onUpdateCandidate) return;
    setSavingStage(true);
    await onUpdateCandidate(c.id, { stage: selectedStage, substatus: selectedSub });
    setSavingStage(false);
    setEditingStage(false);
  };

  // ã‚­ãƒ£ãƒ³ã‚»ãƒ«
  const handleCancelStage = () => {
    setSelectedStage(c.stage);
    setSelectedSub(c.substatus || "");
    setEditingStage(false);
  };

  // è©•ä¾¡ãƒ»FBé–¢é€£
  const EVAL_CRITERIA = [
    { key: "logic", label: "è«–ç†çš„æ€è€ƒåŠ›", icon: "ğŸ’¡" },
    { key: "communication", label: "ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³åŠ›", icon: "ğŸ—£ï¸" },
    { key: "motivation", label: "å¿—æœ›åº¦ãƒ»ç†±æ„", icon: "ğŸ”¥" },
    { key: "culture", label: "ã‚«ãƒ«ãƒãƒ£ãƒ¼ãƒ•ã‚£ãƒƒãƒˆ", icon: "ğŸ¤" },
    { key: "skill", label: "ã‚¹ã‚­ãƒ«ãƒ»çµŒé¨“", icon: "âš™ï¸" },
  ];
  const INTERVIEW_STAGES = ["ä¸€æ¬¡é¢æ¥", "äºŒæ¬¡é¢æ¥", "æœ€çµ‚é¢æ¥"];

  // FBç”¨ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼ˆSupabaseé€£æºæ™‚ã«ç½®ãæ›ãˆï¼‰
  const [feedbacks, setFeedbacks] = useState(() => {
    const stageOrder = STAGE_DEFINITIONS.map(s => s.name);
    const currentIdx = stageOrder.indexOf(c.stage);
    const passedInterviews = INTERVIEW_STAGES.filter(s => {
      const idx = stageOrder.indexOf(s);
      return idx < currentIdx || (idx === currentIdx && ["å®Ÿæ–½æ¸ˆ", "åˆæ ¼"].includes(c.substatus));
    });
    // é€šéæ¸ˆã¿ã®é¢æ¥ã«ã¯ãƒ€ãƒŸãƒ¼FBã‚’ç”Ÿæˆ
    const interviewers = { "ä¸€æ¬¡é¢æ¥": "ä½ã€…æœ¨", "äºŒæ¬¡é¢æ¥": "å®‰å²¡", "æœ€çµ‚é¢æ¥": "ç”°ä¸­éƒ¨é•·" };
    const dummyComments = {
      "ä¸€æ¬¡é¢æ¥": "ç¬¬ä¸€å°è±¡ãŒè‰¯ãã€åŸºæœ¬çš„ãªã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³èƒ½åŠ›ã¯é«˜ã„ã€‚æ¥­ç•Œç†è§£ã¯ã‚„ã‚„æµ…ã„éƒ¨åˆ†ã‚‚ã‚ã‚‹ãŒã€å­¦ç¿’æ„æ¬²ã¯æ„Ÿã˜ã‚‰ã‚Œã‚‹ã€‚",
      "äºŒæ¬¡é¢æ¥": "å‰å›ã‹ã‚‰ã®æˆé•·ãŒè¦‹ã‚‰ã‚ŒãŸã€‚å…·ä½“çš„ãªã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã‚’äº¤ãˆãŸè‡ªå·±PRãŒåŠ¹æœçš„ã€‚ãƒãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®çµŒé¨“ã«ã¤ã„ã¦ã‚‚ã†å°‘ã—æ·±æ˜ã‚Šã—ãŸã„ã€‚",
      "æœ€çµ‚é¢æ¥": "çµŒå–¶ãƒ“ã‚¸ãƒ§ãƒ³ã¸ã®å…±æ„Ÿåº¦ãŒé«˜ãã€é•·æœŸçš„ãªã‚­ãƒ£ãƒªã‚¢ãƒ—ãƒ©ãƒ³ãŒæ˜ç¢ºã€‚å…¥ç¤¾å¾Œã®æ´»èºãŒæœŸå¾…ã§ãã‚‹äººæã€‚",
    };
    return passedInterviews.map(stage => ({
      stage,
      interviewer: interviewers[stage] || "æœªå®š",
      date: "2026/02/" + (10 + passedInterviews.indexOf(stage) * 7).toString().padStart(2, "0"),
      format: Math.random() > 0.5 ? "WEB" : "å¯¾é¢",
      scores: {
        logic: Math.floor(Math.random() * 2) + 3,
        communication: Math.floor(Math.random() * 2) + 3,
        motivation: Math.floor(Math.random() * 2) + 3,
        culture: Math.floor(Math.random() * 2) + 3,
        skill: Math.floor(Math.random() * 2) + 3,
      },
      overall: +(3 + Math.random() * 1.5).toFixed(1),
      result: "åˆæ ¼",
      comment: dummyComments[stage] || "",
      strengths: stage === "ä¸€æ¬¡é¢æ¥" ? "ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³åŠ›ã€ç¬¬ä¸€å°è±¡" : stage === "äºŒæ¬¡é¢æ¥" ? "è«–ç†çš„æ€è€ƒåŠ›ã€æˆé•·æ„æ¬²" : "ãƒ“ã‚¸ãƒ§ãƒ³å…±æ„Ÿåº¦ã€ã‚­ãƒ£ãƒªã‚¢ãƒ—ãƒ©ãƒ³",
      concerns: stage === "ä¸€æ¬¡é¢æ¥" ? "æ¥­ç•Œç†è§£ãŒã‚„ã‚„æµ…ã„" : stage === "äºŒæ¬¡é¢æ¥" ? "ãƒãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯çµŒé¨“ã®æ·±æ˜ã‚ŠãŒå¿…è¦" : "ç‰¹ã«ãªã—",
    }));
  });

  const [fbFormOpen, setFbFormOpen] = useState(false); // FBå…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤º
  const [fbFormStage, setFbFormStage] = useState(""); // å…¥åŠ›ä¸­ã®ã‚¹ãƒ†ãƒ¼ã‚¸
  const [fbFormData, setFbFormData] = useState({
    interviewer: "", date: new Date().toISOString().slice(0, 10), format: "WEB",
    scores: { logic: 3, communication: 3, motivation: 3, culture: 3, skill: 3 },
    overall: 3, result: "åˆæ ¼", comment: "", strengths: "", concerns: "",
  });

  const openFbForm = (stage) => {
    setFbFormStage(stage || INTERVIEW_STAGES.find(s => !feedbacks.some(f => f.stage === s)) || "ä¸€æ¬¡é¢æ¥");
    setFbFormData({ interviewer: "", date: new Date().toISOString().slice(0, 10), format: "WEB",
      scores: { logic: 3, communication: 3, motivation: 3, culture: 3, skill: 3 },
      overall: 3, result: "åˆæ ¼", comment: "", strengths: "", concerns: "" });
    setFbFormOpen(true);
  };

  const saveFb = () => {
    const newFb = { ...fbFormData, stage: fbFormStage };
    setFeedbacks(prev => {
      const existing = prev.findIndex(f => f.stage === fbFormStage);
      if (existing >= 0) { const updated = [...prev]; updated[existing] = newFb; return updated; }
      return [...prev, newFb].sort((a, b) => INTERVIEW_STAGES.indexOf(a.stage) - INTERVIEW_STAGES.indexOf(b.stage));
    });
    setFbFormOpen(false);
  };

  // ãƒ¡ãƒ¼ãƒ«é€ä¿¡é–¢é€£
  const [showCompose, setShowCompose] = useState(false);
  const [emailSubject, setEmailSubject] = useState("");
  const [emailBody, setEmailBody] = useState("");
  const [sending, setSending] = useState(false);
  const [sendError, setSendError] = useState("");
  const [sendSuccess, setSendSuccess] = useState("");
  const [messageHistory, setMessageHistory] = useState([]);
  const [loadingMessages, setLoadingMessages] = useState(false);

  // Gmail APIã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å±¥æ­´ã‚’èª­ã¿è¾¼ã‚€
  const loadMessages = useCallback(async () => {
    if (!c.email) return;
    setLoadingMessages(true);
    try {
      const res = await fetch('/.netlify/functions/gmail', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'fetch', candidateEmail: c.email }),
      });
      const data = await res.json();
      if (data.success && data.messages) {
        setMessageHistory(data.messages);
      }
    } catch (err) {
      console.error('ãƒ¡ãƒ¼ãƒ«å–å¾—ã‚¨ãƒ©ãƒ¼:', err);
    }
    setLoadingMessages(false);
  }, [c.email]);

  useEffect(() => { if (activeTab === "messages") loadMessages(); }, [activeTab, loadMessages]);

  // Gmail APIçµŒç”±ã§ãƒ¡ãƒ¼ãƒ«é€ä¿¡
  const handleSendEmail = async () => {
    if (!emailSubject.trim() || !emailBody.trim()) {
      setSendError("ä»¶åã¨æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      return;
    }
    if (!c.email) {
      setSendError("ã“ã®å€™è£œè€…ã«ã¯ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“");
      return;
    }
    setSending(true);
    setSendError("");
    setSendSuccess("");

    try {
      const res = await fetch('/.netlify/functions/gmail', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: 'send',
          to: c.email,
          subject: emailSubject,
          body: emailBody,
          candidateName: c.lastName + " " + c.firstName,
        }),
      });
      const result = await res.json();

      if (!res.ok || !result.success) {
        setSendError(result.error || "é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ");
        setSending(false);
        return;
      }

      // Supabaseã«ã‚‚å±¥æ­´ã‚’ä¿å­˜
      await sbApi.insert('messages', {
        candidate_id: c.id,
        direction: 'outbound',
        channel: 'email',
        to_email: c.email,
        subject: emailSubject,
        body: emailBody,
        status: 'sent',
      });

      setSendSuccess("ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼");
      setEmailSubject("");
      setEmailBody("");
      setShowCompose(false);
      loadMessages();
      setTimeout(() => setSendSuccess(""), 3000);
    } catch (err) {
      setSendError("é€ä¿¡ã‚¨ãƒ©ãƒ¼: " + err.message);
    }
    setSending(false);
  };

  // å®Ÿãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’æ§‹ç¯‰ï¼ˆ8æ®µéšå¯¾å¿œï¼‰
  const buildTimeline = () => {
    const currentStage = c.stage || "";
    const currentSub = c.substatus || "";
    const currentStageId = candidateToStageId(currentStage);
    const currentDef = getStageDefById(currentStageId);
    const currentOrder = currentDef ? currentDef.order : 0;
    const isExit = isExitStatus(currentSub);

    return STAGE_DEFINITIONS.map(def => {
      let status = "pending";
      let result = null;
      let date = "æœªå®š";

      if (def.id === currentStageId) {
        status = isExit ? "exit" : "current";
        result = currentSub || null;
        date = c.stageDate || "â€”";
        if (def.id === "entry") date = c.entryDate || c.stageDate || "â€”";
      } else if (def.order < currentOrder) {
        status = "completed";
        result = "é€šé";
        if (def.id === "entry") date = c.entryDate || "â€”";
        else date = "â€”";
      } else {
        status = "pending";
        date = "æœªå®š";
      }

      return { stage: def.name, date, status, result, color: def.color };
    });
  };
  const timeline = buildTimeline();
  return (
    <div style={{ padding: 24, maxWidth: 1000 }}>
      <button onClick={() => onNavigate("candidates")} style={{ display: "flex", alignItems: "center", gap: 4, color: "#6366f1", background: "none", border: "none", cursor: "pointer", fontSize: 13, marginBottom: 16 }}>
        <Icon name="arrow-left" size={16} /> å€™è£œè€…ä¸€è¦§ã«æˆ»ã‚‹
      </button>
      <div style={{ background: "white", borderRadius: 12, padding: 24, boxShadow: "0 1px 3px rgba(0,0,0,0.08)", marginBottom: 16 }}>
        <div style={{ display: "flex", gap: 20, alignItems: "flex-start" }}>
          <div style={{ width: 72, height: 72, borderRadius: 16, background: isNewGrad ? "#eef2ff" : "#fffbeb", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 26, fontWeight: 700, color: isNewGrad ? "#4338ca" : "#92400e", flexShrink: 0 }}>{c.lastName[0]}</div>
          <div style={{ flex: 1 }}>
            <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
              <h2 style={{ fontSize: 22, fontWeight: 700, color: "#111827", margin: 0 }}>{c.lastName} {c.firstName}</h2>
              {(c.lastNameKana || c.firstNameKana) && <span style={{ fontSize: 13, color: "#9ca3af" }}>({c.lastNameKana || ""} {c.firstNameKana || ""})</span>}
              <RecruitTypeBadge type={c.recruitType} />
            </div>
            <div style={{ display: "flex", flexWrap: "wrap", gap: 16, marginTop: 8, fontSize: 13, color: "#6b7280" }}>
              <span style={{ display: "flex", alignItems: "center", gap: 4 }}><Icon name="mail" size={14} /> {c.email}</span>
              <span style={{ display: "flex", alignItems: "center", gap: 4 }}><Icon name="phone" size={14} /> {c.phone}</span>
              {c.birthDate && <span style={{ display: "flex", alignItems: "center", gap: 4 }}><Icon name="calendar" size={14} /> ç”Ÿå¹´æœˆæ—¥: {c.birthDate}</span>}
            </div>
            <div style={{ display: "flex", flexWrap: "wrap", gap: 16, marginTop: 6, fontSize: 13, color: "#6b7280" }}>
              {isNewGrad ? (
                <span style={{ display: "flex", alignItems: "center", gap: 4 }}>
                  <Icon name="graduation-cap" size={14} /> {c.university} {c.faculty}{c.department ? ` / ${c.department}` : ""} / {c.gradYear}å¹´å’{c.graduationPeriod ? ` (${c.graduationPeriod})` : ""} / {c.majorType}
                </span>
              ) : (
                <span style={{ display: "flex", alignItems: "center", gap: 4 }}>
                  <Icon name="briefcase" size={14} /> {c.company} / {c.position} / çµŒé¨“{c.experience}å¹´
                </span>
              )}
            </div>
            <div style={{ display: "flex", gap: 12, marginTop: 10, flexWrap: "wrap" }}>
              <span style={{ fontSize: 12, padding: "3px 10px", borderRadius: 12, background: "#eef2ff", color: "#4338ca" }}>çµŒè·¯: {c.route}</span>
              {c.entryDate && <span style={{ fontSize: 12, padding: "3px 10px", borderRadius: 12, background: "#e0e7ff", color: "#3730a3" }}>ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ—¥: {c.entryDate}</span>}
              {c.stageDate && <span style={{ fontSize: 12, padding: "3px 10px", borderRadius: 12, background: "#dbeafe", color: "#1e40af" }}>ã‚¹ãƒ†ãƒ¼ã‚¸åˆ°é”æ—¥: {c.stageDate}</span>}
              {c.originalStage && <span style={{ fontSize: 12, padding: "3px 10px", borderRadius: 12, background: "#f0f9ff", color: "#075985" }}>å…ƒã‚¹ãƒ†ãƒ¼ã‚¸: {c.originalStage}</span>}
              <span style={{ fontSize: 12, padding: "3px 10px", borderRadius: 12, background: "#fef3c7", color: "#92400e" }}>å¿—æœ›åº¦: {"â˜…".repeat(c.aspiration)}{"â˜†".repeat(5 - c.aspiration)}</span>
              {c.agent && <span style={{ fontSize: 12, padding: "3px 10px", borderRadius: 12, background: "#f0fdf4", color: "#15803d" }}>{c.agent}</span>}
            </div>
            {c.notes && (
              <div style={{ marginTop: 10, padding: "8px 12px", background: "#fffbeb", borderRadius: 8, fontSize: 12, color: "#92400e", border: "1px solid #fde68a" }}>
                ğŸ“ ãƒ¡ãƒ¢: {c.notes}
              </div>
            )}
          </div>
          <div style={{ display: "flex", flexDirection: "column", gap: 10, alignItems: "flex-end" }}>
            {/* ã‚¹ãƒ†ãƒ¼ã‚¸å¤‰æ›´UI */}
            {!can("changeStage") ? (
              <div style={{ display: "flex", alignItems: "center", gap: 6, padding: "8px 16px", border: "2px solid #e5e7eb", borderRadius: 10, background: "#f9fafb", fontSize: 13, color: "#111827", fontWeight: 600, minWidth: 200, justifyContent: "center" }}>
                <div style={{ width: 8, height: 8, borderRadius: "50%", background: currentStageDef ? currentStageDef.color : "#6366f1" }} />
                {c.stage} {c.substatus ? `/ ${c.substatus}` : ""}
              </div>
            ) : !editingStage ? (
              <button onClick={() => setEditingStage(true)}
                style={{ display: "flex", alignItems: "center", gap: 6, padding: "8px 16px", border: `2px solid ${currentStageDef ? currentStageDef.color : "#6366f1"}`, borderRadius: 10, background: "white", fontSize: 13, cursor: "pointer", color: "#111827", fontWeight: 600, minWidth: 200, justifyContent: "center" }}>
                <div style={{ width: 8, height: 8, borderRadius: "50%", background: currentStageDef ? currentStageDef.color : "#6366f1" }} />
                {c.stage} {c.substatus ? `/ ${c.substatus}` : ""}
                <span style={{ fontSize: 10, color: "#9ca3af", marginLeft: 4 }}>â–¼ å¤‰æ›´</span>
              </button>
            ) : (
              <div style={{ background: "white", border: "2px solid #6366f1", borderRadius: 12, padding: 14, boxShadow: "0 8px 24px rgba(0,0,0,0.15)", minWidth: 280 }}>
                <div style={{ fontSize: 11, fontWeight: 600, color: "#6b7280", marginBottom: 8 }}>ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’å¤‰æ›´</div>
                <select value={selectedStage} onChange={e => handleStageChange(e.target.value)}
                  style={{ width: "100%", padding: "8px 10px", border: "1px solid #d1d5db", borderRadius: 8, fontSize: 13, marginBottom: 10, outline: "none", background: "white", cursor: "pointer" }}>
                  {STAGE_DEFINITIONS.map(def => (
                    <option key={def.id} value={def.name}>{def.order}. {def.name}</option>
                  ))}
                </select>
                <div style={{ fontSize: 11, fontWeight: 600, color: "#6b7280", marginBottom: 6 }}>ã‚µãƒ–ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
                <div style={{ display: "flex", flexWrap: "wrap", gap: 4, marginBottom: 12 }}>
                  {availableSubs.map(sub => {
                    const isExit = isExitStatus(sub);
                    const isActive = selectedSub === sub;
                    return (
                      <button key={sub} onClick={() => setSelectedSub(sub)}
                        style={{
                          padding: "5px 10px", border: isActive ? "2px solid" : "1px solid",
                          borderColor: isActive ? (isExit ? "#ef4444" : "#6366f1") : (isExit ? "#fecaca" : "#e5e7eb"),
                          borderRadius: 8, fontSize: 11, cursor: "pointer", fontWeight: isActive ? 700 : 400,
                          background: isActive ? (isExit ? "#fef2f2" : "#eef2ff") : (isExit ? "#fff5f5" : "white"),
                          color: isExit ? "#dc2626" : (isActive ? "#4338ca" : "#374151"),
                        }}>
                        {sub}
                      </button>
                    );
                  })}
                </div>
                {/* å¤‰æ›´å‰ â†’ å¤‰æ›´å¾Œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */}
                {(selectedStage !== c.stage || selectedSub !== (c.substatus || "")) && (
                  <div style={{ padding: "8px 10px", background: "#f9fafb", borderRadius: 8, fontSize: 11, marginBottom: 10, lineHeight: 1.8 }}>
                    <span style={{ color: "#9ca3af" }}>{c.stage}/{c.substatus || "â€”"}</span>
                    <span style={{ margin: "0 6px", color: "#6366f1" }}>â†’</span>
                    <strong style={{ color: isExitStatus(selectedSub) ? "#dc2626" : "#4338ca" }}>{selectedStage}/{selectedSub}</strong>
                  </div>
                )}
                <div style={{ display: "flex", gap: 8, justifyContent: "flex-end" }}>
                  <button onClick={handleCancelStage}
                    style={{ padding: "6px 16px", border: "1px solid #d1d5db", borderRadius: 8, background: "white", fontSize: 12, cursor: "pointer", color: "#6b7280" }}>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                  <button onClick={handleSaveStage} disabled={savingStage || (selectedStage === c.stage && selectedSub === (c.substatus || ""))}
                    style={{ padding: "6px 16px", border: "none", borderRadius: 8, background: (selectedStage === c.stage && selectedSub === (c.substatus || "")) ? "#d1d5db" : "#6366f1", color: "white", fontSize: 12, cursor: savingStage ? "default" : "pointer", fontWeight: 600 }}>
                    {savingStage ? "ä¿å­˜ä¸­..." : "ä¿å­˜"}
                  </button>
                </div>
              </div>
            )}
            <div style={{ display: "flex", gap: 8 }}>
              <button style={{ padding: "8px 16px", border: "1px solid #d1d5db", borderRadius: 8, background: "white", fontSize: 12, cursor: "pointer", color: "#374151" }}>LINEé€ä¿¡</button>
              <button onClick={() => onNavigate("interview-fb")} style={{ padding: "8px 16px", border: "none", borderRadius: 8, background: "#6366f1", color: "white", fontSize: 12, cursor: "pointer" }}>FBå…¥åŠ›</button>
            </div>
          </div>
        </div>
      </div>
      <div style={{ display: "flex", gap: 4, marginBottom: 16, background: "#f3f4f6", borderRadius: 10, padding: 4 }}>
        {["timeline", "evaluation", "messages", "memo", "docs"].map(tab => (
          <button key={tab} onClick={() => setActiveTab(tab)}
            style={{ flex: 1, padding: "8px 0", border: "none", borderRadius: 8, fontSize: 12, fontWeight: activeTab === tab ? 600 : 400, background: activeTab === tab ? "white" : "transparent", color: activeTab === tab ? "#4338ca" : "#6b7280", cursor: "pointer", boxShadow: activeTab === tab ? "0 1px 2px rgba(0,0,0,0.1)" : "none" }}>
            {({ timeline: "é¸è€ƒçŠ¶æ³", evaluation: "è©•ä¾¡ãƒ»FB", messages: "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸", memo: "ãƒ¡ãƒ¢", docs: "æ›¸é¡" })[tab]}
          </button>
        ))}
      </div>
      {/* ===== é¸è€ƒçŠ¶æ³ã‚¿ãƒ– ===== */}
      {activeTab === "timeline" && (
        <>
          <div style={{ background: "white", borderRadius: 12, padding: 24, boxShadow: "0 1px 3px rgba(0,0,0,0.08)" }}>
            <h3 style={{ fontSize: 15, fontWeight: 600, color: "#111827", marginBottom: 20 }}>é¸è€ƒã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</h3>
            {timeline.map((t, i) => {
              const dotColor = t.status === "completed" ? "#10b981" : t.status === "current" ? "#6366f1" : t.status === "exit" ? "#ef4444" : "#d1d5db";
              const dotBorder = t.status === "current" ? "3px solid #c7d2fe" : t.status === "exit" ? "3px solid #fecaca" : "none";
              const lineColor = t.status === "completed" ? "#a7f3d0" : "#e5e7eb";
              const isPositive = ["é€šé", "å®Œäº†", "å‚åŠ æ¸ˆ", "åˆæ ¼", "æ‰¿è«¾æ¸ˆ", "å…¥ç¤¾æ¸ˆ", "æ›¸é¡é€šé", "å—é¨“æ¸ˆ", "å®Ÿæ–½æ¸ˆ"].includes(t.result);
              const isNegative = ["ä¸åˆæ ¼", "æ¬ å¸­", "è¾é€€", "æ‰¿è«¾å¾Œè¾é€€"].includes(t.result);
              const resultBg = isPositive ? "#dcfce7" : isNegative ? "#fee2e2" : t.result === "ä¿ç•™" ? "#f3f4f6" : "#fef3c7";
              const resultText = isPositive ? "#15803d" : isNegative ? "#dc2626" : t.result === "ä¿ç•™" ? "#6b7280" : "#92400e";
              return (
                <div key={i} style={{ display: "flex", gap: 16 }}>
                  <div style={{ display: "flex", flexDirection: "column", alignItems: "center", width: 20 }}>
                    <div style={{ width: 12, height: 12, borderRadius: "50%", background: dotColor, border: dotBorder, boxSizing: "content-box", flexShrink: 0 }} />
                    {i < timeline.length - 1 && <div style={{ width: 2, flex: 1, background: lineColor, minHeight: 40 }} />}
                  </div>
                  <div style={{ flex: 1, paddingBottom: 20 }}>
                    <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start" }}>
                      <div style={{ fontSize: 14, fontWeight: 600, color: t.status === "pending" ? "#9ca3af" : t.status === "exit" ? "#dc2626" : "#111827" }}>{t.stage}</div>
                      <div style={{ fontSize: 12, color: "#9ca3af" }}>{t.date}</div>
                    </div>
                    {t.result && <span style={{ fontSize: 11, padding: "2px 8px", borderRadius: 10, background: resultBg, color: resultText, marginTop: 4, display: "inline-block" }}>{t.result}</span>}
                  </div>
                </div>
              );
            })}
          </div>
          <div style={{ background: "white", borderRadius: 12, padding: 20, marginTop: 16, boxShadow: "0 1px 3px rgba(0,0,0,0.08)" }}>
            <h4 style={{ fontSize: 14, fontWeight: 600, color: "#111827", marginBottom: 12 }}>åŸºæœ¬æƒ…å ±</h4>
            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "10px 24px", fontSize: 13 }}>
              <div><span style={{ color: "#9ca3af" }}>ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¸:</span> <strong style={{ color: "#4338ca" }}>{c.stage}</strong></div>
              <div><span style={{ color: "#9ca3af" }}>ã‚µãƒ–ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</span> <strong style={{ color: isExitStatus(c.substatus) ? "#dc2626" : "#374151" }}>{c.substatus || "â€”"}</strong></div>
              {c.originalStage && <div><span style={{ color: "#9ca3af" }}>å…ƒã‚¹ãƒ†ãƒ¼ã‚¸:</span> <strong>{c.originalStage}</strong></div>}
              {c.entryDate && <div><span style={{ color: "#9ca3af" }}>ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ—¥:</span> <strong>{c.entryDate}</strong></div>}
              {c.stageDate && <div><span style={{ color: "#9ca3af" }}>ã‚¹ãƒ†ãƒ¼ã‚¸åˆ°é”æ—¥:</span> <strong>{c.stageDate}</strong></div>}
              {c.birthDate && <div><span style={{ color: "#9ca3af" }}>ç”Ÿå¹´æœˆæ—¥:</span> <strong>{c.birthDate}</strong></div>}
              {c.graduationPeriod && <div><span style={{ color: "#9ca3af" }}>å’æ¥­äºˆå®š:</span> <strong>{c.graduationPeriod}</strong></div>}
              <div><span style={{ color: "#9ca3af" }}>ç™»éŒ²æ—¥:</span> <strong>{c.createdAt}</strong></div>
              <div><span style={{ color: "#9ca3af" }}>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</span> <strong>{c.status}</strong></div>
            </div>
          </div>
        </>
      )}

      {/* ===== è©•ä¾¡ãƒ»FBã‚¿ãƒ– ===== */}
      {activeTab === "evaluation" && (
        <div style={{ display: "flex", flexDirection: "column", gap: 16 }}>
          {/* ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ */}
          <div style={{ background: "white", borderRadius: 12, padding: 24, boxShadow: "0 1px 3px rgba(0,0,0,0.08)" }}>
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 16 }}>
              <h3 style={{ fontSize: 15, fontWeight: 600, color: "#111827" }}>è©•ä¾¡ã‚µãƒãƒªãƒ¼</h3>
              {can("inputFB") && <button onClick={() => openFbForm()} style={{ padding: "6px 16px", border: "none", borderRadius: 8, background: "#6366f1", color: "white", fontSize: 12, cursor: "pointer", fontWeight: 500 }}>ï¼‹ FBå…¥åŠ›</button>}
            </div>
            <div style={{ display: "flex", gap: 16, flexWrap: "wrap" }}>
              {/* ç·åˆã‚¹ã‚³ã‚¢ */}
              <div style={{ textAlign: "center", padding: 16, background: "#f9fafb", borderRadius: 10, minWidth: 100 }}>
                <div style={{ fontSize: 36, fontWeight: 700, color: (() => { const avg = feedbacks.length ? (feedbacks.reduce((s,f) => s + f.overall, 0) / feedbacks.length) : (c.score || 0); return avg >= 4 ? "#10b981" : avg >= 3 ? "#f59e0b" : "#ef4444"; })() }}>
                  {feedbacks.length ? (feedbacks.reduce((s,f) => s + f.overall, 0) / feedbacks.length).toFixed(1) : (c.score ? c.score.toFixed(1) : "â€”")}
                </div>
                <div style={{ fontSize: 11, color: "#9ca3af" }}>ç·åˆè©•ä¾¡</div>
                <div style={{ fontSize: 11, color: "#9ca3af", marginTop: 2 }}>{feedbacks.length}ä»¶ã®FB</div>
              </div>
              {/* é …ç›®åˆ¥ãƒ¬ãƒ¼ãƒ€ãƒ¼çš„è¡¨ç¤º */}
              <div style={{ flex: 1, minWidth: 200 }}>
                {EVAL_CRITERIA.map(cr => {
                  const avg = feedbacks.length ? feedbacks.reduce((s,f) => s + (f.scores[cr.key] || 0), 0) / feedbacks.length : 0;
                  return (
                    <div key={cr.key} style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 6 }}>
                      <span style={{ fontSize: 12, width: 16 }}>{cr.icon}</span>
                      <span style={{ fontSize: 12, color: "#6b7280", width: 120 }}>{cr.label}</span>
                      <div style={{ flex: 1, height: 8, background: "#f3f4f6", borderRadius: 4, overflow: "hidden" }}>
                        <div style={{ width: `${(avg / 5) * 100}%`, height: "100%", background: avg >= 4 ? "#10b981" : avg >= 3 ? "#f59e0b" : avg >= 2 ? "#f97316" : "#ef4444", borderRadius: 4, transition: "width 0.3s" }} />
                      </div>
                      <span style={{ fontSize: 12, fontWeight: 600, color: "#374151", width: 28, textAlign: "right" }}>{avg ? avg.toFixed(1) : "â€”"}</span>
                    </div>
                  );
                })}
              </div>
              {/* å¿—æœ›åº¦ãƒ»å½¢æ…‹ */}
              <div style={{ padding: 16, background: "#f9fafb", borderRadius: 10, minWidth: 120 }}>
                <div style={{ fontSize: 11, color: "#9ca3af", marginBottom: 4 }}>å¿—æœ›åº¦</div>
                <div style={{ fontSize: 13, marginBottom: 12 }}>{[...Array(5)].map((_, i) => <span key={i} style={{ color: i < c.aspiration ? "#f59e0b" : "#e5e7eb" }}>â˜…</span>)}</div>
                <div style={{ fontSize: 11, color: "#9ca3af", marginBottom: 4 }}>é¸è€ƒå½¢æ…‹</div>
                <div style={{ fontSize: 13, fontWeight: 500 }}>{c.format || "â€”"}</div>
              </div>
            </div>
          </div>

          {/* é¢æ¥ã”ã¨ã®FBã‚«ãƒ¼ãƒ‰ */}
          {feedbacks.length > 0 ? feedbacks.map((fb, idx) => (
            <div key={idx} style={{ background: "white", borderRadius: 12, padding: 20, boxShadow: "0 1px 3px rgba(0,0,0,0.08)", borderLeft: `4px solid ${fb.result === "åˆæ ¼" ? "#10b981" : fb.result === "ä¸åˆæ ¼" ? "#ef4444" : "#f59e0b"}` }}>
              <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start", marginBottom: 12 }}>
                <div>
                  <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                    <span style={{ fontSize: 15, fontWeight: 600, color: "#111827" }}>{fb.stage}</span>
                    <span style={{ fontSize: 11, padding: "2px 8px", borderRadius: 10, background: fb.result === "åˆæ ¼" ? "#dcfce7" : fb.result === "ä¸åˆæ ¼" ? "#fee2e2" : "#fef3c7", color: fb.result === "åˆæ ¼" ? "#15803d" : fb.result === "ä¸åˆæ ¼" ? "#dc2626" : "#92400e" }}>{fb.result}</span>
                    <span style={{ fontSize: 11, padding: "2px 8px", borderRadius: 10, background: fb.format === "WEB" ? "#dbeafe" : "#fce7f3", color: fb.format === "WEB" ? "#1d4ed8" : "#be185d" }}>{fb.format}</span>
                  </div>
                  <div style={{ fontSize: 12, color: "#9ca3af", marginTop: 4 }}>é¢æ¥å®˜: {fb.interviewer}ã€€|ã€€{fb.date}</div>
                </div>
                <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                  <div style={{ textAlign: "center" }}>
                    <div style={{ fontSize: 22, fontWeight: 700, color: fb.overall >= 4 ? "#10b981" : fb.overall >= 3 ? "#f59e0b" : "#ef4444" }}>{fb.overall}</div>
                    <div style={{ fontSize: 10, color: "#9ca3af" }}>ç·åˆ</div>
                  </div>
                  <button onClick={() => { setFbFormStage(fb.stage); setFbFormData({...fb}); setFbFormOpen(true); }}
                    style={{ fontSize: 11, padding: "4px 10px", border: "1px solid #e5e7eb", borderRadius: 6, background: "white", color: "#6b7280", cursor: "pointer" }}>ç·¨é›†</button>
                </div>
              </div>
              {/* é …ç›®åˆ¥ã‚¹ã‚³ã‚¢ */}
              <div style={{ display: "flex", gap: 8, flexWrap: "wrap", marginBottom: 12 }}>
                {EVAL_CRITERIA.map(cr => (
                  <div key={cr.key} style={{ display: "flex", alignItems: "center", gap: 4, padding: "4px 10px", background: "#f9fafb", borderRadius: 8, fontSize: 12 }}>
                    <span>{cr.icon}</span>
                    <span style={{ color: "#6b7280" }}>{cr.label}</span>
                    <span style={{ fontWeight: 600, color: (fb.scores[cr.key] || 0) >= 4 ? "#10b981" : (fb.scores[cr.key] || 0) >= 3 ? "#f59e0b" : "#ef4444" }}>
                      {fb.scores[cr.key] || "â€”"}
                    </span>
                  </div>
                ))}
              </div>
              {/* ã‚³ãƒ¡ãƒ³ãƒˆ */}
              {fb.comment && <div style={{ fontSize: 13, color: "#374151", lineHeight: 1.6, marginBottom: 10, padding: 12, background: "#f9fafb", borderRadius: 8 }}>{fb.comment}</div>}
              {/* è‰¯ã„ç‚¹ãƒ»æ‡¸å¿µç‚¹ */}
              <div style={{ display: "flex", gap: 12, flexWrap: "wrap" }}>
                {fb.strengths && (
                  <div style={{ flex: 1, minWidth: 150, padding: 10, background: "#f0fdf4", borderRadius: 8, border: "1px solid #bbf7d0" }}>
                    <div style={{ fontSize: 11, fontWeight: 600, color: "#15803d", marginBottom: 4 }}>âœ… è‰¯ã„ç‚¹</div>
                    <div style={{ fontSize: 12, color: "#374151" }}>{fb.strengths}</div>
                  </div>
                )}
                {fb.concerns && (
                  <div style={{ flex: 1, minWidth: 150, padding: 10, background: "#fff7ed", borderRadius: 8, border: "1px solid #fed7aa" }}>
                    <div style={{ fontSize: 11, fontWeight: 600, color: "#c2410c", marginBottom: 4 }}>âš ï¸ æ‡¸å¿µç‚¹</div>
                    <div style={{ fontSize: 12, color: "#374151" }}>{fb.concerns}</div>
                  </div>
                )}
              </div>
            </div>
          )) : (
            <div style={{ background: "white", borderRadius: 12, padding: 40, boxShadow: "0 1px 3px rgba(0,0,0,0.08)", textAlign: "center", color: "#9ca3af" }}>
              <Icon name="file-text" size={32} color="#d1d5db" />
              <div style={{ marginTop: 12, fontSize: 14 }}>é¢æ¥ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã¯ã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>
              {can("inputFB") && <button onClick={() => openFbForm()} style={{ marginTop: 16, padding: "10px 24px", border: "none", borderRadius: 8, background: "#6366f1", color: "white", fontSize: 13, cursor: "pointer", fontWeight: 500 }}>æœ€åˆã®FBã‚’å…¥åŠ›ã™ã‚‹</button>}
            </div>
          )}

          {/* ===== FBå…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰ ===== */}
          {fbFormOpen && (
            <div style={{ position: "fixed", top: 0, left: 0, right: 0, bottom: 0, background: "rgba(0,0,0,0.5)", zIndex: 9999, display: "flex", alignItems: "center", justifyContent: "center", padding: 20 }} onClick={e => { if (e.target === e.currentTarget) setFbFormOpen(false); }}>
            <div style={{ background: "white", borderRadius: 16, padding: 28, boxShadow: "0 20px 60px rgba(0,0,0,0.3)", border: "2px solid #6366f1", width: "100%", maxWidth: 680, maxHeight: "90vh", overflowY: "auto" }}>
              <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 20 }}>
                <h3 style={{ fontSize: 15, fontWeight: 600, color: "#4338ca" }}>ğŸ“ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å…¥åŠ› â€” {fbFormStage}</h3>
                <button onClick={() => setFbFormOpen(false)} style={{ background: "none", border: "none", fontSize: 18, cursor: "pointer", color: "#9ca3af" }}>âœ•</button>
              </div>

              {/* åŸºæœ¬æƒ…å ±è¡Œ */}
              <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr 1fr", gap: 12, marginBottom: 20 }}>
                <div>
                  <label style={{ fontSize: 11, color: "#6b7280", display: "block", marginBottom: 4 }}>ã‚¹ãƒ†ãƒ¼ã‚¸</label>
                  <select value={fbFormStage} onChange={e => setFbFormStage(e.target.value)}
                    style={{ width: "100%", padding: "8px 10px", border: "1px solid #e5e7eb", borderRadius: 8, fontSize: 13 }}>
                    {INTERVIEW_STAGES.map(s => <option key={s} value={s}>{s}</option>)}
                  </select>
                </div>
                <div>
                  <label style={{ fontSize: 11, color: "#6b7280", display: "block", marginBottom: 4 }}>é¢æ¥å®˜</label>
                  <input value={fbFormData.interviewer} onChange={e => setFbFormData({...fbFormData, interviewer: e.target.value})}
                    placeholder="é¢æ¥å®˜å" style={{ width: "100%", padding: "8px 10px", border: "1px solid #e5e7eb", borderRadius: 8, fontSize: 13, boxSizing: "border-box" }} />
                </div>
                <div>
                  <label style={{ fontSize: 11, color: "#6b7280", display: "block", marginBottom: 4 }}>å®Ÿæ–½æ—¥</label>
                  <input type="date" value={fbFormData.date} onChange={e => setFbFormData({...fbFormData, date: e.target.value})}
                    style={{ width: "100%", padding: "8px 10px", border: "1px solid #e5e7eb", borderRadius: 8, fontSize: 13, boxSizing: "border-box" }} />
                </div>
                <div>
                  <label style={{ fontSize: 11, color: "#6b7280", display: "block", marginBottom: 4 }}>å½¢æ…‹</label>
                  <div style={{ display: "flex", gap: 4 }}>
                    {["WEB", "å¯¾é¢"].map(f => (
                      <button key={f} onClick={() => setFbFormData({...fbFormData, format: f})}
                        style={{ flex: 1, padding: "8px 0", border: fbFormData.format === f ? "2px solid #6366f1" : "1px solid #e5e7eb", borderRadius: 8, fontSize: 12, background: fbFormData.format === f ? "#eef2ff" : "white", color: fbFormData.format === f ? "#4338ca" : "#6b7280", cursor: "pointer", fontWeight: fbFormData.format === f ? 600 : 400 }}>{f}</button>
                    ))}
                  </div>
                </div>
              </div>

              {/* é …ç›®åˆ¥è©•ä¾¡ */}
              <div style={{ marginBottom: 20 }}>
                <label style={{ fontSize: 12, fontWeight: 600, color: "#374151", display: "block", marginBottom: 10 }}>é …ç›®åˆ¥è©•ä¾¡</label>
                <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 10 }}>
                  {EVAL_CRITERIA.map(cr => (
                    <div key={cr.key} style={{ display: "flex", alignItems: "center", gap: 8, padding: "8px 12px", background: "#f9fafb", borderRadius: 8 }}>
                      <span style={{ fontSize: 14 }}>{cr.icon}</span>
                      <span style={{ fontSize: 12, color: "#6b7280", flex: 1 }}>{cr.label}</span>
                      <div style={{ display: "flex", gap: 2 }}>
                        {[1,2,3,4,5].map(n => (
                          <button key={n} onClick={() => setFbFormData({...fbFormData, scores: {...fbFormData.scores, [cr.key]: n}})}
                            style={{ width: 28, height: 28, border: "none", borderRadius: 6, fontSize: 12, fontWeight: 600, cursor: "pointer",
                              background: fbFormData.scores[cr.key] === n ? (n >= 4 ? "#10b981" : n >= 3 ? "#f59e0b" : "#ef4444") : "#f3f4f6",
                              color: fbFormData.scores[cr.key] === n ? "white" : "#9ca3af" }}>{n}</button>
                        ))}
                      </div>
                    </div>
                  ))}
                </div>
              </div>

              {/* ç·åˆè©•ä¾¡ãƒ»çµæœ */}
              <div style={{ display: "flex", gap: 16, marginBottom: 20 }}>
                <div style={{ flex: 1 }}>
                  <label style={{ fontSize: 12, fontWeight: 600, color: "#374151", display: "block", marginBottom: 8 }}>ç·åˆè©•ä¾¡</label>
                  <div style={{ display: "flex", gap: 4 }}>
                    {[1,2,3,4,5].map(n => (
                      <button key={n} onClick={() => setFbFormData({...fbFormData, overall: n})}
                        style={{ flex: 1, padding: "10px 0", border: "none", borderRadius: 8, fontSize: 16, fontWeight: 700, cursor: "pointer",
                          background: fbFormData.overall === n ? (n >= 4 ? "#10b981" : n >= 3 ? "#f59e0b" : "#ef4444") : "#f3f4f6",
                          color: fbFormData.overall === n ? "white" : "#d1d5db" }}>{n}</button>
                    ))}
                  </div>
                </div>
                <div style={{ flex: 1 }}>
                  <label style={{ fontSize: 12, fontWeight: 600, color: "#374151", display: "block", marginBottom: 8 }}>åˆ¤å®š</label>
                  <div style={{ display: "flex", gap: 4 }}>
                    {["åˆæ ¼", "ä¿ç•™", "ä¸åˆæ ¼"].map(r => (
                      <button key={r} onClick={() => setFbFormData({...fbFormData, result: r})}
                        style={{ flex: 1, padding: "10px 0", border: fbFormData.result === r ? "2px solid" : "1px solid #e5e7eb", borderRadius: 8, fontSize: 13, fontWeight: 600, cursor: "pointer",
                          background: fbFormData.result === r ? (r === "åˆæ ¼" ? "#dcfce7" : r === "ä¸åˆæ ¼" ? "#fee2e2" : "#fef3c7") : "white",
                          color: r === "åˆæ ¼" ? "#15803d" : r === "ä¸åˆæ ¼" ? "#dc2626" : "#92400e",
                          borderColor: fbFormData.result === r ? (r === "åˆæ ¼" ? "#86efac" : r === "ä¸åˆæ ¼" ? "#fca5a5" : "#fcd34d") : "#e5e7eb" }}>{r}</button>
                    ))}
                  </div>
                </div>
              </div>

              {/* ã‚³ãƒ¡ãƒ³ãƒˆ */}
              <div style={{ marginBottom: 16 }}>
                <label style={{ fontSize: 12, fontWeight: 600, color: "#374151", display: "block", marginBottom: 6 }}>ã‚³ãƒ¡ãƒ³ãƒˆãƒ»æ‰€æ„Ÿ</label>
                <textarea value={fbFormData.comment} onChange={e => setFbFormData({...fbFormData, comment: e.target.value})}
                  rows={3} placeholder="é¢æ¥ã®æ‰€æ„Ÿã€å€™è£œè€…ã®å°è±¡ãªã©ã‚’è¨˜å…¥..."
                  style={{ width: "100%", padding: 12, border: "1px solid #e5e7eb", borderRadius: 8, fontSize: 13, resize: "vertical", boxSizing: "border-box", lineHeight: 1.6 }} />
              </div>

              {/* è‰¯ã„ç‚¹ãƒ»æ‡¸å¿µç‚¹ */}
              <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12, marginBottom: 20 }}>
                <div>
                  <label style={{ fontSize: 12, fontWeight: 600, color: "#15803d", display: "block", marginBottom: 6 }}>âœ… è‰¯ã„ç‚¹</label>
                  <input value={fbFormData.strengths} onChange={e => setFbFormData({...fbFormData, strengths: e.target.value})}
                    placeholder="è©•ä¾¡ã§ãã‚‹ãƒã‚¤ãƒ³ãƒˆ" style={{ width: "100%", padding: "8px 12px", border: "1px solid #bbf7d0", borderRadius: 8, fontSize: 13, background: "#f0fdf4", boxSizing: "border-box" }} />
                </div>
                <div>
                  <label style={{ fontSize: 12, fontWeight: 600, color: "#c2410c", display: "block", marginBottom: 6 }}>âš ï¸ æ‡¸å¿µç‚¹</label>
                  <input value={fbFormData.concerns} onChange={e => setFbFormData({...fbFormData, concerns: e.target.value})}
                    placeholder="æ°—ã«ãªã‚‹ç‚¹ãƒ»èª²é¡Œ" style={{ width: "100%", padding: "8px 12px", border: "1px solid #fed7aa", borderRadius: 8, fontSize: 13, background: "#fff7ed", boxSizing: "border-box" }} />
                </div>
              </div>

              {/* ä¿å­˜ãƒœã‚¿ãƒ³ */}
              <div style={{ display: "flex", justifyContent: "flex-end", gap: 8 }}>
                <button onClick={() => setFbFormOpen(false)}
                  style={{ padding: "10px 24px", border: "1px solid #e5e7eb", borderRadius: 8, background: "white", color: "#6b7280", fontSize: 13, cursor: "pointer" }}>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button onClick={saveFb}
                  style={{ padding: "10px 24px", border: "none", borderRadius: 8, background: "#6366f1", color: "white", fontSize: 13, cursor: "pointer", fontWeight: 600 }}>
                  <Icon name="check-circle" size={14} /> ä¿å­˜ã™ã‚‹
                </button>
              </div>
            </div>
            </div>
          )}
        </div>
      )}

      {/* ===== ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¿ãƒ– ===== */}
      {activeTab === "messages" && (
        <div style={{ background: "white", borderRadius: 12, padding: 24, boxShadow: "0 1px 3px rgba(0,0,0,0.08)" }}>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 20 }}>
            <h3 style={{ fontSize: 15, fontWeight: 600, color: "#111827" }}>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</h3>
            <div style={{ display: "flex", gap: 8 }}>
              <button onClick={() => { setShowCompose(!showCompose); setSendError(""); setSendSuccess(""); }}
                style={{ padding: "8px 20px", border: "none", borderRadius: 8, background: showCompose ? "#ef4444" : "#1d4aff", color: "white", fontSize: 12, cursor: "pointer", fontWeight: 500 }}>
                {showCompose ? "âœ• é–‰ã˜ã‚‹" : "âœ‰ ãƒ¡ãƒ¼ãƒ«ä½œæˆ"}
              </button>
            </div>
          </div>

          {/* é€ä¿¡æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */}
          {sendSuccess && (
            <div style={{ padding: 12, background: "#ecfdf5", border: "1px solid #a7f3d0", borderRadius: 8, color: "#065f46", fontSize: 13, marginBottom: 16 }}>
              âœ“ {sendSuccess}
            </div>
          )}

          {/* ãƒ¡ãƒ¼ãƒ«ä½œæˆãƒ•ã‚©ãƒ¼ãƒ  */}
          {showCompose && (
            <div style={{ border: "1px solid #e5e7eb", borderRadius: 10, padding: 20, marginBottom: 20, background: "#fafbfc" }}>
              <div style={{ marginBottom: 14 }}>
                <label style={{ display: "block", fontSize: 12, fontWeight: 500, color: "#6b7280", marginBottom: 4 }}>å®›å…ˆ</label>
                <div style={{ padding: "8px 12px", background: "#f3f4f6", borderRadius: 6, fontSize: 13, color: "#374151" }}>
                  {c.lastName} {c.firstName} &lt;{c.email || "ãƒ¡ãƒ¼ãƒ«æœªç™»éŒ²"}&gt;
                </div>
              </div>
              <div style={{ marginBottom: 14 }}>
                <label style={{ display: "block", fontSize: 12, fontWeight: 500, color: "#6b7280", marginBottom: 4 }}>ä»¶å</label>
                <input
                  type="text"
                  value={emailSubject}
                  onChange={e => setEmailSubject(e.target.value)}
                  placeholder="ä»¶åã‚’å…¥åŠ›..."
                  style={{ width: "100%", padding: "8px 12px", border: "1px solid #d1d5db", borderRadius: 6, fontSize: 13, outline: "none", boxSizing: "border-box" }}
                />
              </div>
              <div style={{ marginBottom: 14 }}>
                <label style={{ display: "block", fontSize: 12, fontWeight: 500, color: "#6b7280", marginBottom: 4 }}>æœ¬æ–‡</label>
                <textarea
                  value={emailBody}
                  onChange={e => setEmailBody(e.target.value)}
                  placeholder="ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ã‚’å…¥åŠ›..."
                  rows={8}
                  style={{ width: "100%", padding: 12, border: "1px solid #d1d5db", borderRadius: 6, fontSize: 13, lineHeight: 1.7, resize: "vertical", outline: "none", fontFamily: "inherit", boxSizing: "border-box" }}
                />
              </div>
              {sendError && (
                <div style={{ padding: 10, background: "#fef2f2", border: "1px solid #fecaca", borderRadius: 6, color: "#dc2626", fontSize: 12, marginBottom: 12 }}>
                  {sendError}
                </div>
              )}
              <div style={{ display: "flex", justifyContent: "flex-end", gap: 8 }}>
                <button onClick={() => setShowCompose(false)}
                  style={{ padding: "8px 20px", border: "1px solid #d1d5db", borderRadius: 8, background: "white", fontSize: 12, cursor: "pointer", color: "#6b7280" }}>
                  ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button onClick={handleSendEmail} disabled={sending}
                  style={{ padding: "8px 24px", border: "none", borderRadius: 8, background: sending ? "#93c5fd" : "#1d4aff", color: "white", fontSize: 12, cursor: sending ? "default" : "pointer", fontWeight: 500 }}>
                  {sending ? "é€ä¿¡ä¸­..." : "é€ä¿¡ã™ã‚‹"}
                </button>
              </div>
            </div>
          )}

          {/* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å±¥æ­´ (Gmail API) */}
          <div>
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 12 }}>
              <h4 style={{ fontSize: 13, fontWeight: 600, color: "#6b7280" }}>ãƒ¡ãƒ¼ãƒ«å±¥æ­´</h4>
              <button onClick={loadMessages} disabled={loadingMessages}
                style={{ padding: "4px 12px", border: "1px solid #d1d5db", borderRadius: 6, background: "white", fontSize: 11, cursor: "pointer", color: "#6b7280" }}>
                {loadingMessages ? "èª­è¾¼ä¸­..." : "â†» æ›´æ–°"}
              </button>
            </div>
            {loadingMessages && messageHistory.length === 0 ? (
              <div style={{ textAlign: "center", padding: 20, color: "#9ca3af", fontSize: 13 }}>èª­ã¿è¾¼ã¿ä¸­...</div>
            ) : messageHistory.length === 0 ? (
              <div style={{ padding: 24, background: "#f9fafb", borderRadius: 10, textAlign: "center", color: "#9ca3af", fontSize: 13 }}>
                <Icon name="mail" size={24} color="#d1d5db" />
                <div style={{ marginTop: 8 }}>ã“ã®å€™è£œè€…ã¨ã®ãƒ¡ãƒ¼ãƒ«å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</div>
                <div style={{ marginTop: 4, fontSize: 12 }}>ã€Œãƒ¡ãƒ¼ãƒ«ä½œæˆã€ãƒœã‚¿ãƒ³ã‹ã‚‰ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã§ãã¾ã™</div>
              </div>
            ) : (
              <div style={{ display: "flex", flexDirection: "column", gap: 10 }}>
                {messageHistory.map((msg, i) => {
                  const isInbound = msg.direction === "inbound";
                  return (
                    <div key={msg.id || i} style={{
                      border: "1px solid " + (isInbound ? "#bfdbfe" : "#e5e7eb"),
                      borderRadius: 8, padding: 14,
                      background: isInbound ? "#eff6ff" : "#fff",
                      borderLeft: "3px solid " + (isInbound ? "#3b82f6" : "#1d4aff"),
                    }}>
                      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 6 }}>
                        <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                          <span style={{
                            background: isInbound ? "#dbeafe" : "#e0e7ff",
                            color: isInbound ? "#1d4aff" : "#4338ca",
                            padding: "2px 8px", borderRadius: 4, fontSize: 11, fontWeight: 500,
                          }}>
                            {isInbound ? "â† å—ä¿¡" : "â†’ é€ä¿¡"}
                          </span>
                          <span style={{ fontSize: 12, color: "#6b7280" }}>
                            {isInbound ? msg.from : msg.to}
                          </span>
                        </div>
                        <span style={{ fontSize: 11, color: "#9ca3af" }}>
                          {msg.date ? new Date(msg.date).toLocaleString('ja-JP', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : ""}
                        </span>
                      </div>
                      <div style={{ fontSize: 13, fontWeight: 500, color: "#111827", marginBottom: 4 }}>{msg.subject}</div>
                      <div style={{ fontSize: 12, color: "#6b7280", lineHeight: 1.6, whiteSpace: "pre-wrap", maxHeight: 80, overflow: "hidden" }}>{msg.body}</div>
                    </div>
                  );
                })}
              </div>
            )}
          </div>
        </div>
      )}

      {/* ===== ãƒ¡ãƒ¢ã‚¿ãƒ– ===== */}
      {activeTab === "memo" && (
        <div style={{ background: "white", borderRadius: 12, padding: 24, boxShadow: "0 1px 3px rgba(0,0,0,0.08)" }}>
          <h3 style={{ fontSize: 15, fontWeight: 600, color: "#111827", marginBottom: 20 }}>ãƒ¡ãƒ¢</h3>
          <textarea
            value={memoText}
            onChange={e => setMemoText(e.target.value)}
            placeholder="ã“ã®å€™è£œè€…ã«é–¢ã™ã‚‹ãƒ¡ãƒ¢ã‚’å…¥åŠ›..."
            style={{ width: "100%", minHeight: 160, padding: 14, border: "1px solid #e5e7eb", borderRadius: 10, fontSize: 13, lineHeight: 1.7, resize: "vertical", outline: "none", fontFamily: "inherit", boxSizing: "border-box" }}
          />
          <div style={{ display: "flex", justifyContent: "flex-end", marginTop: 10 }}>
            <button onClick={() => { if (onUpdateCandidate) onUpdateCandidate(c.id, { notes: memoText }); }}
              style={{ padding: "8px 20px", border: "none", borderRadius: 8, background: "#6366f1", color: "white", fontSize: 12, cursor: "pointer" }}>ä¿å­˜</button>
          </div>
        </div>
      )}

      {/* ===== æ›¸é¡ã‚¿ãƒ– ===== */}
      {activeTab === "docs" && (
        <div style={{ background: "white", borderRadius: 12, padding: 24, boxShadow: "0 1px 3px rgba(0,0,0,0.08)" }}>
          <h3 style={{ fontSize: 15, fontWeight: 600, color: "#111827", marginBottom: 20 }}>æ›¸é¡</h3>
          <div style={{ padding: 20, background: "#f9fafb", borderRadius: 10, textAlign: "center", color: "#9ca3af", fontSize: 13 }}>
            <Icon name="file-text" size={24} color="#d1d5db" />
            <div style={{ marginTop: 8 }}>æå‡ºæ›¸é¡ã¯ã¾ã ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>
            <button style={{ marginTop: 12, padding: "8px 20px", border: "1px solid #d1d5db", borderRadius: 8, background: "white", fontSize: 12, cursor: "pointer", color: "#374151" }}>æ›¸é¡ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
          </div>
        </div>
      )}
    </div>
  );
}

// Pipeline - é¸è€ƒãƒ•ãƒ­ãƒ¼è©³ç´°ãƒ“ãƒ¥ãƒ¼ï¼ˆ8æ®µéšå¯¾å¿œãƒ»æ­©ç•™ã¾ã‚Šè¨ˆç®—ä»˜ãï¼‰
// å€™è£œè€…ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰é¸è€ƒãƒ•ãƒ­ãƒ¼ã‚’å‹•çš„ã«æ§‹ç¯‰ã™ã‚‹é–¢æ•°
function buildPipelineFromCandidates(candidates) {
  // ã‚¹ãƒ†ãƒ¼ã‚¸åˆ¥ãƒ»ã‚µãƒ–ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥ã«é›†è¨ˆ
  const counts = {}; // { stageId: { substatus: count } }
  const exitCounts = {}; // { stageId: { exitStatus: count } }
  const stageTotal = {}; // { stageId: totalInStage }

  (candidates || []).forEach(c => {
    const stage = c.stage || "";
    const sub = c.substatus || "ãã®ä»–";
    const stageId = candidateToStageId(stage);

    if (!counts[stageId]) counts[stageId] = {};
    if (!exitCounts[stageId]) exitCounts[stageId] = {};
    if (!stageTotal[stageId]) stageTotal[stageId] = 0;

    stageTotal[stageId]++;

    if (isExitStatus(sub)) {
      exitCounts[stageId][sub] = (exitCounts[stageId][sub] || 0) + 1;
    } else {
      counts[stageId][sub] = (counts[stageId][sub] || 0) + 1;
    }
  });

  // ç´¯ç©é€šéæ•°ï¼ˆãã®ã‚¹ãƒ†ãƒ¼ã‚¸ä»¥é™ã«é€²ã‚“ã äººæ•°ï¼‰ã‚’è¨ˆç®—
  const cumulativePassed = {};
  let runningTotal = (candidates || []).length;
  STAGE_DEFINITIONS.forEach((def, i) => {
    cumulativePassed[def.id] = runningTotal;
    // é›¢è„±è€…ã‚’å·®ã—å¼•ã„ã¦æ¬¡ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã¸
    const exitCount = Object.values(exitCounts[def.id] || {}).reduce((a, b) => a + b, 0);
    const stayingInStage = Object.values(counts[def.id] || {}).reduce((a, b) => a + b, 0);
    // æ¬¡ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã«é€²ã‚“ã  = ç´¯ç© - é›¢è„± - æ»ç•™ä¸­
    runningTotal = runningTotal - exitCount - stayingInStage;
    if (runningTotal < 0) runningTotal = 0;
  });

  return STAGE_DEFINITIONS.map((def, i) => {
    const progSubs = def.substatuses.map(sub => ({
      status: sub,
      color: def.color,
      staying: (counts[def.id] && counts[def.id][sub]) || 0,
      total: (counts[def.id] && counts[def.id][sub]) || 0,
      isAlert: false,
    })).filter(s => s.staying > 0);

    const exitSubs = (def.exitStatuses || []).map(sub => ({
      status: sub,
      color: sub === "è¾é€€" || sub === "æ‰¿è«¾å¾Œè¾é€€" ? "#f59e0b" : sub === "ä¸åˆæ ¼" ? "#ef4444" : "#9ca3af",
      staying: (exitCounts[def.id] && exitCounts[def.id][sub]) || 0,
      total: (exitCounts[def.id] && exitCounts[def.id][sub]) || 0,
      isAlert: true,
    })).filter(s => s.staying > 0);

    const allSubs = [...progSubs, ...exitSubs];

    // æ­©ç•™ã¾ã‚Šï¼ˆå‰ã‚¹ãƒ†ãƒ¼ã‚¸ã‹ã‚‰ã®é€šéç‡ï¼‰
    const prevCumulative = i === 0 ? (candidates || []).length : cumulativePassed[STAGE_DEFINITIONS[i - 1].id];
    const thisCumulative = cumulativePassed[def.id];
    const conversionRate = prevCumulative > 0 ? Math.round((thisCumulative / prevCumulative) * 100) : 0;

    return {
      id: def.id,
      name: def.name,
      color: def.color,
      icon: def.icon,
      order: def.order,
      substages: allSubs.length > 0 ? allSubs : [{ status: "â€”", staying: 0, total: 0, color: def.color }],
      cumulativePassed: thisCumulative,
      exitCount: Object.values(exitCounts[def.id] || {}).reduce((a, b) => a + b, 0),
      activeCount: Object.values(counts[def.id] || {}).reduce((a, b) => a + b, 0),
      conversionRate: i === 0 ? 100 : conversionRate,
    };
  });
}

// ã‚µãƒ–ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®è¡Œã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
function SubstageRow({ sub, maxTotal, onClickStaying }) {
  const barWidth = maxTotal > 0 ? (sub.total / maxTotal) * 100 : 0;
  const isClickable = sub.staying > 0 && onClickStaying;
  return (
    <div style={{ display: "flex", alignItems: "center", gap: 8, padding: "6px 0" }}>
      <div style={{ width: 56, fontSize: 11, color: sub.isAlert ? "#ef4444" : "#6b7280", fontWeight: 500, flexShrink: 0 }}>
        {sub.status}
      </div>
      <div style={{ flex: 1, position: "relative", height: 22, background: "#f9fafb", borderRadius: 6, overflow: "hidden",
        cursor: isClickable ? "pointer" : "default" }}
        onClick={isClickable ? onClickStaying : undefined}>
        <div style={{
          height: "100%", borderRadius: 6,
          background: sub.isAlert
            ? "linear-gradient(90deg, #fecaca, #fca5a5)"
            : `linear-gradient(90deg, ${sub.color}30, ${sub.color}60)`,
          width: `${barWidth}%`, transition: "width 0.5s",
        }} />
        {sub.staying > 0 && (
          <div style={{
            position: "absolute", left: 0, top: 0, height: "100%", borderRadius: 6,
            background: sub.isAlert ? "#ef4444" : sub.color,
            width: `${maxTotal > 0 ? (sub.staying / maxTotal) * 100 : 0}%`,
            opacity: 0.85, transition: "width 0.5s",
          }} />
        )}
      </div>
      <div style={{ width: 32, textAlign: "right", flexShrink: 0 }}>
        <span onClick={isClickable ? onClickStaying : undefined}
          style={{
            fontSize: 13, fontWeight: 700,
            color: sub.staying > 0 ? (sub.isAlert ? "#ef4444" : "#111827") : "#d1d5db",
            cursor: isClickable ? "pointer" : "default",
            borderBottom: isClickable ? "1px dashed currentColor" : "none",
            transition: "opacity 0.15s",
          }}
          onMouseOver={e => { if (isClickable) e.target.style.opacity = "0.7"; }}
          onMouseOut={e => { if (isClickable) e.target.style.opacity = "1"; }}>
          {sub.staying}
        </span>
      </div>
      <div style={{ width: 36, textAlign: "right", flexShrink: 0, fontSize: 10, color: "#9ca3af" }}>
        /{sub.total}
      </div>
    </div>
  );
}

// ã‚¹ãƒ†ãƒ¼ã‚¸ã‚«ãƒ¼ãƒ‰ï¼ˆ8æ®µéšå¯¾å¿œãƒ»æ­©ç•™ã¾ã‚Šè¡¨ç¤ºä»˜ãï¼‰
function StageCard({ stage, onSubstageClick }) {
  const maxTotal = Math.max(...stage.substages.map(s => s.total), 1);
  const totalStaying = stage.activeCount || stage.substages.reduce((a, s) => a + (s.isAlert ? 0 : s.staying), 0);
  const alertCount = stage.exitCount || stage.substages.filter(s => s.isAlert).reduce((a, s) => a + s.staying, 0);

  return (
    <div style={{ background: "white", borderRadius: 14, boxShadow: "0 2px 8px rgba(0,0,0,0.06)", overflow: "hidden", minWidth: 150, maxWidth: 180, flex: 1 }}>
      <div style={{ height: 4, background: `linear-gradient(90deg, ${stage.color}, ${stage.color}99)` }} />
      <div style={{ padding: "12px 14px 4px" }}>
        <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 8 }}>
          <div style={{ display: "flex", alignItems: "center", gap: 5 }}>
            <Icon name={stage.icon} size={14} color={stage.color} />
            <span style={{ fontSize: 12, fontWeight: 700, color: "#111827" }}>{stage.name}</span>
          </div>
          <span style={{ fontSize: 18, fontWeight: 800, color: stage.color }}>{totalStaying}</span>
        </div>
      </div>
      <div style={{ padding: "0 14px 12px" }}>
        {stage.substages.map((sub, i) => (
          <SubstageRow key={i} sub={sub} maxTotal={maxTotal}
            onClickStaying={onSubstageClick ? () => onSubstageClick(stage.name, sub.status) : undefined} />
        ))}
        {alertCount > 0 && (
          <div style={{ marginTop: 6, padding: "4px 8px", background: "#fef2f2", borderRadius: 6, display: "flex", alignItems: "center", gap: 4, fontSize: 10, color: "#ef4444" }}>
            <Icon name="alert-circle" size={11} color="#ef4444" /> é›¢è„± {alertCount}å
          </div>
        )}
      </div>
    </div>
  );
}

function PipelinePage({ recruitFilter, onNavigateFromPipeline, candidates }) {
  const [viewMode, setViewMode] = useState("detail");
  const DETAILED_PIPELINE = buildPipelineFromCandidates(candidates);
  const totalEntry = (candidates || []).length;
  const totalActive = DETAILED_PIPELINE.reduce((a, s) => a + s.activeCount, 0);
  const totalExit = DETAILED_PIPELINE.reduce((a, s) => a + s.exitCount, 0);

  // ãƒ•ã‚¡ãƒãƒ«ãƒ‡ãƒ¼ã‚¿
  const funnelData = DETAILED_PIPELINE.map(s => ({ stage: s.name, value: s.cumulativePassed, color: s.color }));

  return (
    <div style={{ padding: 24, maxWidth: 1400 }}>
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 20 }}>
        <div>
          <h1 style={{ fontSize: 22, fontWeight: 700, color: "#111827" }}>é¸è€ƒãƒ•ãƒ­ãƒ¼</h1>
          <div style={{ fontSize: 12, color: "#6b7280", marginTop: 4 }}>
            å…¨ã‚¨ãƒ³ãƒˆãƒªãƒ¼ <strong style={{ color: "#6366f1" }}>{totalEntry}å</strong> ãƒ»
            é¸è€ƒä¸­ <strong style={{ color: "#111827" }}>{totalActive}å</strong> ãƒ»
            é›¢è„± <strong style={{ color: "#ef4444" }}>{totalExit}å</strong>
          </div>
        </div>
        <div style={{ display: "flex", gap: 4, background: "#f3f4f6", borderRadius: 8, padding: 3 }}>
          {[
            { id: "detail", icon: "git-branch", label: "è©³ç´°ãƒ•ãƒ­ãƒ¼" },
            { id: "funnel", icon: "filter", label: "ãƒ•ã‚¡ãƒãƒ«" },
            { id: "trend", icon: "bar-chart", label: "æœˆæ¬¡ãƒˆãƒ¬ãƒ³ãƒ‰" },
          ].map(v => (
            <button key={v.id} onClick={() => setViewMode(v.id)}
              style={{ display: "flex", alignItems: "center", gap: 4, padding: "6px 14px", border: "none", borderRadius: 6, fontSize: 12, cursor: "pointer",
                background: viewMode === v.id ? "white" : "transparent",
                color: viewMode === v.id ? "#4338ca" : "#6b7280",
                fontWeight: viewMode === v.id ? 600 : 400,
                boxShadow: viewMode === v.id ? "0 1px 2px rgba(0,0,0,0.08)" : "none" }}>
              <Icon name={v.icon} size={13} /> {v.label}
            </button>
          ))}
        </div>
      </div>


      {viewMode === "detail" ? (
        <>
          {/* å‡¡ä¾‹ */}
          <div style={{ display: "flex", gap: 20, marginBottom: 16, fontSize: 11, color: "#6b7280", alignItems: "center" }}>
            <span style={{ display: "flex", alignItems: "center", gap: 4 }}>
              <div style={{ width: 12, height: 12, borderRadius: 3, background: "#6366f1" }} /> é€²è¡Œä¸­
            </span>
            <span style={{ display: "flex", alignItems: "center", gap: 4 }}>
              <div style={{ width: 12, height: 12, borderRadius: 3, background: "#f59e0b" }} /> è¾é€€
            </span>
            <span style={{ display: "flex", alignItems: "center", gap: 4 }}>
              <div style={{ width: 12, height: 12, borderRadius: 3, background: "#ef4444" }} /> ä¸åˆæ ¼
            </span>
            <span style={{ display: "flex", alignItems: "center", gap: 4 }}>
              <div style={{ width: 12, height: 12, borderRadius: 3, background: "#9ca3af" }} /> ä¿ç•™
            </span>
          </div>

          {/* ãƒ¡ã‚¤ãƒ³ãƒ•ãƒ­ãƒ¼ï¼šæ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ãªã‚¹ãƒ†ãƒ¼ã‚¸ã‚«ãƒ¼ãƒ‰ */}
          <div style={{ display: "flex", gap: 8, overflowX: "auto", paddingBottom: 16, alignItems: "flex-start" }}>
            {DETAILED_PIPELINE.map((stage, i) => (
              <div key={stage.id} style={{ display: "flex", alignItems: "flex-start", gap: 8 }}>
                <StageCard stage={stage} onSubstageClick={onNavigateFromPipeline} />
                {i < DETAILED_PIPELINE.length - 1 && (
                  <div style={{ display: "flex", flexDirection: "column", alignItems: "center", paddingTop: 24, flexShrink: 0, gap: 2 }}>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#d1d5db" strokeWidth="2">
                      <path d="M5 12h14M12 5l7 7-7 7" />
                    </svg>
                    <span style={{ fontSize: 9, color: DETAILED_PIPELINE[i + 1].conversionRate >= 80 ? "#10b981" : DETAILED_PIPELINE[i + 1].conversionRate >= 50 ? "#f59e0b" : "#ef4444", fontWeight: 700 }}>
                      {DETAILED_PIPELINE[i + 1].conversionRate}%
                    </span>
                  </div>
                )}
              </div>
            ))}
          </div>

          {/* ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆå®Ÿãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å‹•çš„ç”Ÿæˆï¼‰ */}
          {(() => {
            const alerts = [];
            DETAILED_PIPELINE.forEach(stage => {
              if (stage.exitCount >= 5) {
                const exitDetails = stage.substages.filter(s => s.isAlert).map(s => `${s.status}${s.staying}å`).join("ã€");
                alerts.push({ title: `${stage.name}ã®é›¢è„±ãŒå¤šã„`, desc: `${exitDetails}ã€‚æ­©ç•™ã¾ã‚Š ${stage.conversionRate}%`, severity: stage.exitCount >= 20 ? "high" : "medium", count: stage.exitCount });
              }
              stage.substages.forEach(sub => {
                if (!sub.isAlert && (sub.status === "æ—¥ç¨‹èª¿æ•´ä¸­" || sub.status === "æ¡ˆå†…æ¸ˆ") && sub.staying >= 10) {
                  alerts.push({ title: `${stage.name} â†’ ${sub.status}ã®æ»ç•™`, desc: `${sub.staying}åãŒæ»ç•™ä¸­ã€‚ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ¨å¥¨`, severity: sub.staying >= 30 ? "high" : "medium", count: sub.staying });
                }
              });
              if (stage.order > 1 && stage.conversionRate < 50 && stage.cumulativePassed > 0) {
                alerts.push({ title: `${stage.name}ã®æ­©ç•™ã¾ã‚ŠãŒä½ã„`, desc: `æ­©ç•™ã¾ã‚Š ${stage.conversionRate}%ã€‚é¸è€ƒãƒ—ãƒ­ã‚»ã‚¹æ”¹å–„ã‚’æ¤œè¨`, severity: stage.conversionRate < 30 ? "high" : "medium", count: `${stage.conversionRate}%` });
              }
            });
            if (alerts.length === 0) return null;
            return (
              <div style={{ background: "linear-gradient(135deg, #fef2f2, #fff1f2)", borderRadius: 12, padding: 20, border: "1px solid #fecaca", marginTop: 8 }}>
                <h3 style={{ fontSize: 14, fontWeight: 600, color: "#dc2626", marginBottom: 12, display: "flex", alignItems: "center", gap: 6 }}>
                  <Icon name="alert-circle" size={16} color="#dc2626" /> ãƒœãƒˆãƒ«ãƒãƒƒã‚¯æ¤œçŸ¥
                </h3>
                <div style={{ display: "grid", gridTemplateColumns: alerts.length >= 3 ? "1fr 1fr 1fr" : alerts.length === 2 ? "1fr 1fr" : "1fr", gap: 12 }}>
                  {alerts.map((item, i) => (
                    <div key={i} style={{ padding: 14, background: "white", borderRadius: 10, border: `1px solid ${item.severity === "high" ? "#fecaca" : "#fde68a"}` }}>
                      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start", marginBottom: 6 }}>
                        <span style={{ fontSize: 12, fontWeight: 600, color: "#111827" }}>{item.title}</span>
                        <span style={{ fontSize: 16, fontWeight: 800, color: item.severity === "high" ? "#ef4444" : "#f59e0b" }}>{item.count}</span>
                      </div>
                      <div style={{ fontSize: 11, color: "#6b7280", lineHeight: 1.5 }}>{item.desc}</div>
                    </div>
                  ))}
                </div>
              </div>
            );
          })()}
        </>
      ) : viewMode === "funnel" ? (
        /* ãƒ•ã‚¡ãƒãƒ«ãƒ“ãƒ¥ãƒ¼ */
        <div style={{ background: "white", borderRadius: 12, padding: 24, boxShadow: "0 1px 3px rgba(0,0,0,0.08)" }}>
          <h3 style={{ fontSize: 14, fontWeight: 600, marginBottom: 20 }}>é¸è€ƒãƒ•ã‚¡ãƒãƒ«</h3>
          <div style={{ maxWidth: 700, margin: "0 auto" }}>
            {funnelData.map((item, i) => {
              const maxVal = funnelData[0].value || 1;
              const widthPct = Math.max((item.value / maxVal) * 100, 8);
              const prevVal = i > 0 ? funnelData[i - 1].value : item.value;
              const rate = prevVal > 0 ? Math.round((item.value / prevVal) * 100) : 100;
              return (
                <div key={item.stage} style={{ marginBottom: 4 }}>
                  <div style={{ display: "flex", alignItems: "center", gap: 12, marginBottom: 4 }}>
                    <div style={{ width: 80, fontSize: 12, fontWeight: 600, color: "#374151", textAlign: "right", flexShrink: 0 }}>{item.stage}</div>
                    <div style={{ flex: 1, position: "relative" }}>
                      <div style={{
                        height: 36, borderRadius: 8,
                        background: `linear-gradient(90deg, ${item.color}, ${item.color}cc)`,
                        width: `${widthPct}%`,
                        display: "flex", alignItems: "center", paddingLeft: 12,
                        transition: "width 0.5s",
                        minWidth: 50,
                      }}>
                        <span style={{ color: "white", fontSize: 13, fontWeight: 700 }}>{item.value}å</span>
                      </div>
                    </div>
                    <div style={{ width: 50, fontSize: 11, fontWeight: 600, flexShrink: 0, textAlign: "right",
                      color: i === 0 ? "#6b7280" : rate >= 80 ? "#10b981" : rate >= 50 ? "#f59e0b" : "#ef4444" }}>
                      {i === 0 ? "â€”" : `${rate}%`}
                    </div>
                  </div>
                  {i < funnelData.length - 1 && (
                    <div style={{ display: "flex", alignItems: "center", gap: 12, marginBottom: 4 }}>
                      <div style={{ width: 80 }} />
                      <div style={{ fontSize: 10, color: "#9ca3af", paddingLeft: 8 }}>
                        â†“ {DETAILED_PIPELINE[i].exitCount > 0 ? `é›¢è„± ${DETAILED_PIPELINE[i].exitCount}å` : ""}
                      </div>
                    </div>
                  )}
                </div>
              );
            })}
          </div>

          {/* å…¨ä½“æ­©ç•™ã¾ã‚Šã‚µãƒãƒªãƒ¼ */}
          <div style={{ marginTop: 24, padding: 16, background: "#f9fafb", borderRadius: 10, display: "flex", gap: 24, justifyContent: "center", flexWrap: "wrap" }}>
            <div style={{ textAlign: "center" }}>
              <div style={{ fontSize: 10, color: "#6b7280" }}>ã‚¨ãƒ³ãƒˆãƒªãƒ¼ â†’ å†…å®š</div>
              <div style={{ fontSize: 20, fontWeight: 800, color: "#6366f1" }}>
                {totalEntry > 0 ? Math.round(((DETAILED_PIPELINE.find(s => s.id === "offer")?.cumulativePassed || 0) / totalEntry) * 100) : 0}%
              </div>
            </div>
            <div style={{ textAlign: "center" }}>
              <div style={{ fontSize: 10, color: "#6b7280" }}>ã‚¨ãƒ³ãƒˆãƒªãƒ¼ â†’ å†…å®šæ‰¿è«¾</div>
              <div style={{ fontSize: 20, fontWeight: 800, color: "#10b981" }}>
                {totalEntry > 0 ? Math.round(((DETAILED_PIPELINE.find(s => s.id === "accepted")?.cumulativePassed || 0) / totalEntry) * 100) : 0}%
              </div>
            </div>
            <div style={{ textAlign: "center" }}>
              <div style={{ fontSize: 10, color: "#6b7280" }}>ç·é›¢è„±æ•°</div>
              <div style={{ fontSize: 20, fontWeight: 800, color: "#ef4444" }}>{totalExit}å</div>
            </div>
          </div>
        </div>
      ) : (
        /* æœˆæ¬¡ãƒˆãƒ¬ãƒ³ãƒ‰ */
        <div style={{ background: "white", borderRadius: 12, padding: 20, boxShadow: "0 1px 3px rgba(0,0,0,0.08)" }}>
          <h3 style={{ fontSize: 14, fontWeight: 600, marginBottom: 16 }}>æœˆæ¬¡ãƒˆãƒ¬ãƒ³ãƒ‰</h3>
          <ResponsiveContainer width="100%" height={300}>
            <LineChart data={MONTHLY_TREND}>
              <XAxis dataKey="month" tick={{ fontSize: 11 }} />
              <YAxis tick={{ fontSize: 11 }} />
              <Tooltip />
              <Legend wrapperStyle={{ fontSize: 11 }} />
              <Line type="monotone" dataKey="entries" name="ã‚¨ãƒ³ãƒˆãƒªãƒ¼" stroke="#6366f1" strokeWidth={2} dot={{ r: 4 }} />
              <Line type="monotone" dataKey="passes" name="é€šé" stroke="#10b981" strokeWidth={2} dot={{ r: 4 }} />
              <Line type="monotone" dataKey="offers" name="å†…å®š" stroke="#f59e0b" strokeWidth={2} dot={{ r: 4 }} />
            </LineChart>
          </ResponsiveContainer>
        </div>
      )}
    </div>
  );
}

// Interview Feedback
function InterviewFBPage({ onNavigate }) {
  const [isRecording, setIsRecording] = useState(false);
  const [scores, setScores] = useState({ communication: 4, logic: 5, motivation: 3, cultureFit: 4, skill: 4 });
  const [recommendation, setRecommendation] = useState("yes");
  const [showAI, setShowAI] = useState(false);
  const scoreLabels = { communication: "ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³åŠ›", logic: "è«–ç†çš„æ€è€ƒåŠ›", motivation: "å¿—æœ›åº¦ãƒ»ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³", cultureFit: "ã‚«ãƒ«ãƒãƒ£ãƒ¼ãƒ•ã‚£ãƒƒãƒˆ", skill: "ã‚¹ã‚­ãƒ«ãƒ»ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«" };
  const avgScore = (Object.values(scores).reduce((a, b) => a + b, 0) / Object.values(scores).length).toFixed(1);
  return (
    <div style={{ padding: 24, maxWidth: 800 }}>
      <button onClick={() => onNavigate("candidates")} style={{ display: "flex", alignItems: "center", gap: 4, color: "#6366f1", background: "none", border: "none", cursor: "pointer", fontSize: 13, marginBottom: 16 }}>
        <Icon name="arrow-left" size={16} /> æˆ»ã‚‹
      </button>
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 20 }}>
        <h1 style={{ fontSize: 22, fontWeight: 700, color: "#111827" }}>é¢æ¥ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å…¥åŠ›</h1>
        <button style={{ padding: "8px 16px", border: "1px solid #d1d5db", borderRadius: 8, background: "white", fontSize: 12, cursor: "pointer", color: "#374151" }}>ä¸‹æ›¸ãä¿å­˜</button>
      </div>
      <div style={{ background: "#f9fafb", borderRadius: 10, padding: "12px 16px", marginBottom: 20, fontSize: 13, color: "#374151", display: "flex", gap: 24, flexWrap: "wrap" }}>
        <span>å€™è£œè€…: <strong>å±±ç”° èŠ±å­</strong></span>
        <span>ã‚¹ãƒ†ãƒ¼ã‚¸: <strong>äºŒæ¬¡é¢æ¥ï¼ˆå½¹å“¡é¢è«‡ï¼‰</strong></span>
        <span>æ—¥æ™‚: <strong>2026/02/26 14:00-14:45</strong></span>
        <span>é¢æ¥å®˜: <strong>å®‰å²¡</strong></span>
      </div>
      <div style={{ background: "white", borderRadius: 12, padding: 20, boxShadow: "0 1px 3px rgba(0,0,0,0.08)", marginBottom: 16 }}>
        <h3 style={{ fontSize: 14, fontWeight: 600, marginBottom: 16, display: "flex", alignItems: "center", gap: 6 }}>
          <Icon name="mic" size={16} color="#ef4444" /> ãƒœã‚¤ã‚¹ãƒ¬ã‚³ãƒ¼ãƒ€ãƒ¼
        </h3>
        <div style={{ display: "flex", alignItems: "center", gap: 16, padding: "16px", background: isRecording ? "#fef2f2" : "#f9fafb", borderRadius: 10, border: isRecording ? "1px solid #fecaca" : "1px solid #e5e7eb" }}>
          <button onClick={() => { setIsRecording(!isRecording); if (!isRecording) setShowAI(false); }}
            style={{ width: 48, height: 48, borderRadius: "50%", border: "none", background: isRecording ? "#ef4444" : "#6366f1", color: "white", cursor: "pointer", display: "flex", alignItems: "center", justifyContent: "center" }}>
            <Icon name={isRecording ? "mic-off" : "mic"} size={22} color="white" />
          </button>
          <div style={{ flex: 1 }}>
            <div style={{ fontSize: 14, fontWeight: 600, color: isRecording ? "#dc2626" : "#374151" }}>
              {isRecording ? "â— éŒ²éŸ³ä¸­..." : "éŒ²éŸ³é–‹å§‹"}
            </div>
            <div style={{ fontSize: 12, color: "#9ca3af", marginTop: 2 }}>
              {isRecording ? "ã‚¯ãƒªãƒƒã‚¯ã—ã¦åœæ­¢" : "éŒ²éŸ³çµ‚äº†å¾Œã€AIãŒè‡ªå‹•ã§æ–‡å­—èµ·ã“ã—ã‚’è¡Œã„ã¾ã™"}
            </div>
          </div>
          <div style={{ fontSize: 20, fontWeight: 600, fontFamily: "monospace", color: isRecording ? "#dc2626" : "#9ca3af" }}>
            {isRecording ? "00:23:45" : "00:00:00"}
          </div>
        </div>
        {!isRecording && (
          <button onClick={() => setShowAI(true)} style={{ marginTop: 12, width: "100%", padding: "10px", border: "1px dashed #c7d2fe", borderRadius: 8, background: "#fafafe", color: "#6366f1", fontSize: 12, cursor: "pointer" }}>
            ğŸ“ æ–‡å­—èµ·ã“ã—çµæœã‚’è¡¨ç¤ºï¼ˆãƒ‡ãƒ¢ï¼‰
          </button>
        )}
      </div>
      <div style={{ background: "white", borderRadius: 12, padding: 20, boxShadow: "0 1px 3px rgba(0,0,0,0.08)", marginBottom: 16 }}>
        <h3 style={{ fontSize: 14, fontWeight: 600, marginBottom: 16 }}>è©•ä¾¡</h3>
        {Object.entries(scoreLabels).map(([key, label]) => (
          <div key={key} style={{ display: "flex", alignItems: "center", justifyContent: "space-between", padding: "10px 0", borderBottom: "1px solid #f3f4f6" }}>
            <span style={{ fontSize: 13, color: "#374151", width: 180 }}>{label}</span>
            <div style={{ display: "flex", gap: 8 }}>
              {[1, 2, 3, 4, 5].map(n => (
                <button key={n} onClick={() => setScores(prev => ({ ...prev, [key]: n }))}
                  style={{ width: 36, height: 36, borderRadius: "50%", border: scores[key] === n ? "none" : "2px solid #e5e7eb", background: scores[key] === n ? "#6366f1" : "white", color: scores[key] === n ? "white" : "#6b7280", fontSize: 14, fontWeight: 600, cursor: "pointer" }}>
                  {n}
                </button>
              ))}
            </div>
          </div>
        ))}
        <div style={{ marginTop: 16, padding: "12px 16px", background: "#eef2ff", borderRadius: 8, display: "flex", justifyContent: "space-between", alignItems: "center" }}>
          <span style={{ fontSize: 13, fontWeight: 600, color: "#4338ca" }}>ç·åˆè©•ä¾¡</span>
          <span style={{ fontSize: 22, fontWeight: 700, color: "#4338ca" }}>{avgScore} / 5.0</span>
        </div>
      </div>
      <div style={{ background: "white", borderRadius: 12, padding: 20, boxShadow: "0 1px 3px rgba(0,0,0,0.08)", marginBottom: 16 }}>
        <h3 style={{ fontSize: 14, fontWeight: 600, marginBottom: 12 }}>æ¨è–¦</h3>
        <div style={{ display: "flex", gap: 8 }}>
          {[["strong_yes", "å¼·ãæ¨è–¦"], ["yes", "æ¨è–¦"], ["neutral", "ä¿ç•™"], ["no", "éæ¨è–¦"], ["strong_no", "å¼·ãéæ¨è–¦"]].map(([val, label]) => (
            <button key={val} onClick={() => setRecommendation(val)}
              style={{ flex: 1, padding: "10px 8px", border: recommendation === val ? "none" : "1px solid #e5e7eb", borderRadius: 8, background: recommendation === val ? (val.includes("yes") ? "#10b981" : val === "neutral" ? "#f59e0b" : "#ef4444") : "white", color: recommendation === val ? "white" : "#6b7280", fontSize: 12, fontWeight: recommendation === val ? 600 : 400, cursor: "pointer" }}>
              {label}
            </button>
          ))}
        </div>
      </div>
      <div style={{ background: "white", borderRadius: 12, padding: 20, boxShadow: "0 1px 3px rgba(0,0,0,0.08)", marginBottom: 16 }}>
        <h3 style={{ fontSize: 14, fontWeight: 600, marginBottom: 12 }}>ã‚³ãƒ¡ãƒ³ãƒˆ</h3>
        <label style={{ fontSize: 12, fontWeight: 500, color: "#374151", display: "block", marginBottom: 4 }}>å¼·ã¿</label>
        <textarea placeholder="å€™è£œè€…ã®å¼·ã¿ã‚’è¨˜å…¥..." style={{ width: "100%", minHeight: 60, padding: 10, border: "1px solid #d1d5db", borderRadius: 8, fontSize: 13, resize: "vertical", fontFamily: "inherit", boxSizing: "border-box" }} />
        <label style={{ fontSize: 12, fontWeight: 500, color: "#374151", display: "block", marginBottom: 4, marginTop: 12 }}>æ‡¸å¿µç‚¹</label>
        <textarea placeholder="æ‡¸å¿µã•ã‚Œã‚‹ç‚¹ã‚’è¨˜å…¥..." style={{ width: "100%", minHeight: 60, padding: 10, border: "1px solid #d1d5db", borderRadius: 8, fontSize: 13, resize: "vertical", fontFamily: "inherit", boxSizing: "border-box" }} />
      </div>
      {showAI && (
        <div style={{ background: "linear-gradient(135deg, #eef2ff, #f5f3ff)", borderRadius: 12, padding: 20, marginBottom: 16, border: "1px solid #c7d2fe" }}>
          <h4 style={{ fontSize: 14, fontWeight: 600, color: "#4338ca", marginBottom: 10 }}>ğŸ’¡ AIææ¡ˆï¼ˆæ–‡å­—èµ·ã“ã—ã‹ã‚‰æŠ½å‡ºï¼‰</h4>
          <ul style={{ margin: 0, paddingLeft: 18, fontSize: 13, color: "#374151", lineHeight: 2 }}>
            <li>å€™è£œè€…ã¯ã€Œãƒãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã€ã«ã¤ã„ã¦3å›è¨€åŠ</li>
            <li>å…·ä½“çš„ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰: å¤§å­¦ã‚¼ãƒŸã§ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒªãƒ¼ãƒ€ãƒ¼çµŒé¨“</li>
            <li>è³ªå•ã¸ã®å›ç­”æ™‚é–“: å¹³å‡12ç§’ï¼ˆå³ç­”å‚¾å‘ï¼‰</li>
            <li>ç™ºè©±æ¯”ç‡: å€™è£œè€…55% / é¢æ¥å®˜45%ï¼ˆãƒãƒ©ãƒ³ã‚¹è‰¯å¥½ï¼‰</li>
          </ul>
          <button style={{ marginTop: 10, padding: "8px 16px", border: "none", borderRadius: 8, background: "#4338ca", color: "white", fontSize: 12, cursor: "pointer" }}>ã“ã®å†…å®¹ã‚’ãƒ¡ãƒ¢ã«åæ˜ ã™ã‚‹</button>
        </div>
      )}
      <div style={{ display: "flex", gap: 12, justifyContent: "flex-end" }}>
        <button style={{ padding: "12px 24px", border: "1px solid #d1d5db", borderRadius: 8, background: "white", fontSize: 13, cursor: "pointer", color: "#374151" }}>ä¸‹æ›¸ãä¿å­˜</button>
        <button style={{ padding: "12px 24px", border: "none", borderRadius: 8, background: "#6366f1", color: "white", fontSize: 13, fontWeight: 600, cursor: "pointer", display: "flex", alignItems: "center", gap: 6 }}>
          <Icon name="check-circle" size={16} /> è©•ä¾¡ã‚’ç¢ºå®šã—ã¦é€ä¿¡
        </button>
      </div>
    </div>
  );
}

// Schedule Page - æœ¬æ—¥ã®äºˆç´„ãƒ»ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä¸€è¦§
function SchedulePage({ recruitFilter }) {
  const todayEvents = [
    { time: "10:00-10:30", name: "ä½è—¤ å¤ªéƒ", stage: "èª¬æ˜ä¼š", format: "WEB", interviewer: null, type: "æ–°å’", meetUrl: "https://meet.google.com/xxx", location: null },
    { time: "11:00-11:45", name: "å°æ— ç”±ç¾", stage: "ä¸€æ¬¡é¢æ¥", format: "WEB", interviewer: "ä½ã€…æœ¨", type: "ä¸­é€”", meetUrl: "https://meet.google.com/yyy", location: null },
    { time: "14:00-14:45", name: "å±±ç”° èŠ±å­", stage: "äºŒæ¬¡é¢æ¥", format: "å¯¾é¢", interviewer: "å®‰å²¡", type: "æ–°å’", meetUrl: null, location: "æœ¬ç¤¾ 3F ä¼šè­°å®¤A" },
    { time: "15:30-16:15", name: "æ¾æœ¬ å¤§ä»‹", stage: "äºŒæ¬¡é¢æ¥", format: "å¯¾é¢", interviewer: "éˆ´æœ¨", type: "ä¸­é€”", meetUrl: null, location: "æœ¬ç¤¾ 3F ä¼šè­°å®¤B" },
    { time: "16:00-16:45", name: "ç”°ä¸­ å¥ä¸€", stage: "æœ€çµ‚é¢æ¥", format: "å¯¾é¢", interviewer: "ç”°ä¸­éƒ¨é•·", type: "æ–°å’", meetUrl: null, location: "æœ¬ç¤¾ 5F å½¹å“¡å®¤" },
    { time: "17:00-17:30", name: "åŠ è—¤ ç¿”å¤ª", stage: "æ›¸é¡é¸è€ƒçµæœé€šçŸ¥", format: "WEB", interviewer: null, type: "ä¸­é€”", meetUrl: "https://meet.google.com/zzz", location: null },
  ];

  const filtered = recruitFilter === "all" ? todayEvents : todayEvents.filter(e => e.type === recruitFilter);
  const webCount = filtered.filter(e => e.format === "WEB").length;
  const inPersonCount = filtered.filter(e => e.format === "å¯¾é¢").length;

  return (
    <div style={{ padding: 24, maxWidth: 900 }}>
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 20 }}>
        <div>
          <h1 style={{ fontSize: 22, fontWeight: 700, color: "#111827" }}>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h1>
          <div style={{ fontSize: 12, color: "#6b7280", marginTop: 4 }}>
            æœ¬æ—¥ã®äºˆå®š <strong>{filtered.length}ä»¶</strong>ï¼ˆğŸ’» WEB {webCount}ä»¶ ãƒ» ğŸ¢ å¯¾é¢ {inPersonCount}ä»¶ï¼‰
          </div>
        </div>
        <div style={{ fontSize: 14, fontWeight: 600, color: "#6366f1" }}>
          <Icon name="calendar" size={16} color="#6366f1" style={{ marginRight: 4 }} /> 2026å¹´2æœˆ26æ—¥ï¼ˆæœ¨ï¼‰
        </div>
      </div>

      <div style={{ display: "flex", flexDirection: "column", gap: 10 }}>
        {filtered.map((ev, i) => (
          <div key={i} style={{ background: "white", borderRadius: 12, boxShadow: "0 1px 3px rgba(0,0,0,0.08)", overflow: "hidden", display: "flex", border: "1px solid #f3f4f6" }}>
            {/* å·¦ã®è‰²ãƒãƒ¼ */}
            <div style={{ width: 4, background: ev.format === "WEB" ? "#10b981" : "#ec4899", flexShrink: 0 }} />
            <div style={{ flex: 1, padding: "14px 18px", display: "flex", alignItems: "center", gap: 16 }}>
              {/* æ™‚é–“ */}
              <div style={{ width: 100, flexShrink: 0 }}>
                <div style={{ fontSize: 14, fontWeight: 700, color: "#111827" }}>{ev.time.split("-")[0]}</div>
                <div style={{ fontSize: 10, color: "#9ca3af" }}>ã€œ {ev.time.split("-")[1]}</div>
              </div>
              {/* ãƒãƒƒã‚¸ç¾¤ */}
              <div style={{ display: "flex", gap: 4, flexShrink: 0 }}>
                <FormatBadge format={ev.format} />
                <RecruitTypeBadge type={ev.type} />
              </div>
              {/* ãƒ¡ã‚¤ãƒ³æƒ…å ± */}
              <div style={{ flex: 1 }}>
                <div style={{ fontSize: 14, fontWeight: 600, color: "#111827" }}>{ev.name}</div>
                <div style={{ fontSize: 12, color: "#6b7280", marginTop: 2 }}>
                  {ev.stage}{ev.interviewer ? ` ãƒ» é¢æ¥å®˜: ${ev.interviewer}` : ""}
                </div>
              </div>
              {/* å ´æ‰€/ãƒªãƒ³ã‚¯ */}
              <div style={{ textAlign: "right", flexShrink: 0 }}>
                {ev.format === "WEB" ? (
                  <div style={{ display: "flex", alignItems: "center", gap: 4, fontSize: 11, color: "#10b981", fontWeight: 500 }}>
                    <Icon name="volume" size={12} color="#10b981" /> Google Meet
                  </div>
                ) : (
                  <div style={{ fontSize: 11, color: "#6b7280" }}>
                    <Icon name="building" size={12} color="#9ca3af" style={{ marginRight: 3 }} />
                    {ev.location}
                  </div>
                )}
              </div>
            </div>
          </div>
        ))}
      </div>

      {/* GCalé€£æºã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */}
      <div style={{ marginTop: 24, padding: "16px 20px", background: "#f0fdf4", borderRadius: 12, border: "1px solid #bbf7d0", display: "flex", alignItems: "center", gap: 12 }}>
        <Icon name="check-circle" size={18} color="#16a34a" />
        <div style={{ flex: 1 }}>
          <div style={{ fontSize: 13, fontWeight: 600, color: "#15803d" }}>Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é€£æºä¸­</div>
          <div style={{ fontSize: 11, color: "#16a34a", marginTop: 2 }}>
            ã‚¿ã‚¤ãƒˆãƒ«ã«ã€ŒWEBã€ã€Œå¯¾é¢ã€ãŒè‡ªå‹•åæ˜ ã•ã‚Œã¾ã™ã€‚ãƒªãƒã‚¤ãƒ³ãƒ‰ãƒ¡ãƒ¼ãƒ«ã‚‚å½¢æ…‹ã«å¿œã˜ã¦è‡ªå‹•é€ä¿¡ã•ã‚Œã¾ã™ã€‚
          </div>
        </div>
        <button style={{ padding: "6px 14px", border: "1px solid #86efac", borderRadius: 8, background: "white", fontSize: 12, cursor: "pointer", color: "#15803d" }}>è¨­å®š</button>
      </div>
    </div>
  );
}

// Automation
function AutomationPage({ emailTemplates = [] }) {
  const [triggers, setTriggers] = useState(() => {
    try { const s = localStorage.getItem('ats_automations'); return s ? JSON.parse(s) : AUTOMATION_TRIGGERS; } catch(e) { return AUTOMATION_TRIGGERS; }
  });
  const save = (list) => { setTriggers(list); localStorage.setItem('ats_automations', JSON.stringify(list)); };
  const [showModal, setShowModal] = useState(false);
  const [editId, setEditId] = useState(null);
  const [form, setForm] = useState({ name: "", trigger: "", triggerType: "stage_change", triggerStage: "ã‚¨ãƒ³ãƒˆãƒªãƒ¼", target: "å€™è£œè€…", delay: "å³æ™‚", channels: ["ãƒ¡ãƒ¼ãƒ«"], templateId: "", active: true });
  const [expandedId, setExpandedId] = useState(null);
  const [logFilter, setLogFilter] = useState("all"); // all, active, inactive

  const TRIGGER_TYPES = [
    { id: "stage_change", label: "ã‚¹ãƒ†ãƒ¼ã‚¸å¤‰æ›´æ™‚", icon: "âš¡" },
    { id: "time_before", label: "äºˆå®šæ—¥ã®â—‹æ™‚é–“å‰", icon: "â°" },
    { id: "time_after", label: "â—‹æ™‚é–“å¾Œï¼ˆæœªå¯¾å¿œæ™‚ï¼‰", icon: "â³" },
    { id: "manual", label: "æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼", icon: "ğŸ‘†" },
  ];
  const DELAY_OPTIONS = ["å³æ™‚", "30åˆ†å¾Œ", "1æ™‚é–“å¾Œ", "3æ™‚é–“å¾Œ", "24æ™‚é–“å¾Œ", "24æ™‚é–“ã”ã¨", "è‡ªå‹•"];
  const TARGET_OPTIONS = ["å€™è£œè€…", "é¢æ¥å®˜", "å€™è£œè€… + é¢æ¥å®˜", "æ¡ç”¨æ‹…å½“"];

  const openNew = () => {
    setEditId(null);
    setForm({ name: "", trigger: "", triggerType: "stage_change", triggerStage: "ã‚¨ãƒ³ãƒˆãƒªãƒ¼", target: "å€™è£œè€…", delay: "å³æ™‚", channels: ["ãƒ¡ãƒ¼ãƒ«"], templateId: "", active: true });
    setShowModal(true);
  };
  const openEdit = (t) => {
    setEditId(t.id);
    setForm({ name: t.name, trigger: t.trigger, triggerType: t.triggerType || "stage_change", triggerStage: t.triggerStage || "ã‚¨ãƒ³ãƒˆãƒªãƒ¼", target: t.target, delay: t.delay, channels: [...t.channels], templateId: t.templateId || "", active: t.active });
    setShowModal(true);
  };
  const handleSave = () => {
    if (!form.name.trim()) return;
    if (editId) {
      save(triggers.map(t => t.id === editId ? { ...t, ...form } : t));
    } else {
      save([...triggers, { id: Date.now(), ...form }]);
    }
    setShowModal(false);
  };
  const handleDelete = (id) => { if (confirm("ã“ã®è‡ªå‹•åŒ–ãƒ«ãƒ¼ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) save(triggers.filter(t => t.id !== id)); };
  const toggleChannel = (ch) => {
    setForm(prev => ({ ...prev, channels: prev.channels.includes(ch) ? prev.channels.filter(c => c !== ch) : [...prev.channels, ch] }));
  };

  const filteredTriggers = logFilter === "all" ? triggers : logFilter === "active" ? triggers.filter(t => t.active) : triggers.filter(t => !t.active);
  const stats = { total: triggers.length, active: triggers.filter(t => t.active).length, inactive: triggers.filter(t => !t.active).length };

  const getTemplateLabel = (id) => { const t = emailTemplates.find(x => x.id === id); return t ? `[${t.category}] ${t.label}` : ""; };
  const cardStyle = { background: "white", borderRadius: 12, boxShadow: "0 1px 3px rgba(0,0,0,0.08)" };

  return (
    <div style={{ padding: 24, maxWidth: 1100 }}>
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 20 }}>
        <div>
          <h1 style={{ fontSize: 22, fontWeight: 700, color: "#111827", marginBottom: 4 }}>è‡ªå‹•åŒ–è¨­å®š</h1>
          <p style={{ fontSize: 13, color: "#9ca3af" }}>ã‚¹ãƒ†ãƒ¼ã‚¸å¤‰æ›´ã‚„ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã«å¿œã˜ã¦è‡ªå‹•ã§ãƒ¡ãƒ¼ãƒ«ãƒ»LINEã‚’é€ä¿¡</p>
        </div>
        <button onClick={openNew}
          style={{ display: "flex", alignItems: "center", gap: 6, background: "#6366f1", color: "white", border: "none", borderRadius: 10, padding: "10px 20px", fontSize: 13, fontWeight: 600, cursor: "pointer" }}>
          <Icon name="plus" size={16} /> æ–°è¦ãƒ«ãƒ¼ãƒ«ä½œæˆ
        </button>
      </div>

      {/* çµ±è¨ˆ */}
      <div style={{ display: "grid", gridTemplateColumns: "repeat(3, 1fr)", gap: 12, marginBottom: 20 }}>
        {[
          { label: "ãƒ«ãƒ¼ãƒ«ç·æ•°", value: stats.total, icon: "âš™ï¸", color: "#6366f1" },
          { label: "æœ‰åŠ¹", value: stats.active, icon: "âœ…", color: "#10b981" },
          { label: "ç„¡åŠ¹", value: stats.inactive, icon: "â¸ï¸", color: "#9ca3af" },
        ].map((s, i) => (
          <div key={i} style={{ ...cardStyle, padding: "14px 16px", borderLeft: `3px solid ${s.color}` }}>
            <div style={{ fontSize: 11, color: "#6b7280", marginBottom: 4 }}>{s.icon} {s.label}</div>
            <div style={{ fontSize: 24, fontWeight: 700, color: s.color }}>{s.value}</div>
          </div>
        ))}
      </div>

      {/* ãƒ•ã‚£ãƒ«ã‚¿ */}
      <div style={{ display: "flex", gap: 4, marginBottom: 16, background: "#f3f4f6", borderRadius: 10, padding: 4, width: "fit-content" }}>
        {[["all", "ã™ã¹ã¦"], ["active", "æœ‰åŠ¹ã®ã¿"], ["inactive", "ç„¡åŠ¹ã®ã¿"]].map(([id, label]) => (
          <button key={id} onClick={() => setLogFilter(id)}
            style={{ padding: "6px 14px", border: "none", borderRadius: 8, fontSize: 12, cursor: "pointer", background: logFilter === id ? "white" : "transparent", color: logFilter === id ? "#4338ca" : "#6b7280", fontWeight: logFilter === id ? 600 : 400, boxShadow: logFilter === id ? "0 1px 2px rgba(0,0,0,0.1)" : "none" }}>{label}</button>
        ))}
      </div>

      {/* ãƒ«ãƒ¼ãƒ«ä¸€è¦§ */}
      <div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
        {filteredTriggers.length === 0 ? (
          <div style={{ ...cardStyle, padding: 40, textAlign: "center" }}>
            <div style={{ fontSize: 36, marginBottom: 8 }}>âš¡</div>
            <div style={{ color: "#9ca3af", fontSize: 13 }}>è‡ªå‹•åŒ–ãƒ«ãƒ¼ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“</div>
          </div>
        ) : filteredTriggers.map(t => (
          <div key={t.id} style={{ ...cardStyle, border: `1px solid ${t.active ? "#e0e7ff" : "#f3f4f6"}`, overflow: "hidden", opacity: t.active ? 1 : 0.7 }}>
            <div style={{ padding: "16px 20px" }}>
              <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start" }}>
                <div style={{ flex: 1, cursor: "pointer" }} onClick={() => setExpandedId(expandedId === t.id ? null : t.id)}>
                  <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 6 }}>
                    <span style={{ fontSize: 16 }}>{(TRIGGER_TYPES.find(x => x.id === t.triggerType) || TRIGGER_TYPES[0]).icon}</span>
                    <span style={{ fontSize: 14, fontWeight: 600, color: "#111827" }}>{t.name}</span>
                    {!t.active && <span style={{ fontSize: 10, background: "#f3f4f6", color: "#9ca3af", padding: "2px 8px", borderRadius: 4 }}>ç„¡åŠ¹</span>}
                  </div>
                  <div style={{ fontSize: 12, color: "#6b7280", marginBottom: 6 }}>
                    <Icon name="zap" size={12} color="#d1d5db" /> {t.trigger}
                  </div>
                  <div style={{ display: "flex", gap: 8, alignItems: "center", flexWrap: "wrap" }}>
                    <span style={{ fontSize: 11, color: "#9ca3af" }}>ğŸ‘¤ {t.target}</span>
                    <span style={{ fontSize: 11, color: "#9ca3af" }}>â±ï¸ {t.delay}</span>
                    {t.channels.map(ch => (
                      <span key={ch} style={{ fontSize: 10, padding: "2px 8px", borderRadius: 10, background: ch === "LINE" ? "#dcfce7" : "#dbeafe", color: ch === "LINE" ? "#15803d" : "#1d4ed8" }}>{ch}</span>
                    ))}
                    {t.templateId && <span style={{ fontSize: 10, padding: "2px 8px", borderRadius: 10, background: "#fef3c7", color: "#92400e" }}>ğŸ“„ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç´ä»˜</span>}
                  </div>
                </div>
                <div style={{ display: "flex", alignItems: "center", gap: 10, flexShrink: 0 }}>
                  <button onClick={() => save(triggers.map(tr => tr.id === t.id ? { ...tr, active: !tr.active } : tr))}
                    style={{ width: 42, height: 24, borderRadius: 12, border: "none", background: t.active ? "#10b981" : "#d1d5db", cursor: "pointer", position: "relative", transition: "background 0.2s" }}>
                    <div style={{ width: 20, height: 20, borderRadius: "50%", background: "white", position: "absolute", top: 2, left: t.active ? 20 : 2, transition: "left 0.2s", boxShadow: "0 1px 3px rgba(0,0,0,0.2)" }} />
                  </button>
                </div>
              </div>
            </div>

            {/* å±•é–‹ã‚¨ãƒªã‚¢ */}
            {expandedId === t.id && (
              <div style={{ padding: "12px 20px 16px", borderTop: "1px solid #f3f4f6", background: "#fafbfc" }}>
                <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: 16, marginBottom: 12, fontSize: 12 }}>
                  <div>
                    <div style={{ color: "#6b7280", marginBottom: 2, fontWeight: 600 }}>ãƒˆãƒªã‚¬ãƒ¼ã‚¿ã‚¤ãƒ—</div>
                    <div style={{ color: "#111827" }}>{(TRIGGER_TYPES.find(x => x.id === t.triggerType) || TRIGGER_TYPES[0]).label}</div>
                  </div>
                  <div>
                    <div style={{ color: "#6b7280", marginBottom: 2, fontWeight: 600 }}>é€ä¿¡å…ˆ</div>
                    <div style={{ color: "#111827" }}>{t.target}</div>
                  </div>
                  <div>
                    <div style={{ color: "#6b7280", marginBottom: 2, fontWeight: 600 }}>é…å»¶</div>
                    <div style={{ color: "#111827" }}>{t.delay}</div>
                  </div>
                </div>
                {t.templateId && (
                  <div style={{ fontSize: 12, marginBottom: 12 }}>
                    <span style={{ color: "#6b7280", fontWeight: 600 }}>ç´ä»˜ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ: </span>
                    <span style={{ color: "#4338ca" }}>{getTemplateLabel(t.templateId)}</span>
                  </div>
                )}
                <div style={{ display: "flex", gap: 8, justifyContent: "flex-end" }}>
                  <button onClick={() => openEdit(t)}
                    style={{ padding: "6px 16px", border: "1px solid #d1d5db", borderRadius: 8, background: "white", fontSize: 12, cursor: "pointer", color: "#374151" }}>
                    âœï¸ ç·¨é›†
                  </button>
                  <button onClick={() => handleDelete(t.id)}
                    style={{ padding: "6px 16px", border: "1px solid #fecaca", borderRadius: 8, background: "#fef2f2", fontSize: 12, cursor: "pointer", color: "#dc2626" }}>
                    ğŸ—‘ï¸ å‰Šé™¤
                  </button>
                </div>
              </div>
            )}
          </div>
        ))}
      </div>

      {/* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒªã‚»ãƒƒãƒˆ */}
      <div style={{ marginTop: 20, textAlign: "center" }}>
        <button onClick={() => { if (confirm("åˆæœŸè¨­å®šã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ")) save(AUTOMATION_TRIGGERS); }}
          style={{ padding: "6px 14px", border: "1px solid #e5e7eb", borderRadius: 8, background: "white", fontSize: 11, cursor: "pointer", color: "#9ca3af" }}>
          ğŸ”„ åˆæœŸè¨­å®šã«æˆ»ã™
        </button>
      </div>

      {/* ä½œæˆãƒ»ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« */}
      {showModal && (
        <div style={{ position: "fixed", top: 0, left: 0, right: 0, bottom: 0, background: "rgba(0,0,0,0.5)", zIndex: 1000, display: "flex", alignItems: "center", justifyContent: "center" }} onClick={(e) => { if (e.target === e.currentTarget) setShowModal(false); }}>
          <div style={{ background: "white", borderRadius: 16, width: 560, maxHeight: "90vh", overflow: "auto", padding: 28 }}>
            <h2 style={{ fontSize: 18, fontWeight: 700, color: "#111827", marginBottom: 20 }}>
              {editId ? "ãƒ«ãƒ¼ãƒ«ã‚’ç·¨é›†" : "æ–°è¦ãƒ«ãƒ¼ãƒ«ä½œæˆ"}
            </h2>

            {/* ãƒ«ãƒ¼ãƒ«å */}
            <div style={{ marginBottom: 14 }}>
              <label style={{ display: "block", fontSize: 12, fontWeight: 600, color: "#374151", marginBottom: 4 }}>ãƒ«ãƒ¼ãƒ«å *</label>
              <input value={form.name} onChange={(e) => setForm(p => ({ ...p, name: e.target.value }))}
                placeholder="ä¾‹: ã‚¨ãƒ³ãƒˆãƒªãƒ¼å®Œäº† â†’ ã‚µãƒ³ã‚¯ã‚¹ãƒ¡ãƒ¼ãƒ«"
                style={{ width: "100%", padding: "8px 12px", border: "1px solid #d1d5db", borderRadius: 8, fontSize: 13, outline: "none", boxSizing: "border-box" }} />
            </div>

            {/* ãƒˆãƒªã‚¬ãƒ¼ã‚¿ã‚¤ãƒ— */}
            <div style={{ marginBottom: 14 }}>
              <label style={{ display: "block", fontSize: 12, fontWeight: 600, color: "#374151", marginBottom: 6 }}>ãƒˆãƒªã‚¬ãƒ¼ã‚¿ã‚¤ãƒ—</label>
              <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 6 }}>
                {TRIGGER_TYPES.map(tt => (
                  <button key={tt.id} onClick={() => setForm(p => ({ ...p, triggerType: tt.id }))}
                    style={{ padding: "10px 12px", border: `2px solid ${form.triggerType === tt.id ? "#6366f1" : "#e5e7eb"}`, borderRadius: 10, background: form.triggerType === tt.id ? "#eef2ff" : "white", cursor: "pointer", textAlign: "left", fontSize: 12 }}>
                    <span style={{ marginRight: 6 }}>{tt.icon}</span>{tt.label}
                  </button>
                ))}
              </div>
            </div>

            {/* ãƒˆãƒªã‚¬ãƒ¼æ¡ä»¶ */}
            {form.triggerType === "stage_change" && (
              <div style={{ marginBottom: 14 }}>
                <label style={{ display: "block", fontSize: 12, fontWeight: 600, color: "#374151", marginBottom: 4 }}>ãƒˆãƒªã‚¬ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¸</label>
                <select value={form.triggerStage} onChange={(e) => setForm(p => ({ ...p, triggerStage: e.target.value, trigger: `ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒã€Œ${e.target.value}ã€ã«å¤‰æ›´` }))}
                  style={{ width: "100%", padding: "8px 12px", border: "1px solid #d1d5db", borderRadius: 8, fontSize: 13, outline: "none", background: "white" }}>
                  {STAGE_NAMES.map(s => <option key={s} value={s}>{s}</option>)}
                  <option value="ä¸åˆæ ¼">ä¸åˆæ ¼</option>
                  <option value="è¾é€€">è¾é€€</option>
                </select>
              </div>
            )}

            <div style={{ marginBottom: 14 }}>
              <label style={{ display: "block", fontSize: 12, fontWeight: 600, color: "#374151", marginBottom: 4 }}>ãƒˆãƒªã‚¬ãƒ¼æ¡ä»¶ï¼ˆèª¬æ˜ï¼‰</label>
              <input value={form.trigger} onChange={(e) => setForm(p => ({ ...p, trigger: e.target.value }))}
                placeholder="ä¾‹: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒã€Œã‚¨ãƒ³ãƒˆãƒªãƒ¼ã€ã«å¤‰æ›´"
                style={{ width: "100%", padding: "8px 12px", border: "1px solid #d1d5db", borderRadius: 8, fontSize: 13, outline: "none", boxSizing: "border-box" }} />
            </div>

            {/* é€ä¿¡å…ˆãƒ»é…å»¶ */}
            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12, marginBottom: 14 }}>
              <div>
                <label style={{ display: "block", fontSize: 12, fontWeight: 600, color: "#374151", marginBottom: 4 }}>é€ä¿¡å…ˆ</label>
                <select value={form.target} onChange={(e) => setForm(p => ({ ...p, target: e.target.value }))}
                  style={{ width: "100%", padding: "8px 12px", border: "1px solid #d1d5db", borderRadius: 8, fontSize: 13, outline: "none", background: "white" }}>
                  {TARGET_OPTIONS.map(o => <option key={o} value={o}>{o}</option>)}
                </select>
              </div>
              <div>
                <label style={{ display: "block", fontSize: 12, fontWeight: 600, color: "#374151", marginBottom: 4 }}>é€ä¿¡ã‚¿ã‚¤ãƒŸãƒ³ã‚°</label>
                <select value={form.delay} onChange={(e) => setForm(p => ({ ...p, delay: e.target.value }))}
                  style={{ width: "100%", padding: "8px 12px", border: "1px solid #d1d5db", borderRadius: 8, fontSize: 13, outline: "none", background: "white" }}>
                  {DELAY_OPTIONS.map(o => <option key={o} value={o}>{o}</option>)}
                </select>
              </div>
            </div>

            {/* ãƒãƒ£ãƒãƒ« */}
            <div style={{ marginBottom: 14 }}>
              <label style={{ display: "block", fontSize: 12, fontWeight: 600, color: "#374151", marginBottom: 6 }}>é€ä¿¡ãƒãƒ£ãƒãƒ«</label>
              <div style={{ display: "flex", gap: 8 }}>
                {["ãƒ¡ãƒ¼ãƒ«", "LINE"].map(ch => (
                  <button key={ch} onClick={() => toggleChannel(ch)}
                    style={{ padding: "8px 20px", border: `2px solid ${form.channels.includes(ch) ? (ch === "LINE" ? "#10b981" : "#3b82f6") : "#e5e7eb"}`, borderRadius: 10, background: form.channels.includes(ch) ? (ch === "LINE" ? "#dcfce7" : "#dbeafe") : "white", cursor: "pointer", fontSize: 12, fontWeight: form.channels.includes(ch) ? 600 : 400 }}>
                    {ch === "LINE" ? "ğŸ’¬" : "âœ‰ï¸"} {ch}
                  </button>
                ))}
              </div>
            </div>

            {/* ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç´ä»˜ */}
            <div style={{ marginBottom: 20 }}>
              <label style={{ display: "block", fontSize: 12, fontWeight: 600, color: "#374151", marginBottom: 4 }}>ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆä»»æ„ï¼‰</label>
              <select value={form.templateId} onChange={(e) => setForm(p => ({ ...p, templateId: e.target.value }))}
                style={{ width: "100%", padding: "8px 12px", border: "1px solid #d1d5db", borderRadius: 8, fontSize: 13, outline: "none", background: "white" }}>
                <option value="">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãªã—</option>
                {emailTemplates.map(t => (
                  <option key={t.id} value={t.id}>[{t.category}] {t.label}</option>
                ))}
              </select>
            </div>

            {/* ãƒœã‚¿ãƒ³ */}
            <div style={{ display: "flex", justifyContent: "flex-end", gap: 10 }}>
              <button onClick={() => setShowModal(false)}
                style={{ padding: "10px 24px", border: "1px solid #d1d5db", borderRadius: 10, background: "white", fontSize: 13, cursor: "pointer", color: "#6b7280" }}>
                ã‚­ãƒ£ãƒ³ã‚»ãƒ«
              </button>
              <button onClick={handleSave}
                style={{ padding: "10px 28px", border: "none", borderRadius: 10, background: "#6366f1", color: "white", fontSize: 13, cursor: "pointer", fontWeight: 600 }}>
                {editId ? "ä¿å­˜" : "ä½œæˆ"}
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// Analytics â€” ãƒªã‚¢ãƒ«ãƒ‡ãƒ¼ã‚¿ç‰ˆ
function AnalyticsPage({ recruitFilter, candidates = [] }) {
  const [tab, setTab] = useState("funnel");

  // ===== ãƒ•ã‚¡ãƒãƒ«ãƒ‡ãƒ¼ã‚¿ =====
  const funnelData = useMemo(() => {
    const stageCounts = {};
    STAGE_DEFINITIONS.forEach(s => { stageCounts[s.name] = 0; });
    candidates.forEach(c => { if (stageCounts[c.stage] !== undefined) stageCounts[c.stage]++; });
    // ç´¯ç©: å„ã‚¹ãƒ†ãƒ¼ã‚¸ã«ã€Œåˆ°é”ã—ãŸã€äººæ•° = ãã®ã‚¹ãƒ†ãƒ¼ã‚¸ä»¥é™ã«ã„ã‚‹å…¨å“¡
    const stageNames = STAGE_DEFINITIONS.map(s => s.name);
    const cumulative = stageNames.map((name, i) => {
      let count = 0;
      for (let j = i; j < stageNames.length; j++) count += stageCounts[stageNames[j]];
      return { stage: name, current: stageCounts[name], reached: count, color: STAGE_DEFINITIONS[i].color };
    });
    return cumulative;
  }, [candidates]);

  const conversionData = useMemo(() => {
    if (funnelData.length < 2) return [];
    return funnelData.slice(1).map((item, i) => {
      const prev = funnelData[i];
      const rate = prev.reached > 0 ? Math.round((item.reached / prev.reached) * 100) : 0;
      return { label: prev.stage + " â†’ " + item.stage, rate, from: prev.reached, to: item.reached };
    });
  }, [funnelData]);

  // ===== çµŒè·¯ãƒ»ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåˆ†æ =====
  const routeData = useMemo(() => {
    const map = {};
    candidates.forEach(c => {
      const r = c.route || "ä¸æ˜";
      map[r] = (map[r] || 0) + 1;
    });
    return Object.entries(map).sort((a, b) => b[1] - a[1]).map(([name, value]) => ({ name, value }));
  }, [candidates]);

  const agentData = useMemo(() => {
    const map = {};
    candidates.forEach(c => {
      if (c.agent && c.agent.trim()) map[c.agent.trim()] = (map[c.agent.trim()] || 0) + 1;
    });
    return Object.entries(map).sort((a, b) => b[1] - a[1]).map(([name, value]) => ({ name, value }));
  }, [candidates]);

  // ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåˆ¥ã‚¹ãƒ†ãƒ¼ã‚¸é€²æ—
  const agentStageData = useMemo(() => {
    const advancedStages = new Set(["äºŒæ¬¡é¢æ¥", "æœ€çµ‚é¢æ¥", "å†…å®š", "å†…å®šæ‰¿è«¾"]);
    const map = {};
    candidates.forEach(c => {
      if (!c.agent || !c.agent.trim()) return;
      const a = c.agent.trim();
      if (!map[a]) map[a] = { total: 0, advanced: 0 };
      map[a].total++;
      if (advancedStages.has(c.stage)) map[a].advanced++;
    });
    return Object.entries(map)
      .filter(([, v]) => v.total >= 1)
      .sort((a, b) => b[1].total - a[1].total)
      .map(([name, v]) => ({ name, total: v.total, advanced: v.advanced, rate: v.total > 0 ? Math.round((v.advanced / v.total) * 100) : 0 }));
  }, [candidates]);

  // ===== å¤§å­¦åˆ¥åˆ†æ =====
  const universityData = useMemo(() => {
    const map = {};
    candidates.forEach(c => {
      const u = c.university || "ä¸æ˜";
      if (!map[u]) map[u] = { total: 0, advanced: 0 };
      map[u].total++;
      const si = STAGE_DEFINITIONS.findIndex(s => s.name === c.stage);
      if (si >= 4) map[u].advanced++; // äºŒæ¬¡é¢æ¥ä»¥é™
    });
    return Object.entries(map)
      .filter(([, v]) => v.total >= 2)
      .sort((a, b) => b[1].total - a[1].total)
      .slice(0, 10)
      .map(([name, v]) => ({ name: name.length > 8 ? name.slice(0, 8) + ".." : name, fullName: name, total: v.total, advanced: v.advanced, rate: v.total > 0 ? Math.round((v.advanced / v.total) * 100) : 0 }));
  }, [candidates]);

  // ===== æœˆåˆ¥ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ¨ç§» =====
  const monthlyData = useMemo(() => {
    const map = {};
    candidates.forEach(c => {
      const d = c.entryDate || c.createdAt;
      if (!d) return;
      const m = d.replace(/-/g, "/").slice(0, 7); // "2025/01" or "2025-01"
      map[m] = (map[m] || 0) + 1;
    });
    return Object.entries(map).sort((a, b) => a[0].localeCompare(b[0])).map(([month, count]) => ({ month: month.replace(/^\d{4}[\/\-]/, "").replace(/^0/, "") + "æœˆ", count }));
  }, [candidates]);

  // ===== æ€§åˆ¥åˆ†å¸ƒ =====
  const genderData = useMemo(() => {
    const map = {};
    candidates.forEach(c => {
      const g = c.gender || "ä¸æ˜";
      map[g] = (map[g] || 0) + 1;
    });
    return Object.entries(map).map(([name, value]) => ({ name, value }));
  }, [candidates]);

  // ===== KPIã‚µãƒãƒªãƒ¼ =====
  const kpi = useMemo(() => {
    const total = candidates.length;
    const offerCount = candidates.filter(c => c.stage === "å†…å®š" || c.stage === "å†…å®šæ‰¿è«¾").length;
    const acceptedCount = candidates.filter(c => c.stage === "å†…å®šæ‰¿è«¾").length;
    const interviewCount = candidates.filter(c => ["ä¸€æ¬¡é¢æ¥", "äºŒæ¬¡é¢æ¥", "æœ€çµ‚é¢æ¥"].includes(c.stage)).length;
    const offerRate = total > 0 ? ((offerCount / total) * 100).toFixed(1) : "0";
    const acceptRate = offerCount > 0 ? ((acceptedCount / offerCount) * 100).toFixed(1) : "0";
    return { total, offerCount, acceptedCount, interviewCount, offerRate, acceptRate };
  }, [candidates]);

  const cardStyle = { background: "white", borderRadius: 12, padding: 20, boxShadow: "0 1px 3px rgba(0,0,0,0.08)" };
  const tabBtnStyle = (active) => ({ padding: "8px 16px", border: "none", borderRadius: 8, fontSize: 12, cursor: "pointer", background: active ? "white" : "transparent", color: active ? "#4338ca" : "#6b7280", fontWeight: active ? 600 : 400, boxShadow: active ? "0 1px 2px rgba(0,0,0,0.1)" : "none" });

  return (
    <div style={{ padding: 24, maxWidth: 1200 }}>
      <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 20 }}>
        <h1 style={{ fontSize: 22, fontWeight: 700, color: "#111827" }}>åˆ†æ</h1>
        <span style={{ fontSize: 12, color: "#9ca3af" }}>å¯¾è±¡: {candidates.length}å</span>
      </div>

      {/* KPIã‚«ãƒ¼ãƒ‰ */}
      <div style={{ display: "grid", gridTemplateColumns: "repeat(5, 1fr)", gap: 12, marginBottom: 24 }}>
        {[
          { label: "ç·ã‚¨ãƒ³ãƒˆãƒªãƒ¼", value: kpi.total, unit: "å", color: "#6366f1", icon: "ğŸ“‹" },
          { label: "é¢æ¥ä¸­", value: kpi.interviewCount, unit: "å", color: "#a855f7", icon: "ğŸ¤" },
          { label: "å†…å®š", value: kpi.offerCount, unit: "å", color: "#f59e0b", icon: "ğŸ‰" },
          { label: "å†…å®šæ‰¿è«¾", value: kpi.acceptedCount, unit: "å", color: "#10b981", icon: "âœ…" },
          { label: "å†…å®šç‡", value: kpi.offerRate, unit: "%", color: "#ec4899", icon: "ğŸ“Š" },
        ].map((item, i) => (
          <div key={i} style={{ background: "white", borderRadius: 12, padding: "16px 14px", boxShadow: "0 1px 3px rgba(0,0,0,0.06)", borderLeft: `3px solid ${item.color}` }}>
            <div style={{ fontSize: 11, color: "#6b7280", marginBottom: 6 }}>{item.icon} {item.label}</div>
            <div style={{ fontSize: 24, fontWeight: 700, color: item.color }}>{item.value}<span style={{ fontSize: 12, fontWeight: 400, color: "#9ca3af", marginLeft: 2 }}>{item.unit}</span></div>
          </div>
        ))}
      </div>

      {/* ã‚¿ãƒ– */}
      <div style={{ display: "flex", gap: 4, marginBottom: 20, background: "#f3f4f6", borderRadius: 10, padding: 4, width: "fit-content" }}>
        {[["funnel", "ãƒ•ã‚¡ãƒãƒ«åˆ†æ"], ["route", "çµŒè·¯ãƒ»ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ"], ["university", "å¤§å­¦ãƒ»å±æ€§"], ["timeline", "æ™‚ç³»åˆ—"]].map(([id, label]) => (
          <button key={id} onClick={() => setTab(id)} style={tabBtnStyle(tab === id)}>{label}</button>
        ))}
      </div>

      {/* ===== ãƒ•ã‚¡ãƒãƒ«åˆ†æ ===== */}
      {tab === "funnel" && (
        <>
          <div style={{ ...cardStyle, marginBottom: 16 }}>
            <h3 style={{ fontSize: 14, fontWeight: 600, marginBottom: 16 }}>é¸è€ƒãƒ•ã‚¡ãƒãƒ«ï¼ˆç¾åœ¨ã®å€™è£œè€…åˆ†å¸ƒï¼‰</h3>
            <ResponsiveContainer width="100%" height={280}>
              <BarChart data={funnelData} margin={{ left: 20 }}>
                <XAxis dataKey="stage" tick={{ fontSize: 10 }} />
                <YAxis tick={{ fontSize: 10 }} />
                <Tooltip formatter={(v, name) => [v + "å", name === "reached" ? "åˆ°é”äººæ•°" : "ç¾åœ¨äººæ•°"]} />
                <Bar dataKey="reached" name="åˆ°é”äººæ•°" fill="#e0e7ff" radius={[4, 4, 0, 0]} />
                <Bar dataKey="current" name="ç¾åœ¨äººæ•°" radius={[4, 4, 0, 0]}>
                  {funnelData.map((entry, i) => <Cell key={i} fill={entry.color} />)}
                </Bar>
              </BarChart>
            </ResponsiveContainer>
          </div>
          <div style={{ ...cardStyle }}>
            <h3 style={{ fontSize: 14, fontWeight: 600, marginBottom: 16 }}>ã‚¹ãƒ†ãƒ¼ã‚¸é–“é€šéç‡</h3>
            <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(180px, 1fr))", gap: 12 }}>
              {conversionData.map((item, i) => (
                <div key={i} style={{ padding: 14, background: item.rate >= 50 ? "#f0fdf4" : item.rate >= 30 ? "#fffbeb" : "#fef2f2", borderRadius: 10, border: `1px solid ${item.rate >= 50 ? "#bbf7d0" : item.rate >= 30 ? "#fde68a" : "#fecaca"}` }}>
                  <div style={{ fontSize: 11, color: "#6b7280", marginBottom: 6 }}>{item.label}</div>
                  <div style={{ fontSize: 28, fontWeight: 700, color: item.rate >= 50 ? "#15803d" : item.rate >= 30 ? "#b45309" : "#dc2626" }}>{item.rate}%</div>
                  <div style={{ fontSize: 11, color: "#9ca3af" }}>{item.from}å â†’ {item.to}å</div>
                </div>
              ))}
            </div>
          </div>
        </>
      )}

      {/* ===== çµŒè·¯ãƒ»ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ ===== */}
      {tab === "route" && (
        <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 16 }}>
          <div style={cardStyle}>
            <h3 style={{ fontSize: 14, fontWeight: 600, marginBottom: 16 }}>ã‚¨ãƒ³ãƒˆãƒªãƒ¼çµŒè·¯åˆ¥åˆ†å¸ƒ</h3>
            {routeData.length > 0 ? (
              <ResponsiveContainer width="100%" height={250}>
                <PieChart>
                  <Pie data={routeData} cx="50%" cy="50%" outerRadius={85} label={({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`} labelLine fontSize={10}>
                    {routeData.map((_, i) => <Cell key={i} fill={COLORS[i % COLORS.length]} />)}
                  </Pie>
                  <Tooltip formatter={(v) => v + "å"} />
                </PieChart>
              </ResponsiveContainer>
            ) : <div style={{ padding: 40, textAlign: "center", color: "#9ca3af", fontSize: 13 }}>çµŒè·¯ãƒ‡ãƒ¼ã‚¿ãªã—</div>}
          </div>
          <div style={cardStyle}>
            <h3 style={{ fontSize: 14, fontWeight: 600, marginBottom: 16 }}>ç´¹ä»‹ä¼šç¤¾åˆ¥å€™è£œè€…æ•°</h3>
            {agentData.length > 0 ? (
              <ResponsiveContainer width="100%" height={250}>
                <BarChart data={agentData.slice(0, 8)} layout="vertical" margin={{ left: 80 }}>
                  <XAxis type="number" tick={{ fontSize: 10 }} />
                  <YAxis type="category" dataKey="name" tick={{ fontSize: 11 }} width={80} />
                  <Tooltip formatter={(v) => v + "å"} />
                  <Bar dataKey="value" name="å€™è£œè€…æ•°" fill="#8b5cf6" radius={[0, 4, 4, 0]} />
                </BarChart>
              </ResponsiveContainer>
            ) : <div style={{ padding: 40, textAlign: "center", color: "#9ca3af", fontSize: 13 }}>ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ãªã—</div>}
          </div>
          {agentStageData.length > 0 && (
            <div style={{ ...cardStyle, gridColumn: "1 / -1" }}>
              <h3 style={{ fontSize: 14, fontWeight: 600, marginBottom: 16 }}>ç´¹ä»‹ä¼šç¤¾åˆ¥ é¸è€ƒé€²æ—ç‡ï¼ˆäºŒæ¬¡é¢æ¥ä»¥é™ï¼‰</h3>
              <table style={{ width: "100%", borderCollapse: "collapse" }}>
                <thead>
                  <tr style={{ background: "#f9fafb" }}>
                    {["ç´¹ä»‹ä¼šç¤¾", "ç´¹ä»‹æ•°", "äºŒæ¬¡ä»¥é™", "é€²æ—ç‡", ""].map((h, i) => (
                      <th key={i} style={{ padding: "10px 16px", fontSize: 11, fontWeight: 600, color: "#6b7280", textAlign: "left", borderBottom: "1px solid #e5e7eb" }}>{h}</th>
                    ))}
                  </tr>
                </thead>
                <tbody>
                  {agentStageData.map((a, i) => (
                    <tr key={i} style={{ borderBottom: "1px solid #f3f4f6" }}>
                      <td style={{ padding: "12px 16px", fontSize: 13, fontWeight: 600, color: "#111827" }}>{a.name}</td>
                      <td style={{ padding: "12px 16px", fontSize: 13, color: "#374151" }}>{a.total}å</td>
                      <td style={{ padding: "12px 16px", fontSize: 13, color: "#374151" }}>{a.advanced}å</td>
                      <td style={{ padding: "12px 16px", fontSize: 14, fontWeight: 700, color: a.rate >= 30 ? "#10b981" : a.rate >= 15 ? "#f59e0b" : "#ef4444" }}>{a.rate}%</td>
                      <td style={{ padding: "12px 16px", width: 120 }}>
                        <div style={{ height: 6, background: "#f3f4f6", borderRadius: 3 }}>
                          <div style={{ height: "100%", background: a.rate >= 30 ? "#10b981" : a.rate >= 15 ? "#f59e0b" : "#ef4444", borderRadius: 3, width: `${Math.min(a.rate, 100)}%`, transition: "width 0.3s" }} />
                        </div>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </div>
      )}

      {/* ===== å¤§å­¦ãƒ»å±æ€§åˆ†æ ===== */}
      {tab === "university" && (
        <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 16 }}>
          <div style={cardStyle}>
            <h3 style={{ fontSize: 14, fontWeight: 600, marginBottom: 16 }}>å¤§å­¦åˆ¥å€™è£œè€…æ•° & äºŒæ¬¡ä»¥é™åˆ°é”ç‡</h3>
            {universityData.length > 0 ? (
              <ResponsiveContainer width="100%" height={280}>
                <BarChart data={universityData} margin={{ left: 10 }}>
                  <XAxis dataKey="name" tick={{ fontSize: 9 }} interval={0} angle={-20} textAnchor="end" height={50} />
                  <YAxis tick={{ fontSize: 10 }} />
                  <Tooltip formatter={(v, name) => [name === "total" ? v + "å" : v + "å", name === "total" ? "ç·æ•°" : "äºŒæ¬¡ä»¥é™"]} />
                  <Bar dataKey="total" name="ç·æ•°" fill="#e0e7ff" radius={[4, 4, 0, 0]} />
                  <Bar dataKey="advanced" name="äºŒæ¬¡ä»¥é™" fill="#6366f1" radius={[4, 4, 0, 0]} />
                </BarChart>
              </ResponsiveContainer>
            ) : <div style={{ padding: 40, textAlign: "center", color: "#9ca3af", fontSize: 13 }}>å¤§å­¦ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³</div>}
          </div>
          <div style={cardStyle}>
            <h3 style={{ fontSize: 14, fontWeight: 600, marginBottom: 16 }}>æ€§åˆ¥åˆ†å¸ƒ</h3>
            {genderData.length > 0 ? (
              <ResponsiveContainer width="100%" height={280}>
                <PieChart>
                  <Pie data={genderData} cx="50%" cy="50%" outerRadius={90} innerRadius={50} label={({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`} labelLine fontSize={11}>
                    {genderData.map((_, i) => <Cell key={i} fill={["#6366f1", "#ec4899", "#9ca3af", "#f59e0b"][i % 4]} />)}
                  </Pie>
                  <Tooltip formatter={(v) => v + "å"} />
                </PieChart>
              </ResponsiveContainer>
            ) : <div style={{ padding: 40, textAlign: "center", color: "#9ca3af", fontSize: 13 }}>æ€§åˆ¥ãƒ‡ãƒ¼ã‚¿ãªã—</div>}
          </div>
          {/* ã‚¹ãƒ†ãƒ¼ã‚¸Ã—å¤§å­¦ ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—é¢¨ãƒ†ãƒ¼ãƒ–ãƒ« */}
          {universityData.length > 0 && (
            <div style={{ ...cardStyle, gridColumn: "1 / -1" }}>
              <h3 style={{ fontSize: 14, fontWeight: 600, marginBottom: 16 }}>å¤§å­¦åˆ¥ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆäºŒæ¬¡ä»¥é™åˆ°é”ç‡ï¼‰</h3>
              <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fill, minmax(200px, 1fr))", gap: 10 }}>
                {universityData.filter(u => u.total >= 2).sort((a, b) => b.rate - a.rate).map((u, i) => (
                  <div key={i} style={{ padding: 12, background: "#f9fafb", borderRadius: 8, border: "1px solid #e5e7eb" }}>
                    <div style={{ display: "flex", justifyContent: "space-between", marginBottom: 6 }}>
                      <span style={{ fontSize: 12, fontWeight: 600, color: "#111827" }}>{i + 1}. {u.fullName}</span>
                      <span style={{ fontSize: 12, fontWeight: 700, color: u.rate >= 30 ? "#10b981" : "#f59e0b" }}>{u.rate}%</span>
                    </div>
                    <div style={{ height: 5, background: "#e5e7eb", borderRadius: 3 }}>
                      <div style={{ height: "100%", background: u.rate >= 30 ? "#10b981" : "#f59e0b", borderRadius: 3, width: `${Math.min(u.rate, 100)}%` }} />
                    </div>
                    <div style={{ fontSize: 10, color: "#9ca3af", marginTop: 4 }}>{u.total}åä¸­ {u.advanced}åãŒäºŒæ¬¡ä»¥é™</div>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      )}

      {/* ===== æ™‚ç³»åˆ— ===== */}
      {tab === "timeline" && (
        <div style={{ display: "grid", gridTemplateColumns: "1fr", gap: 16 }}>
          <div style={cardStyle}>
            <h3 style={{ fontSize: 14, fontWeight: 600, marginBottom: 16 }}>æœˆåˆ¥ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ¨ç§»</h3>
            {monthlyData.length > 0 ? (
              <ResponsiveContainer width="100%" height={280}>
                <BarChart data={monthlyData}>
                  <XAxis dataKey="month" tick={{ fontSize: 11 }} />
                  <YAxis tick={{ fontSize: 10 }} />
                  <Tooltip formatter={(v) => v + "å"} />
                  <Bar dataKey="count" name="ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ•°" fill="#6366f1" radius={[4, 4, 0, 0]} />
                </BarChart>
              </ResponsiveContainer>
            ) : <div style={{ padding: 40, textAlign: "center", color: "#9ca3af", fontSize: 13 }}>æ—¥ä»˜ãƒ‡ãƒ¼ã‚¿ãªã—</div>}
          </div>
          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 16 }}>
            <div style={cardStyle}>
              <h3 style={{ fontSize: 14, fontWeight: 600, marginBottom: 16 }}>ã‚¹ãƒ†ãƒ¼ã‚¸åˆ¥ ç¾åœ¨ã®åœ¨ç±äººæ•°</h3>
              <ResponsiveContainer width="100%" height={240}>
                <PieChart>
                  <Pie data={funnelData.filter(d => d.current > 0)} dataKey="current" cx="50%" cy="50%" outerRadius={85} label={({ stage, current }) => `${stage} ${current}`} labelLine fontSize={10}>
                    {funnelData.filter(d => d.current > 0).map((entry, i) => <Cell key={i} fill={entry.color} />)}
                  </Pie>
                  <Tooltip formatter={(v) => v + "å"} />
                </PieChart>
              </ResponsiveContainer>
            </div>
            <div style={{ ...cardStyle, background: "linear-gradient(135deg, #eef2ff, #f5f3ff)", border: "1px solid #c7d2fe" }}>
              <h4 style={{ fontSize: 14, fontWeight: 600, color: "#4338ca", marginBottom: 12 }}>ğŸ“Š ã‚µãƒãƒªãƒ¼</h4>
              <div style={{ fontSize: 13, color: "#374151", lineHeight: 2.0 }}>
                <p>ç·ã‚¨ãƒ³ãƒˆãƒªãƒ¼: <strong>{kpi.total}</strong>å</p>
                <p>å†…å®šç‡: <strong style={{ color: "#10b981" }}>{kpi.offerRate}%</strong></p>
                <p>å†…å®šæ‰¿è«¾ç‡: <strong style={{ color: "#10b981" }}>{kpi.acceptRate}%</strong></p>
                {agentStageData.length > 0 && <p>æœ€å„ªç§€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ: <strong style={{ color: "#6366f1" }}>{agentStageData[0]?.name}</strong>ï¼ˆ{agentStageData[0]?.total}åç´¹ä»‹ï¼‰</p>}
                {monthlyData.length > 0 && <p>ãƒ”ãƒ¼ã‚¯æœˆ: <strong>{monthlyData.reduce((a, b) => a.count > b.count ? a : b).month}</strong>ï¼ˆ{monthlyData.reduce((a, b) => a.count > b.count ? a : b).count}åï¼‰</p>}
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// ============================================================
// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç®¡ç†ãƒšãƒ¼ã‚¸
// ============================================================
function MessagesPage({ candidates = [], emailTemplates = [], onNavigate }) {
  const [messages, setMessages] = useState([]);
  const [loading, setLoading] = useState(false);
  const [filter, setFilter] = useState("all"); // all, sent, received, draft
  const [search, setSearch] = useState("");
  const [selectedMsg, setSelectedMsg] = useState(null);
  const [showCompose, setShowCompose] = useState(false);
  const [composeData, setComposeData] = useState({ to: "", candidateId: null, candidateName: "", subject: "", body: "", channel: "email" });
  const [sending, setSending] = useState(false);
  const [sendResult, setSendResult] = useState({ type: "", text: "" });
  const [selectedTemplate, setSelectedTemplate] = useState("");

  // Supabaseã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å±¥æ­´ã‚’å–å¾—
  const loadMessages = useCallback(async () => {
    setLoading(true);
    try {
      const { data, error } = await sbApi.select('messages', 'order=created_at.desc');
      if (!error && data) {
        // å€™è£œè€…åã‚’ãƒãƒƒãƒ”ãƒ³ã‚°
        const candMap = {};
        candidates.forEach(c => { candMap[c.id] = (c.lastName || "") + " " + (c.firstName || ""); });
        setMessages(data.map(m => ({
          ...m,
          candidateName: candMap[m.candidate_id] || "ä¸æ˜",
          date: m.created_at,
        })));
      }
    } catch (err) {
      console.error("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å–å¾—ã‚¨ãƒ©ãƒ¼:", err);
    }
    setLoading(false);
  }, [candidates]);

  useEffect(() => { loadMessages(); }, [loadMessages]);

  // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
  const filteredMessages = useMemo(() => {
    let list = messages;
    if (filter === "sent") list = list.filter(m => m.direction === "outbound");
    else if (filter === "received") list = list.filter(m => m.direction === "inbound");
    if (search) {
      const q = search.toLowerCase();
      list = list.filter(m =>
        (m.subject || "").toLowerCase().includes(q) ||
        (m.body || "").toLowerCase().includes(q) ||
        (m.candidateName || "").toLowerCase().includes(q) ||
        (m.to_email || "").toLowerCase().includes(q)
      );
    }
    return list;
  }, [messages, filter, search]);

  // çµ±è¨ˆ
  const stats = useMemo(() => {
    const total = messages.length;
    const sent = messages.filter(m => m.direction === "outbound").length;
    const received = messages.filter(m => m.direction === "inbound").length;
    const today = messages.filter(m => {
      if (!m.date) return false;
      const d = new Date(m.date);
      const now = new Date();
      return d.toDateString() === now.toDateString();
    }).length;
    return { total, sent, received, today };
  }, [messages]);

  // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠ
  const handleTemplateSelect = (templateId) => {
    const tmpl = emailTemplates.find(t => t.id === templateId);
    if (tmpl) {
      let subject = tmpl.subject.replace(/\{\{company\}\}/g, "æ ªå¼ä¼šç¤¾madoguchi");
      let body = tmpl.body.replace(/\{\{company\}\}/g, "æ ªå¼ä¼šç¤¾madoguchi");
      if (composeData.candidateName) {
        subject = subject.replace(/\{\{name\}\}/g, composeData.candidateName);
        body = body.replace(/\{\{name\}\}/g, composeData.candidateName);
      }
      setComposeData(prev => ({ ...prev, subject, body }));
    }
    setSelectedTemplate(templateId);
  };

  // å€™è£œè€…é¸æŠ
  const handleCandidateSelect = (candidateId) => {
    const c = candidates.find(x => x.id == candidateId);
    if (c) {
      setComposeData(prev => ({ ...prev, candidateId: c.id, candidateName: (c.lastName || "") + " " + (c.firstName || ""), to: c.email || "" }));
    }
  };

  // é€ä¿¡
  const handleSend = async () => {
    if (!composeData.to || !composeData.subject || !composeData.body) {
      setSendResult({ type: "error", text: "å®›å…ˆãƒ»ä»¶åãƒ»æœ¬æ–‡ã‚’ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„" });
      return;
    }
    setSending(true);
    setSendResult({ type: "", text: "" });
    try {
      // Gmail API ã§é€ä¿¡
      const res = await fetch('/.netlify/functions/gmail', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: 'send',
          to: composeData.to,
          subject: composeData.subject,
          body: composeData.body,
          candidateName: composeData.candidateName,
        }),
      });
      const result = await res.json();
      if (!res.ok || !result.success) {
        setSendResult({ type: "error", text: result.error || "é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ" });
        setSending(false);
        return;
      }
      // Supabaseã«å±¥æ­´ä¿å­˜
      if (composeData.candidateId) {
        await sbApi.insert('messages', {
          candidate_id: composeData.candidateId,
          direction: 'outbound',
          channel: composeData.channel,
          to_email: composeData.to,
          subject: composeData.subject,
          body: composeData.body,
          status: 'sent',
        });
      }
      setSendResult({ type: "success", text: "ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸ" });
      setComposeData({ to: "", candidateId: null, candidateName: "", subject: "", body: "", channel: "email" });
      setSelectedTemplate("");
      setShowCompose(false);
      loadMessages();
      setTimeout(() => setSendResult({ type: "", text: "" }), 3000);
    } catch (err) {
      setSendResult({ type: "error", text: "é€ä¿¡ã‚¨ãƒ©ãƒ¼: " + err.message });
    }
    setSending(false);
  };

  const cardStyle = { background: "white", borderRadius: 12, boxShadow: "0 1px 3px rgba(0,0,0,0.08)" };
  const formatDate = (d) => {
    if (!d) return "";
    const dt = new Date(d);
    const now = new Date();
    if (dt.toDateString() === now.toDateString()) return dt.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
    return dt.toLocaleDateString('ja-JP', { month: 'numeric', day: 'numeric' }) + " " + dt.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
  };

  return (
    <div style={{ padding: 24, maxWidth: 1200 }}>
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 20 }}>
        <h1 style={{ fontSize: 22, fontWeight: 700, color: "#111827" }}>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</h1>
        <button onClick={() => { setShowCompose(true); setSendResult({ type: "", text: "" }); }}
          style={{ padding: "10px 24px", border: "none", borderRadius: 10, background: "#1d4aff", color: "white", fontSize: 13, cursor: "pointer", fontWeight: 600, display: "flex", alignItems: "center", gap: 6 }}>
          <Icon name="edit" size={14} /> æ–°è¦ãƒ¡ãƒ¼ãƒ«ä½œæˆ
        </button>
      </div>

      {/* çµ±è¨ˆã‚«ãƒ¼ãƒ‰ */}
      <div style={{ display: "grid", gridTemplateColumns: "repeat(4, 1fr)", gap: 12, marginBottom: 20 }}>
        {[
          { label: "ç·ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸", value: stats.total, icon: "ğŸ“¨", color: "#6366f1" },
          { label: "é€ä¿¡æ¸ˆã¿", value: stats.sent, icon: "ğŸ“¤", color: "#10b981" },
          { label: "å—ä¿¡", value: stats.received, icon: "ğŸ“¥", color: "#3b82f6" },
          { label: "ä»Šæ—¥", value: stats.today, icon: "ğŸ“…", color: "#f59e0b" },
        ].map((item, i) => (
          <div key={i} style={{ ...cardStyle, padding: "14px 16px", borderLeft: `3px solid ${item.color}` }}>
            <div style={{ fontSize: 11, color: "#6b7280", marginBottom: 4 }}>{item.icon} {item.label}</div>
            <div style={{ fontSize: 22, fontWeight: 700, color: item.color }}>{item.value}</div>
          </div>
        ))}
      </div>

      {/* æˆåŠŸ/ã‚¨ãƒ©ãƒ¼é€šçŸ¥ */}
      {sendResult.text && (
        <div style={{ padding: 12, borderRadius: 8, marginBottom: 16, background: sendResult.type === "success" ? "#ecfdf5" : "#fef2f2", border: `1px solid ${sendResult.type === "success" ? "#a7f3d0" : "#fecaca"}`, color: sendResult.type === "success" ? "#065f46" : "#dc2626", fontSize: 13 }}>
          {sendResult.type === "success" ? "âœ“" : "âœ•"} {sendResult.text}
        </div>
      )}

      {/* ãƒ¡ãƒ¼ãƒ«ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« */}
      {showCompose && (
        <div style={{ position: "fixed", top: 0, left: 0, right: 0, bottom: 0, background: "rgba(0,0,0,0.5)", zIndex: 1000, display: "flex", alignItems: "center", justifyContent: "center" }} onClick={(e) => { if (e.target === e.currentTarget) setShowCompose(false); }}>
          <div style={{ background: "white", borderRadius: 16, width: 680, maxHeight: "90vh", overflow: "auto", padding: 28 }}>
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 20 }}>
              <h2 style={{ fontSize: 18, fontWeight: 700, color: "#111827" }}>æ–°è¦ãƒ¡ãƒ¼ãƒ«ä½œæˆ</h2>
              <button onClick={() => setShowCompose(false)} style={{ border: "none", background: "none", cursor: "pointer", fontSize: 20, color: "#9ca3af" }}>âœ•</button>
            </div>

            {/* å€™è£œè€…é¸æŠ */}
            <div style={{ marginBottom: 14 }}>
              <label style={{ display: "block", fontSize: 12, fontWeight: 500, color: "#6b7280", marginBottom: 4 }}>å®›å…ˆï¼ˆå€™è£œè€…ã‚’é¸æŠï¼‰</label>
              <select value={composeData.candidateId || ""} onChange={(e) => handleCandidateSelect(e.target.value)}
                style={{ width: "100%", padding: "8px 12px", border: "1px solid #d1d5db", borderRadius: 8, fontSize: 13, outline: "none", boxSizing: "border-box", background: "white" }}>
                <option value="">å€™è£œè€…ã‚’é¸æŠ...</option>
                {candidates.filter(c => c.email).map(c => (
                  <option key={c.id} value={c.id}>{c.lastName} {c.firstName} ({c.email}) â€” {c.stage}</option>
                ))}
              </select>
            </div>

            {/* ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ */}
            <div style={{ marginBottom: 14 }}>
              <label style={{ display: "block", fontSize: 12, fontWeight: 500, color: "#6b7280", marginBottom: 4 }}>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
              <input type="email" value={composeData.to} onChange={(e) => setComposeData(prev => ({ ...prev, to: e.target.value }))}
                placeholder="example@email.com"
                style={{ width: "100%", padding: "8px 12px", border: "1px solid #d1d5db", borderRadius: 8, fontSize: 13, outline: "none", boxSizing: "border-box" }} />
            </div>

            {/* ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠ */}
            <div style={{ marginBottom: 14 }}>
              <label style={{ display: "block", fontSize: 12, fontWeight: 500, color: "#6b7280", marginBottom: 4 }}>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</label>
              <select value={selectedTemplate} onChange={(e) => handleTemplateSelect(e.target.value)}
                style={{ width: "100%", padding: "8px 12px", border: "1px solid #d1d5db", borderRadius: 8, fontSize: 13, outline: "none", boxSizing: "border-box", background: "white" }}>
                <option value="">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠï¼ˆä»»æ„ï¼‰...</option>
                {emailTemplates.map(t => (
                  <option key={t.id} value={t.id}>[{t.category}] {t.label}</option>
                ))}
              </select>
            </div>

            {/* ä»¶å */}
            <div style={{ marginBottom: 14 }}>
              <label style={{ display: "block", fontSize: 12, fontWeight: 500, color: "#6b7280", marginBottom: 4 }}>ä»¶å</label>
              <input type="text" value={composeData.subject} onChange={(e) => setComposeData(prev => ({ ...prev, subject: e.target.value }))}
                placeholder="ä»¶åã‚’å…¥åŠ›..."
                style={{ width: "100%", padding: "8px 12px", border: "1px solid #d1d5db", borderRadius: 8, fontSize: 13, outline: "none", boxSizing: "border-box" }} />
            </div>

            {/* æœ¬æ–‡ */}
            <div style={{ marginBottom: 16 }}>
              <label style={{ display: "block", fontSize: 12, fontWeight: 500, color: "#6b7280", marginBottom: 4 }}>æœ¬æ–‡</label>
              <textarea value={composeData.body} onChange={(e) => setComposeData(prev => ({ ...prev, body: e.target.value }))}
                rows={12} placeholder="ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ã‚’å…¥åŠ›..."
                style={{ width: "100%", padding: 12, border: "1px solid #d1d5db", borderRadius: 8, fontSize: 13, lineHeight: 1.7, resize: "vertical", outline: "none", fontFamily: "inherit", boxSizing: "border-box" }} />
            </div>

            {/* ãƒœã‚¿ãƒ³ */}
            <div style={{ display: "flex", justifyContent: "flex-end", gap: 10 }}>
              <button onClick={() => setShowCompose(false)}
                style={{ padding: "10px 24px", border: "1px solid #d1d5db", borderRadius: 10, background: "white", fontSize: 13, cursor: "pointer", color: "#6b7280" }}>
                ã‚­ãƒ£ãƒ³ã‚»ãƒ«
              </button>
              <button onClick={handleSend} disabled={sending}
                style={{ padding: "10px 28px", border: "none", borderRadius: 10, background: sending ? "#93c5fd" : "#1d4aff", color: "white", fontSize: 13, cursor: sending ? "default" : "pointer", fontWeight: 600 }}>
                {sending ? "é€ä¿¡ä¸­..." : "âœ‰ é€ä¿¡ã™ã‚‹"}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ & æ¤œç´¢ */}
      <div style={{ display: "flex", gap: 12, marginBottom: 16, alignItems: "center" }}>
        <div style={{ display: "flex", gap: 4, background: "#f3f4f6", borderRadius: 10, padding: 4 }}>
          {[["all", "ã™ã¹ã¦"], ["sent", "é€ä¿¡æ¸ˆã¿"], ["received", "å—ä¿¡"]].map(([id, label]) => (
            <button key={id} onClick={() => setFilter(id)}
              style={{ padding: "6px 14px", border: "none", borderRadius: 8, fontSize: 12, cursor: "pointer", background: filter === id ? "white" : "transparent", color: filter === id ? "#4338ca" : "#6b7280", fontWeight: filter === id ? 600 : 400, boxShadow: filter === id ? "0 1px 2px rgba(0,0,0,0.1)" : "none" }}>{label}</button>
          ))}
        </div>
        <input value={search} onChange={(e) => setSearch(e.target.value)} placeholder="ğŸ” ä»¶åãƒ»æœ¬æ–‡ãƒ»å€™è£œè€…åã§æ¤œç´¢..."
          style={{ flex: 1, padding: "8px 14px", border: "1px solid #e5e7eb", borderRadius: 8, fontSize: 13, outline: "none", background: "#fafbfc" }} />
        <button onClick={loadMessages} disabled={loading}
          style={{ padding: "8px 14px", border: "1px solid #d1d5db", borderRadius: 8, background: "white", fontSize: 12, cursor: "pointer", color: "#6b7280" }}>
          {loading ? "èª­è¾¼ä¸­..." : "â†» æ›´æ–°"}
        </button>
      </div>

      {/* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸€è¦§ & è©³ç´° */}
      <div style={{ display: "grid", gridTemplateColumns: selectedMsg ? "1fr 1fr" : "1fr", gap: 16 }}>
        {/* ä¸€è¦§ */}
        <div style={{ ...cardStyle, overflow: "hidden" }}>
          {loading && messages.length === 0 ? (
            <div style={{ padding: 40, textAlign: "center", color: "#9ca3af", fontSize: 13 }}>èª­ã¿è¾¼ã¿ä¸­...</div>
          ) : filteredMessages.length === 0 ? (
            <div style={{ padding: 40, textAlign: "center" }}>
              <div style={{ fontSize: 36, marginBottom: 8 }}>ğŸ“­</div>
              <div style={{ color: "#9ca3af", fontSize: 13 }}>{messages.length === 0 ? "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å±¥æ­´ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“" : "æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã›ã‚“"}</div>
              <div style={{ color: "#d1d5db", fontSize: 12, marginTop: 4 }}>å€™è£œè€…ã«ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã™ã‚‹ã¨ã€ã“ã“ã«å±¥æ­´ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
            </div>
          ) : (
            <div>
              {filteredMessages.map((msg, i) => {
                const isInbound = msg.direction === "inbound";
                const isSelected = selectedMsg && selectedMsg.id === msg.id;
                return (
                  <div key={msg.id || i} onClick={() => setSelectedMsg(msg)}
                    style={{
                      padding: "14px 18px", cursor: "pointer", borderBottom: "1px solid #f3f4f6",
                      background: isSelected ? "#eef2ff" : "white",
                      transition: "background 0.15s",
                    }}
                    onMouseEnter={(e) => { if (!isSelected) e.currentTarget.style.background = "#fafbfc"; }}
                    onMouseLeave={(e) => { if (!isSelected) e.currentTarget.style.background = "white"; }}
                  >
                    <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 4 }}>
                      <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                        <span style={{
                          fontSize: 10, padding: "2px 8px", borderRadius: 4, fontWeight: 500,
                          background: isInbound ? "#dbeafe" : "#e0e7ff",
                          color: isInbound ? "#1d4aff" : "#4338ca",
                        }}>
                          {isInbound ? "å—ä¿¡" : "é€ä¿¡"}
                        </span>
                        <span style={{ fontSize: 13, fontWeight: 600, color: "#111827" }}>{msg.candidateName}</span>
                        {msg.channel === "line" && <span style={{ fontSize: 10, background: "#dcfce7", color: "#15803d", padding: "1px 6px", borderRadius: 4 }}>LINE</span>}
                      </div>
                      <span style={{ fontSize: 11, color: "#9ca3af" }}>{formatDate(msg.date)}</span>
                    </div>
                    <div style={{ fontSize: 13, fontWeight: 500, color: "#374151", marginBottom: 2, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>{msg.subject || "(ä»¶åãªã—)"}</div>
                    <div style={{ fontSize: 12, color: "#9ca3af", overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>{(msg.body || "").slice(0, 80)}</div>
                  </div>
                );
              })}
            </div>
          )}
        </div>

        {/* è©³ç´°ãƒ‘ãƒãƒ« */}
        {selectedMsg && (
          <div style={{ ...cardStyle, padding: 24, position: "sticky", top: 24 }}>
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start", marginBottom: 16 }}>
              <div>
                <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 8 }}>
                  <span style={{
                    fontSize: 11, padding: "3px 10px", borderRadius: 6, fontWeight: 500,
                    background: selectedMsg.direction === "inbound" ? "#dbeafe" : "#e0e7ff",
                    color: selectedMsg.direction === "inbound" ? "#1d4aff" : "#4338ca",
                  }}>
                    {selectedMsg.direction === "inbound" ? "â† å—ä¿¡" : "â†’ é€ä¿¡"}
                  </span>
                  {selectedMsg.channel === "line" && <span style={{ fontSize: 10, background: "#dcfce7", color: "#15803d", padding: "2px 8px", borderRadius: 4 }}>LINE</span>}
                </div>
                <h3 style={{ fontSize: 16, fontWeight: 600, color: "#111827", marginBottom: 4 }}>{selectedMsg.subject || "(ä»¶åãªã—)"}</h3>
                <div style={{ fontSize: 12, color: "#6b7280" }}>
                  {selectedMsg.direction === "inbound" ? "From" : "To"}: {selectedMsg.to_email || "â€”"}
                </div>
              </div>
              <button onClick={() => setSelectedMsg(null)}
                style={{ border: "none", background: "#f3f4f6", borderRadius: 6, padding: "4px 8px", cursor: "pointer", fontSize: 14, color: "#6b7280" }}>âœ•</button>
            </div>

            <div style={{ display: "flex", gap: 12, marginBottom: 16, fontSize: 12, color: "#6b7280" }}>
              <span>ğŸ“… {formatDate(selectedMsg.date)}</span>
              <span>ğŸ‘¤ {selectedMsg.candidateName}</span>
              {selectedMsg.status && <span style={{ background: "#f3f4f6", padding: "2px 8px", borderRadius: 4, fontSize: 11 }}>{selectedMsg.status}</span>}
            </div>

            <div style={{ borderTop: "1px solid #e5e7eb", paddingTop: 16 }}>
              <div style={{ fontSize: 13, color: "#374151", lineHeight: 1.8, whiteSpace: "pre-wrap" }}>{selectedMsg.body || "(æœ¬æ–‡ãªã—)"}</div>
            </div>

            {/* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ */}
            <div style={{ borderTop: "1px solid #e5e7eb", paddingTop: 16, marginTop: 16, display: "flex", gap: 8 }}>
              {selectedMsg.candidate_id && (
                <button onClick={() => onNavigate && onNavigate("candidate-detail", selectedMsg.candidate_id)}
                  style={{ padding: "8px 16px", border: "1px solid #d1d5db", borderRadius: 8, background: "white", fontSize: 12, cursor: "pointer", color: "#374151" }}>
                  ğŸ‘¤ å€™è£œè€…è©³ç´°
                </button>
              )}
              <button onClick={() => {
                setComposeData({
                  to: selectedMsg.to_email || "",
                  candidateId: selectedMsg.candidate_id,
                  candidateName: selectedMsg.candidateName,
                  subject: "Re: " + (selectedMsg.subject || ""),
                  body: "\n\n---\n" + (selectedMsg.body || ""),
                  channel: "email",
                });
                setShowCompose(true);
              }}
                style={{ padding: "8px 16px", border: "none", borderRadius: 8, background: "#1d4aff", color: "white", fontSize: 12, cursor: "pointer", fontWeight: 500 }}>
                â†© è¿”ä¿¡
              </button>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

// ============================================================
// ã‚¹ãƒ†ãƒ¼ã‚¸åˆ¥ã‚¿ã‚¹ã‚¯å®šç¾©ï¼ˆè‡ªå‹•ç”Ÿæˆç”¨ï¼‰
// ============================================================
const STAGE_TASKS = {
  "ã‚¨ãƒ³ãƒˆãƒªãƒ¼": [
    { label: "å¿œå‹Ÿæ›¸é¡ã®ç¢ºèª", priority: "high", daysDue: 2 },
    { label: "ã‚¨ãƒ³ãƒˆãƒªãƒ¼å—é ˜ãƒ¡ãƒ¼ãƒ«é€ä¿¡", priority: "high", daysDue: 1 },
  ],
  "èª¬æ˜ä¼š": [
    { label: "èª¬æ˜ä¼šã®æ¡ˆå†…ãƒ¡ãƒ¼ãƒ«é€ä¿¡", priority: "high", daysDue: 1 },
    { label: "å‚åŠ å¯å¦ã®ç¢ºèª", priority: "medium", daysDue: 3 },
  ],
  "ä¸€æ¬¡é¢æ¥": [
    { label: "é¢æ¥æ—¥ç¨‹ã®èª¿æ•´ãƒ»å€™è£œæ—¥é€£çµ¡", priority: "high", daysDue: 2 },
    { label: "é¢æ¥ãƒªãƒã‚¤ãƒ³ãƒ‰ãƒ¡ãƒ¼ãƒ«é€ä¿¡", priority: "medium", daysDue: 0, note: "é¢æ¥å‰æ—¥" },
    { label: "é¢æ¥FBã®å…¥åŠ›", priority: "high", daysDue: 1, note: "é¢æ¥å®Ÿæ–½å¾Œ" },
  ],
  "é©æ€§ãƒ†ã‚¹ãƒˆ": [
    { label: "é©æ€§ãƒ†ã‚¹ãƒˆå—æ¤œæ¡ˆå†…ãƒ¡ãƒ¼ãƒ«é€ä¿¡", priority: "high", daysDue: 1 },
    { label: "å—æ¤œçŠ¶æ³ã®ç¢ºèª", priority: "medium", daysDue: 5 },
    { label: "ãƒ†ã‚¹ãƒˆçµæœã®ç¢ºèªãƒ»è©•ä¾¡", priority: "high", daysDue: 2, note: "å—æ¤œå®Œäº†å¾Œ" },
  ],
  "äºŒæ¬¡é¢æ¥": [
    { label: "äºŒæ¬¡é¢æ¥ã®æ—¥ç¨‹èª¿æ•´", priority: "high", daysDue: 2 },
    { label: "é¢æ¥ãƒªãƒã‚¤ãƒ³ãƒ‰ãƒ¡ãƒ¼ãƒ«é€ä¿¡", priority: "medium", daysDue: 0, note: "é¢æ¥å‰æ—¥" },
    { label: "é¢æ¥FBã®å…¥åŠ›", priority: "high", daysDue: 1, note: "é¢æ¥å®Ÿæ–½å¾Œ" },
  ],
  "æœ€çµ‚é¢æ¥": [
    { label: "æœ€çµ‚é¢æ¥ã®æ—¥ç¨‹èª¿æ•´", priority: "high", daysDue: 2 },
    { label: "é¢æ¥ãƒªãƒã‚¤ãƒ³ãƒ‰ãƒ¡ãƒ¼ãƒ«é€ä¿¡", priority: "medium", daysDue: 0, note: "é¢æ¥å‰æ—¥" },
    { label: "é¢æ¥FBã®å…¥åŠ›ãƒ»åˆå¦åˆ¤å®š", priority: "high", daysDue: 1, note: "é¢æ¥å®Ÿæ–½å¾Œ" },
  ],
  "å†…å®š": [
    { label: "å†…å®šé€šçŸ¥ãƒ¡ãƒ¼ãƒ«ã®é€ä¿¡", priority: "high", daysDue: 1 },
    { label: "ã‚ªãƒ•ã‚¡ãƒ¼é¢è«‡ã®æ—¥ç¨‹èª¿æ•´", priority: "high", daysDue: 3 },
    { label: "ãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—é€£çµ¡", priority: "medium", daysDue: 7 },
  ],
  "å†…å®šæ‰¿è«¾": [
    { label: "å…¥ç¤¾æ‰‹ç¶šãæ›¸é¡ã®æ¡ˆå†…", priority: "high", daysDue: 3 },
    { label: "å…¥ç¤¾å‰ãƒ•ã‚©ãƒ­ãƒ¼é€£çµ¡", priority: "medium", daysDue: 14 },
    { label: "å…¥ç¤¾æ—¥ãƒ»é…å±ã®ç¢ºèª", priority: "medium", daysDue: 7 },
  ],
};

function generateTasksForStage(candidate, stageName) {
  const defs = STAGE_TASKS[stageName];
  if (!defs) return [];
  const now = new Date();
  return defs.map((def, i) => ({
    id: "task_" + candidate.id + "_" + stageName + "_" + i + "_" + Date.now(),
    candidateId: candidate.id,
    candidateName: (candidate.lastName || "") + " " + (candidate.firstName || ""),
    recruitType: candidate.recruitType,
    stage: stageName,
    label: def.label,
    priority: def.priority,
    note: def.note || "",
    done: false,
    createdAt: now.toISOString(),
    dueAt: new Date(now.getTime() + def.daysDue * 86400000).toISOString().split("T")[0],
  }));
}

// ============================================================
// ã‚¿ã‚¹ã‚¯ãƒšãƒ¼ã‚¸
// ============================================================
function TasksPage({ tasks, onUpdateTasks, candidates, onNavigate }) {
  const [filter, setFilter] = useState("pending"); // pending | all | done | overdue
  const [sortBy, setSortBy] = useState("dueAt"); // dueAt | priority | stage
  const [showAddModal, setShowAddModal] = useState(false);
  const [newTask, setNewTask] = useState({ candidateId: "", label: "", priority: "medium", dueAt: "", note: "" });

  const today = new Date().toISOString().split("T")[0];

  const filteredTasks = useMemo(() => {
    let list = [...(tasks || [])];
    if (filter === "pending") list = list.filter(t => !t.done);
    else if (filter === "done") list = list.filter(t => t.done);
    else if (filter === "overdue") list = list.filter(t => !t.done && t.dueAt < today);

    list.sort((a, b) => {
      if (sortBy === "dueAt") return (a.dueAt || "9999") < (b.dueAt || "9999") ? -1 : 1;
      if (sortBy === "priority") {
        const p = { high: 0, medium: 1, low: 2 };
        return (p[a.priority] || 1) - (p[b.priority] || 1);
      }
      if (sortBy === "stage") {
        const si = (n) => STAGE_DEFINITIONS.findIndex(s => s.name === n);
        return si(a.stage) - si(b.stage);
      }
      return 0;
    });
    return list;
  }, [tasks, filter, sortBy, today]);

  const toggleDone = (taskId) => {
    const updated = (tasks || []).map(t => t.id === taskId ? { ...t, done: !t.done, doneAt: !t.done ? new Date().toISOString() : null } : t);
    onUpdateTasks(updated);
  };

  const deleteTask = (taskId) => {
    onUpdateTasks((tasks || []).filter(t => t.id !== taskId));
  };

  const addTask = () => {
    if (!newTask.label.trim()) return;
    const cand = candidates.find(c => c.id == newTask.candidateId);
    const task = {
      id: "task_manual_" + Date.now(),
      candidateId: newTask.candidateId ? Number(newTask.candidateId) : null,
      candidateName: cand ? (cand.lastName + " " + cand.firstName) : "ï¼ˆå…±é€šï¼‰",
      recruitType: cand?.recruitType || "",
      stage: cand?.stage || "",
      label: newTask.label.trim(),
      priority: newTask.priority,
      note: newTask.note,
      done: false,
      createdAt: new Date().toISOString(),
      dueAt: newTask.dueAt || today,
    };
    onUpdateTasks([...(tasks || []), task]);
    setNewTask({ candidateId: "", label: "", priority: "medium", dueAt: "", note: "" });
    setShowAddModal(false);
  };

  const overdueCount = (tasks || []).filter(t => !t.done && t.dueAt < today).length;
  const todayCount = (tasks || []).filter(t => !t.done && t.dueAt === today).length;
  const pendingCount = (tasks || []).filter(t => !t.done).length;
  const doneCount = (tasks || []).filter(t => t.done).length;

  const prioStyle = (p) => p === "high" ? { bg: "#fee2e2", color: "#dc2626", label: "é«˜" } : p === "medium" ? { bg: "#fef3c7", color: "#92400e", label: "ä¸­" } : { bg: "#f3f4f6", color: "#6b7280", label: "ä½" };

  const dueStyle = (dueAt, done) => {
    if (done) return { color: "#9ca3af" };
    if (dueAt < today) return { color: "#dc2626", fontWeight: 600 };
    if (dueAt === today) return { color: "#f59e0b", fontWeight: 600 };
    return { color: "#6b7280" };
  };

  const formatDate = (d) => {
    if (!d) return "";
    const dt = new Date(d + "T00:00:00");
    const mm = dt.getMonth() + 1, dd = dt.getDate();
    const days = ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"];
    return mm + "/" + dd + "(" + days[dt.getDay()] + ")";
  };

  // ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ï¼ˆå€™è£œè€…ã”ã¨ï¼‰
  const grouped = useMemo(() => {
    const map = {};
    filteredTasks.forEach(t => {
      const key = t.candidateId || "__common__";
      if (!map[key]) map[key] = { name: t.candidateName, recruitType: t.recruitType, stage: t.stage, tasks: [] };
      map[key].tasks.push(t);
    });
    return Object.entries(map);
  }, [filteredTasks]);

  return (
    <div style={{ padding: 24, maxWidth: 1000 }}>
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 20 }}>
        <h1 style={{ fontSize: 22, fontWeight: 700, color: "#111827" }}>âœ… ã‚¿ã‚¹ã‚¯</h1>
        <button onClick={() => setShowAddModal(true)} style={{ display: "flex", alignItems: "center", gap: 6, padding: "8px 16px", background: "#4338ca", color: "white", border: "none", borderRadius: 8, fontSize: 13, fontWeight: 600, cursor: "pointer" }}>
          <Icon name="plus" size={14} color="white" /> æ–°è¦ã‚¿ã‚¹ã‚¯
        </button>
      </div>

      {/* ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ */}
      <div style={{ display: "flex", gap: 12, marginBottom: 20 }}>
        {[
          { label: "æœŸé™è¶…é", count: overdueCount, bg: "#fee2e2", color: "#dc2626", icon: "ğŸ”´", fKey: "overdue" },
          { label: "ä»Šæ—¥ãŒæœŸé™", count: todayCount, bg: "#fef3c7", color: "#92400e", icon: "ğŸŸ¡", fKey: "pending" },
          { label: "æœªå®Œäº†", count: pendingCount, bg: "#eef2ff", color: "#4338ca", icon: "ğŸ“‹", fKey: "pending" },
          { label: "å®Œäº†", count: doneCount, bg: "#dcfce7", color: "#15803d", icon: "âœ…", fKey: "done" },
        ].map((c, i) => (
          <div key={i} onClick={() => setFilter(c.fKey)} style={{ flex: 1, padding: "14px 16px", background: c.bg, borderRadius: 10, cursor: "pointer", border: filter === c.fKey ? "2px solid " + c.color : "2px solid transparent", transition: "all 0.15s" }}>
            <div style={{ fontSize: 11, color: c.color, marginBottom: 4 }}>{c.icon} {c.label}</div>
            <div style={{ fontSize: 24, fontWeight: 700, color: c.color }}>{c.count}</div>
          </div>
        ))}
      </div>

      {/* ãƒ•ã‚£ãƒ«ã‚¿ï¼†ã‚½ãƒ¼ãƒˆ */}
      <div style={{ display: "flex", gap: 8, marginBottom: 16, alignItems: "center" }}>
        {[
          { id: "pending", label: "æœªå®Œäº†" },
          { id: "overdue", label: "æœŸé™è¶…é" },
          { id: "done", label: "å®Œäº†æ¸ˆã¿" },
          { id: "all", label: "ã™ã¹ã¦" },
        ].map(f => (
          <button key={f.id} onClick={() => setFilter(f.id)}
            style={{ padding: "5px 14px", border: "1px solid " + (filter === f.id ? "#4338ca" : "#e5e7eb"), borderRadius: 8, background: filter === f.id ? "#eef2ff" : "white", color: filter === f.id ? "#4338ca" : "#6b7280", fontSize: 12, cursor: "pointer", fontWeight: filter === f.id ? 600 : 400 }}>
            {f.label}
          </button>
        ))}
        <div style={{ marginLeft: "auto", display: "flex", alignItems: "center", gap: 6 }}>
          <span style={{ fontSize: 11, color: "#9ca3af" }}>ä¸¦ã³æ›¿ãˆ:</span>
          <select value={sortBy} onChange={e => setSortBy(e.target.value)} style={{ padding: "4px 8px", border: "1px solid #e5e7eb", borderRadius: 6, fontSize: 12, color: "#374151" }}>
            <option value="dueAt">æœŸé™æ—¥</option>
            <option value="priority">å„ªå…ˆåº¦</option>
            <option value="stage">ã‚¹ãƒ†ãƒ¼ã‚¸</option>
          </select>
        </div>
      </div>

      {/* ã‚¿ã‚¹ã‚¯ä¸€è¦§ */}
      {grouped.length === 0 ? (
        <div style={{ textAlign: "center", padding: 60, color: "#9ca3af" }}>
          <div style={{ fontSize: 40, marginBottom: 8 }}>{filter === "done" ? "ğŸ‰" : "ğŸ“­"}</div>
          <div style={{ fontSize: 14 }}>{filter === "done" ? "å®Œäº†ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“" : "æœªå®Œäº†ã®ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“"}</div>
        </div>
      ) : (
        grouped.map(([key, group]) => (
          <div key={key} style={{ marginBottom: 16 }}>
            <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 8, padding: "6px 0" }}>
              <span style={{ fontSize: 13, fontWeight: 600, color: "#374151" }}>{group.name}</span>
              {group.recruitType && <span style={{ fontSize: 10, padding: "2px 8px", borderRadius: 8, background: group.recruitType === "æ–°å’" ? "#eef2ff" : "#fffbeb", color: group.recruitType === "æ–°å’" ? "#4338ca" : "#92400e" }}>{group.recruitType}</span>}
              {group.stage && <span style={{ fontSize: 10, padding: "2px 8px", borderRadius: 8, background: "#f3f4f6", color: "#6b7280" }}>{group.stage}</span>}
            </div>
            <div style={{ background: "white", borderRadius: 10, boxShadow: "0 1px 3px rgba(0,0,0,0.06)", overflow: "hidden" }}>
              {group.tasks.map((task, ti) => {
                const ps = prioStyle(task.priority);
                const ds = dueStyle(task.dueAt, task.done);
                const stDef = getStageDefByName(task.stage);
                return (
                  <div key={task.id} style={{ display: "flex", alignItems: "center", gap: 12, padding: "12px 16px", borderBottom: ti < group.tasks.length - 1 ? "1px solid #f3f4f6" : "none", opacity: task.done ? 0.5 : 1, transition: "opacity 0.2s" }}>
                    <input type="checkbox" checked={task.done} onChange={() => toggleDone(task.id)}
                      style={{ width: 18, height: 18, accentColor: "#4338ca", cursor: "pointer", flexShrink: 0 }} />
                    <div style={{ width: 4, height: 32, borderRadius: 2, background: stDef?.color || "#9ca3af", flexShrink: 0 }} />
                    <div style={{ flex: 1, minWidth: 0 }}>
                      <div style={{ fontSize: 13, color: task.done ? "#9ca3af" : "#111827", textDecoration: task.done ? "line-through" : "none", fontWeight: 500 }}>{task.label}</div>
                      {task.note && <div style={{ fontSize: 11, color: "#9ca3af", marginTop: 2 }}>ğŸ’¡ {task.note}</div>}
                    </div>
                    <span style={{ fontSize: 10, padding: "2px 8px", borderRadius: 8, background: ps.bg, color: ps.color, fontWeight: 600, flexShrink: 0 }}>{ps.label}</span>
                    <span style={{ fontSize: 11, ...ds, flexShrink: 0, minWidth: 65 }}>{task.dueAt < today && !task.done ? "âš  " : ""}{formatDate(task.dueAt)}</span>
                    <button onClick={() => deleteTask(task.id)} style={{ background: "none", border: "none", color: "#d1d5db", cursor: "pointer", fontSize: 16, padding: "0 4px", flexShrink: 0 }} title="å‰Šé™¤">Ã—</button>
                  </div>
                );
              })}
            </div>
          </div>
        ))
      )}

      {/* æ–°è¦ã‚¿ã‚¹ã‚¯è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« */}
      {showAddModal && (
        <div style={{ position: "fixed", inset: 0, background: "rgba(0,0,0,0.4)", display: "flex", alignItems: "center", justifyContent: "center", zIndex: 100 }}>
          <div style={{ background: "white", borderRadius: 14, padding: 28, width: 480, maxHeight: "80vh", overflow: "auto" }}>
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 20 }}>
              <h2 style={{ fontSize: 16, fontWeight: 700 }}>æ–°è¦ã‚¿ã‚¹ã‚¯ä½œæˆ</h2>
              <button onClick={() => setShowAddModal(false)} style={{ background: "none", border: "none", fontSize: 20, cursor: "pointer", color: "#9ca3af" }}>Ã—</button>
            </div>
            <div style={{ display: "flex", flexDirection: "column", gap: 14 }}>
              <div>
                <label style={{ fontSize: 12, fontWeight: 600, color: "#374151", display: "block", marginBottom: 4 }}>å€™è£œè€…ï¼ˆä»»æ„ï¼‰</label>
                <select value={newTask.candidateId} onChange={e => setNewTask(p => ({ ...p, candidateId: e.target.value }))} style={{ width: "100%", padding: "8px 10px", border: "1px solid #e5e7eb", borderRadius: 8, fontSize: 13 }}>
                  <option value="">-- å…±é€šã‚¿ã‚¹ã‚¯ --</option>
                  {(candidates || []).map(c => <option key={c.id} value={c.id}>{c.lastName} {c.firstName}ï¼ˆ{c.stage}ï¼‰</option>)}
                </select>
              </div>
              <div>
                <label style={{ fontSize: 12, fontWeight: 600, color: "#374151", display: "block", marginBottom: 4 }}>ã‚¿ã‚¹ã‚¯å†…å®¹ *</label>
                <input value={newTask.label} onChange={e => setNewTask(p => ({ ...p, label: e.target.value }))} placeholder="ä¾‹: é¢æ¥æ—¥ç¨‹ã‚’èª¿æ•´ã™ã‚‹" style={{ width: "100%", padding: "8px 10px", border: "1px solid #e5e7eb", borderRadius: 8, fontSize: 13, boxSizing: "border-box" }} />
              </div>
              <div style={{ display: "flex", gap: 12 }}>
                <div style={{ flex: 1 }}>
                  <label style={{ fontSize: 12, fontWeight: 600, color: "#374151", display: "block", marginBottom: 4 }}>å„ªå…ˆåº¦</label>
                  <select value={newTask.priority} onChange={e => setNewTask(p => ({ ...p, priority: e.target.value }))} style={{ width: "100%", padding: "8px 10px", border: "1px solid #e5e7eb", borderRadius: 8, fontSize: 13 }}>
                    <option value="high">é«˜</option>
                    <option value="medium">ä¸­</option>
                    <option value="low">ä½</option>
                  </select>
                </div>
                <div style={{ flex: 1 }}>
                  <label style={{ fontSize: 12, fontWeight: 600, color: "#374151", display: "block", marginBottom: 4 }}>æœŸé™æ—¥</label>
                  <input type="date" value={newTask.dueAt} onChange={e => setNewTask(p => ({ ...p, dueAt: e.target.value }))} style={{ width: "100%", padding: "8px 10px", border: "1px solid #e5e7eb", borderRadius: 8, fontSize: 13, boxSizing: "border-box" }} />
                </div>
              </div>
              <div>
                <label style={{ fontSize: 12, fontWeight: 600, color: "#374151", display: "block", marginBottom: 4 }}>ãƒ¡ãƒ¢</label>
                <input value={newTask.note} onChange={e => setNewTask(p => ({ ...p, note: e.target.value }))} placeholder="è£œè¶³æƒ…å ±" style={{ width: "100%", padding: "8px 10px", border: "1px solid #e5e7eb", borderRadius: 8, fontSize: 13, boxSizing: "border-box" }} />
              </div>
              <button onClick={addTask} disabled={!newTask.label.trim()} style={{ padding: "10px 0", background: newTask.label.trim() ? "#4338ca" : "#d1d5db", color: "white", border: "none", borderRadius: 8, fontSize: 14, fontWeight: 600, cursor: newTask.label.trim() ? "pointer" : "not-allowed" }}>ä½œæˆ</button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// ============================================================
// ç´¹ä»‹ä¼šç¤¾ï¼ˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼‰ç®¡ç†ãƒšãƒ¼ã‚¸
// ============================================================
function AgentsPage({ candidates = [] }) {
  const [agents, setAgents] = useState(() => {
    try { const saved = localStorage.getItem('ats_agents'); return saved ? JSON.parse(saved) : []; } catch(e) { return []; }
  });
  const save = (list) => { setAgents(list); localStorage.setItem('ats_agents', JSON.stringify(list)); };

  // å€™è£œè€…ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ç´¹ä»‹ä¼šç¤¾åã‚’è‡ªå‹•æ¤œå‡ºã—ã€æœªç™»éŒ²ãªã‚‰è¿½åŠ 
  useEffect(() => {
    const agentNames = new Set(agents.map(a => a.name));
    const newAgents = [];
    candidates.forEach(c => {
      if (c.agent && c.agent.trim() && !agentNames.has(c.agent.trim())) {
        agentNames.add(c.agent.trim());
        newAgents.push({
          id: "ag_auto_" + Date.now() + "_" + newAgents.length,
          name: c.agent.trim(),
          contactPerson: "",
          email: "",
          phone: "",
          contractType: "æˆåŠŸå ±é…¬å‹",
          feePercent: 35,
          contractStart: "",
          contractEnd: "",
          notes: "å€™è£œè€…ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è‡ªå‹•æ¤œå‡º",
          active: true,
        });
      }
    });
    if (newAgents.length > 0) {
      const updated = [...agents, ...newAgents];
      save(updated);
    }
  }, [candidates]); // eslint-disable-line react-hooks/exhaustive-deps

  const [showEditor, setShowEditor] = useState(false);
  const [editing, setEditing] = useState(null); // null = new
  const [form, setForm] = useState({});
  const [selectedAgent, setSelectedAgent] = useState(null);
  const [filterActive, setFilterActive] = useState("all"); // all | active | inactive
  const [searchQ, setSearchQ] = useState("");

  const openNew = () => { setEditing(null); setForm({ name: "", contactPerson: "", email: "", phone: "", contractType: "æˆåŠŸå ±é…¬å‹", feePercent: 35, contractStart: "", contractEnd: "", notes: "", active: true }); setShowEditor(true); };
  const openEdit = (ag) => { setEditing(ag); setForm({ ...ag }); setShowEditor(true); };
  const saveAgent = () => {
    if (!form.name.trim()) return;
    if (editing) {
      save(agents.map(a => a.id === editing.id ? { ...form, id: editing.id } : a));
    } else {
      save([...agents, { ...form, id: "ag_" + Date.now() }]);
    }
    setShowEditor(false);
  };
  const deleteAgent = (id) => { if (window.confirm("ã“ã®ç´¹ä»‹ä¼šç¤¾ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) save(agents.filter(a => a.id !== id)); };
  const toggleActive = (id) => { save(agents.map(a => a.id === id ? { ...a, active: !a.active } : a)); };

  // å€™è£œè€…ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã”ã¨ã®ç´¹ä»‹å®Ÿç¸¾ã‚’é›†è¨ˆ
  const agentStats = useMemo(() => {
    const stats = {};
    agents.forEach(ag => { stats[ag.name] = { total: 0, byStage: {}, byRecruitType: { "æ–°å’": 0, "ä¸­é€”": 0 } }; });
    candidates.forEach(c => {
      if (c.agent && stats[c.agent]) {
        stats[c.agent].total++;
        stats[c.agent].byStage[c.stage] = (stats[c.agent].byStage[c.stage] || 0) + 1;
        if (c.recruitType) stats[c.agent].byRecruitType[c.recruitType] = (stats[c.agent].byRecruitType[c.recruitType] || 0) + 1;
      }
    });
    return stats;
  }, [agents, candidates]);

  // ã‚¹ãƒ†ãƒ¼ã‚¸ã®é€²æ—åº¦ã‚’è¨ˆç®—ï¼ˆå†…å®šä»¥é™ã®æ•° / totalï¼‰
  const calcProgress = (name) => {
    const s = agentStats[name];
    if (!s || s.total === 0) return 0;
    const advancedStages = ["å†…å®š", "å†…å®šæ‰¿è«¾"];
    const advanced = advancedStages.reduce((sum, st) => sum + (s.byStage[st] || 0), 0);
    return Math.round((advanced / s.total) * 100);
  };

  const filteredAgents = agents.filter(a => {
    if (filterActive === "active" && !a.active) return false;
    if (filterActive === "inactive" && a.active) return false;
    if (searchQ && !a.name.includes(searchQ) && !a.contactPerson.includes(searchQ)) return false;
    return true;
  });

  const today = new Date().toISOString().split("T")[0];
  const isExpired = (ag) => ag.contractEnd && ag.contractEnd < today;

  // è©³ç´°è¡¨ç¤ºä¸­ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å€™è£œè€…ãƒªã‚¹ãƒˆ
  const selectedCandidates = selectedAgent ? candidates.filter(c => c.agent === selectedAgent.name) : [];

  return (
    <div style={{ padding: 24, maxWidth: 1100 }}>
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 20 }}>
        <h1 style={{ fontSize: 22, fontWeight: 700, color: "#111827" }}>ğŸ¢ ç´¹ä»‹ä¼šç¤¾ç®¡ç†</h1>
        <div style={{ display: "flex", gap: 8 }}>
          <button onClick={() => { if (window.confirm("ç´¹ä»‹ä¼šç¤¾ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã€å€™è£œè€…ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å†æ¤œå‡ºã—ã¾ã™ã‹ï¼Ÿ")) { localStorage.removeItem('ats_agents'); setAgents([]); setSelectedAgent(null); } }} style={{ padding: "8px 12px", border: "1px solid #e5e7eb", borderRadius: 8, background: "white", fontSize: 12, cursor: "pointer", color: "#6b7280" }}>ğŸ”„ å†æ¤œå‡º</button>
          <button onClick={openNew} style={{ display: "flex", alignItems: "center", gap: 6, padding: "8px 16px", background: "#4338ca", color: "white", border: "none", borderRadius: 8, fontSize: 13, fontWeight: 600, cursor: "pointer" }}>
            <Icon name="plus" size={14} color="white" /> æ–°è¦ç™»éŒ²
          </button>
        </div>
      </div>

      {/* ã‚µãƒãƒªãƒ¼ */}
      <div style={{ display: "flex", gap: 12, marginBottom: 20 }}>
        {[
          { label: "å¥‘ç´„ä¸­", count: agents.filter(a => a.active).length, bg: "#dcfce7", color: "#15803d" },
          { label: "ç´¹ä»‹å€™è£œè€…æ•°", count: candidates.filter(c => c.agent).length, bg: "#eef2ff", color: "#4338ca" },
          { label: "å†…å®šä»¥é™", count: candidates.filter(c => c.agent && (c.stage === "å†…å®š" || c.stage === "å†…å®šæ‰¿è«¾")).length, bg: "#fef3c7", color: "#92400e" },
          { label: "å¥‘ç´„æœŸé™åˆ‡ã‚Œ", count: agents.filter(a => isExpired(a)).length, bg: "#fee2e2", color: "#dc2626" },
        ].map((c, i) => (
          <div key={i} style={{ flex: 1, padding: "14px 16px", background: c.bg, borderRadius: 10 }}>
            <div style={{ fontSize: 11, color: c.color, marginBottom: 4 }}>{c.label}</div>
            <div style={{ fontSize: 24, fontWeight: 700, color: c.color }}>{c.count}</div>
          </div>
        ))}
      </div>

      {/* ãƒ•ã‚£ãƒ«ã‚¿ */}
      <div style={{ display: "flex", gap: 8, marginBottom: 16, alignItems: "center" }}>
        {[{ id: "all", l: "ã™ã¹ã¦" }, { id: "active", l: "å¥‘ç´„ä¸­" }, { id: "inactive", l: "éã‚¢ã‚¯ãƒ†ã‚£ãƒ–" }].map(f => (
          <button key={f.id} onClick={() => setFilterActive(f.id)} style={{ padding: "5px 14px", border: "1px solid " + (filterActive === f.id ? "#4338ca" : "#e5e7eb"), borderRadius: 8, background: filterActive === f.id ? "#eef2ff" : "white", color: filterActive === f.id ? "#4338ca" : "#6b7280", fontSize: 12, cursor: "pointer", fontWeight: filterActive === f.id ? 600 : 400 }}>{f.l}</button>
        ))}
        <div style={{ marginLeft: "auto" }}>
          <input value={searchQ} onChange={e => setSearchQ(e.target.value)} placeholder="ä¼šç¤¾åãƒ»æ‹…å½“è€…ã§æ¤œç´¢" style={{ padding: "6px 12px", border: "1px solid #e5e7eb", borderRadius: 8, fontSize: 12, width: 200 }} />
        </div>
      </div>

      <div style={{ display: "flex", gap: 16 }}>
        {/* å·¦: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆä¸€è¦§ */}
        <div style={{ flex: selectedAgent ? "0 0 420px" : 1 }}>
          {filteredAgents.map(ag => {
            const stats = agentStats[ag.name] || { total: 0 };
            const progress = calcProgress(ag.name);
            const expired = isExpired(ag);
            const isSelected = selectedAgent?.id === ag.id;
            return (
              <div key={ag.id} onClick={() => setSelectedAgent(isSelected ? null : ag)} style={{ background: isSelected ? "#eef2ff" : "white", borderRadius: 10, padding: 16, marginBottom: 10, boxShadow: "0 1px 3px rgba(0,0,0,0.06)", cursor: "pointer", border: isSelected ? "2px solid #4338ca" : "2px solid transparent", transition: "all 0.15s", opacity: ag.active ? 1 : 0.6 }}>
                <div style={{ display: "flex", alignItems: "center", gap: 10, marginBottom: 10 }}>
                  <div style={{ width: 40, height: 40, borderRadius: 10, background: ag.active ? "#eef2ff" : "#f3f4f6", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 18 }}>ğŸ¢</div>
                  <div style={{ flex: 1, minWidth: 0 }}>
                    <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
                      <span style={{ fontSize: 14, fontWeight: 600, color: "#111827" }}>{ag.name}</span>
                      {ag.active ? <span style={{ fontSize: 10, padding: "1px 6px", borderRadius: 6, background: "#dcfce7", color: "#15803d" }}>å¥‘ç´„ä¸­</span> : <span style={{ fontSize: 10, padding: "1px 6px", borderRadius: 6, background: "#f3f4f6", color: "#9ca3af" }}>éã‚¢ã‚¯ãƒ†ã‚£ãƒ–</span>}
                      {expired && <span style={{ fontSize: 10, padding: "1px 6px", borderRadius: 6, background: "#fee2e2", color: "#dc2626" }}>æœŸé™åˆ‡ã‚Œ</span>}
                    </div>
                    <div style={{ fontSize: 11, color: "#6b7280" }}>æ‹…å½“: {ag.contactPerson} ãƒ» {ag.contractType} {ag.feePercent}%</div>
                  </div>
                  <div style={{ textAlign: "right" }}>
                    <div style={{ fontSize: 20, fontWeight: 700, color: "#4338ca" }}>{stats.total}</div>
                    <div style={{ fontSize: 10, color: "#9ca3af" }}>ç´¹ä»‹æ•°</div>
                  </div>
                </div>
                {/* é€²æ—ãƒãƒ¼ */}
                <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                  <div style={{ flex: 1, height: 6, background: "#f3f4f6", borderRadius: 3, overflow: "hidden" }}>
                    <div style={{ height: "100%", width: progress + "%", background: progress > 0 ? "#10b981" : "transparent", borderRadius: 3, transition: "width 0.3s" }} />
                  </div>
                  <span style={{ fontSize: 10, color: "#6b7280", minWidth: 32 }}>{progress}% å†…å®š</span>
                </div>
                {/* ã‚¹ãƒ†ãƒ¼ã‚¸åˆ†å¸ƒãƒŸãƒ‹ãƒãƒƒã‚¸ */}
                {stats.total > 0 && (
                  <div style={{ display: "flex", gap: 4, marginTop: 8, flexWrap: "wrap" }}>
                    {Object.entries(stats.byStage || {}).map(([st, cnt]) => {
                      const def = getStageDefByName(st);
                      return <span key={st} style={{ fontSize: 10, padding: "1px 6px", borderRadius: 6, background: (def?.color || "#6b7280") + "18", color: def?.color || "#6b7280" }}>{st} {cnt}</span>;
                    })}
                  </div>
                )}
              </div>
            );
          })}
          {filteredAgents.length === 0 && (
            <div style={{ textAlign: "center", padding: 40, color: "#9ca3af" }}>
              <div style={{ fontSize: 32, marginBottom: 8 }}>ğŸ”</div>
              <div style={{ fontSize: 13 }}>è©²å½“ã™ã‚‹ç´¹ä»‹ä¼šç¤¾ãŒã‚ã‚Šã¾ã›ã‚“</div>
            </div>
          )}
        </div>

        {/* å³: è©³ç´°ãƒ‘ãƒãƒ« */}
        {selectedAgent && (
          <div style={{ flex: 1, minWidth: 0 }}>
            <div style={{ background: "white", borderRadius: 12, boxShadow: "0 1px 3px rgba(0,0,0,0.08)", overflow: "hidden" }}>
              {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
              <div style={{ padding: "16px 20px", borderBottom: "1px solid #f3f4f6", display: "flex", alignItems: "center", justifyContent: "space-between" }}>
                <h3 style={{ fontSize: 16, fontWeight: 700, color: "#111827" }}>{selectedAgent.name}</h3>
                <div style={{ display: "flex", gap: 6 }}>
                  <button onClick={(e) => { e.stopPropagation(); openEdit(selectedAgent); }} style={{ padding: "5px 12px", border: "1px solid #e5e7eb", borderRadius: 6, background: "white", fontSize: 11, cursor: "pointer" }}>âœï¸ ç·¨é›†</button>
                  <button onClick={(e) => { e.stopPropagation(); toggleActive(selectedAgent.id); }} style={{ padding: "5px 12px", border: "1px solid #e5e7eb", borderRadius: 6, background: "white", fontSize: 11, cursor: "pointer" }}>{selectedAgent.active ? "â¸ éã‚¢ã‚¯ãƒ†ã‚£ãƒ–" : "â–¶ ã‚¢ã‚¯ãƒ†ã‚£ãƒ–"}</button>
                  <button onClick={(e) => { e.stopPropagation(); deleteAgent(selectedAgent.id); setSelectedAgent(null); }} style={{ padding: "5px 12px", border: "1px solid #fee2e2", borderRadius: 6, background: "#fff5f5", fontSize: 11, cursor: "pointer", color: "#dc2626" }}>ğŸ—‘</button>
                </div>
              </div>

              {/* åŸºæœ¬æƒ…å ± */}
              <div style={{ padding: "16px 20px", borderBottom: "1px solid #f3f4f6" }}>
                <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12 }}>
                  {[
                    { l: "æ‹…å½“è€…", v: selectedAgent.contactPerson },
                    { l: "ãƒ¡ãƒ¼ãƒ«", v: selectedAgent.email },
                    { l: "é›»è©±", v: selectedAgent.phone },
                    { l: "å¥‘ç´„å½¢æ…‹", v: selectedAgent.contractType },
                    { l: "æ‰‹æ•°æ–™ç‡", v: selectedAgent.feePercent + "%" },
                    { l: "å¥‘ç´„æœŸé–“", v: (selectedAgent.contractStart || "?") + " ã€œ " + (selectedAgent.contractEnd || "?") },
                  ].map((item, i) => (
                    <div key={i}>
                      <div style={{ fontSize: 10, color: "#9ca3af", marginBottom: 2 }}>{item.l}</div>
                      <div style={{ fontSize: 13, color: "#111827" }}>{item.v || "â€”"}</div>
                    </div>
                  ))}
                </div>
                {selectedAgent.notes && <div style={{ marginTop: 12, fontSize: 12, color: "#6b7280", background: "#f9fafb", padding: "8px 12px", borderRadius: 8 }}>ğŸ“ {selectedAgent.notes}</div>}
              </div>

              {/* ç´¹ä»‹å€™è£œè€…ä¸€è¦§ */}
              <div style={{ padding: "16px 20px" }}>
                <h4 style={{ fontSize: 13, fontWeight: 600, marginBottom: 10 }}>ç´¹ä»‹å€™è£œè€… ({selectedCandidates.length}å)</h4>
                {selectedCandidates.length === 0 ? (
                  <div style={{ fontSize: 12, color: "#9ca3af", padding: 12, textAlign: "center" }}>ç´¹ä»‹å®Ÿç¸¾ãŒã‚ã‚Šã¾ã›ã‚“</div>
                ) : (
                  <div style={{ maxHeight: 300, overflowY: "auto" }}>
                    {selectedCandidates.map(c => {
                      const stDef = getStageDefByName(c.stage);
                      return (
                        <div key={c.id} style={{ display: "flex", alignItems: "center", gap: 10, padding: "10px 0", borderBottom: "1px solid #f3f4f6" }}>
                          <div style={{ width: 32, height: 32, borderRadius: "50%", background: stDef?.color || "#6b7280", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 11, color: "white", fontWeight: 600 }}>{(c.lastName || "?").charAt(0)}</div>
                          <div style={{ flex: 1, minWidth: 0 }}>
                            <div style={{ fontSize: 13, fontWeight: 500, color: "#111827" }}>{c.lastName} {c.firstName}</div>
                            <div style={{ fontSize: 10, color: "#9ca3af" }}>{c.recruitType} ãƒ» {c.university || c.company || ""}</div>
                          </div>
                          <span style={{ fontSize: 10, padding: "2px 8px", borderRadius: 6, background: (stDef?.color || "#6b7280") + "18", color: stDef?.color || "#6b7280", fontWeight: 600 }}>{c.stage}</span>
                        </div>
                      );
                    })}
                  </div>
                )}
              </div>
            </div>
          </div>
        )}
      </div>

      {/* ç™»éŒ²/ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« */}
      {showEditor && (
        <div style={{ position: "fixed", inset: 0, background: "rgba(0,0,0,0.4)", display: "flex", alignItems: "center", justifyContent: "center", zIndex: 100 }}>
          <div style={{ background: "white", borderRadius: 14, padding: 28, width: 520, maxHeight: "85vh", overflow: "auto" }}>
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 20 }}>
              <h2 style={{ fontSize: 16, fontWeight: 700 }}>{editing ? "ç´¹ä»‹ä¼šç¤¾ã‚’ç·¨é›†" : "æ–°è¦ç´¹ä»‹ä¼šç¤¾"}</h2>
              <button onClick={() => setShowEditor(false)} style={{ background: "none", border: "none", fontSize: 20, cursor: "pointer", color: "#9ca3af" }}>Ã—</button>
            </div>
            <div style={{ display: "flex", flexDirection: "column", gap: 14 }}>
              {[
                { key: "name", label: "ä¼šç¤¾å *", type: "text", ph: "ä¾‹: â—‹â—‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ" },
                { key: "contactPerson", label: "æ‹…å½“è€…å", type: "text", ph: "ä¾‹: ä½ã€…æœ¨ èª " },
                { key: "email", label: "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹", type: "email", ph: "example@agent.co.jp" },
                { key: "phone", label: "é›»è©±ç•ªå·", type: "text", ph: "03-1234-5678" },
              ].map(f => (
                <div key={f.key}>
                  <label style={{ fontSize: 12, fontWeight: 600, color: "#374151", display: "block", marginBottom: 4 }}>{f.label}</label>
                  <input value={form[f.key] || ""} onChange={e => setForm(p => ({ ...p, [f.key]: e.target.value }))} placeholder={f.ph} type={f.type} style={{ width: "100%", padding: "8px 10px", border: "1px solid #e5e7eb", borderRadius: 8, fontSize: 13, boxSizing: "border-box" }} />
                </div>
              ))}
              <div style={{ display: "flex", gap: 12 }}>
                <div style={{ flex: 1 }}>
                  <label style={{ fontSize: 12, fontWeight: 600, color: "#374151", display: "block", marginBottom: 4 }}>å¥‘ç´„å½¢æ…‹</label>
                  <select value={form.contractType || ""} onChange={e => setForm(p => ({ ...p, contractType: e.target.value }))} style={{ width: "100%", padding: "8px 10px", border: "1px solid #e5e7eb", borderRadius: 8, fontSize: 13 }}>
                    <option value="æˆåŠŸå ±é…¬å‹">æˆåŠŸå ±é…¬å‹</option>
                    <option value="ãƒªãƒ†ãƒ¼ãƒŠãƒ¼å‹">ãƒªãƒ†ãƒ¼ãƒŠãƒ¼å‹</option>
                    <option value="å›ºå®šå ±é…¬å‹">å›ºå®šå ±é…¬å‹</option>
                  </select>
                </div>
                <div style={{ flex: 1 }}>
                  <label style={{ fontSize: 12, fontWeight: 600, color: "#374151", display: "block", marginBottom: 4 }}>æ‰‹æ•°æ–™ç‡ (%)</label>
                  <input type="number" value={form.feePercent || ""} onChange={e => setForm(p => ({ ...p, feePercent: Number(e.target.value) }))} style={{ width: "100%", padding: "8px 10px", border: "1px solid #e5e7eb", borderRadius: 8, fontSize: 13, boxSizing: "border-box" }} />
                </div>
              </div>
              <div style={{ display: "flex", gap: 12 }}>
                <div style={{ flex: 1 }}>
                  <label style={{ fontSize: 12, fontWeight: 600, color: "#374151", display: "block", marginBottom: 4 }}>å¥‘ç´„é–‹å§‹æ—¥</label>
                  <input type="date" value={form.contractStart || ""} onChange={e => setForm(p => ({ ...p, contractStart: e.target.value }))} style={{ width: "100%", padding: "8px 10px", border: "1px solid #e5e7eb", borderRadius: 8, fontSize: 13, boxSizing: "border-box" }} />
                </div>
                <div style={{ flex: 1 }}>
                  <label style={{ fontSize: 12, fontWeight: 600, color: "#374151", display: "block", marginBottom: 4 }}>å¥‘ç´„çµ‚äº†æ—¥</label>
                  <input type="date" value={form.contractEnd || ""} onChange={e => setForm(p => ({ ...p, contractEnd: e.target.value }))} style={{ width: "100%", padding: "8px 10px", border: "1px solid #e5e7eb", borderRadius: 8, fontSize: 13, boxSizing: "border-box" }} />
                </div>
              </div>
              <div>
                <label style={{ fontSize: 12, fontWeight: 600, color: "#374151", display: "block", marginBottom: 4 }}>å‚™è€ƒ</label>
                <textarea value={form.notes || ""} onChange={e => setForm(p => ({ ...p, notes: e.target.value }))} rows={3} placeholder="ç‰¹è¨˜äº‹é …" style={{ width: "100%", padding: "8px 10px", border: "1px solid #e5e7eb", borderRadius: 8, fontSize: 13, resize: "vertical", boxSizing: "border-box" }} />
              </div>
              <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                <input type="checkbox" checked={form.active !== false} onChange={e => setForm(p => ({ ...p, active: e.target.checked }))} id="agent-active" />
                <label htmlFor="agent-active" style={{ fontSize: 13, color: "#374151" }}>ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ï¼ˆå¥‘ç´„ä¸­ï¼‰</label>
              </div>
              <button onClick={saveAgent} disabled={!form.name?.trim()} style={{ padding: "10px 0", background: form.name?.trim() ? "#4338ca" : "#d1d5db", color: "white", border: "none", borderRadius: 8, fontSize: 14, fontWeight: 600, cursor: form.name?.trim() ? "pointer" : "not-allowed" }}>{editing ? "æ›´æ–°" : "ç™»éŒ²"}</button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// ============================================================
// è¨­å®šãƒšãƒ¼ã‚¸ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†ï¼‰
// ============================================================
function SettingsPage({ emailTemplates, onSaveTemplates }) {
  const [tab, setTab] = useState("templates");
  const [templates, setTemplates] = useState(emailTemplates || []);
  const [editingTpl, setEditingTpl] = useState(null); // null | template object
  const [filterCat, setFilterCat] = useState("all");
  const [searchTerm, setSearchTerm] = useState("");
  const [toast, setToast] = useState(null);

  const categories = useMemo(() => {
    const cats = new Set(templates.map(t => t.category));
    return ["all", ...Array.from(cats)];
  }, [templates]);

  const filtered = useMemo(() => {
    return templates.filter(t => {
      if (filterCat !== "all" && t.category !== filterCat) return false;
      if (searchTerm && !t.label.includes(searchTerm) && !t.subject.includes(searchTerm) && !t.category.includes(searchTerm)) return false;
      return true;
    });
  }, [templates, filterCat, searchTerm]);

  const grouped = useMemo(() => {
    const map = {};
    filtered.forEach(t => { if (!map[t.category]) map[t.category] = []; map[t.category].push(t); });
    return map;
  }, [filtered]);

  const showToast = (msg) => { setToast(msg); setTimeout(() => setToast(null), 2500); };

  const openNew = () => {
    setEditingTpl({ id: "t_" + Date.now(), category: "", label: "", subject: "", body: "", isNew: true });
  };

  const openEdit = (tpl) => {
    setEditingTpl({ ...tpl, isNew: false });
  };

  const saveTemplate = () => {
    if (!editingTpl.label || !editingTpl.subject || !editingTpl.category) { alert("ã‚«ãƒ†ã‚´ãƒªãƒ»ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåãƒ»ä»¶åã¯å¿…é ˆã§ã™"); return; }
    let updated;
    if (editingTpl.isNew) {
      updated = [...templates, { id: editingTpl.id, category: editingTpl.category, label: editingTpl.label, subject: editingTpl.subject, body: editingTpl.body }];
    } else {
      updated = templates.map(t => t.id === editingTpl.id ? { id: t.id, category: editingTpl.category, label: editingTpl.label, subject: editingTpl.subject, body: editingTpl.body } : t);
    }
    setTemplates(updated);
    onSaveTemplates(updated);
    setEditingTpl(null);
    showToast(editingTpl.isNew ? "ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ" : "ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸ");
  };

  const deleteTemplate = (id) => {
    if (!window.confirm("ã“ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    const updated = templates.filter(t => t.id !== id);
    setTemplates(updated);
    onSaveTemplates(updated);
    showToast("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ");
  };

  const duplicateTemplate = (tpl) => {
    const newTpl = { ...tpl, id: "t_" + Date.now(), label: tpl.label + "ï¼ˆã‚³ãƒ”ãƒ¼ï¼‰" };
    const updated = [...templates, newTpl];
    setTemplates(updated);
    onSaveTemplates(updated);
    showToast("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’è¤‡è£½ã—ã¾ã—ãŸ");
  };

  const resetToDefault = () => {
    if (!window.confirm("å…¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆã‚«ã‚¹ã‚¿ãƒ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¯å¤±ã‚ã‚Œã¾ã™ï¼‰")) return;
    setTemplates(DEFAULT_EMAIL_TEMPLATES);
    onSaveTemplates(DEFAULT_EMAIL_TEMPLATES);
    showToast("ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã—ã¾ã—ãŸ");
  };

  const inputStyle = { width: "100%", padding: "8px 12px", border: "1px solid #d1d5db", borderRadius: 8, fontSize: 13, outline: "none", boxSizing: "border-box" };

  return (
    <div style={{ padding: 24, maxWidth: 1000 }}>
      <h1 style={{ fontSize: 22, fontWeight: 700, color: "#111827", marginBottom: 20 }}>âš™ï¸ è¨­å®š</h1>

      {/* ã‚¿ãƒ– */}
      <div style={{ display: "flex", gap: 4, marginBottom: 20, borderBottom: "1px solid #e5e7eb", paddingBottom: 0 }}>
        {[{ id: "templates", label: "ğŸ“§ ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ" }, { id: "company", label: "ğŸ¢ ä¼šç¤¾æƒ…å ±" }].map(t => (
          <button key={t.id} onClick={() => setTab(t.id)}
            style={{ padding: "8px 16px", border: "none", borderBottom: tab === t.id ? "2px solid #6366f1" : "2px solid transparent", background: "none", fontSize: 13, fontWeight: tab === t.id ? 600 : 400, color: tab === t.id ? "#6366f1" : "#6b7280", cursor: "pointer" }}>
            {t.label}
          </button>
        ))}
      </div>

      {tab === "templates" && !editingTpl && (<>
        {/* ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ */}
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 16, flexWrap: "wrap", gap: 8 }}>
          <div style={{ display: "flex", gap: 8, alignItems: "center" }}>
            <div style={{ position: "relative" }}>
              <Icon name="search" size={14} color="#9ca3af" style={{ position: "absolute", left: 8, top: 9 }} />
              <input value={searchTerm} onChange={e => setSearchTerm(e.target.value)} placeholder="ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’æ¤œç´¢..."
                style={{ ...inputStyle, paddingLeft: 28, width: 220 }} />
            </div>
            <select value={filterCat} onChange={e => setFilterCat(e.target.value)}
              style={{ ...inputStyle, width: 150, cursor: "pointer" }}>
              {categories.map(c => <option key={c} value={c}>{c === "all" ? "å…¨ã‚«ãƒ†ã‚´ãƒª" : c}</option>)}
            </select>
          </div>
          <div style={{ display: "flex", gap: 6 }}>
            <button onClick={resetToDefault}
              style={{ padding: "7px 14px", border: "1px solid #d1d5db", borderRadius: 8, background: "white", fontSize: 12, cursor: "pointer", color: "#6b7280" }}>
              ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™
            </button>
            <button onClick={openNew}
              style={{ display: "flex", alignItems: "center", gap: 5, padding: "7px 14px", border: "none", borderRadius: 8, background: "#6366f1", color: "white", fontSize: 12, fontWeight: 500, cursor: "pointer" }}>
              <Icon name="plus" size={14} /> æ–°è¦ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
            </button>
          </div>
        </div>

        {/* ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¸€è¦§ */}
        <div style={{ fontSize: 12, color: "#9ca3af", marginBottom: 10 }}>{filtered.length}ä»¶ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</div>
        {Object.entries(grouped).map(([cat, tpls]) => (
          <div key={cat} style={{ marginBottom: 16 }}>
            <div style={{ fontSize: 12, fontWeight: 700, color: "#4338ca", marginBottom: 6, display: "flex", alignItems: "center", gap: 6 }}>
              <span style={{ padding: "2px 8px", background: "#eef2ff", borderRadius: 4 }}>{cat}</span>
              <span style={{ color: "#9ca3af", fontWeight: 400 }}>({tpls.length})</span>
            </div>
            <div style={{ display: "flex", flexDirection: "column", gap: 6 }}>
              {tpls.map(tpl => (
                <div key={tpl.id} style={{ background: "white", borderRadius: 10, border: "1px solid #e5e7eb", padding: "12px 16px", display: "flex", alignItems: "center", gap: 12, transition: "box-shadow 0.15s" }}
                  onMouseOver={e => e.currentTarget.style.boxShadow = "0 2px 8px rgba(0,0,0,0.06)"} onMouseOut={e => e.currentTarget.style.boxShadow = "none"}>
                  <div style={{ flex: 1, minWidth: 0 }}>
                    <div style={{ fontSize: 13, fontWeight: 600, color: "#111827", marginBottom: 2 }}>{tpl.label}</div>
                    <div style={{ fontSize: 11, color: "#6b7280", overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>{tpl.subject}</div>
                  </div>
                  <div style={{ display: "flex", gap: 4 }}>
                    <button onClick={() => openEdit(tpl)} style={{ padding: "4px 10px", border: "1px solid #d1d5db", borderRadius: 6, background: "white", fontSize: 11, cursor: "pointer", color: "#374151" }}>ç·¨é›†</button>
                    <button onClick={() => duplicateTemplate(tpl)} style={{ padding: "4px 10px", border: "1px solid #d1d5db", borderRadius: 6, background: "white", fontSize: 11, cursor: "pointer", color: "#6b7280" }}>è¤‡è£½</button>
                    <button onClick={() => deleteTemplate(tpl.id)} style={{ padding: "4px 10px", border: "1px solid #fecaca", borderRadius: 6, background: "white", fontSize: 11, cursor: "pointer", color: "#dc2626" }}>å‰Šé™¤</button>
                  </div>
                </div>
              ))}
            </div>
          </div>
        ))}
        {filtered.length === 0 && <div style={{ padding: 40, textAlign: "center", color: "#9ca3af" }}>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>}
      </>)}

      {/* ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ  */}
      {tab === "templates" && editingTpl && (
        <div style={{ background: "white", borderRadius: 12, border: "1px solid #e5e7eb", padding: 24 }}>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 20 }}>
            <h3 style={{ fontSize: 16, fontWeight: 700, color: "#111827" }}>{editingTpl.isNew ? "âœ¨ æ–°è¦ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆ" : "âœï¸ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç·¨é›†"}</h3>
            <button onClick={() => setEditingTpl(null)} style={{ background: "none", border: "none", fontSize: 18, color: "#9ca3af", cursor: "pointer" }}>Ã—</button>
          </div>

          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12, marginBottom: 14 }}>
            <div>
              <label style={{ fontSize: 11, fontWeight: 600, color: "#6b7280", display: "block", marginBottom: 4 }}>ã‚«ãƒ†ã‚´ãƒª *</label>
              <input value={editingTpl.category} onChange={e => setEditingTpl({...editingTpl, category: e.target.value})}
                placeholder="ä¾‹: ä¸€æ¬¡é¢æ¥" style={inputStyle} list="cat-suggestions" />
              <datalist id="cat-suggestions">
                {STAGE_NAMES.map(s => <option key={s} value={s} />)}
                <option value="å…±é€š" />
              </datalist>
            </div>
            <div>
              <label style={{ fontSize: 11, fontWeight: 600, color: "#6b7280", display: "block", marginBottom: 4 }}>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå *</label>
              <input value={editingTpl.label} onChange={e => setEditingTpl({...editingTpl, label: e.target.value})}
                placeholder="ä¾‹: é¢æ¥æ—¥ç¨‹ã®ã”æ¡ˆå†…" style={inputStyle} />
            </div>
          </div>

          <div style={{ marginBottom: 14 }}>
            <label style={{ fontSize: 11, fontWeight: 600, color: "#6b7280", display: "block", marginBottom: 4 }}>ä»¶å *</label>
            <input value={editingTpl.subject} onChange={e => setEditingTpl({...editingTpl, subject: e.target.value})}
              placeholder="ã€{{company}}ã€‘â—‹â—‹ã®ã”æ¡ˆå†…" style={inputStyle} />
          </div>

          <div style={{ marginBottom: 14 }}>
            <label style={{ fontSize: 11, fontWeight: 600, color: "#6b7280", display: "block", marginBottom: 4 }}>æœ¬æ–‡</label>
            <div style={{ fontSize: 10, color: "#9ca3af", marginBottom: 4 }}>å·®ã—è¾¼ã¿å¤‰æ•°: {"{{name}}"} = å€™è£œè€…æ°å / {"{{company}}"} = è‡ªç¤¾å</div>
            <textarea value={editingTpl.body} onChange={e => setEditingTpl({...editingTpl, body: e.target.value})}
              rows={12} placeholder="ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ã‚’å…¥åŠ›..."
              style={{ ...inputStyle, resize: "vertical", fontFamily: "inherit", lineHeight: 1.7 }} />
          </div>

          {/* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */}
          {editingTpl.body && (
            <div style={{ marginBottom: 14 }}>
              <label style={{ fontSize: 11, fontWeight: 600, color: "#6b7280", display: "block", marginBottom: 4 }}>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</label>
              <div style={{ background: "#f9fafb", borderRadius: 8, border: "1px solid #e5e7eb", padding: 14 }}>
                <div style={{ fontSize: 13, fontWeight: 600, color: "#111827", marginBottom: 8 }}>
                  {editingTpl.subject.replace(/\{\{name\}\}/g, "å±±ç”°å¤ªéƒ").replace(/\{\{company\}\}/g, "æ ªå¼ä¼šç¤¾madoguchi")}
                </div>
                <div style={{ fontSize: 12, color: "#374151", whiteSpace: "pre-wrap", lineHeight: 1.6 }}>
                  {editingTpl.body.replace(/\{\{name\}\}/g, "å±±ç”°å¤ªéƒ").replace(/\{\{company\}\}/g, "æ ªå¼ä¼šç¤¾madoguchi")}
                </div>
              </div>
            </div>
          )}

          <div style={{ display: "flex", gap: 8, justifyContent: "flex-end" }}>
            <button onClick={() => setEditingTpl(null)}
              style={{ padding: "8px 20px", border: "1px solid #d1d5db", borderRadius: 8, background: "white", color: "#374151", fontSize: 13, cursor: "pointer" }}>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button onClick={saveTemplate}
              style={{ padding: "8px 20px", border: "none", borderRadius: 8, background: "#6366f1", color: "white", fontSize: 13, fontWeight: 500, cursor: "pointer" }}>
              {editingTpl.isNew ? "ä½œæˆ" : "ä¿å­˜"}
            </button>
          </div>
        </div>
      )}

      {tab === "company" && (
        <div style={{ background: "white", borderRadius: 12, border: "1px solid #e5e7eb", padding: 24 }}>
          <h3 style={{ fontSize: 15, fontWeight: 600, color: "#374151", marginBottom: 16 }}>ä¼šç¤¾æƒ…å ±</h3>
          <div style={{ fontSize: 13, color: "#9ca3af" }}>ã“ã®æ©Ÿèƒ½ã¯æ¬¡ã®ãƒ•ã‚§ãƒ¼ã‚ºã§å®Ÿè£…äºˆå®šã§ã™ã€‚</div>
        </div>
      )}

      {/* ãƒˆãƒ¼ã‚¹ãƒˆ */}
      {toast && (
        <div style={{ position: "fixed", bottom: 24, left: "50%", transform: "translateX(-50%)", background: "#111827", color: "white", padding: "10px 24px", borderRadius: 10, fontSize: 13, fontWeight: 500, zIndex: 10000, boxShadow: "0 4px 16px rgba(0,0,0,0.2)" }}>
          âœ… {toast}
        </div>
      )}
    </div>
  );
}

// ============================================================
// ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†ãƒšãƒ¼ã‚¸ï¼ˆAdminå°‚ç”¨ï¼‰
// ============================================================
function AccountsPage({ currentUser, onRefreshProfile }) {
  const [accounts, setAccounts] = useState([]);
  const [loading, setLoading] = useState(true);
  const [inviteOpen, setInviteOpen] = useState(false);
  const [inviteData, setInviteData] = useState({ email: "", password: "", display_name: "", role: "recruiter" });
  const [inviteLoading, setInviteLoading] = useState(false);
  const [inviteError, setInviteError] = useState("");
  const [inviteSuccess, setInviteSuccess] = useState("");

  const loadAccounts = useCallback(async () => {
    setLoading(true);
    const { data } = await sbApi.select('profiles', 'order=created_at.asc');
    setAccounts(data || []);
    setLoading(false);
  }, []);

  useEffect(() => { if (SUPABASE_READY) loadAccounts(); }, []);

  const handleInvite = async () => {
    setInviteError(""); setInviteSuccess("");
    if (!inviteData.email || !inviteData.password || !inviteData.display_name) {
      setInviteError("å…¨é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return;
    }
    if (inviteData.password.length < 6) {
      setInviteError("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã«ã—ã¦ãã ã•ã„"); return;
    }
    setInviteLoading(true);
    const { user: newUser, error } = await sbApi.signUp(inviteData.email, inviteData.password, { display_name: inviteData.display_name });
    if (error) {
      setInviteError(error.msg || error.message || JSON.stringify(error));
      setInviteLoading(false); return;
    }
    const uid = newUser?.id || newUser?.user?.id;
    if (uid) {
      await sbApi.insert('profiles', { id: uid, role: inviteData.role, display_name: inviteData.display_name, is_active: true }).catch(() => {});
    }
    setInviteSuccess(inviteData.display_name + " ã‚’æ‹›å¾…ã—ã¾ã—ãŸï¼");
    setInviteData({ email: "", password: "", display_name: "", role: "recruiter" });
    setInviteLoading(false);
    await loadAccounts();
    setTimeout(() => setInviteSuccess(""), 3000);
  };

  const updateRole = async (profileId, newRole) => {
    if (profileId === currentUser?.id && newRole !== "admin") {
      if (!window.confirm("è‡ªåˆ†ã®ãƒ­ãƒ¼ãƒ«ã‚’å¤‰æ›´ã™ã‚‹ã¨ç®¡ç†è€…æ¨©é™ã‚’å¤±ã„ã¾ã™ã€‚ç¶šã‘ã¾ã™ã‹ï¼Ÿ")) return;
    }
    await sbApi.update ? await fetch(SUPABASE_URL + '/rest/v1/profiles?id=eq.' + profileId, {
      method: 'PATCH', headers: { 'apikey': SUPABASE_ANON_KEY, 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + tokenStore.accessToken, 'Prefer': 'return=representation' },
      body: JSON.stringify({ role: newRole })
    }) : null;
    await loadAccounts();
    if (profileId === currentUser?.id && onRefreshProfile) onRefreshProfile();
  };

  const toggleActive = async (profileId, currentActive) => {
    if (profileId === currentUser?.id) { alert("è‡ªåˆ†è‡ªèº«ã¯ç„¡åŠ¹åŒ–ã§ãã¾ã›ã‚“"); return; }
    await fetch(SUPABASE_URL + '/rest/v1/profiles?id=eq.' + profileId, {
      method: 'PATCH', headers: { 'apikey': SUPABASE_ANON_KEY, 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + tokenStore.accessToken, 'Prefer': 'return=representation' },
      body: JSON.stringify({ is_active: !currentActive })
    });
    await loadAccounts();
  };

  const inputStyle = { width: "100%", padding: "8px 12px", border: "1px solid #d1d5db", borderRadius: 8, fontSize: 13, outline: "none", boxSizing: "border-box" };

  return (
    <div style={{ padding: 24, maxWidth: 900 }}>
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 20 }}>
        <h1 style={{ fontSize: 22, fontWeight: 700, color: "#111827" }}>ğŸ”‘ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†</h1>
        <button onClick={() => { setInviteOpen(!inviteOpen); setInviteError(""); setInviteSuccess(""); }}
          style={{ display: "flex", alignItems: "center", gap: 6, background: "#6366f1", color: "white", border: "none", borderRadius: 8, padding: "8px 16px", fontSize: 13, fontWeight: 500, cursor: "pointer" }}>
          <Icon name="plus" size={16} /> æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼æ‹›å¾…
        </button>
      </div>

      {/* æ‹›å¾…ãƒ•ã‚©ãƒ¼ãƒ  */}
      {inviteOpen && (
        <div style={{ background: "white", borderRadius: 12, padding: 20, marginBottom: 20, border: "1px solid #e5e7eb", boxShadow: "0 1px 4px rgba(0,0,0,0.06)" }}>
          <h3 style={{ fontSize: 15, fontWeight: 600, marginBottom: 14, color: "#374151" }}>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ‹›å¾…</h3>
          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12, marginBottom: 12 }}>
            <div>
              <label style={{ fontSize: 11, fontWeight: 600, color: "#6b7280", display: "block", marginBottom: 4 }}>è¡¨ç¤ºå *</label>
              <input value={inviteData.display_name} onChange={e => setInviteData({...inviteData, display_name: e.target.value})} placeholder="å±±ç”°å¤ªéƒ" style={inputStyle} />
            </div>
            <div>
              <label style={{ fontSize: 11, fontWeight: 600, color: "#6b7280", display: "block", marginBottom: 4 }}>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ *</label>
              <input value={inviteData.email} onChange={e => setInviteData({...inviteData, email: e.target.value})} placeholder="taro@example.com" style={inputStyle} type="email" />
            </div>
            <div>
              <label style={{ fontSize: 11, fontWeight: 600, color: "#6b7280", display: "block", marginBottom: 4 }}>åˆæœŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ *</label>
              <input value={inviteData.password} onChange={e => setInviteData({...inviteData, password: e.target.value})} placeholder="6æ–‡å­—ä»¥ä¸Š" style={inputStyle} type="password" />
            </div>
            <div>
              <label style={{ fontSize: 11, fontWeight: 600, color: "#6b7280", display: "block", marginBottom: 4 }}>ãƒ­ãƒ¼ãƒ«</label>
              <select value={inviteData.role} onChange={e => setInviteData({...inviteData, role: e.target.value})} style={{ ...inputStyle, cursor: "pointer" }}>
                {ROLES.map(r => <option key={r.id} value={r.id}>{r.icon} {r.label} â€” {r.description}</option>)}
              </select>
            </div>
          </div>
          {inviteError && <div style={{ background: "#fef2f2", color: "#dc2626", padding: "8px 12px", borderRadius: 8, fontSize: 12, marginBottom: 10 }}>âš ï¸ {inviteError}</div>}
          {inviteSuccess && <div style={{ background: "#f0fdf4", color: "#15803d", padding: "8px 12px", borderRadius: 8, fontSize: 12, marginBottom: 10 }}>âœ… {inviteSuccess}</div>}
          <div style={{ display: "flex", gap: 8 }}>
            <button onClick={handleInvite} disabled={inviteLoading}
              style={{ background: "#6366f1", color: "white", border: "none", borderRadius: 8, padding: "8px 20px", fontSize: 13, fontWeight: 500, cursor: "pointer", opacity: inviteLoading ? 0.6 : 1 }}>
              {inviteLoading ? "æ‹›å¾…ä¸­..." : "æ‹›å¾…ã‚’é€ä¿¡"}
            </button>
            <button onClick={() => setInviteOpen(false)}
              style={{ background: "#f3f4f6", color: "#374151", border: "none", borderRadius: 8, padding: "8px 20px", fontSize: 13, cursor: "pointer" }}>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          </div>
        </div>
      )}

      {/* ãƒ­ãƒ¼ãƒ«å‡¡ä¾‹ */}
      <div style={{ display: "flex", gap: 8, marginBottom: 16, flexWrap: "wrap" }}>
        {ROLES.map(r => (
          <div key={r.id} style={{ display: "flex", alignItems: "center", gap: 6, padding: "4px 10px", borderRadius: 6, background: "white", border: "1px solid #e5e7eb", fontSize: 11 }}>
            <span>{r.icon}</span>
            <span style={{ fontWeight: 600, color: r.color }}>{r.label}</span>
            <span style={{ color: "#9ca3af" }}>{r.description}</span>
          </div>
        ))}
      </div>

      {/* ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä¸€è¦§ */}
      {loading ? (
        <div style={{ textAlign: "center", padding: 40, color: "#9ca3af" }}>èª­ã¿è¾¼ã¿ä¸­...</div>
      ) : (
        <div style={{ background: "white", borderRadius: 12, border: "1px solid #e5e7eb", overflow: "hidden" }}>
          <table style={{ width: "100%", borderCollapse: "collapse", fontSize: 13 }}>
            <thead>
              <tr style={{ background: "#f9fafb", borderBottom: "1px solid #e5e7eb" }}>
                <th style={{ padding: "10px 16px", textAlign: "left", fontWeight: 600, color: "#6b7280", fontSize: 11 }}>ãƒ¦ãƒ¼ã‚¶ãƒ¼</th>
                <th style={{ padding: "10px 16px", textAlign: "left", fontWeight: 600, color: "#6b7280", fontSize: 11 }}>ãƒ­ãƒ¼ãƒ«</th>
                <th style={{ padding: "10px 16px", textAlign: "center", fontWeight: 600, color: "#6b7280", fontSize: 11 }}>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                <th style={{ padding: "10px 16px", textAlign: "center", fontWeight: 600, color: "#6b7280", fontSize: 11 }}>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              {accounts.map((acc, i) => {
                const roleDef = getRoleDef(acc.role);
                const isMe = acc.id === currentUser?.id;
                return (
                  <tr key={acc.id} style={{ borderBottom: i < accounts.length - 1 ? "1px solid #f3f4f6" : "none", opacity: acc.is_active === false ? 0.5 : 1 }}>
                    <td style={{ padding: "12px 16px" }}>
                      <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
                        <div style={{ width: 32, height: 32, borderRadius: "50%", background: roleDef.color, display: "flex", alignItems: "center", justifyContent: "center", color: "white", fontSize: 12, fontWeight: 600 }}>
                          {(acc.display_name || "?").charAt(0)}
                        </div>
                        <div>
                          <div style={{ fontWeight: 500, color: "#111827" }}>{acc.display_name || "â€”"} {isMe && <span style={{ fontSize: 10, color: "#6366f1", fontWeight: 600 }}>ï¼ˆè‡ªåˆ†ï¼‰</span>}</div>
                          <div style={{ fontSize: 11, color: "#9ca3af" }}>{acc.email || acc.id?.substring(0, 8)}</div>
                        </div>
                      </div>
                    </td>
                    <td style={{ padding: "12px 16px" }}>
                      <select value={acc.role || "viewer"} onChange={e => updateRole(acc.id, e.target.value)}
                        style={{ padding: "4px 8px", border: "1px solid #d1d5db", borderRadius: 6, fontSize: 12, cursor: "pointer", background: "white", color: roleDef.color, fontWeight: 600 }}>
                        {ROLES.map(r => <option key={r.id} value={r.id}>{r.icon} {r.label}</option>)}
                      </select>
                    </td>
                    <td style={{ padding: "12px 16px", textAlign: "center" }}>
                      <span style={{ fontSize: 11, padding: "2px 8px", borderRadius: 6, background: acc.is_active !== false ? "#dcfce7" : "#fee2e2", color: acc.is_active !== false ? "#15803d" : "#dc2626", fontWeight: 500 }}>
                        {acc.is_active !== false ? "æœ‰åŠ¹" : "ç„¡åŠ¹"}
                      </span>
                    </td>
                    <td style={{ padding: "12px 16px", textAlign: "center" }}>
                      {!isMe && (
                        <button onClick={() => toggleActive(acc.id, acc.is_active !== false)}
                          style={{ fontSize: 11, padding: "4px 10px", border: "1px solid #d1d5db", borderRadius: 6, background: "white", cursor: "pointer", color: acc.is_active !== false ? "#dc2626" : "#15803d" }}>
                          {acc.is_active !== false ? "ç„¡åŠ¹åŒ–" : "æœ‰åŠ¹åŒ–"}
                        </button>
                      )}
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
          {accounts.length === 0 && <div style={{ padding: 24, textAlign: "center", color: "#9ca3af", fontSize: 13 }}>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>}
        </div>
      )}

      {/* æ¨©é™ãƒãƒˆãƒªã‚¯ã‚¹ */}
      <div style={{ marginTop: 24, background: "white", borderRadius: 12, border: "1px solid #e5e7eb", padding: 20 }}>
        <h3 style={{ fontSize: 14, fontWeight: 600, color: "#374151", marginBottom: 12 }}>æ¨©é™ãƒãƒˆãƒªã‚¯ã‚¹</h3>
        <table style={{ width: "100%", borderCollapse: "collapse", fontSize: 12 }}>
          <thead>
            <tr style={{ borderBottom: "1px solid #e5e7eb" }}>
              <th style={{ padding: "8px 12px", textAlign: "left", color: "#6b7280", fontWeight: 600 }}>æ¨©é™</th>
              {ROLES.map(r => <th key={r.id} style={{ padding: "8px 12px", textAlign: "center", color: r.color, fontWeight: 600 }}>{r.icon} {r.label}</th>)}
            </tr>
          </thead>
          <tbody>
            {Object.keys(PERMISSIONS.admin).map(perm => (
              <tr key={perm} style={{ borderBottom: "1px solid #f3f4f6" }}>
                <td style={{ padding: "6px 12px", color: "#374151" }}>{PERMISSION_LABELS[perm] || perm}</td>
                {ROLES.map(r => (
                  <td key={r.id} style={{ padding: "6px 12px", textAlign: "center" }}>
                    {PERMISSIONS[r.id][perm] ? <span style={{ color: "#22c55e" }}>âœ“</span> : <span style={{ color: "#d1d5db" }}>â€”</span>}
                  </td>
                ))}
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
}

// ============================================================
// APP
// ============================================================
function App() {
  const [user, setUser] = useState(null);
  const [userRole, setUserRole] = useState("admin"); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: adminï¼ˆåˆå›ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ç®¡ç†è€…ï¼‰
  const [userProfile, setUserProfile] = useState(null);
  const [authChecked, setAuthChecked] = useState(false);
  const [currentPage, setCurrentPage] = useState("dashboard");
  const [selectedCandidateId, setSelectedCandidateId] = useState(null);
  const [recruitFilter, setRecruitFilter] = useState("all");
  const [pipelineFilter, setPipelineFilter] = useState(null);
  const [showAddModal, setShowAddModal] = useState(false);
  const [showProfileModal, setShowProfileModal] = useState(false);
  // ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†
  const [emailTemplates, setEmailTemplates] = useState(() => {
    try { const saved = localStorage.getItem('ats_email_templates'); return saved ? JSON.parse(saved) : DEFAULT_EMAIL_TEMPLATES; } catch(e) { return DEFAULT_EMAIL_TEMPLATES; }
  });
  const saveEmailTemplates = (tpls) => { setEmailTemplates(tpls); localStorage.setItem('ats_email_templates', JSON.stringify(tpls)); };

  // ã‚¿ã‚¹ã‚¯ç®¡ç†
  const [tasks, setTasks] = useState(() => {
    try { const saved = localStorage.getItem('ats_tasks'); return saved ? JSON.parse(saved) : []; } catch(e) { return []; }
  });
  const saveTasks = useCallback((newTasks) => { setTasks(newTasks); localStorage.setItem('ats_tasks', JSON.stringify(newTasks)); }, []);

  // ã‚¹ãƒ†ãƒ¼ã‚¸å¤‰æ›´æ™‚ã«ã‚¿ã‚¹ã‚¯ã‚’è‡ªå‹•ç”Ÿæˆ
  const autoGenerateTasks = useCallback((candidate, newStage) => {
    const newTasks = generateTasksForStage(candidate, newStage);
    if (newTasks.length > 0) {
      setTasks(prev => {
        const updated = [...prev, ...newTasks];
        localStorage.setItem('ats_tasks', JSON.stringify(updated));
        return updated;
      });
    }
  }, []);
  const [profileEditName, setProfileEditName] = useState("");
  const [migrationStatus, setMigrationStatus] = useState(null);
  const [migrationMsg, setMigrationMsg] = useState('');

  // profileå–å¾—
  const loadProfile = useCallback(async (userId, email) => {
    if (!SUPABASE_READY || !userId) {
      setUserRole("admin");
      setUserProfile({ display_name: email || "ãƒ‡ãƒ¢ãƒ¦ãƒ¼ã‚¶ãƒ¼", role: "admin" });
      return;
    }
    const { data } = await sbApi.select('profiles', 'id=eq.' + userId);
    if (data && data.length > 0) {
      setUserProfile(data[0]);
      setUserRole(data[0].role || "admin");
    } else {
      // profileãŒãªã„å ´åˆã¯æœ€åˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼â†’admin ã¨ã—ã¦è‡ªå‹•ä½œæˆ
      const displayName = email ? email.split("@")[0] : "ç®¡ç†è€…";
      const profile = { id: userId, role: "admin", display_name: displayName, email: email || "", is_active: true };
      await sbApi.insert('profiles', profile).catch(() => {});
      setUserProfile(profile);
      setUserRole("admin");
    }
  }, []);

  const can = (permission) => hasPermission(userRole, permission);

  const openProfileEdit = () => {
    setProfileEditName(userProfile?.display_name || "");
    setShowProfileModal(true);
  };
  const saveProfile = async () => {
    if (!profileEditName.trim()) return;
    if (SUPABASE_READY && user?.id) {
      await fetch(SUPABASE_URL + '/rest/v1/profiles?id=eq.' + user.id, {
        method: 'PATCH',
        headers: { 'apikey': SUPABASE_ANON_KEY, 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + tokenStore.accessToken, 'Prefer': 'return=representation' },
        body: JSON.stringify({ display_name: profileEditName.trim() })
      });
      await loadProfile(user.id, user.email);
    } else {
      setUserProfile(prev => ({ ...prev, display_name: profileEditName.trim() }));
    }
    setShowProfileModal(false);
  };

  // ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒƒã‚¯
  const { candidates, loading: dataLoading, addCandidate, updateCandidate: rawUpdateCandidate, bulkUpdateStatus, refresh } = useSupabaseCandidates(recruitFilter);

  // ã‚¹ãƒ†ãƒ¼ã‚¸å¤‰æ›´æ™‚ã«ã‚¿ã‚¹ã‚¯ã‚‚è‡ªå‹•ç”Ÿæˆã™ã‚‹ãƒ©ãƒƒãƒ‘ãƒ¼
  const updateCandidate = useCallback(async (id, updates) => {
    await rawUpdateCandidate(id, updates);
    if (updates.stage) {
      const cand = candidates.find(c => c.id === id);
      if (cand) autoGenerateTasks({ ...cand, ...updates }, updates.stage);
    }
  }, [rawUpdateCandidate, candidates, autoGenerateTasks]);

  const handleMigration = async () => {
    if (!window.confirm('å€™è£œè€…ãƒ‡ãƒ¼ã‚¿ã‚’æ–°ã—ã„8ã‚¹ãƒ†ãƒ¼ã‚¸å½¢å¼ã«ä¸€æ‹¬å¤‰æ›ã—ã¾ã™ã€‚\\nï¼ˆæ—¢å­˜ã®ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ»ã‚µãƒ–ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒä¸Šæ›¸ãã•ã‚Œã¾ã™ï¼‰\\n\\nå®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ')) return;
    setMigrationStatus('running');
    const ok = await runDataMigration((msg) => setMigrationMsg(msg));
    if (ok) {
      setMigrationStatus('done');
      await refresh();
      setTimeout(() => { setMigrationStatus(null); setMigrationMsg(''); }, 5000);
    } else {
      setMigrationStatus(null);
    }
  };

  // èªè¨¼çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
  useEffect(() => {
    if (SUPABASE_READY) {
      sbApi.getUser().then(async u => {
        setUser(u || null);
        if (u) await loadProfile(u.id, u.email);
        setAuthChecked(true);
      });
    } else {
      setAuthChecked(true);
    }
  }, []);

  const handleLogout = async () => {
    if (SUPABASE_READY) await sbApi.signOut();
    setUser(null);
  };

  // æœªãƒ­ã‚°ã‚¤ãƒ³ â†’ ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢
  if (authChecked && !user) {
    return <LoginPage onLogin={async (u) => { setUser(u); await loadProfile(u.id, u.email); }} />;
  }
  if (!authChecked) {
    return <div style={{ minHeight: "100vh", display: "flex", alignItems: "center", justifyContent: "center", background: "#f5f5f7" }}><div style={{ fontSize: 14, color: "#6b7280" }}>èª­ã¿è¾¼ã¿ä¸­...</div></div>;
  }

  const navigate = (page, id) => {
    setCurrentPage(page);
    if (id) setSelectedCandidateId(id);
    if (page !== "candidates" || !id) setPipelineFilter(null);
  };

  const navigateFromPipeline = (stageName, substatus) => {
    setPipelineFilter({ stageName, substatus });
    setCurrentPage("candidates");
  };

  const renderPage = () => {
    switch (currentPage) {
      case "dashboard": return <DashboardPage onNavigate={navigate} recruitFilter={recruitFilter} tasks={tasks} />;
      case "candidates": return <CandidatesPage onNavigate={navigate} recruitFilter={recruitFilter} pipelineFilter={pipelineFilter} onClearPipelineFilter={() => setPipelineFilter(null)} candidates={candidates} onUpdateCandidate={updateCandidate} onBulkUpdateStatus={bulkUpdateStatus} onShowAddModal={() => setShowAddModal(true)} can={can} emailTemplates={emailTemplates} />;
      case "candidate-detail": return <CandidateDetailPage candidateId={selectedCandidateId} onNavigate={navigate} candidates={candidates} onUpdateCandidate={updateCandidate} can={can} />;
      case "pipeline": return <PipelinePage recruitFilter={recruitFilter} onNavigateFromPipeline={navigateFromPipeline} candidates={candidates} />;
      case "messages": return <MessagesPage candidates={candidates} emailTemplates={emailTemplates} onNavigate={navigate} />;
      case "schedule": return <SchedulePage recruitFilter={recruitFilter} />;
      case "interview-fb": return <InterviewFBPage onNavigate={navigate} />;
      case "automation": return <AutomationPage emailTemplates={emailTemplates} />;
      case "analytics": return <AnalyticsPage recruitFilter={recruitFilter} candidates={candidates} />;
      case "tasks": return <TasksPage tasks={tasks} onUpdateTasks={saveTasks} candidates={candidates} onNavigate={navigate} />;
      case "agents": return <AgentsPage candidates={candidates} />;
      case "accounts": return can("manageAccounts") ? <AccountsPage currentUser={user} onRefreshProfile={() => loadProfile(user?.id, user?.email)} /> : <div style={{ padding: 40, textAlign: "center", color: "#9ca3af" }}>ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“</div>;
      case "settings": return can("editSettings") ? <SettingsPage emailTemplates={emailTemplates} onSaveTemplates={saveEmailTemplates} /> : <div style={{ padding: 40, textAlign: "center", color: "#9ca3af" }}>ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“</div>;
      default: return (
        <div style={{ padding: 24, display: "flex", alignItems: "center", justifyContent: "center", height: "60vh" }}>
          <div style={{ textAlign: "center" }}>
            <div style={{ fontSize: 48, marginBottom: 12 }}>ğŸš§</div>
            <h2 style={{ fontSize: 18, fontWeight: 600, color: "#374151", marginBottom: 4 }}>ã“ã®ç”»é¢ã¯é–‹ç™ºä¸­ã§ã™</h2>
            <p style={{ fontSize: 13, color: "#9ca3af" }}>æ¬¡ã®ãƒ•ã‚§ãƒ¼ã‚ºã§å®Ÿè£…äºˆå®šã§ã™</p>
          </div>
        </div>
      );
    }
  };

  return (
    <div style={{ display: "flex", minHeight: "100vh", background: "#f5f5f7", fontFamily: "-apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Kaku Gothic ProN', sans-serif" }}>
      <Sidebar currentPage={currentPage} onNavigate={navigate} userRole={userRole} userProfile={userProfile} onEditProfile={openProfileEdit} />
      <div style={{ flex: 1, overflowY: "auto", maxHeight: "100vh" }}>
        <div style={{ background: "white", borderBottom: "1px solid #e5e7eb", padding: "10px 24px", display: "flex", justifyContent: "space-between", alignItems: "center", position: "sticky", top: 0, zIndex: 10 }}>
          <div style={{ display: "flex", alignItems: "center", gap: 16 }}>
            <RecruitTypeSelector value={recruitFilter} onChange={setRecruitFilter} />
            {SUPABASE_READY && (
              <span style={{ fontSize: 10, padding: "2px 8px", borderRadius: 6, background: "#dcfce7", color: "#15803d", fontWeight: 600 }}>DBæ¥ç¶šä¸­</span>
            )}
            {!SUPABASE_READY && (
              <span style={{ fontSize: 10, padding: "2px 8px", borderRadius: 6, background: "#fef3c7", color: "#92400e", fontWeight: 600 }}>ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰</span>
            )}
            <div style={{ position: "relative", width: 260 }}>
              <Icon name="search" size={14} color="#9ca3af" style={{ position: "absolute", left: 8, top: 8 }} />
              <input placeholder="å€™è£œè€…ãƒ»ã‚¿ã‚¹ã‚¯ã‚’æ¤œç´¢..." style={{ width: "100%", padding: "6px 6px 6px 28px", border: "1px solid #e5e7eb", borderRadius: 8, fontSize: 12, outline: "none", boxSizing: "border-box" }} />
            </div>
          </div>
          <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
            {SUPABASE_READY && migrationStatus !== 'done' && (
              <button onClick={handleMigration} disabled={migrationStatus === 'running'}
                style={{ fontSize: 11, color: "white", background: migrationStatus === 'running' ? '#9ca3af' : '#f59e0b', border: "none", borderRadius: 6, padding: "4px 12px", cursor: migrationStatus === 'running' ? "default" : "pointer", fontWeight: 600, whiteSpace: 'nowrap' }}>
                {migrationStatus === 'running' ? migrationMsg || 'å®Ÿè¡Œä¸­...' : 'ãƒ‡ãƒ¼ã‚¿ç§»è¡Œ'}
              </button>
            )}
            {migrationStatus === 'done' && (
              <span style={{ fontSize: 11, color: '#15803d', fontWeight: 600 }}>{migrationMsg}</span>
            )}
            <button style={{ position: "relative", background: "none", border: "none", cursor: "pointer", padding: 4 }}>
              <Icon name="bell" size={18} color="#6b7280" />
              <div style={{ position: "absolute", top: 0, right: 0, width: 8, height: 8, borderRadius: "50%", background: "#ef4444" }} />
            </button>
            <button onClick={handleLogout} style={{ fontSize: 11, color: "#6b7280", background: "none", border: "1px solid #e5e7eb", borderRadius: 6, padding: "4px 10px", cursor: "pointer" }}>ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
          </div>
        </div>
        {renderPage()}
      </div>

      {/* å€™è£œè€…è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« */}
      {showAddModal && <AddCandidateModal onClose={() => setShowAddModal(false)} onAdd={async (c) => { const result = await addCandidate(c); if (result) autoGenerateTasks({ ...c, id: result.id || result[0]?.id || Date.now() }, c.stage || "ã‚¨ãƒ³ãƒˆãƒªãƒ¼"); setShowAddModal(false); }} />}

      {/* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« */}
      {showProfileModal && (
        <div style={{ position: "fixed", top: 0, left: 0, right: 0, bottom: 0, background: "rgba(0,0,0,0.5)", zIndex: 9999, display: "flex", alignItems: "center", justifyContent: "center", padding: 20 }}
          onClick={e => { if (e.target === e.currentTarget) setShowProfileModal(false); }}>
          <div style={{ background: "white", borderRadius: 16, padding: 28, boxShadow: "0 20px 60px rgba(0,0,0,0.3)", width: "100%", maxWidth: 420 }}>
            <h3 style={{ fontSize: 17, fontWeight: 700, color: "#111827", marginBottom: 20 }}>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†</h3>
            <div style={{ marginBottom: 16 }}>
              <label style={{ fontSize: 12, fontWeight: 600, color: "#6b7280", display: "block", marginBottom: 6 }}>è¡¨ç¤ºå</label>
              <input value={profileEditName} onChange={e => setProfileEditName(e.target.value)}
                style={{ width: "100%", padding: "10px 14px", border: "2px solid #e5e7eb", borderRadius: 10, fontSize: 14, outline: "none", boxSizing: "border-box", transition: "border 0.2s" }}
                onFocus={e => e.target.style.borderColor = "#6366f1"} onBlur={e => e.target.style.borderColor = "#e5e7eb"}
                placeholder="åå‰ã‚’å…¥åŠ›" autoFocus
                onKeyDown={e => { if (e.key === "Enter") saveProfile(); }} />
            </div>
            <div style={{ marginBottom: 20, padding: "10px 14px", background: "#f9fafb", borderRadius: 8, fontSize: 12, color: "#6b7280" }}>
              <div><strong>ãƒ¡ãƒ¼ãƒ«:</strong> {user?.email || "â€”"}</div>
              <div><strong>ãƒ­ãƒ¼ãƒ«:</strong> {getRoleDef(userRole).icon} {getRoleDef(userRole).label}</div>
            </div>
            <div style={{ display: "flex", gap: 8, justifyContent: "flex-end" }}>
              <button onClick={() => setShowProfileModal(false)}
                style={{ padding: "8px 20px", border: "1px solid #d1d5db", borderRadius: 8, background: "white", color: "#374151", fontSize: 13, cursor: "pointer" }}>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
              <button onClick={saveProfile}
                style={{ padding: "8px 20px", border: "none", borderRadius: 8, background: "#6366f1", color: "white", fontSize: 13, fontWeight: 500, cursor: "pointer" }}>ä¿å­˜</button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// ============================================================
// å€™è£œè€…è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«
// ============================================================
function AddCandidateModal({ onClose, onAdd }) {
  const [form, setForm] = useState({
    recruitType: "æ–°å’", lastName: "", firstName: "", lastNameKana: "", firstNameKana: "",
    email: "", phone: "", birthDate: "",
    university: "", faculty: "", department: "", gradYear: 2027, majorType: "æ–‡ç³»", graduationPeriod: "2027å¹´3æœˆ",
    company: "", position: "", experience: "",
    route: "", aspiration: 3, agent: "", gender: "ç”·æ€§", notes: "",
  });
  const [saving, setSaving] = useState(false);
  const set = (key, val) => setForm(prev => ({ ...prev, [key]: val }));
  const isNew = form.recruitType === "æ–°å’";

  const handleSave = async () => {
    if (!form.lastName || !form.firstName) return;
    setSaving(true);
    await onAdd({
      ...form,
      stage: "ã‚¨ãƒ³ãƒˆãƒªãƒ¼/å—ä»˜æ¸ˆ",
      substatus: "å—ä»˜æ¸ˆ",
      status: "æ–°è¦",
      format: null,
      score: null,
      experience: form.experience ? parseInt(form.experience) : null,
      entryDate: new Date().toISOString().split("T")[0],
    });
    setSaving(false);
  };

  const inputStyle = { width: "100%", padding: "8px 12px", border: "1px solid #d1d5db", borderRadius: 8, fontSize: 13, outline: "none", boxSizing: "border-box" };
  const labelStyle = { display: "block", fontSize: 11, fontWeight: 600, color: "#374151", marginBottom: 4 };

  return (
    <div style={{ position: "fixed", inset: 0, background: "rgba(0,0,0,0.4)", display: "flex", alignItems: "center", justifyContent: "center", zIndex: 1000 }} onClick={onClose}>
      <div style={{ background: "white", borderRadius: 16, padding: 28, width: 520, maxHeight: "80vh", overflowY: "auto", boxShadow: "0 20px 60px rgba(0,0,0,0.2)" }} onClick={e => e.stopPropagation()}>
        <h2 style={{ fontSize: 18, fontWeight: 700, marginBottom: 20, color: "#111827" }}>å€™è£œè€…ã‚’æ–°è¦ç™»éŒ²</h2>

        {/* æ¡ç”¨åŒºåˆ† */}
        <div style={{ display: "flex", gap: 8, marginBottom: 16 }}>
          {["æ–°å’", "ä¸­é€”"].map(t => (
            <button key={t} onClick={() => set("recruitType", t)}
              style={{ flex: 1, padding: "8px", border: form.recruitType === t ? "2px solid #4338ca" : "1px solid #d1d5db", borderRadius: 8, background: form.recruitType === t ? "#eef2ff" : "white", fontSize: 13, fontWeight: 600, cursor: "pointer", color: form.recruitType === t ? "#4338ca" : "#6b7280" }}>
              {t}
            </button>
          ))}
        </div>

        {/* åŸºæœ¬æƒ…å ± */}
        <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12, marginBottom: 16 }}>
          <div><label style={labelStyle}>å§“ *</label><input value={form.lastName} onChange={e => set("lastName", e.target.value)} style={inputStyle} placeholder="å±±ç”°" /></div>
          <div><label style={labelStyle}>å *</label><input value={form.firstName} onChange={e => set("firstName", e.target.value)} style={inputStyle} placeholder="èŠ±å­" /></div>
          <div><label style={labelStyle}>ã‚»ã‚¤</label><input value={form.lastNameKana} onChange={e => set("lastNameKana", e.target.value)} style={inputStyle} placeholder="ãƒ¤ãƒãƒ€" /></div>
          <div><label style={labelStyle}>ãƒ¡ã‚¤</label><input value={form.firstNameKana} onChange={e => set("firstNameKana", e.target.value)} style={inputStyle} placeholder="ãƒãƒŠã‚³" /></div>
          <div><label style={labelStyle}>ãƒ¡ãƒ¼ãƒ«</label><input type="email" value={form.email} onChange={e => set("email", e.target.value)} style={inputStyle} placeholder="email@example.com" /></div>
          <div><label style={labelStyle}>é›»è©±</label><input value={form.phone} onChange={e => set("phone", e.target.value)} style={inputStyle} placeholder="090-1234-5678" /></div>
          <div><label style={labelStyle}>ç”Ÿå¹´æœˆæ—¥</label><input type="date" value={form.birthDate} onChange={e => set("birthDate", e.target.value)} style={inputStyle} /></div>
          <div><label style={labelStyle}>æ€§åˆ¥</label>
            <select value={form.gender} onChange={e => set("gender", e.target.value)} style={inputStyle}>
              <option value="ç”·æ€§">ç”·æ€§</option><option value="å¥³æ€§">å¥³æ€§</option><option value="ãã®ä»–">ãã®ä»–</option>
            </select>
          </div>
        </div>

        {/* æ–°å’ or ä¸­é€”å›ºæœ‰ */}
        {isNew ? (
          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12, marginBottom: 16 }}>
            <div><label style={labelStyle}>å¤§å­¦</label><input value={form.university} onChange={e => set("university", e.target.value)} style={inputStyle} placeholder="â—‹â—‹å¤§å­¦" /></div>
            <div><label style={labelStyle}>å­¦éƒ¨</label><input value={form.faculty} onChange={e => set("faculty", e.target.value)} style={inputStyle} placeholder="â—‹â—‹å­¦éƒ¨" /></div>
            <div><label style={labelStyle}>å­¦ç§‘</label><input value={form.department} onChange={e => set("department", e.target.value)} style={inputStyle} placeholder="â—‹â—‹å­¦ç§‘" /></div>
            <div><label style={labelStyle}>æ–‡ç†</label>
              <select value={form.majorType} onChange={e => set("majorType", e.target.value)} style={inputStyle}>
                <option value="æ–‡ç³»">æ–‡ç³»</option><option value="ç†ç³»">ç†ç³»</option>
              </select>
            </div>
            <div><label style={labelStyle}>å’æ¥­å¹´</label><input type="number" value={form.gradYear} onChange={e => set("gradYear", parseInt(e.target.value))} style={inputStyle} /></div>
            <div><label style={labelStyle}>å’æ¥­äºˆå®šæ™‚æœŸ</label><input value={form.graduationPeriod} onChange={e => set("graduationPeriod", e.target.value)} style={inputStyle} placeholder="2027å¹´3æœˆ" /></div>
          </div>
        ) : (
          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12, marginBottom: 16 }}>
            <div><label style={labelStyle}>ç¾è·ä¼æ¥­</label><input value={form.company} onChange={e => set("company", e.target.value)} style={inputStyle} /></div>
            <div><label style={labelStyle}>è·ç¨®</label><input value={form.position} onChange={e => set("position", e.target.value)} style={inputStyle} /></div>
            <div><label style={labelStyle}>çµŒé¨“å¹´æ•°</label><input type="number" value={form.experience} onChange={e => set("experience", e.target.value)} style={inputStyle} /></div>
            <div />
          </div>
        )}

        {/* ãƒ¡ã‚¿æƒ…å ± */}
        <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12, marginBottom: 16 }}>
          <div><label style={labelStyle}>å¿œå‹ŸçµŒè·¯</label><input value={form.route} onChange={e => set("route", e.target.value)} style={inputStyle} placeholder="ãƒã‚¤ãƒŠãƒ“ã€ç´¹ä»‹ä¼šç¤¾ ç­‰" /></div>
          <div><label style={labelStyle}>ç´¹ä»‹ä¼šç¤¾/ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ</label><input value={form.agent} onChange={e => set("agent", e.target.value)} style={inputStyle} /></div>
          <div><label style={labelStyle}>å¿—æœ›åº¦</label>
            <select value={form.aspiration} onChange={e => set("aspiration", parseInt(e.target.value))} style={inputStyle}>
              {[1,2,3,4,5].map(n => <option key={n} value={n}>{n} - {"â˜…".repeat(n)}</option>)}
            </select>
          </div>
        </div>
        <div style={{ marginBottom: 24 }}>
          <label style={labelStyle}>ãƒ¡ãƒ¢</label>
          <textarea value={form.notes} onChange={e => set("notes", e.target.value)} style={{ ...inputStyle, minHeight: 60, resize: "vertical" }} placeholder="è‡ªç”±è¨˜å…¥æ¬„" />
        </div>

        <div style={{ display: "flex", gap: 10, justifyContent: "flex-end" }}>
          <button onClick={onClose} style={{ padding: "8px 20px", border: "1px solid #d1d5db", borderRadius: 8, background: "white", fontSize: 13, cursor: "pointer", color: "#374151" }}>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button onClick={handleSave} disabled={saving || !form.lastName || !form.firstName}
            style={{ padding: "8px 24px", border: "none", borderRadius: 8, background: (!form.lastName || !form.firstName) ? "#a5b4fc" : "#4338ca", color: "white", fontSize: 13, fontWeight: 600, cursor: saving ? "default" : "pointer" }}>
            {saving ? "ä¿å­˜ä¸­..." : "ç™»éŒ²ã™ã‚‹"}
          </button>
        </div>
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>
